import{Buffer as x}from"https://registry.koishi.chat/modules/buffer/index.js";import w from"https://registry.koishi.chat/modules/process/index.js";import{defineProperty as ot}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{defineProperty as b,remove as V}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{defineProperty as G,isNullable as O}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{defineProperty as ct}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{defineProperty as ht}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{deepEqual as pt,defineProperty as J,isNullable as dt,remove as j}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{defineProperty as gt}from"https://registry.koishi.chat/modules/cosmokit/index.js";var nt=Object.defineProperty,a=(r,t)=>nt(r,"name",{value:t,configurable:!0}),c={shadow:Symbol.for("cordis.shadow"),receiver:Symbol.for("cordis.receiver"),original:Symbol.for("cordis.original"),store:Symbol.for("cordis.store"),events:Symbol.for("cordis.events"),static:Symbol.for("cordis.static"),filter:Symbol.for("cordis.filter"),expose:Symbol.for("cordis.expose"),isolate:Symbol.for("cordis.isolate"),internal:Symbol.for("cordis.internal"),intercept:Symbol.for("cordis.intercept"),setup:Symbol.for("cordis.setup"),invoke:Symbol.for("cordis.invoke"),extend:Symbol.for("cordis.extend"),tracker:Symbol.for("cordis.tracker"),provide:Symbol.for("cordis.provide"),immediate:Symbol.for("cordis.immediate")},at=function*(){}.constructor,M=async function*(){}.constructor;function F(r){return!(!r.prototype||r instanceof at||M!==Function&&r instanceof M)}a(F,"isConstructor");function _(r,t){let e=r.Config||r.schema;return e&&r.schema!==!1&&(t=e(t)),t??{}}a(_,"resolveConfig");function W(r){return[Map,Set,Date,Promise].some(t=>r instanceof t)}a(W,"isUnproxyable");function L(r,t){if(r===Object.prototype)return t;let e=Object.create(L(Object.getPrototypeOf(r),t));for(let s of Reflect.ownKeys(r))Object.defineProperty(e,s,Object.getOwnPropertyDescriptor(r,s));return e}a(L,"joinPrototype");function N(r){return r&&(typeof r=="object"||typeof r=="function")}a(N,"isObject");function m(r,t,e){if(!N(t))return t;if(Object.hasOwn(t,c.shadow))return Object.getPrototypeOf(t);let s=t[c.tracker];return s?E(r,t,s,e):t}a(m,"getTraceable");function S(r,t){return t?new Proxy(r,{get:a((e,s,i)=>s in t&&s!=="constructor"?Reflect.get(t,s,i):Reflect.get(e,s,i),"get"),set:a((e,s,i,o)=>s in t&&s!=="constructor"?Reflect.set(t,s,i,o):Reflect.set(e,s,i,o),"set")}):r}a(S,"withProps");function P(r,t,e){return S(r,Object.defineProperty(Object.create(null),t,{value:e,writable:!1}))}a(P,"withProp");function A(r,t,e,s){if(!e)return s;let i=Reflect.getOwnPropertyDescriptor(t,e)?.value;return i?P(s,e,r.extend({[c.shadow]:i})):s}a(A,"createShadow");function H(r,t,e,s){return new Proxy(t,{apply:a((i,o,n)=>(o===e&&(o=s),n=n.map(l=>typeof l!="function"||l[c.original]?l:new Proxy(l,{get:a((f,u,p)=>{if(u===c.original)return f;let d=Reflect.get(f,u,p);return u==="toString"&&d===Function.prototype.toString?function(...v){return Reflect.apply(d,this===p?f:this,v)}:d},"get"),apply:a((f,u,p)=>Reflect.apply(f,m(r,u),p.map(d=>m(r,d))),"apply"),construct:a((f,u,p)=>Reflect.construct(f,u.map(d=>m(r,d)),p),"construct")})),m(r,Reflect.apply(i,o,n))),"apply")})}a(H,"createShadowMethod");function E(r,t,e,s){r[c.shadow]&&(r=Object.getPrototypeOf(r));let i=new Proxy(t,{get:a((o,n,l)=>{if(n===c.original)return o;if(n===e.property)return r;if(typeof n=="symbol")return Reflect.get(o,n,l);if(e.associate&&r[c.internal][`${e.associate}.${n}`])return Reflect.get(r,`${e.associate}.${n}`,P(r,c.receiver,l));let f=A(r,o,e.property,l),u=Reflect.get(o,n,f),p=u?.[c.tracker];return p?E(r,u,p):!s&&typeof u=="function"?H(r,u,l,f):u},"get"),set:a((o,n,l,f)=>{if(n===c.original||n===e.property)return!1;if(typeof n=="symbol")return Reflect.set(o,n,l,f);if(e.associate&&r[c.internal][`${e.associate}.${n}`])return Reflect.set(r,`${e.associate}.${n}`,l,P(r,c.receiver,f));let u=A(r,o,e.property,f);return Reflect.set(o,n,l,u)},"set"),apply:a((o,n,l)=>U(i,o,n,l),"apply")});return i}a(E,"createTraceable");function U(r,t,e,s){return t[c.invoke]?t[c.invoke].apply(r,s):Reflect.apply(t,e,s)}a(U,"applyTraceable");function C(r,t,e){let s=a(function(...i){let o=E(s.ctx,s,e);return U(o,s,this,i)},"self");return ct(s,"name",r),Object.setPrototypeOf(s,t)}a(C,"createCallable");var lt=class g{constructor(t){this.ctx=t,G(this,c.tracker,{associate:"reflect",property:"ctx"}),this._mixin("reflect",["get","set","provide","accessor","mixin","alias"]),this._mixin("scope",["config","runtime","effect","collect","accept","decline"]),this._mixin("registry",["using","inject","plugin"]),this._mixin("lifecycle",["on","once","parallel","emit","serial","bail","start","stop"])}static{a(this,"ReflectService")}static resolveInject(t,e){let s=t[c.internal][e];for(;s?.type==="alias";)e=s.name,s=t[c.internal][e];return[e,s]}static checkInject(t,e,s){if(t=t[c.shadow]??t,["prototype","then","registry","lifecycle"].includes(e)||e[0]==="$"||e[0]==="_"||!t.runtime.plugin||t.bail(t,"internal/inject",e))return;let i=s.stack.split(`
`);i.splice(1,1),s.stack=i.join(`
`),t.emit(t,"internal/warning",s)}static handler={get:a((t,e,s)=>{if(typeof e!="string")return Reflect.get(t,e,s);if(Reflect.has(t,e))return m(s,Reflect.get(t,e,s),!0);let[i,o]=g.resolveInject(t,e),n=new Error(`property ${i} is not registered, declare it as \`inject\` to suppress this warning`);return o?o.type==="accessor"?o.get.call(s,s[c.receiver]):(o.builtin||g.checkInject(s,i,n),s.reflect.get(i)):(g.checkInject(s,i,n),Reflect.get(t,i,s))},"get"),set:a((t,e,s,i)=>{if(typeof e!="string")return Reflect.set(t,e,s,i);let[o,n]=g.resolveInject(t,e);return n?n.type==="accessor"?n.set?n.set.call(i,s,i[c.receiver]):!1:(i.reflect.set(o,s),!0):Reflect.set(t,o,s,i)},"set"),has:a((t,e)=>{if(typeof e!="string")return Reflect.has(t,e);if(Reflect.has(t,e))return!0;let[,s]=g.resolveInject(t,e);return!!s},"has")};get(t){if(this.ctx[c.internal][t]?.type!=="service")return;let s=this.ctx[c.isolate][t],i=this.ctx[c.store][s]?.value;return m(this.ctx,i)}set(t,e){this.provide(t);let s=this.ctx[c.isolate][t],i=this.ctx[c.store][s]?.value;e??=void 0;let o=a(()=>{},"dispose");if(i===e)return o;if(!O(e)&&!O(i))throw new Error(`service ${t} has been registered`);let n=this.ctx;O(e)||(o=n.effect(()=>()=>{n.set(t,void 0)})),W(e)&&n.emit(n,"internal/warning",new Error(`service ${t} is an unproxyable object, which may lead to unexpected behavior`));let l=Object.create(n);return l[c.filter]=f=>n[c.isolate][t]===f[c.isolate][t],n.emit(l,"internal/before-service",t,e),n[c.store][s]={value:e,source:n},n.emit(l,"internal/service",t,i),o}provide(t,e,s){let i=this.ctx.root[c.internal];if(t in i)return;let o=Symbol(t);i[t]={type:"service",builtin:s},this.ctx.root[c.isolate][t]=o,N(e)&&(this.ctx[c.store][o]={value:e,source:null},G(e,c.tracker,{associate:t,property:"ctx"}))}_accessor(t,e){let s=this.ctx.root[c.internal];return t in s?()=>{}:(s[t]={type:"accessor",...e},()=>delete this.ctx.root[c.isolate][t])}accessor(t,e){this.ctx.scope.effect(()=>this._accessor(t,e))}alias(t,e){let s=this.ctx.root[c.internal];if(!(t in s))for(let i of e)s[i]||={type:"alias",name:t}}_mixin(t,e){let s=Array.isArray(e)?e.map(n=>[n,n]):Object.entries(e),i=typeof t=="string"?n=>n[t]:()=>t,o=s.map(([n,l])=>this._accessor(l,{get(f){let u=i(this);if(O(u))return u;let p=f?S(f,u):u,d=Reflect.get(u,n,p);return typeof d!="function"?d:d.bind(p??u)},set(f,u){let p=i(this),d=u?S(u,p):p;return Reflect.set(p,n,f,d)}}));return()=>o.forEach(n=>n())}mixin(t,e){this.ctx.scope.effect(()=>this._mixin(t,e))}trace(t){return m(this.ctx,t)}bind(t){return new Proxy(t,{apply:a((e,s,i)=>e.apply(this.trace(s),i.map(o=>this.trace(o))),"apply")})}},T=lt;function $(r){return r!==null&&r!==!1&&r!==void 0}a($,"isBailed");var ft=class{constructor(r){this.ctx=r,b(this,c.tracker,{associate:"lifecycle",property:"ctx"}),b(this.on("internal/listener",function(e,s,i){let o=i.prepend?"unshift":"push";if(e==="ready")return this.lifecycle.isActive?(this.scope.ensure(async()=>s()),()=>!1):void 0;if(e==="dispose")return this.scope.disposables[o](s),b(s,"name","event <dispose>"),()=>V(this.scope.disposables,s);if(e==="fork")return this.scope.runtime.forkables[o](s),this.scope.collect("event <fork>",()=>V(this.scope.runtime.forkables,s))}),h.static,r.scope);for(let e of["info","error","warning"])b(this.on(`internal/${e}`,(s,...i)=>{this._hooks[`internal/${e}`].length>1}),h.static,r.scope);b(this.on("internal/before-service",function(e){for(let s of this.registry.values()){if(!s.inject[e]?.required)continue;let i=s.isReusable?s.children:[s];for(let o of i)this[c.filter](o.ctx)&&(o.updateStatus(),o.reset())}},{global:!0}),h.static,r.scope),b(this.on("internal/service",function(e){for(let s of this.registry.values()){if(!s.inject[e]?.required)continue;let i=s.isReusable?s.children:[s];for(let o of i)this[c.filter](o.ctx)&&o.start()}},{global:!0}),h.static,r.scope);let t=a((e,s)=>{if(!e.runtime.plugin)return!1;for(let i in e.runtime.inject)if(s===T.resolveInject(e.ctx,i)[0])return!0;return t(e.parent.scope,s)},"checkInject");b(this.on("internal/inject",function(e){return t(this.scope,e)},{global:!0}),h.static,r.scope)}static{a(this,"Lifecycle")}isActive=!1;_tasks=new Set;_hooks={};async flush(){for(;this._tasks.size;)await Promise.all(Array.from(this._tasks))}filterHooks(r,t){return t=m(this.ctx,t),r.slice().filter(e=>{let s=t?.[h.filter];return e.global||!s||s.call(t,e.ctx)})}*dispatch(r,t){let e=typeof t[0]=="object"||typeof t[0]=="function"?t.shift():null,s=t.shift();s!=="internal/event"&&this.emit("internal/event",r,s,t,e);for(let i of this.filterHooks(this._hooks[s]||[],e))yield i.callback.apply(e,t)}async parallel(...r){await Promise.all(this.dispatch("emit",r))}emit(...r){Array.from(this.dispatch("emit",r))}async serial(...r){for await(let t of this.dispatch("serial",r))if($(t))return t}bail(...r){for(let t of this.dispatch("bail",r))if($(t))return t}register(r,t,e,s){let i=s.prepend?"unshift":"push";return t[i]({ctx:this.ctx,callback:e,...s}),this.ctx.state.collect(r,()=>this.unregister(t,e))}unregister(r,t){let e=r.findIndex(s=>s.callback===t);if(e>=0)return r.splice(e,1),!0}on(r,t,e){typeof e!="object"&&(e={prepend:e}),this.ctx.scope.assertActive(),t=this.ctx.reflect.bind(t);let s=this.bail(this.ctx,"internal/listener",r,t,e);if(s)return s;let i=this._hooks[r]||=[],o=typeof r=="string"?`event <${r}>`:"event (Symbol)";return this.register(o,i,t,e)}once(r,t,e){let s=this.on(r,function(...i){return s(),t.apply(this,i)},e);return s}async start(){this.isActive=!0;let r=this._hooks.ready||[];for(;r.length;){let{ctx:t,callback:e}=r.shift();t.scope.ensure(async()=>e())}await this.flush()}async stop(){this.isActive=!1,this.ctx.scope.reset()}},ut=ft,mt=(r=>(r[r.PENDING=0]="PENDING",r[r.LOADING=1]="LOADING",r[r.ACTIVE=2]="ACTIVE",r[r.FAILED=3]="FAILED",r[r.DISPOSED=4]="DISPOSED",r))(mt||{}),D=class K extends Error{constructor(t,e){super(e??K.Code[t]),this.code=t}static{a(this,"CordisError")}};(r=>{r.Code={INACTIVE_EFFECT:"cannot create effect on inactive context"}})(D||(D={}));var Q=class{constructor(r,t){this.parent=r,this.config=t,this.uid=r.registry?r.registry.counter:0,this.ctx=this.context=r.extend({scope:this}),this.proxy=new Proxy({},{get:a((e,s)=>Reflect.get(this.config,s),"get")})}static{a(this,"EffectScope")}uid;ctx;disposables=[];error;status=0;isActive=!1;context;proxy;acceptors=[];tasks=new Set;hasError=!1;get _config(){return this.runtime.isReactive?this.proxy:this.config}assertActive(){if(!(this.uid!==null||this.isActive))throw new D("INACTIVE_EFFECT")}effect(r,t){this.assertActive();let e=F(r)?new r(this.ctx,t):r(this.ctx,t),s=!1,i=typeof e=="function"?e:e.dispose.bind(e),o=a((...n)=>{if(!s)return s=!0,j(this.disposables,o),i(...n)},"wrapped");return this.disposables.push(o),typeof e=="function"?o:(e.dispose=o,e)}collect(r,t){let e=J(()=>(j(this.disposables,e),t()),"name",r);return this.disposables.push(e),e}restart(){this.reset(),this.error=null,this.hasError=!1,this.status=0,this.start()}_getStatus(){return this.uid===null?4:this.hasError?3:this.tasks.size?1:this.ready?2:0}updateStatus(r){let t=this.status;r?.(),this.status=this._getStatus(),t!==this.status&&this.context.emit("internal/status",this,t)}ensure(r){let t=r().catch(e=>{this.context.emit(this.ctx,"internal/error",e),this.cancel(e)}).finally(()=>{this.updateStatus(()=>this.tasks.delete(t)),this.context.events._tasks.delete(t)});this.updateStatus(()=>this.tasks.add(t)),this.context.events._tasks.add(t)}cancel(r){this.error=r,this.updateStatus(()=>this.hasError=!0),this.reset()}get ready(){return Object.entries(this.runtime.inject).every(([r,t])=>!t.required||!dt(this.ctx.get(r)))}reset(){this.isActive=!1,this.disposables=this.disposables.splice(0).filter(r=>{if(this.uid!==null&&r[h.static]===this)return!0;(async()=>r())().catch(t=>{this.context.emit(this.ctx,"internal/error",t)})})}init(r){this.config?this.start():this.cancel(r)}start(){if(!this.ready||this.isActive||this.uid===null)return!0;this.isActive=!0,this.updateStatus(()=>this.hasError=!1)}accept(...r){let e={keys:Array.isArray(r[0])?r.shift():null,callback:r[0],...r[1]};return this.effect(()=>(this.acceptors.push(e),e.immediate&&e.callback?.(this.config),()=>j(this.acceptors,e)))}decline(r){return this.accept(r,()=>!0)}checkUpdate(r,t){if(t||!this.config)return[!0,!0];if(t===!1)return[!1,!1];let e=Object.create(null),s=a(f=>{let u=e[f]??=!pt(this.config[f],r[f]);return o||=u,u},"checkPropertyUpdate"),i=new Set,o=!1,n=!1,l=this.runtime.isReactive||null;for(let{keys:f,callback:u,passive:p}of this.acceptors){if(!f)l||=!p;else if(p)f?.forEach(v=>i.add(v));else{let v=!1;for(let it of f)v||=s(it);if(!v)continue}u?.(r)&&(n=!0)}for(let f in{...this.config,...r})if(l!==!1&&!(f in e)&&!i.has(f)){let u=s(f);l===null&&(n||=u)}return[o,n]}},yt=class extends Q{constructor(r,t,e,s){super(r,e),this.runtime=t,this.dispose=J(r.scope.collect(`fork <${r.runtime.name}>`,()=>{this.uid=null,this.reset(),this.context.emit("internal/fork",this);let i=j(t.disposables,this.dispose);return j(t.children,this)&&!t.children.length&&r.registry.delete(t.plugin),i}),h.static,t),t.children.push(this),t.disposables.push(this.dispose),this.context.emit("internal/fork",this),this.init(s)}static{a(this,"ForkScope")}dispose;start(){if(super.start())return!0;for(let r of this.runtime.forkables)this.ensure(async()=>r(this.context,this._config))}update(r,t){let e=this.config,s=this.runtime.isForkable?this:this.runtime;if(s.config!==e)return;let i;try{i=_(this.runtime.plugin,r)}catch(l){return this.context.emit("internal/error",l),this.cancel(l)}let[o,n]=s.checkUpdate(i,t);this.context.emit("internal/before-update",this,r),this.config=i,s.config=i,o&&this.context.emit("internal/update",this,e),n&&s.restart()}},B=class extends Q{constructor(r,t,e,s){super(r,e),this.plugin=t,t?(this.setup(),this.init(s)):(this.name="root",this.isActive=!0)}static{a(this,"MainScope")}value;runtime=this;schema;name;inject=Object.create(null);forkables=[];children=[];isReusable=!1;isReactive=!1;get isForkable(){return this.forkables.length>0}fork(r,t,e){return new yt(r,this,t,e)}dispose(){return this.uid=null,this.reset(),this.context.emit("internal/runtime",this),!0}setup(){let{name:r}=this.plugin;r&&r!=="apply"&&(this.name=r),this.schema=this.plugin.Config||this.plugin.schema,this.inject=R.resolve(this.plugin.using||this.plugin.inject),this.isReusable=this.plugin.reusable,this.isReactive=this.plugin.reactive,this.context.emit("internal/runtime",this),this.isReusable&&this.forkables.push(this.apply)}apply=a((r,t)=>{if(typeof this.plugin!="function")return this.plugin.apply(r,t);if(F(this.plugin)){let e=new this.plugin(r,t),s=e[h.expose];return s&&r.set(s,e),e.fork&&this.forkables.push(e.fork.bind(e)),e}else return this.plugin(r,t)},"apply");reset(){super.reset();for(let r of this.children)r.reset()}start(){if(super.start())return!0;!this.isReusable&&this.plugin&&this.ensure(async()=>this.value=this.apply(this.ctx,this._config));for(let r of this.children)r.start()}update(r,t){if(this.isForkable){let l=new Error(`attempting to update forkable plugin "${this.plugin.name}", which may lead to unexpected behavior`);this.context.emit(this.ctx,"internal/warning",l)}let e=this.config,s;try{s=_(this.runtime.plugin||this.context.constructor,r)}catch(l){return this.context.emit("internal/error",l),this.cancel(l)}let[i,o]=this.checkUpdate(s,t),n=this.children.find(l=>l.config===e);this.config=s,n&&(this.context.emit("internal/before-update",n,r),n.config=s,i&&this.context.emit("internal/update",n,e)),o&&this.restart()}};function X(r){return r&&typeof r=="object"&&typeof r.apply=="function"}a(X,"isApplicable");function R(r){return function(t,e){if(e.kind==="class")t.inject=r;else if(e.kind==="method")e.addInitializer(function(){let s=this[c.tracker]?.property;if(!s)throw new Error("missing context tracker");this[s].inject(r,i=>{t.call(S(this,{[s]:i}))})});else throw new Error("@Inject can only be used on class or class methods")}}a(R,"Inject");(r=>{function t(e){if(!e)return{};if(Array.isArray(e))return Object.fromEntries(e.map(n=>[n,{required:!0}]));let{required:s,optional:i,...o}=e;return Array.isArray(s)&&Object.assign(o,Object.fromEntries(s.map(n=>[n,{required:!0}]))),Array.isArray(i)&&Object.assign(o,Object.fromEntries(i.map(n=>[n,{required:!1}]))),o}r.resolve=t,a(t,"resolve")})(R||(R={}));var bt=class{constructor(r,t){this.ctx=r,ht(this,c.tracker,{associate:"registry",property:"ctx"}),this.context=r;let e=new B(r,null,t);r.scope=e,e.ctx=r,this.set(null,e)}static{a(this,"Registry")}_counter=0;_internal=new Map;context;get counter(){return++this._counter}get size(){return this._internal.size}resolve(r,t=!1){if(r===null||typeof r=="function")return r;if(X(r))return r.apply;if(t)throw new Error('invalid plugin, expect function or object with an "apply" method, received '+typeof r)}get(r){let t=this.resolve(r);return t&&this._internal.get(t)}has(r){let t=this.resolve(r);return!!t&&this._internal.has(t)}set(r,t){let e=this.resolve(r);this._internal.set(e,t)}delete(r){let t=this.resolve(r),e=t&&this._internal.get(t);if(e)return this._internal.delete(t),e.dispose(),e}keys(){return this._internal.keys()}values(){return this._internal.values()}entries(){return this._internal.entries()}forEach(r){return this._internal.forEach(r)}using(r,t){return this.inject(r,t)}inject(r,t){return this.plugin({inject:r,apply:t,name:t.name})}plugin(r,t,e){if(this.resolve(r,!0),this.ctx.scope.assertActive(),!e)try{t=_(r,t)}catch(i){this.context.emit(this.ctx,"internal/error",i),e=i,t=null}let s=this.get(r);return s?(s.isForkable||this.context.emit(this.ctx,"internal/warning",new Error(`duplicate plugin detected: ${r.name}`)),s.fork(this.ctx,t,e)):(s=new B(this.ctx,r,t,e),this.set(r,s),s.fork(this.ctx,t,e))}},vt=bt,h=class k{static{a(this,"Context")}static store=c.store;static events=c.events;static static=c.static;static filter=c.filter;static expose=c.expose;static isolate=c.isolate;static internal=c.internal;static intercept=c.intercept;static origin="ctx";static current="ctx";static is(t){return!!t?.[k.is]}static{k.is[Symbol.toPrimitive]=()=>Symbol.for("cordis.is"),k.prototype[k.is]=!0}static associate(t,e){return t}constructor(t){t=_(this.constructor,t),this[c.store]=Object.create(null),this[c.isolate]=Object.create(null),this[c.internal]=Object.create(null),this[c.intercept]=Object.create(null);let e=new Proxy(this,T.handler);e.root=e,e.reflect=new T(e),e.registry=new vt(e,t),e.lifecycle=new ut(e);let s=a(i=>{if(i){s(Object.getPrototypeOf(i));for(let o of Object.getOwnPropertyNames(i)){let n=i[o].prototype?.constructor;n&&(e[i[o].key]=new n(e,t),ot(e[i[o].key],"ctx",e))}}},"attach");return s(this[c.internal]),e}[Symbol.for("nodejs.util.inspect.custom")](){return`Context <${this.name}>`}get name(){let t=this.runtime;for(;t&&!t.name;)t=t.parent.runtime;return t?.name}get events(){return this.lifecycle}get state(){return this.scope}extend(t={}){let e=Reflect.getOwnPropertyDescriptor(this,c.shadow)?.value,s=Object.assign(Object.create(m(this,this)),t);return e?Object.assign(Object.create(s),{[c.shadow]:e}):s}isolate(t,e){let s=Object.create(this[c.isolate]);return s[t]=e??Symbol(t),this.extend({[c.isolate]:s})}intercept(t,e){let s=Object.create(this[c.intercept]);return s[t]=e,this.extend({[c.intercept]:s})}};h.prototype[h.internal]=Object.create(null);var y=class Y{static{a(this,"Service")}static setup=c.setup;static invoke=c.invoke;static extend=c.extend;static tracker=c.tracker;static provide=c.provide;static immediate=c.immediate;start(){}stop(){}ctx;name;config;constructor(...t){let e,s,i,o;h.is(t[0])?(e=t[0],typeof t[1]=="string"?(s=t[1],i=t[2]):o=t[1]):o=t[0],s??=this.constructor[c.provide],i??=this.constructor[c.immediate];let n=this,l={associate:s,property:"ctx"};return n[c.invoke]&&(n=C(s,L(Object.getPrototypeOf(this),Function.prototype),l)),e?n.ctx=e:n[c.setup](),n.name=s,n.config=o,gt(n,c.tracker,l),n.ctx.provide(s),n.ctx.runtime.name=s,i&&(e?n[c.expose]=s:n.ctx.set(s,n)),n.ctx.on("ready",async()=>{await Promise.resolve(),await n.start(),i||n.ctx.set(s,n)}),n.ctx.on("dispose",()=>n.stop()),n}[c.filter](t){return t[c.isolate][this.name]===this.ctx[c.isolate][this.name]}[c.setup](){this.ctx=new h}[c.extend](t){let e;return this[Y.invoke]?e=C(this.name,this,this[c.tracker]):e=Object.create(this),Object.assign(e,t)}static[Symbol.hasInstance](t){let e=t.constructor;for(;e;){if(e=e.prototype?.constructor,e===this)return!0;e=Object.getPrototypeOf(e)}return!1}};import{defineProperty as jt}from"https://registry.koishi.chat/modules/cosmokit/index.js";import Z from"https://registry.koishi.chat/modules/reggol/index.js";var wt=Object.defineProperty,kt=(r,t)=>wt(r,"name",{value:t,configurable:!0}),tt=class et extends y{static{kt(this,"LoggerService")}constructor(t){super(t,"logger",!0),t.on("internal/info",function(e,...s){this.logger("app").info(e,...s)}),t.on("internal/error",function(e,...s){this.logger("app").error(e,...s)}),t.on("internal/warning",function(e,...s){this.logger("app").warn(e,...s)})}[y.invoke](t){return new Z(t,jt({},"ctx",this.ctx))}static{for(let t of["success","error","info","warn","debug","extend"])et.prototype[t]=function(...e){return this(this.ctx.name)[t](...e)}}};import{defineProperty as Ot,remove as Pt}from"https://registry.koishi.chat/modules/cosmokit/index.js";import Rt from"https://registry.koishi.chat/modules/schemastery/index.js";import{default as Et,default as It}from"https://registry.koishi.chat/modules/schemastery/index.js";var St=Object.defineProperty,_t=(r,t)=>St(r,"name",{value:t,configurable:!0}),rt=Symbol("cordis.schema.order"),st=class{constructor(r){this.ctx=r,Ot(this,y.tracker,{property:"ctx"})}static{_t(this,"SchemaService")}_data=Rt.intersect([]);extend(r,t=0){let e=this._data.list.findIndex(s=>s[rt]<t);return r[rt]=t,this.ctx.effect(()=>(e>=0?this._data.list.splice(e,0,r):this._data.list.push(r),this.ctx.emit("internal/service-schema"),()=>{Pt(this._data.list,r),this.ctx.emit("internal/service-schema")}))}toJSON(){return this._data.toJSON()}};import{remove as Ct}from"https://registry.koishi.chat/modules/cosmokit/index.js";var At=Object.defineProperty,I=(r,t)=>At(r,"name",{value:t,configurable:!0}),q=class extends y{static{I(this,"TimerService")}constructor(r){super(r,"timer",!0),r.mixin("timer",["setTimeout","setInterval","sleep","throttle","debounce"])}setTimeout(r,t){let e=this[h.current].effect(()=>{let s=setTimeout(()=>{e(),r()},t);return()=>clearTimeout(s)});return e}setInterval(r,t){return this[h.current].effect(()=>{let e=setInterval(r,t);return()=>clearInterval(e)})}sleep(r){let t=this[h.current];return new Promise((e,s)=>{let i=this.setTimeout(()=>{i(),o(),e()},r),o=t.on("dispose",()=>{i(),o(),s(new Error("Context has been disposed"))})})}createWrapper(r,t=!1){let e=this[h.current];e.scope.assertActive();let s,i=I(()=>{t=!0,Ct(e.scope.disposables,i),clearTimeout(s)},"dispose"),o=I((...n)=>{clearTimeout(s),s=r(n,()=>!t&&e.scope.isActive)},"wrapper");return o.dispose=i,e.scope.disposables.push(i),o}throttle(r,t,e){let s=-1/0,i=I((...o)=>{s=Date.now(),r(...o)},"execute");return this.createWrapper((o,n)=>{let l=Date.now(),f=t-(l-s);if(f<=0)i(...o);else if(n())return setTimeout(i,f,...o)},e)}debounce(r,t){return this.createWrapper((e,s)=>{if(s())return setTimeout(r,t,...e)})}};var Tt=Object.defineProperty,z=(r,t)=>Tt(r,"name",{value:t,configurable:!0}),$t=class extends h{static{z(this,"Context")}baseDir;constructor(r){super(r),this.baseDir=globalThis.process?.cwd?.()||"",this.provide("logger",void 0,!0),this.provide("timer",void 0,!0),this.plugin(tt),this.plugin(q)}},we=class extends y{static{z(this,"Service")}logger;schema;constructor(...r){super(...r),this.logger=this.ctx.logger(this.name),this.schema=new st(this.ctx)}[y.setup](){this.ctx=new $t}};function Dt(){}z(Dt,"default");export{$t as Context,D as CordisError,Q as EffectScope,yt as ForkScope,R as Inject,ut as Lifecycle,Z as Logger,B as MainScope,T as ReflectService,vt as Registry,Et as Schema,mt as ScopeStatus,we as Service,q as TimerService,C as createCallable,Dt as default,m as getTraceable,$ as isBailed,F as isConstructor,N as isObject,W as isUnproxyable,L as joinPrototype,_ as resolveConfig,c as symbols,S as withProps,It as z};
