var ke=Object.create;var H=Object.defineProperty;var Me=Object.getOwnPropertyDescriptor;var je=Object.getOwnPropertyNames;var Ae=Object.getPrototypeOf,Ue=Object.prototype.hasOwnProperty;var De=(e,t)=>()=>(e&&(t=e(e=0)),t);var Ge=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Fe=(e,t)=>{for(var s in t)H(e,s,{get:t[s],enumerable:!0})},qe=(e,t,s,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of je(t))!Ue.call(e,r)&&r!==s&&H(e,r,{get:()=>t[r],enumerable:!(n=Me(t,r))||n.enumerable});return e};var Be=(e,t,s)=>(s=e!=null?ke(Ae(e)):{},qe(t||!e||!e.__esModule?H(s,"default",{value:e,enumerable:!0}):s,e));import{Buffer as P}from"https://registry.koishi.chat/modules/buffer/index.js";import k from"https://registry.koishi.chat/modules/process/index.js";var x=De(()=>{});var de=Ge(w=>{"use strict";x();Object.defineProperty(w,"__esModule",{value:!0});w.PathError=w.TokenData=void 0;w.parse=Y;w.compile=ze;w.match=Ve;w.pathToRegexp=ce;w.stringify=Xe;var z="/",J=e=>e,oe=/^[$_\p{ID_Start}]$/u,V=/^[$\u200c\u200d\p{ID_Continue}]$/u,We={"{":"{","}":"}","(":"(",")":")","[":"[","]":"]","+":"+","?":"?","!":"!"};function He(e){return e.replace(/[{}()\[\]+?!:*\\]/g,"\\$&")}function E(e){return e.replace(/[.+*?^${}()[\]|/\\]/g,"\\$&")}var U=class{constructor(t,s){this.tokens=t,this.originalPath=s}};w.TokenData=U;var C=class extends TypeError{constructor(t,s){let n=t;s&&(n+=`: ${s}`),n+="; visit https://git.new/pathToRegexpError for info",super(n),this.originalPath=s}};w.PathError=C;function Y(e,t={}){let{encodePath:s=J}=t,n=[...e],r=[],i=0,o=0;function a(){let l="";if(oe.test(n[i]))do l+=n[i++];while(V.test(n[i]));else if(n[i]==='"'){let u=i;for(;i++<n.length;){if(n[i]==='"'){i++,u=0;break}n[i]==="\\"&&i++,l+=n[i]}if(u)throw new C(`Unterminated quote at index ${u}`,e)}if(!l)throw new C(`Missing parameter name at index ${i}`,e);return l}for(;i<n.length;){let l=n[i],u=We[l];u?r.push({type:u,index:i++,value:l}):l==="\\"?r.push({type:"escape",index:i++,value:n[i++]}):l===":"?r.push({type:"param",index:i++,value:a()}):l==="*"?r.push({type:"wildcard",index:i++,value:a()}):r.push({type:"char",index:i++,value:l})}r.push({type:"end",index:i,value:""});function c(l){let u=[];for(;;){let f=r[o++];if(f.type===l)break;if(f.type==="char"||f.type==="escape"){let h=f.value,p=r[o];for(;p.type==="char"||p.type==="escape";)h+=p.value,p=r[++o];u.push({type:"text",value:s(h)});continue}if(f.type==="param"||f.type==="wildcard"){u.push({type:f.type,name:f.value});continue}if(f.type==="{"){u.push({type:"group",tokens:c("}")});continue}throw new C(`Unexpected ${f.type} at index ${f.index}, expected ${l}`,e)}return u}return new U(c("end"),e)}function ze(e,t={}){let{encode:s=encodeURIComponent,delimiter:n=z}=t,r=typeof e=="object"?e:Y(e,t),i=ae(r.tokens,n,s);return function(a={}){let[c,...l]=i(a);if(l.length)throw new TypeError(`Missing parameters: ${l.join(", ")}`);return c}}function ae(e,t,s){let n=e.map(r=>Je(r,t,s));return r=>{let i=[""];for(let o of n){let[a,...c]=o(r);i[0]+=a,i.push(...c)}return i}}function Je(e,t,s){if(e.type==="text")return()=>[e.value];if(e.type==="group"){let r=ae(e.tokens,t,s);return i=>{let[o,...a]=r(i);return a.length?[""]:[o]}}let n=s||J;return e.type==="wildcard"&&s!==!1?r=>{let i=r[e.name];if(i==null)return["",e.name];if(!Array.isArray(i)||i.length===0)throw new TypeError(`Expected "${e.name}" to be a non-empty array`);return[i.map((o,a)=>{if(typeof o!="string")throw new TypeError(`Expected "${e.name}/${a}" to be a string`);return n(o)}).join(t)]}:r=>{let i=r[e.name];if(i==null)return["",e.name];if(typeof i!="string")throw new TypeError(`Expected "${e.name}" to be a string`);return[n(i)]}}function Ve(e,t={}){let{decode:s=decodeURIComponent,delimiter:n=z}=t,{regexp:r,keys:i}=ce(e,t),o=i.map(a=>s===!1?J:a.type==="param"?s:c=>c.split(n).map(s));return function(c){let l=r.exec(c);if(!l)return!1;let u=l[0],f=Object.create(null);for(let h=1;h<l.length;h++){if(l[h]===void 0)continue;let p=i[h-1],_=o[h-1];f[p.name]=_(l[h])}return{path:u,params:f}}}function ce(e,t={}){let{delimiter:s=z,end:n=!0,sensitive:r=!1,trailing:i=!0}=t,o=[],a=r?"":"i",c=[];for(let f of le(e,[])){let h=typeof f=="object"?f:Y(f,t);for(let p of A(h.tokens,0,[]))c.push(Ye(p,s,o,h.originalPath))}let l=`^(?:${c.join("|")})`;return i&&(l+=`(?:${E(s)}$)?`),l+=n?"$":`(?=${E(s)}|$)`,{regexp:new RegExp(l,a),keys:o}}function le(e,t){if(Array.isArray(e))for(let s of e)le(s,t);else t.push(e);return t}function*A(e,t,s){if(t===e.length)return yield s;let n=e[t];if(n.type==="group")for(let r of A(n.tokens,0,s.slice()))yield*A(e,t+1,r);else s.push(n);yield*A(e,t+1,s)}function Ye(e,t,s,n){let r="",i="",o=!0;for(let a of e){if(a.type==="text"){r+=E(a.value),i+=a.value,o||(o=a.value.includes(t));continue}if(a.type==="param"||a.type==="wildcard"){if(!o&&!i)throw new C(`Missing text before "${a.name}" ${a.type}`,n);a.type==="param"?r+=`(${Ke(t,o?"":i)}+)`:r+="([\\s\\S]+)",s.push(a),i="",o=!1;continue}}return r}function Ke(e,t){return t.length<2?e.length<2?`[^${E(e+t)}]`:`(?:(?!${E(e)})[^${E(t)}])`:e.length<2?`(?:(?!${E(t)})[^${E(e)}])`:`(?:(?!${E(t)}|${E(e)})[\\s\\S])`}function ue(e){let t="",s=0;function n(r){return Qe(r)&&Ze(e[s])?r:JSON.stringify(r)}for(;s<e.length;){let r=e[s++];if(r.type==="text"){t+=He(r.value);continue}if(r.type==="group"){t+=`{${ue(r.tokens)}}`;continue}if(r.type==="param"){t+=`:${n(r.name)}`;continue}if(r.type==="wildcard"){t+=`*${n(r.name)}`;continue}throw new TypeError(`Unknown token type: ${r.type}`)}return t}function Xe(e){return ue(e.tokens)}function Qe(e){let[t,...s]=e;return oe.test(t)&&s.every(n=>V.test(n))}function Ze(e){return e&&e.type==="text"?!V.test(e.value[0]):!0}});x();var Re=Be(de(),1);import{Context as pt,Logger as ft,Service as j,z as se}from"https://registry.koishi.chat/modules/cordis/index.js";import{defineProperty as Se}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{Service as mt}from"https://registry.koishi.chat/modules/cordis/index.js";import{remove as gt,valueMap as _e}from"https://registry.koishi.chat/modules/cosmokit/index.js";x();import{Context as Z,Schema as S,Service as D}from"https://registry.koishi.chat/modules/cordis/index.js";import{Binary as rt,defineProperty as pe,isNullable as it,trimSlash as ot}from"https://registry.koishi.chat/modules/cosmokit/index.js";x();var et=Object.defineProperty,he=(e,t)=>et(e,"name",{value:t,configurable:!0}),I=/^(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]\d|\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]\d|\d)){3}$/,g="[a-fA-F\\d]{1,4}",tt=[`(?:${g}:){7}(?:${g}|:)`,`(?:${g}:){6}(?:${I}|:${g}|:)`,`(?:${g}:){5}(?::${I}|(?::${g}){1,2}|:)`,`(?:${g}:){4}(?:(?::${g}){0,1}:${I}|(?::${g}){1,3}|:)`,`(?:${g}:){3}(?:(?::${g}){0,2}:${I}|(?::${g}){1,4}|:)`,`(?:${g}:){2}(?:(?::${g}){0,3}:${I}|(?::${g}){1,5}|:)`,`(?:${g}:){1}(?:(?::${g}){0,4}:${I}|(?::${g}){1,6}|:)`,`(?::(?:(?::${g}){0,5}:${I}|(?::${g}){1,7}|:))`],st=new RegExp(`^(?:${tt.join("|")})(?:%[0-9a-zA-Z]{1,})?$`);async function K(e){if(I.test(e))return{address:e,family:4};if(st.test(e))return{address:e,family:6};throw new Error("Invalid IP address")}he(K,"lookup");async function X(e){}he(X,"loadFile");var{WebSocket:Q}=globalThis;import lt from"https://registry.koishi.chat/modules/mime-db/index.js";var nt=Object.defineProperty,R=(e,t)=>nt(e,"name",{value:t,configurable:!0}),at=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.2.0/24","192.88.99.0/24","192.168.0.0/16","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","224.0.0.0/4","240.0.0.0/4"],ct=["::/8","0100::/64","2001:2::/48","2001:10::/28","2001:db8::/32","2002::/16","3ffe::/16","fc00::/7","fe80::/10","fec0::/10","ff00::/8"];function ee(e){return e.split(".").reduce((t,s)=>(t<<8n)+BigInt(s),0n)}R(ee,"parseIPv4");function me(e){let t=e.indexOf("::"),s=0n;if(t!==-1&&t!==0&&e.slice(0,t).split(":").forEach((a,c)=>{s|=BigInt(`0x${a}`)<<BigInt((7-c)*16)}),t===e.length-2)return s;let n=t===-1?e:e.slice(t+2),r=n.includes("."),i=n.split(":"),o=0;if(r){o+=2;let[a]=i.splice(-1,1);s|=ee(a)}return i.reverse().forEach((a,c)=>{s|=BigInt(`0x${a}`)<<BigInt((o+c)*8)}),s}R(me,"parseIPv6");async function ge({address:e,family:t}){if(t!==4&&t!==6)return!1;let{bogons:s,length:n,parse:r}=t===4?{bogons:at,length:32,parse:ee}:{bogons:ct,length:128,parse:me},i=r(e);for(let o of s){let[a,c]=o.split("/"),l=(1n<<BigInt(c))-1n<<BigInt(n-+c);if((i&l)===r(a))return!0}return!1}R(ge,"isLocalAddress");var fe=Symbol.for("cordis.http.error"),M=class extends Error{constructor(e,t){super(e),this.code=t}static{R(this,"HTTPError")}[fe]=!0;response;static is(e){return!!e?.[fe]}};function ye(e){return e instanceof URLSearchParams?[null,e]:e instanceof ArrayBuffer?[null,e]:ArrayBuffer.isView(e)?[null,e]:e instanceof Blob?[null,e]:e instanceof FormData?[null,e]:["application/json",JSON.stringify(e)]}R(ye,"encodeRequest");var ve=class $ extends D{static{R(this,"HTTP")}static Error=M;static isAxiosError=M.is;static provide="http";static[D.immediate]=!0;static{for(let t of["get","delete"])pe($.prototype,t,async function(s,n){return(await this(s,{method:t,...n})).data});for(let t of["patch","post","put"])pe($.prototype,t,async function(s,n,r){return(await this(s,{method:t,data:n,...r})).data})}static Config=S.object({timeout:S.natural().role("ms").description("等待请求的最长时间。"),keepAlive:S.boolean().description("是否保持连接。")});static Intercept=S.object({baseURL:S.string().description("基础 URL。"),timeout:S.natural().role("ms").description("等待请求的最长时间。"),keepAlive:S.boolean().description("是否保持连接。")});isError=M.is;_decoders=Object.create(null);constructor(...t){let s,n;Z.is(t[0])?(s=t[0],n=t[1]):s=new Z,super(s,"http"),this.config=n??{},this.decoder("json",r=>r.json()),this.decoder("text",r=>r.text()),this.decoder("blob",r=>r.blob()),this.decoder("arraybuffer",r=>r.arrayBuffer()),this.decoder("formdata",r=>r.formData()),this.decoder("stream",r=>r.body),this.ctx.on("http/file",(r,i)=>X(r)),this.schema?.extend($.Intercept)}static mergeConfig=R((t,s)=>({...t,...s,headers:{...t?.headers,...s?.headers}}),"mergeConfig");decoder(t,s){return this.ctx.effect(()=>(this._decoders[t]=s,()=>delete this._decoders[t]))}extend(t={}){return this[D.extend]({config:$.mergeConfig(this.config,t)})}resolveConfig(t){let s={headers:{},...this.config};this.ctx.emit({ctx:this.ctx},"http/config",s);let n=this.ctx[Z.intercept];for(;n;)s=$.mergeConfig(s,n.http),n=Object.getPrototypeOf(n);return s=$.mergeConfig(s,t),s}resolveURL(t,s,n=!1){if(s.endpoint)try{new URL(t)}catch{t=ot(s.endpoint)+t}try{t=new URL(t,s.baseURL)}catch{throw new TypeError(`Invalid URL: ${t}`)}n&&(t.protocol=t.protocol.replace(/^http/,"ws"));for(let[r,i]of Object.entries(s.params??{}))it(i)||t.searchParams.append(r,i);return t}defaultDecoder(t){let s=t.headers.get("Content-Type");return s?.startsWith("application/json")?t.json():s?.startsWith("text/")?t.text():t.arrayBuffer()}async[D.invoke](...t){let s;(typeof t[1]=="string"||t[1]instanceof URL)&&(s=t.shift());let n=this.resolveConfig(t[1]),r=this.resolveURL(t[0],n);s??=n.method??"GET";let i=new AbortController;if(n.signal){if(n.signal.aborted)throw n.signal.reason;n.signal.addEventListener("abort",()=>{i.abort(n.signal.reason)})}let o=this.ctx.effect(()=>{let a=n.timeout&&setTimeout(()=>{i.abort(new M("request timeout","ETIMEDOUT"))},n.timeout);return c=>{clearTimeout(a),!c&&i.abort(new M("context disposed","ETIMEDOUT"))}});i.signal.addEventListener("abort",()=>o());try{let a=new Headers(n.headers),c={method:s,headers:a,body:n.data,keepalive:n.keepAlive,redirect:n.redirect,signal:i.signal};if(n.data&&typeof n.data=="object"){let[h,p]=ye(n.data);c.body=p,h&&!a.has("Content-Type")&&a.append("Content-Type",h)}this.ctx.emit({ctx:this.ctx},"http/fetch-init",r,c,n);let l=await fetch(r,c).catch(h=>{if($.Error.is(h))throw h;let p=new $.Error(`fetch ${r} failed`);throw p.cause=h,p}),u={data:null,url:l.url,status:l.status,statusText:l.statusText,headers:l.headers};if(!(n.validateStatus??(h=>h<400))(l.status)){let h=new $.Error(l.statusText);h.response=u;try{u.data=await this.defaultDecoder(l)}catch{}throw h}if(n.responseType){let h;if(typeof n.responseType=="function")h=n.responseType;else if(h=this._decoders[n.responseType],!h)throw new TypeError(`Unknown responseType: ${n.responseType}`);u.data=await h(l)}else u.data=await this.defaultDecoder(l);return u}finally{o(!0)}}async head(t,s){return(await this(t,{method:"HEAD",...s})).headers}axios(...t){return this.ctx.emit(this.ctx,"internal/warning","ctx.http.axios() is deprecated, use ctx.http() instead"),typeof t[0]=="string"?this(t[0],t[1]):this(t[0].url,t[0])}ws(t,s){let n=this.resolveConfig(s);t=this.resolveURL(t,n,!0);let r;Q!==globalThis.WebSocket&&(r={handshakeTimeout:n?.timeout,headers:n?.headers},this.ctx.emit({ctx:this.ctx},"http/websocket-init",t,r,n));let i=new Q(t,r),o=this.ctx.on("dispose",()=>{i.close(1e3,"context disposed")});return i.addEventListener("close",()=>{o()}),i}async file(t,s={}){let n=await this.ctx.serial(this,"http/file",t,s);if(n)return n;let r=/^data:([\w/.+-]+);base64,(.*)$/.exec(t);if(r){let[,u,f]=r,h="file",p=u&&lt[u]?.extensions?.[0];return p&&(h+=`.${p}`),{type:u,mime:u,data:rt.fromBase64(f),filename:h}}let{headers:i,data:o,url:a}=await this(t,{method:"GET",responseType:"arraybuffer",timeout:+s.timeout||void 0}),c=i.get("content-type"),[,l]=a.match(/.+\/([^/?]*)(?=\?)?/);return{type:c,mime:c,filename:l,data:o}}async isLocal(t){let{hostname:s,protocol:n}=new URL(t);if(n!=="http:"&&n!=="https:")return!0;/^\[.+\]$/.test(s)&&(s=s.slice(1,-1));try{let r=await K(s);return ge(r)}catch{return!1}}};import Le from"https://registry.koishi.chat/modules/@satorijs/element/index.js";export*from"https://registry.koishi.chat/modules/cordis/index.js";export*from"https://registry.koishi.chat/modules/cosmokit/index.js";var $e={};Fe($e,{Channel:()=>N,Methods:()=>F,Opcode:()=>Ee,Resource:()=>L,Status:()=>b,WebSocket:()=>te,transformKey:()=>G});x();import be from"https://registry.koishi.chat/modules/@satorijs/element/index.js";import{isNullable as xe,pick as dt}from"https://registry.koishi.chat/modules/cosmokit/index.js";var ut=Object.defineProperty,O=(e,t)=>ut(e,"name",{value:t,configurable:!0});function we(e){return{name:e}}O(we,"Field");function d(e,t,s=!1){return{name:e,fields:t.map(we),isForm:s}}O(d,"Method");var F={"channel.get":d("getChannel",["channel_id","guild_id"]),"channel.list":d("getChannelList",["guild_id","next"]),"channel.create":d("createChannel",["guild_id","data"]),"channel.update":d("updateChannel",["channel_id","data"]),"channel.delete":d("deleteChannel",["channel_id"]),"channel.mute":d("muteChannel",["channel_id","guild_id","enable"]),"message.create":d("createMessage",["channel_id","content","referrer"]),"message.update":d("editMessage",["channel_id","message_id","content"]),"message.delete":d("deleteMessage",["channel_id","message_id"]),"message.get":d("getMessage",["channel_id","message_id"]),"message.list":d("getMessageList",["channel_id","next","direction","limit","order"]),"reaction.create":d("createReaction",["channel_id","message_id","emoji"]),"reaction.delete":d("deleteReaction",["channel_id","message_id","emoji","user_id"]),"reaction.clear":d("clearReaction",["channel_id","message_id","emoji"]),"reaction.list":d("getReactionList",["channel_id","message_id","emoji","next"]),"upload.create":d("createUpload",[],!0),"guild.get":d("getGuild",["guild_id"]),"guild.list":d("getGuildList",["next"]),"guild.member.get":d("getGuildMember",["guild_id","user_id"]),"guild.member.list":d("getGuildMemberList",["guild_id","next"]),"guild.member.kick":d("kickGuildMember",["guild_id","user_id","permanent"]),"guild.member.mute":d("muteGuildMember",["guild_id","user_id","duration","reason"]),"guild.member.role.set":d("setGuildMemberRole",["guild_id","user_id","role_id"]),"guild.member.role.unset":d("unsetGuildMemberRole",["guild_id","user_id","role_id"]),"guild.member.role.list":d("getGuildMemberRoleList",["guild_id","user_id","next"]),"guild.role.list":d("getGuildRoleList",["guild_id","next"]),"guild.role.create":d("createGuildRole",["guild_id","data"]),"guild.role.update":d("updateGuildRole",["guild_id","role_id","data"]),"guild.role.delete":d("deleteGuildRole",["guild_id","role_id"]),"login.get":d("getLogin",[]),"user.get":d("getUser",["user_id"]),"user.channel.create":d("createDirectChannel",["user_id","guild_id"]),"friend.list":d("getFriendList",["next"]),"friend.delete":d("deleteFriend",["user_id"]),"friend.approve":d("handleFriendRequest",["message_id","approve","comment"]),"guild.approve":d("handleGuildRequest",["message_id","approve","comment"]),"guild.member.approve":d("handleGuildMemberRequest",["message_id","approve","comment"])},N;(e=>{let t;(s=>{s[s.TEXT=0]="TEXT",s[s.DIRECT=1]="DIRECT",s[s.CATEGORY=2]="CATEGORY",s[s.VOICE=3]="VOICE"})(t=e.Type||(e.Type={}))})(N||(N={}));function L(e=[],t=[],s){return{attrs:e,children:t,content:s}}O(L,"Resource");(e=>{let t={user:e(["id","name","nick","avatar","isBot"]),member:e(["name","nick","avatar"]),channel:e(["id","type","name"]),guild:e(["id","name","avatar"]),quote:e(["id"],["quote","user","member","channel"],"content")};function s(r,i){let o=t[r],a=be(r,dt(i,o.attrs));for(let c of o.children)xe(i[c])||a.children.push(s(c,i[c]));return o.content&&!xe(i[o.content])&&a.children.push(...be.parse(i[o.content])),a}e.encode=s,O(s,"encode");function n(r){let i=r.attrs,o=t[r.type];for(let a of o.children){let c=r.children.findIndex(u=>u.type===a);if(c===-1)continue;let[l]=r.children.splice(c,1);i[a]=n(l)}return o.content&&r.children.length&&(i[o.content]=r.children.join("")),i}e.decode=n,O(n,"decode")})(L||(L={}));function G(e,t){return!e||typeof e!="object"?e:Array.isArray(e)?e.map(s=>G(s,t)):Object.fromEntries(Object.entries(e).map(([s,n])=>s.startsWith("_")||s==="referrer"?[s,n]:[t(s),G(n,t)]))}O(G,"transformKey");var b=(e=>(e[e.OFFLINE=0]="OFFLINE",e[e.ONLINE=1]="ONLINE",e[e.CONNECT=2]="CONNECT",e[e.DISCONNECT=3]="DISCONNECT",e[e.RECONNECT=4]="RECONNECT",e))(b||{}),Ee=(e=>(e[e.EVENT=0]="EVENT",e[e.PING=1]="PING",e[e.PONG=2]="PONG",e[e.IDENTIFY=3]="IDENTIFY",e[e.READY=4]="READY",e[e.META=5]="META",e))(Ee||{}),te;(e=>{e.CONNECTING=0,e.OPEN=1,e.CLOSING=2,e.CLOSED=3})(te||(te={}));import{clone as yt,isNonNullable as vt,pick as bt}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{Service as xt}from"https://registry.koishi.chat/modules/cordis/index.js";import{clone as wt,defineProperty as q,isNullable as Et}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{Context as Ie,Service as $t}from"https://registry.koishi.chat/modules/cordis/index.js";import ne from"https://registry.koishi.chat/modules/@satorijs/element/index.js";import{remove as Tt,Time as re}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{z as B}from"https://registry.koishi.chat/modules/cordis/index.js";import Ce from"https://registry.koishi.chat/modules/@satorijs/element/index.js";var ht=Object.defineProperty,m=(e,t)=>ht(e,"name",{value:t,configurable:!0}),Ne=class{constructor(e){this.ctx=e}static{m(this,"InternalRouter")}[mt.tracker]={property:"ctx"};routes=[];define(e,t){return this.ctx.effect(()=>{let s={...(0,Re.pathToRegexp)(e),callback:t};return this.routes.push(s),()=>gt(this.routes,s)})}handle(e,t,s,n,r,i){for(let o of this.routes){let a=o.regexp.exec(s);if(!a)continue;let c={};return o.keys.forEach(({name:l},u)=>{c[l]=a[u+1]}),o.callback({bot:e,method:t,params:c,query:n,body:i,headers:Object.fromEntries(r.entries())})}}},W;(e=>{function t(i,o,a){let c=a.get(o);return c instanceof File?c:!i||typeof i!="object"?i:Array.isArray(i)?i.map((l,u)=>t(l,`${o}.${u}`,a)):_e(i,(l,u)=>t(l,`${o}.${u}`,a))}e.load=t,m(t,"load");function s(i,o,a){return!i||typeof i!="object"?i:i instanceof Blob?(a.append(o,i),null):Array.isArray(i)?i.map((c,l)=>s(c,`${o}.${l}`,a)):_e(i,(c,l)=>s(c,`${o}.${l}`,a))}e.dump=s,m(s,"dump");async function n(i){let o=i.headers.get("content-type");if(o?.startsWith("multipart/form-data")){let c=await new globalThis.Response(i.body,{headers:i.headers}).formData(),l=c.get("$");return t(JSON.parse(l),"$",c)}else{if(o?.startsWith("application/json"))return JSON.parse(new TextDecoder().decode(i.body));throw new Error(`Unsupported content type: ${o}`)}}e.decode=n,m(n,"decode");async function r(i){let o=new FormData,a=JSON.stringify(e.dump(i,"$",o));if([...o.entries()].length){o.append("$",a);let c=new Request("stub:",{method:"POST",body:o});return{body:await c.arrayBuffer(),headers:c.headers}}else{let c=new TextEncoder().encode(a).buffer,l=new Headers({"content-type":"application/json"});return{body:c,headers:l}}}e.encode=r,m(r,"encode")})(W||(W={}));var v=class{static{m(this,"Session")}[$t.tracker]={associate:"session",property:"ctx"};id;sn;bot;app;event;locales=[];constructor(e,t){return t.selfId??=e.selfId,t.platform??=e.platform,t.timestamp??=Date.now(),this.event=t,this.sn=this.id=++e.ctx.satori._sessionSeq,q(this,"bot",e),q(this,"app",e.ctx.root),q(this,Ie.current,e.ctx),Ie.associate(this,"session")}get data(){return this.event}get isDirect(){return this.event.channel?.type===N.Type.DIRECT}set isDirect(e){(this.event.channel??={}).type=e?N.Type.DIRECT:N.Type.TEXT}get author(){return{...this.event.user,...this.event.member,userId:this.event.user?.id,username:this.event.user?.name,nickname:this.event.member?.name}}get uid(){return`${this.platform}:${this.userId}`}get gid(){return`${this.platform}:${this.guildId}`}get cid(){return`${this.platform}:${this.channelId}`}get fid(){return`${this.platform}:${this.channelId}:${this.userId}`}get sid(){return`${this.platform}:${this.selfId}`}get elements(){return this.event.message?.elements}set elements(e){this.event.message??={},this.event.message.elements=e}get content(){return this.event.message?.elements?.join("")}set content(e){if(this.event.message??={},this.event.message.quote=void 0,this.event.message.elements=Et(e)?e:ne.parse(e),this.event.message.elements?.[0]?.type==="quote"){let t=this.event.message.elements.shift();this.event.message.quote=L.decode(t)}}setInternal(e,t){this.event._type=e,this.event._data=t;let s=Object.create(this.bot.internal);q(this,e,Object.assign(s,t))}async transform(e){return await ne.transformAsync(e,async({type:t,attrs:s,children:n},r)=>{let i=t==="component"?s.is:this.app.get("component:"+t);return i?(n=await i(s,n,r),this.transform(ne.toElementArray(n))):!0},this)}toJSON(){let e={...wt(this.event),sn:this.sn,login:this.bot.toJSON(),id:this.sn};return e.message?.elements&&(e.message.content=this.content,delete e.message.elements,e.message.quote&&(e.message.content=L.encode("quote",e.message.quote)+e.message.content)),e}};function y(e,t,s){Object.defineProperty(e,t,{get(){return s.reduce((n,r)=>n?.[r],this)},set(n){if(n===void 0)return;let r=s.slice(),i=r.pop(),o=r.reduce((a,c)=>a[c]??={},this);o[i]=n}})}m(y,"defineAccessor");y(v.prototype,"type",["event","type"]);y(v.prototype,"subtype",["event","subtype"]);y(v.prototype,"subsubtype",["event","subsubtype"]);y(v.prototype,"selfId",["event","selfId"]);y(v.prototype,"platform",["event","platform"]);y(v.prototype,"timestamp",["event","timestamp"]);y(v.prototype,"userId",["event","user","id"]);y(v.prototype,"channelId",["event","channel","id"]);y(v.prototype,"channelName",["event","channel","name"]);y(v.prototype,"guildId",["event","guild","id"]);y(v.prototype,"guildName",["event","guild","name"]);y(v.prototype,"messageId",["event","message","id"]);y(v.prototype,"operatorId",["event","operator","id"]);y(v.prototype,"roleId",["event","role","id"]);y(v.prototype,"quote",["event","message","quote"]);y(v.prototype,"referrer",["event","referrer"]);var _t=[["message-created","message"],["guild-removed","guild-deleted"],["guild-member-removed","guild-member-deleted"]],ie=class{constructor(e,t,s){this.ctx=e,this.config=t,this.adapterName=s,this.sn=++e.satori._loginSeq,this.internal=null,this._internalRouter=new Ne(e),this.context=e,e.bots.push(this),this.context.emit("bot-added",this),this.logger=e.logger(s),this.platform=s,this.features=Object.entries(F).filter(([,n])=>this[n.name]).map(([n])=>n),e.on("ready",async()=>(await Promise.resolve(),this.dispatchLoginEvent("login-added"),this.start())),e.on("dispose",()=>this.dispose()),e.on("interaction/button",n=>{let r=this.callbacks[n.event.button.id];r&&r(n)})}static{m(this,"Bot")}static reusable=!0;static MessageEncoder;[xt.tracker]={associate:"bot",property:"ctx"};sn;user;platform;features;hidden=!1;adapter;error;callbacks={};logger;_internalRouter;context;_status=b.OFFLINE;getInternalUrl(e,t,s){let n=new URLSearchParams(t).toString();return n&&(n="?"+n),`internal${s?"/":":"}${this.platform}/${this.selfId}${e}${n}`}defineInternalRoute(e,t){return this._internalRouter.define(e,t)}update(e){let{sn:t,status:s,...n}=e;Object.assign(this,n),this.status=s}dispose(){let e=this.ctx.bots.findIndex(t=>t.sid===this.sid);return e>=0&&(this.ctx.bots.splice(e,1),this.context.emit("bot-removed",this),this.dispatchLoginEvent("login-removed")),this.stop()}dispatchLoginEvent(e){let t=this.session();t.type=e,t.event.login=this.toJSON(),this.dispatch(t)}get status(){return this._status}set status(e){e!==this._status&&(this._status=e,this.ctx.bots?.some(t=>t.sid===this.sid)&&(this.context.emit("bot-status-updated",this),this.dispatchLoginEvent("login-updated")))}get isActive(){return this._status!==b.OFFLINE&&this._status!==b.DISCONNECT}online(){this.status=b.ONLINE,this.error=void 0}offline(e){this.status=b.OFFLINE,this.error=e}async start(){if(!this.isActive){this.status=b.CONNECT;try{await this.context.parallel("bot-connect",this),await this.adapter?.connect(this)}catch(e){this.offline(e)}}}async stop(){if(this.isActive){this.status=b.DISCONNECT;try{await this.context.parallel("bot-disconnect",this),await this.adapter?.disconnect(this)}catch(e){this.context.emit(this.ctx,"internal/error",e)}finally{this.offline()}}}get sid(){return`${this.platform}:${this.selfId}`}session(e={}){return new v(this,e)}dispatch(e){if(!this.ctx.lifecycle.isActive)return;let t=[e.type];for(let s of _t)if(s.includes(e.type)){t=s,e.type=s[0];break}if(this.context.emit("internal/session",e),e.type==="internal"){this.context.emit(e.event._type,e.event._data,e.bot);return}for(let s of t)this.context.emit(e,s,e)}async createMessage(e,t,s,n){let{MessageEncoder:r}=this.constructor;return new r(this,e,s,n).send(t)}async sendMessage(e,t,s,n){return(await this.createMessage(e,t,s,n)).map(i=>i.id).filter(vt)}async sendPrivateMessage(e,t,s,n){let{id:r}=await this.createDirectChannel(e,s??n?.session?.guildId);return this.sendMessage(r,t,null,n)}async createUpload(...e){let t=[];for(let i of e){let o=Math.random().toString(36).slice(2),a=new Headers;a.set("content-type",i.type),i.filename&&a.set("content-disposition",`attachment; filename*=UTF-8''${encodeURIComponent(i.filename)}`),this.ctx.satori._tempStore[o]={status:200,body:i.data,headers:a},t.push(o)}let s=setTimeout(()=>n(),6e5),n=m(()=>{r(),clearTimeout(s);for(let i of t)delete this.ctx.satori._tempStore[i]},"dispose"),r=this.ctx.on("dispose",n);return t.map(i=>this.getInternalUrl(`/_tmp/${i}`))}async supports(e,t={}){return!!this[F[e]?.name]}async checkPermission(e,t){if(e.startsWith("bot."))return this.supports(e.slice(4),t)}toJSON(){return yt({...bt(this,["sn","user","platform","selfId","status","hidden","features"]),adapter:this.adapterName})}async getLogin(){return this.toJSON()}async getSelf(){let{user:e}=await this.getLogin();return e}},It=["getMessage","getReaction","getFriend","getGuild","getGuildMember","getGuildRole","getChannel"];for(let e of It)ie.prototype[e+"Iter"]=function(...t){let s;if(!this[e+"List"])throw new Error(`not implemented: ${e}List`);let n=m(async()=>{s=await this[e+"List"](...t,s?.next),e==="getMessage"&&s.data.reverse()},"getList");return{async next(){return s?.data.length?{done:!1,value:s.data.shift()}:s&&!s?.next?{done:!0,value:void 0}:(await n(),this.next())},[Symbol.asyncIterator](){return this}}};y(ie.prototype,"selfId",["user","id"]);y(ie.prototype,"userId",["user","id"]);var Te=class{constructor(e){this.ctx=e}static{m(this,"Adapter")}static schema=!1;bots=[];async connect(e){}async disconnect(e){}fork(e,t){t.adapter=this,this.bots.push(t),e.on("dispose",()=>{Tt(this.bots,t)})}};(e=>{e.WsClientConfig=B.object({retryTimes:B.natural().description("初次连接时的最大重试次数。").default(6),retryInterval:B.natural().role("ms").description("初次连接时的重试时间间隔。").default(5*re.second),retryLazy:B.natural().role("ms").description("连接关闭后的重试时间间隔。").default(re.minute)}).description("连接设置");class t extends e{constructor(r,i){super(r),this.config=i}static{m(this,"WsClientBase")}socket;connectionId=0;async start(){let r=0,i=++this.connectionId,o=this.ctx.logger("adapter"),{retryTimes:a,retryInterval:c,retryLazy:l}=this.config,u=m((h,p)=>{if(!this.getActive()||i!==this.connectionId)return;let _=c;if(r>=a){if(h)return this.setStatus(b.OFFLINE,new Error(p));_=l}r++,this.setStatus(b.RECONNECT),o.warn(`${p}, will retry in ${re.format(_)}...`),setTimeout(()=>{!this.getActive()||i!==this.connectionId||f()},_)},"reconnect"),f=m(async(h=!1)=>{o.debug("websocket client opening");let p;try{p=await this.prepare()}catch(T){u(h,T.toString()||"failed to prepare websocket");return}let _=p.url.replace(/\?.+/,"");p.addEventListener("error",T=>{T.message&&o.warn(T.message)}),p.addEventListener("close",({code:T,reason:Pe})=>{this.socket===p&&(this.socket=void 0),o.debug(`websocket closed with ${T}`),u(h,Pe.toString()||`failed to connect to ${_}, code: ${T}`)}),p.addEventListener("open",()=>{r=0,this.socket=p,o.info("connect to server: %c",_),this.accept(p)})},"connect");f(!0)}async stop(){this.socket?.close()}}e.WsClientBase=t;class s extends t{constructor(r,i){super(r,i.config),this.bot=i,i.adapter=this}static{m(this,"WsClient")}static reusable=!0;getActive(){return this.bot.isActive}setStatus(r,i){this.bot.status=r,this.bot.error=i}async connect(r){this.start()}async disconnect(r){this.stop()}}e.WsClient=s})(Te||(Te={}));var Ct=class extends Error{constructor(e,t=""){super(t),this.errors=e}static{m(this,"AggregateError")}},us=class{constructor(e,t,s,n={}){this.bot=e,this.channelId=t,this.referrer=s,this.options=n}static{m(this,"MessageEncoder")}errors=[];results=[];session;async prepare(){}async render(e,t){for(let s of e)await this.visit(s);t&&await this.flush()}async send(e){this.session=this.bot.session({type:"send",channel:{id:this.channelId,...this.options.session?.event.channel},guild:this.options.session?.event.guild});for(let n in this.options.session||{})n==="id"||n==="event"||(this.session[n]=this.options.session[n]);await this.prepare();let t=this.options.session??this.session;this.session.elements=await t.transform(Ce.normalize(e));let s=Ce.select(this.session.elements,"button").filter(n=>n.attrs.type!=="link"&&!n.attrs.id);for(let n of s){let r=Math.random().toString(36).slice(2);n.attrs.id||=r,typeof n.attrs.action=="function"&&(this.bot.callbacks[n.attrs.id]=n.attrs.action)}if(await this.session.app.serial(this.session,"before-send",this.session,this.options))return[];if(await this.render(this.session.elements),await this.flush(),this.errors.length)throw new Ct(this.errors);return this.results}};Le.warn=new ft("element").warn;ve.createConfig=m(function(t){return se.object({endpoint:se.string().role("link").description("要连接的服务器地址。").default(typeof t=="string"?t:void 0).required(typeof t=="boolean"?t:!1),headers:se.dict(String).role("table").description("要附加的额外请求头。"),...this.Config.dict}).description("请求设置")},"createConfig");var ds=class extends pt{static{m(this,"SatoriContext")}constructor(e){super(e),this.provide("satori",void 0,!0),this.plugin(Oe)}},St=class{constructor(e){this.ctx=e,Se(this,j.tracker,{property:"ctx"})}static{m(this,"DisposableSet")}sn=0;map1=new Map;map2=new Map;add(...e){let t=++this.sn;return this.ctx.effect(()=>{let s=!1;for(let n of e)this.map2.has(n)||(this.map2.set(n,new Set),s=!0),this.map2.get(n).add(t);return this.map1.set(t,e),s&&this.ctx.emit("satori/meta"),()=>{let n=!1;this.map1.delete(t);for(let r of e)this.map2.get(r).delete(t),this.map2.get(r).size===0&&(this.map2.delete(r),n=!0);n&&this.ctx.emit("satori/meta")}})}[Symbol.iterator](){return new Set([].concat(...this.map1.values()))[Symbol.iterator]()}},Oe=class extends j{static{m(this,"Satori")}static[j.provide]="satori";static[j.immediate]=!0;uid=Math.random().toString(36).slice(2);proxyUrls=new St(this.ctx);_internalRouter;_tempStore=Object.create(null);_loginSeq=0;_sessionSeq=0;constructor(e){super(e),e.mixin("satori",["bots","component"]),Se(this.bots,j.tracker,{});let t=this;e.on("http/file",async function(s,n){let r=new URL(s);if(r.protocol!=="internal:")return;let{status:i,body:o,headers:a}=await t.handleInternalRoute("GET",r);if(i>=400)throw new Error(`Failed to fetch ${s}, status code: ${i}`);if(i>=300){let u=a?.get("location");return this.file(u,n)}let c=a?.get("content-type"),l=a?.get("content-disposition")?.split("filename=")[1];return{data:o,filename:l,type:c,mime:c}}),this._internalRouter=new Ne(e),this.defineInternalRoute("/_tmp/:id",async({params:s,method:n})=>n!=="GET"?{status:405}:this._tempStore[s.id]??{status:404}),this.defineInternalRoute("/_api/:name",async({bot:s,headers:n,params:r,method:i,body:o})=>{if(i!=="POST")return{status:405};let a=await W.decode({body:o,headers:new Headers(n)});if(!a)return{status:400};try{let c=s.internal;for(let u of r.name.split("."))c=c[u];let l=c(...a);if(n["satori-pagination"]){if(!l?.[Symbol.for("satori.pagination")])return{status:400,statusText:"This API does not support pagination"};l=await l[Symbol.for("satori.pagination")]()}else l=await l;return{...await W.encode(l),status:200}}catch(c){if(!e.http.isError(c)||!c.response)throw c;return c.response}})}bots=new Proxy([],{get(e,t){return t in e||typeof t=="symbol"?Reflect.get(e,t):e.find(s=>s.sid===t)},deleteProperty(e,t){if(t in e||typeof t=="symbol")return Reflect.deleteProperty(e,t);let s=e.findIndex(n=>n.sid===t);return s<0||e.splice(s,1),!0}});component(e,t,s={}){let n=m(async(r,i,o)=>{if(s.session&&o.type==="send")throw new Error("interactive components is not available outside sessions");let a=await t(r,i,o);return o.transform(Le.normalize(a))},"render");return this.ctx.set("component:"+e,n)}defineInternalRoute(e,t){return this._internalRouter.define(e,t)}async handleInternalRoute(e,t,s=new Headers,n){let r=/^([^/]+)\/([^/]+)(\/.+)$/.exec(t.pathname);if(!r)return{status:400};let[,i,o,a]=r,c=this.bots[`${i}:${o}`];if(!c)return{status:404};let l=await this._internalRouter.handle(c,e,a,t.searchParams,s,n);return l??=await c._internalRouter.handle(c,e,a,t.searchParams,s,n),l||{status:404}}toJSON(e=!1){return{logins:e?void 0:this.bots.map(t=>t.toJSON()),proxyUrls:[...this.proxyUrls]}}},hs=Oe;export{Te as Adapter,ie as Bot,ds as Context,Le as Element,ve as HTTP,Ne as InternalRouter,W as JsonForm,us as MessageEncoder,us as Messenger,us as Modulator,ve as Quester,Oe as Satori,v as Session,$e as Universal,hs as default,y as defineAccessor,Le as h,Le as segment};
