var de=Object.defineProperty;var le=(e,t)=>{for(var s in t)de(e,s,{get:t[s],enumerable:!0})};import{Buffer as N}from"https://registry.koishi.chat/modules/buffer/index.js";import R from"https://registry.koishi.chat/modules/process/index.js";import{Context as Ie,Logger as Ce,Service as O,z as F}from"https://registry.koishi.chat/modules/cordis/index.js";import{defineProperty as Te,makeArray as $e,remove as ee}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{Context as me,Schema as w,Service as $}from"https://registry.koishi.chat/modules/cordis/index.js";import{Binary as ge,defineProperty as q,isNullable as ye,trimSlash as ve}from"https://registry.koishi.chat/modules/cosmokit/index.js";var he=Object.defineProperty,W=(e,t)=>he(e,"name",{value:t,configurable:!0}),x=/^(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]\d|\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]\d|\d)){3}$/,h="[a-fA-F\\d]{1,4}",ue=[`(?:${h}:){7}(?:${h}|:)`,`(?:${h}:){6}(?:${x}|:${h}|:)`,`(?:${h}:){5}(?::${x}|(?::${h}){1,2}|:)`,`(?:${h}:){4}(?:(?::${h}){0,1}:${x}|(?::${h}){1,3}|:)`,`(?:${h}:){3}(?:(?::${h}){0,2}:${x}|(?::${h}){1,4}|:)`,`(?:${h}:){2}(?:(?::${h}){0,3}:${x}|(?::${h}){1,5}|:)`,`(?:${h}:){1}(?:(?::${h}){0,4}:${x}|(?::${h}){1,6}|:)`,`(?::(?:(?::${h}){0,5}:${x}|(?::${h}){1,7}|:))`],pe=new RegExp(`^(?:${ue.join("|")})(?:%[0-9a-zA-Z]{1,})?$`);async function M(e){if(x.test(e))return{address:e,family:4};if(pe.test(e))return{address:e,family:6};throw new Error("Invalid IP address")}W(M,"lookup");async function j(e){}W(j,"loadFile");var{WebSocket:A}=globalThis;import Ee from"https://registry.koishi.chat/modules/mime-db/index.js";var fe=Object.defineProperty,_=(e,t)=>fe(e,"name",{value:t,configurable:!0}),be=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.2.0/24","192.88.99.0/24","192.168.0.0/16","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","224.0.0.0/4","240.0.0.0/4"],xe=["::/8","0100::/64","2001:2::/48","2001:10::/28","2001:db8::/32","2002::/16","3ffe::/16","fc00::/7","fe80::/10","fec0::/10","ff00::/8"];function G(e){return e.split(".").reduce((t,s)=>(t<<8n)+BigInt(s),0n)}_(G,"parseIPv4");function z(e){let t=e.indexOf("::"),s=0n;if(t!==-1&&t!==0&&e.slice(0,t).split(":").forEach((c,l)=>{s|=BigInt(`0x${c}`)<<BigInt((7-l)*16)}),t===e.length-2)return s;let i=t===-1?e:e.slice(t+2),r=i.includes("."),n=i.split(":"),a=0;if(r){a+=2;let[c]=n.splice(-1,1);s|=G(c)}return n.reverse().forEach((c,l)=>{s|=BigInt(`0x${c}`)<<BigInt((a+l)*8)}),s}_(z,"parseIPv6");async function V({address:e,family:t}){if(t!==4&&t!==6)return!1;let{bogons:s,length:i,parse:r}=t===4?{bogons:be,length:32,parse:G}:{bogons:xe,length:128,parse:z},n=r(e);for(let a of s){let[c,l]=a.split("/"),p=(1n<<BigInt(l))-1n<<BigInt(i-+l);if((n&p)===r(c))return!0}return!1}_(V,"isLocalAddress");var H=Symbol.for("cordis.http.error"),L=class extends Error{constructor(e,t){super(e),this.code=t}static{_(this,"HTTPError")}[H]=!0;response;static is(e){return!!e?.[H]}};function Y(e){return e instanceof URLSearchParams?[null,e]:e instanceof ArrayBuffer?[null,e]:ArrayBuffer.isView(e)?[null,e]:e instanceof Blob?[null,e]:e instanceof FormData?[null,e]:["application/json",JSON.stringify(e)]}_(Y,"encodeRequest");var J=class b extends ${static{_(this,"HTTP")}static Error=L;static isAxiosError=L.is;static[$.provide]="http";static[$.immediate]=!0;static{for(let t of["get","delete"])q(b.prototype,t,async function(s,i){return(await this(s,{method:t,...i})).data});for(let t of["patch","post","put"])q(b.prototype,t,async function(s,i,r){return(await this(s,{method:t,data:i,...r})).data})}static Config=w.object({timeout:w.natural().role("ms").description("等待请求的最长时间。"),keepAlive:w.boolean().description("是否保持连接。")});static Intercept=w.object({baseURL:w.string().description("基础 URL。"),timeout:w.natural().role("ms").description("等待请求的最长时间。"),keepAlive:w.boolean().description("是否保持连接。")});isError=L.is;_decoders=Object.create(null);constructor(...t){super(t[0],t[1]),this.decoder("json",s=>s.json()),this.decoder("text",s=>s.text()),this.decoder("blob",s=>s.blob()),this.decoder("arraybuffer",s=>s.arrayBuffer()),this.decoder("formdata",s=>s.formData()),this.decoder("stream",s=>s.body),this.ctx.on("http/file",(s,i)=>j(s)),this.schema?.extend(b.Intercept)}static mergeConfig=_((t,s)=>({...t,...s,headers:{...t?.headers,...s?.headers}}),"mergeConfig");decoder(t,s){return this.ctx.effect(()=>(this._decoders[t]=s,()=>delete this._decoders[t]))}extend(t={}){return this[$.extend]({config:b.mergeConfig(this.config,t)})}resolveConfig(t){let s={headers:{},...this.config};this.ctx.emit(this,"http/config",s);let i=this.ctx[me.intercept];for(;i;)s=b.mergeConfig(s,i.http),i=Object.getPrototypeOf(i);return s=b.mergeConfig(s,t),s}resolveURL(t,s,i=!1){if(s.endpoint)try{new URL(t)}catch{t=ve(s.endpoint)+t}try{t=new URL(t,s.baseURL)}catch{throw new TypeError(`Invalid URL: ${t}`)}i&&(t.protocol=t.protocol.replace(/^http/,"ws"));for(let[r,n]of Object.entries(s.params??{}))ye(n)||t.searchParams.append(r,n);return t}defaultDecoder(t){let s=t.headers.get("Content-Type");return s?.startsWith("application/json")?t.json():s?.startsWith("text/")?t.text():t.arrayBuffer()}async[$.invoke](...t){let s;(typeof t[1]=="string"||t[1]instanceof URL)&&(s=t.shift());let i=this.resolveConfig(t[1]),r=this.resolveURL(t[0],i);s??=i.method??"GET";let n=new AbortController;if(i.signal){if(i.signal.aborted)throw i.signal.reason;i.signal.addEventListener("abort",()=>{n.abort(i.signal.reason)})}let a=this.ctx.effect(()=>{let c=i.timeout&&setTimeout(()=>{n.abort(new L("request timeout","ETIMEDOUT"))},i.timeout);return l=>{clearTimeout(c),!l&&n.abort(new L("context disposed","ETIMEDOUT"))}});n.signal.addEventListener("abort",()=>a());try{let c=new Headers(i.headers),l={method:s,headers:c,body:i.data,keepalive:i.keepAlive,redirect:i.redirect,signal:n.signal};if(i.data&&typeof i.data=="object"){let[d,u]=Y(i.data);l.body=u,d&&!c.has("Content-Type")&&c.append("Content-Type",d)}this.ctx.emit(this,"http/fetch-init",r,l,i);let p=await fetch(r,l).catch(d=>{if(this.ctx.emit(this,"http/after-fetch",{url:r,init:l,config:i,error:d}),b.Error.is(d))throw d;let u=new b.Error(`fetch ${r} failed`);throw u.cause=d,u});this.ctx.emit(this,"http/after-fetch",{url:r,init:l,config:i,result:p});let y={data:null,url:p.url,status:p.status,statusText:p.statusText,headers:p.headers};if(!(i.validateStatus??(d=>d<400))(p.status)){let d=new b.Error(p.statusText);d.response=y;try{y.data=await this.defaultDecoder(p)}catch{}throw d}if(i.responseType){let d;if(typeof i.responseType=="function")d=i.responseType;else if(d=this._decoders[i.responseType],!d)throw new TypeError(`Unknown responseType: ${i.responseType}`);y.data=await d(p)}else y.data=await this.defaultDecoder(p);return y}finally{a(!0)}}async head(t,s){return(await this(t,{method:"HEAD",...s})).headers}axios(...t){return this.ctx.emit(this.ctx,"internal/warning","ctx.http.axios() is deprecated, use ctx.http() instead"),typeof t[0]=="string"?this(t[0],t[1]):this(t[0].url,t[0])}ws(t,s){let i=this.resolveConfig(s);t=this.resolveURL(t,i,!0);let r;A!==globalThis.WebSocket&&(r={handshakeTimeout:i?.timeout,headers:i?.headers},this.ctx.emit(this,"http/websocket-init",t,r,i));let n=new A(t,r),a=this.ctx.on("dispose",()=>{n.close(1e3,"context disposed")});return n.addEventListener("close",()=>{a()}),n}async file(t,s={}){let i=await this.ctx.serial(this,"http/file",t,s);if(i)return i;let r=/^data:([\w/.+-]+);base64,(.*)$/.exec(t);if(r){let[,y,T]=r,d="file",u=y&&Ee[y]?.extensions?.[0];return u&&(d+=`.${u}`),{type:y,mime:y,data:ge.fromBase64(T),filename:d}}let{headers:n,data:a,url:c}=await this(t,{method:"GET",responseType:"arraybuffer",timeout:+s.timeout||void 0}),l=n.get("content-type"),[,p]=c.match(/.+\/([^/?]*)(?=\?)?/);return{type:l,mime:l,filename:p,data:a}}async isLocal(t){let{hostname:s,protocol:i}=new URL(t);if(i!=="http:"&&i!=="https:")return!0;/^\[.+\]$/.test(s)&&(s=s.slice(1,-1));try{let r=await M(s);return V(r)}catch{return!1}}};import ne from"https://registry.koishi.chat/modules/@satorijs/element/index.js";export*from"https://registry.koishi.chat/modules/cordis/index.js";export*from"https://registry.koishi.chat/modules/cosmokit/index.js";var K={};le(K,{Channel:()=>I,Methods:()=>k,Opcode:()=>Z,Status:()=>v,WebSocket:()=>D});var we=Object.defineProperty,X=(e,t)=>we(e,"name",{value:t,configurable:!0});function Q(e){return{name:e}}X(Q,"Field");function o(e,t,s=!1){return{name:e,fields:t.map(Q),isForm:s}}X(o,"Method");var k={"channel.get":o("getChannel",["channel_id","guild_id"]),"channel.list":o("getChannelList",["guild_id","next"]),"channel.create":o("createChannel",["guild_id","data"]),"channel.update":o("updateChannel",["channel_id","data"]),"channel.delete":o("deleteChannel",["channel_id"]),"channel.mute":o("muteChannel",["channel_id","guild_id","enable"]),"message.create":o("createMessage",["channel_id","content"]),"message.update":o("editMessage",["channel_id","message_id","content"]),"message.delete":o("deleteMessage",["channel_id","message_id"]),"message.get":o("getMessage",["channel_id","message_id"]),"message.list":o("getMessageList",["channel_id","next","direction","limit","order"]),"reaction.create":o("createReaction",["channel_id","message_id","emoji"]),"reaction.delete":o("deleteReaction",["channel_id","message_id","emoji","user_id"]),"reaction.clear":o("clearReaction",["channel_id","message_id","emoji"]),"reaction.list":o("getReactionList",["channel_id","message_id","emoji","next"]),"upload.create":o("createUpload",[],!0),"guild.get":o("getGuild",["guild_id"]),"guild.list":o("getGuildList",["next"]),"guild.member.get":o("getGuildMember",["guild_id","user_id"]),"guild.member.list":o("getGuildMemberList",["guild_id","next"]),"guild.member.kick":o("kickGuildMember",["guild_id","user_id","permanent"]),"guild.member.mute":o("muteGuildMember",["guild_id","user_id","duration","reason"]),"guild.member.role.set":o("setGuildMemberRole",["guild_id","user_id","role_id"]),"guild.member.role.unset":o("unsetGuildMemberRole",["guild_id","user_id","role_id"]),"guild.role.list":o("getGuildRoleList",["guild_id","next"]),"guild.role.create":o("createGuildRole",["guild_id","data"]),"guild.role.update":o("updateGuildRole",["guild_id","role_id","data"]),"guild.role.delete":o("deleteGuildRole",["guild_id","role_id"]),"login.get":o("getLogin",[]),"user.get":o("getUser",["user_id"]),"user.channel.create":o("createDirectChannel",["user_id","guild_id"]),"friend.list":o("getFriendList",["next"]),"friend.delete":o("deleteFriend",["user_id"]),"friend.approve":o("handleFriendRequest",["message_id","approve","comment"]),"guild.approve":o("handleGuildRequest",["message_id","approve","comment"]),"guild.member.approve":o("handleGuildMemberRequest",["message_id","approve","comment"])},I;(e=>{let t;(s=>{s[s.TEXT=0]="TEXT",s[s.DIRECT=1]="DIRECT",s[s.CATEGORY=2]="CATEGORY",s[s.VOICE=3]="VOICE"})(t=e.Type||(e.Type={}))})(I||(I={}));var v=(e=>(e[e.OFFLINE=0]="OFFLINE",e[e.ONLINE=1]="ONLINE",e[e.CONNECT=2]="CONNECT",e[e.DISCONNECT=3]="DISCONNECT",e[e.RECONNECT=4]="RECONNECT",e))(v||{}),Z=(e=>(e[e.EVENT=0]="EVENT",e[e.PING=1]="PING",e[e.PONG=2]="PONG",e[e.IDENTIFY=3]="IDENTIFY",e[e.READY=4]="READY",e))(Z||{}),D;(e=>{e.CONNECTING=0,e.OPEN=1,e.CLOSING=2,e.CLOSED=3})(D||(D={}));import{clone as Le,pick as Ne}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{Service as Re}from"https://registry.koishi.chat/modules/cordis/index.js";import{defineProperty as S,isNullable as ke}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{Context as te,Service as Oe}from"https://registry.koishi.chat/modules/cordis/index.js";import se from"https://registry.koishi.chat/modules/@satorijs/element/index.js";import{remove as Me,Time as U}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{z as P}from"https://registry.koishi.chat/modules/cordis/index.js";import re from"https://registry.koishi.chat/modules/@satorijs/element/index.js";var _e=Object.defineProperty,m=(e,t)=>_e(e,"name",{value:t,configurable:!0}),g=class oe{static{m(this,"Session")}static counter=0;[Oe.tracker]={associate:"session",property:"ctx"};id;bot;app;event;locales=[];constructor(t,s){return s.selfId??=t.selfId,s.platform??=t.platform,s.timestamp??=Date.now(),this.event=s,this.id=++oe.counter,S(this,"bot",t),S(this,"app",t.ctx.root),S(this,te.current,t.ctx),te.associate(this,"session")}get data(){return this.event}get isDirect(){return this.event.channel.type===I.Type.DIRECT}set isDirect(t){(this.event.channel??={}).type=t?I.Type.DIRECT:I.Type.TEXT}get author(){return{...this.event.user,...this.event.member,userId:this.event.user?.id,username:this.event.user?.name,nickname:this.event.member?.name}}get uid(){return`${this.platform}:${this.userId}`}get gid(){return`${this.platform}:${this.guildId}`}get cid(){return`${this.platform}:${this.channelId}`}get fid(){return`${this.platform}:${this.channelId}:${this.userId}`}get sid(){return`${this.platform}:${this.selfId}`}get elements(){return this.event.message?.elements}set elements(t){this.event.message??={},this.event.message.elements=t}get content(){return this.event.message?.elements?.join("")}set content(t){if(this.event.message??={},this.event.message.quote=void 0,this.event.message.elements=ke(t)?t:se.parse(t),this.event.message.elements?.[0]?.type==="quote"){let s=this.event.message.elements.shift();this.event.message.quote={...s.attrs,content:s.children.join("")}}}setInternal(t,s){this.event._type=t,this.event._data=s;let i=Object.create(this.bot.internal);S(this,t,Object.assign(i,s))}async transform(t){return await se.transformAsync(t,({type:s,attrs:i,children:r},n)=>(s==="component"?i.is:this.app.get("component:"+s))?.(i,r,n)??!0,this)}toJSON(){return{login:{platform:this.platform,user:{id:this.selfId}},...this.event,id:this.id}}};function f(e,t,s){Object.defineProperty(e,t,{get(){return s.reduce((i,r)=>i?.[r],this)},set(i){if(i===void 0)return;let r=s.slice(),n=r.pop(),a=r.reduce((c,l)=>c[l]??={},this);a[n]=i}})}m(f,"defineAccessor");f(g.prototype,"type",["event","type"]);f(g.prototype,"subtype",["event","subtype"]);f(g.prototype,"subsubtype",["event","subsubtype"]);f(g.prototype,"selfId",["event","selfId"]);f(g.prototype,"platform",["event","platform"]);f(g.prototype,"timestamp",["event","timestamp"]);f(g.prototype,"userId",["event","user","id"]);f(g.prototype,"channelId",["event","channel","id"]);f(g.prototype,"channelName",["event","channel","name"]);f(g.prototype,"guildId",["event","guild","id"]);f(g.prototype,"guildName",["event","guild","name"]);f(g.prototype,"messageId",["event","message","id"]);f(g.prototype,"operatorId",["event","operator","id"]);f(g.prototype,"roleId",["event","role","id"]);f(g.prototype,"quote",["event","message","quote"]);var Se=[["message-created","message"],["guild-removed","guild-deleted"],["guild-member-removed","guild-member-deleted"]],B=class{constructor(e,t,s){this.ctx=e,this.config=t,this.internal=null,this.context=e,e.bots.push(this),this.context.emit("bot-added",this),s&&(this.logger=e.logger(s),this.platform=s),this.proxyUrls=[`upload://temp/${e.satori.uid}/`],this.features=Object.entries(k).filter(([,i])=>this[i.name]).map(([i])=>i),e.on("ready",async()=>(await Promise.resolve(),this.dispatchLoginEvent("login-added"),this.start())),e.on("dispose",()=>this.dispose()),e.on("interaction/button",i=>{let r=this.callbacks[i.event.button.id];r&&r(i)})}static{m(this,"Bot")}static reusable=!0;static MessageEncoder;[Re.tracker]={associate:"bot",property:"ctx"};user={};isBot=!0;hidden=!1;platform;features;proxyUrls;adapter;error;callbacks={};logger;context;_status=v.OFFLINE;registerUpload(e,t){this.ctx.satori.upload(e,t,this.proxyUrls)}update(e){let{status:t,...s}=e;Object.assign(this,s),this.status=t}dispose(){let e=this.ctx.bots.findIndex(t=>t.sid===this.sid);return e>=0&&(this.ctx.bots.splice(e,1),this.context.emit("bot-removed",this),this.dispatchLoginEvent("login-removed")),this.stop()}dispatchLoginEvent(e){let t=this.session();t.type=e,t.event.login=this.toJSON(),this.dispatch(t)}get status(){return this._status}set status(e){e!==this._status&&(this._status=e,this.ctx.bots?.some(t=>t.sid===this.sid)&&(this.context.emit("bot-status-updated",this),this.dispatchLoginEvent("login-updated")))}get isActive(){return this._status!==v.OFFLINE&&this._status!==v.DISCONNECT}online(){this.status=v.ONLINE,this.error=null}offline(e){this.status=v.OFFLINE,this.error=e}async start(){if(!this.isActive){this.status=v.CONNECT;try{await this.context.parallel("bot-connect",this),await this.adapter?.connect(this)}catch(e){this.offline(e)}}}async stop(){if(this.isActive){this.status=v.DISCONNECT;try{await this.context.parallel("bot-disconnect",this),await this.adapter?.disconnect(this)}catch(e){this.context.emit(this.ctx,"internal/error",e)}finally{this.offline()}}}get sid(){return`${this.platform}:${this.selfId}`}session(e={}){return new g(this,e)}dispatch(e){if(!this.ctx.lifecycle.isActive)return;let t=[e.type];for(let s of Se)if(s.includes(e.type)){t=s,e.type=s[0];break}if(this.context.emit("internal/session",e),e.type==="internal"){this.context.emit(e.event._type,e.event._data,e.bot);return}for(let s of t)this.context.emit(e,s,e)}async createMessage(e,t,s,i){let{MessageEncoder:r}=this.constructor;return new r(this,e,s,i).send(t)}async sendMessage(e,t,s,i){return(await this.createMessage(e,t,s,i)).map(n=>n.id)}async sendPrivateMessage(e,t,s,i){let{id:r}=await this.createDirectChannel(e,s??i?.session?.guildId);return this.sendMessage(r,t,null,i)}async createUpload(...e){let t=[];for(let n of e){let a=Math.random().toString(36).slice(2),c=new Headers;c.set("content-type",n.type),n.filename&&c.set("content-disposition",`attachment; filename="${n.filename}"`),this.ctx.satori._tempStore[a]={status:200,data:n.data,headers:c},t.push(a)}let s=setTimeout(()=>i(),6e5),i=m(()=>{r(),clearTimeout(s);for(let n of t)delete this.ctx.satori._tempStore[n]},"dispose"),r=this.ctx.on("dispose",i);return t.map(n=>`upload://temp/${this.ctx.satori.uid}/${n}`)}async supports(e,t={}){return!!this[k[e]?.name]}async checkPermission(e,t){if(e.startsWith("bot."))return this.supports(e.slice(4),t)}toJSON(){return Le({...Ne(this,["platform","selfId","status","hidden","features","proxyUrls"]),user:this.user.id?this.user:void 0,adapter:this.platform})}async getLogin(){return this.toJSON()}async getSelf(){let{user:e}=await this.getLogin();return e}},Pe=["getMessage","getReaction","getFriend","getGuild","getGuildMember","getGuildRole","getChannel"];for(let e of Pe)B.prototype[e+"Iter"]=function(...t){let s;if(!this[e+"List"])throw new Error(`not implemented: ${e}List`);let i=m(async()=>{s=await this[e+"List"](...t,s?.next),e==="getMessage"&&s.data.reverse()},"getList");return{async next(){return s?.data.length?{done:!1,value:s.data.shift()}:s&&!s?.next?{done:!0,value:void 0}:(await i(),this.next())},[Symbol.asyncIterator](){return this}}};f(B.prototype,"selfId",["user","id"]);f(B.prototype,"userId",["user","id"]);var ie=class{constructor(e){this.ctx=e}static{m(this,"Adapter")}static schema=!1;bots=[];async connect(e){}async disconnect(e){}fork(e,t){t.adapter=this,this.bots.push(t),e.on("dispose",()=>{Me(this.bots,t)})}};(e=>{e.WsClientConfig=P.object({retryTimes:P.natural().description("初次连接时的最大重试次数。").default(6),retryInterval:P.natural().role("ms").description("初次连接时的重试时间间隔。").default(5*U.second),retryLazy:P.natural().role("ms").description("连接关闭后的重试时间间隔。").default(U.minute)}).description("连接设置");class t extends e{constructor(r,n){super(r),this.config=n}static{m(this,"WsClientBase")}socket;connectionId=0;async start(){let r=0,n=++this.connectionId,a=this.ctx.logger("adapter"),{retryTimes:c,retryInterval:l,retryLazy:p}=this.config,y=m((d,u)=>{if(!this.getActive()||n!==this.connectionId)return;let C=l;if(r>=c){if(d)return this.setStatus(v.OFFLINE,new Error(u));C=p}r++,this.setStatus(v.RECONNECT),a.warn(`${u}, will retry in ${U.format(C)}...`),setTimeout(()=>{!this.getActive()||n!==this.connectionId||T()},C)},"reconnect"),T=m(async(d=!1)=>{a.debug("websocket client opening");let u;try{u=await this.prepare()}catch(E){y(d,E.toString()||"failed to prepare websocket");return}let C=u.url.replace(/\?.+/,"");u.addEventListener("error",E=>{E.message&&a.warn(E.message)}),u.addEventListener("close",({code:E,reason:ce})=>{this.socket===u&&(this.socket=null),a.debug(`websocket closed with ${E}`),y(d,ce.toString()||`failed to connect to ${C}, code: ${E}`)}),u.addEventListener("open",()=>{r=0,this.socket=u,a.info("connect to server: %c",C),this.accept(u)})},"connect");T(!0)}async stop(){this.socket?.close()}}e.WsClientBase=t;class s extends t{constructor(r,n){super(r,n.config),this.bot=n,n.adapter=this}static{m(this,"WsClient")}static reusable=!0;getActive(){return this.bot.isActive}setStatus(r,n=null){this.bot.status=r,this.bot.error=n}async connect(r){this.start()}async disconnect(r){this.stop()}}e.WsClient=s})(ie||(ie={}));var je=class extends Error{constructor(e,t=""){super(t),this.errors=e}static{m(this,"AggregateError")}},ut=class{constructor(e,t,s,i={}){this.bot=e,this.channelId=t,this.guildId=s,this.options=i}static{m(this,"MessageEncoder")}errors=[];results=[];session;async prepare(){}async render(e,t){for(let s of e)await this.visit(s);t&&await this.flush()}async send(e){this.session=this.bot.session({type:"send",channel:{id:this.channelId,...this.options.session?.event.channel},guild:this.options.session?.event.guild});for(let i in this.options.session||{})i==="id"||i==="event"||(this.session[i]=this.options.session[i]);await this.prepare();let t=this.options.session??this.session;this.session.elements=await t.transform(re.normalize(e));let s=re.select(this.session.elements,"button").filter(i=>i.attrs.type!=="link"&&!i.attrs.id);for(let i of s){let r=Math.random().toString(36).slice(2);i.attrs.id||=r,typeof i.attrs.action=="function"&&(this.bot.callbacks[i.attrs.id]=i.attrs.action)}if(await this.session.app.serial(this.session,"before-send",this.session,this.options))return[];if(await this.render(this.session.elements),await this.flush(),this.errors.length)throw new je(this.errors);return this.results}};ne.warn=new Ce("element").warn;J.createConfig=m(function(t){return F.object({endpoint:F.string().role("link").description("要连接的服务器地址。").default(typeof t=="string"?t:null).required(typeof t=="boolean"?t:!1),headers:F.dict(String).role("table").description("要附加的额外请求头。"),...this.Config.dict}).description("请求设置")},"createConfig");var pt=class extends Ie{static{m(this,"SatoriContext")}constructor(e){super(e),this.provide("satori",void 0,!0),this.plugin(ae)}},ae=class extends O{static{m(this,"Satori")}static[O.provide]="satori";static[O.immediate]=!0;uid=Math.random().toString(36).slice(2);_uploadRoutes=[];_tempStore=Object.create(null);constructor(e){super(e),e.mixin("satori",["bots","component"]),this.upload(`/temp/${this.uid}/`,async s=>{let i=s.split("/").pop();return this._tempStore[i]??{status:404}}),Te(this.bots,O.tracker,{});let t=this;e.on("http/file",async function(s,i){if(!s.startsWith("upload://"))return;let{status:r,data:n,headers:a}=await t.download(s.slice(9));if(r>=400)throw new Error(`Failed to fetch ${s}, status code: ${r}`);if(r>=300){let p=a?.get("location");return this.file(p,i)}let c=a?.get("content-type"),l=a?.get("content-disposition")?.split("filename=")[1];return{data:n,filename:l,type:c,mime:c}})}bots=new Proxy([],{get(e,t){return t in e||typeof t=="symbol"?Reflect.get(e,t):e.find(s=>s.sid===t)},deleteProperty(e,t){if(t in e||typeof t=="symbol")return Reflect.deleteProperty(e,t);let s=e.findIndex(i=>i.sid===t);return s<0||e.splice(s,1),!0}});component(e,t,s={}){let i=m(async(r,n,a)=>{if(s.session&&a.type==="send")throw new Error("interactive components is not available outside sessions");let c=await t(r,n,a);return a.transform(ne.normalize(c))},"render");return this.ctx.set("component:"+e,i)}upload(e,t,s=[]){return this.ctx.effect(()=>{let i={path:e,callback:t};return this._uploadRoutes.push(i),s.push(e),()=>{ee(this._uploadRoutes,i),ee(s,e)}})}async download(e){for(let t of this._uploadRoutes)if($e(typeof t.path=="function"?t.path():t.path).some(i=>e.startsWith(i)))return t.callback(e);return{status:404}}},ft=ae;export{ie as Adapter,B as Bot,pt as Context,ne as Element,J as HTTP,ut as MessageEncoder,ut as Messenger,ut as Modulator,J as Quester,ae as Satori,g as Session,K as Universal,ft as default,f as defineAccessor,ne as h,ne as segment};
