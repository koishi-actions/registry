var d=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var b=(e,r)=>()=>(e&&(r=e(e=0)),r);var N=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports);var f=(e,r,i,a)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of D(r))!I.call(e,n)&&n!==i&&d(e,n,{get:()=>r[n],enumerable:!(a=L(r,n))||a.enumerable});return e},m=(e,r,i)=>(f(e,r,"default"),i&&f(i,r,"default"));var x=e=>f(d({},"__esModule",{value:!0}),e);import{Buffer as _}from"https://registry.koishi.chat/modules/buffer/index.js";import y from"https://registry.koishi.chat/modules/process/index.js";var c=b(()=>{});var u={};import*as X from"https://registry.koishi.chat/modules/koishi/index.js";var S=b(()=>{c();m(u,X)});var K=N((Y,w)=>{c();var l=Object.defineProperty,A=Object.getOwnPropertyDescriptor,M=Object.getOwnPropertyNames,q=Object.prototype.hasOwnProperty,z=(e,r)=>l(e,"name",{value:r,configurable:!0}),B=(e,r)=>{for(var i in r)l(e,i,{get:r[i],enumerable:!0})},J=(e,r,i,a)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of M(r))!q.call(e,n)&&n!==i&&l(e,n,{get:()=>r[n],enumerable:!(a=A(r,n))||a.enumerable});return e},E=e=>J(l({},"__esModule",{value:!0}),e),P={};B(P,{Config:()=>F,apply:()=>j,name:()=>G,using:()=>H});w.exports=E(P);var t=(S(),x(u)),O=t.Schema.object({interval:t.Schema.number(),responses:t.Schema.number()}),C=t.Schema.object({participants:t.Schema.number(),length:t.Schema.number(),debounce:t.Schema.number()}),F=t.Schema.object({throttle:t.Schema.union([t.Schema.array(O),t.Schema.transform(O,e=>[e])]),preventLoop:t.Schema.union([t.Schema.array(C),t.Schema.transform(C,e=>[e]),t.Schema.transform(Number,e=>[{participants:1,length:e}])])}),G="koishi-plugin-dialogue-rate-limit",H=["dialogue"];function j(e,r){let i=(0,t.makeArray)(r.throttle),a={};for(let{interval:o,responses:s}of i)a[o]=s;e.on("dialogue/state",o=>{o.counters={...a}}),e.on("dialogue/receive",({counters:o,session:s})=>{if(!s._redirected){for(let p in o)if(o[p]<=0)return!0}}),e.before("dialogue/send",({counters:o,session:s})=>{if(!s._redirected)for(let{interval:p}of i)o[p]--,setTimeout(()=>o[p]++,p)});let{preventLoop:n}=r,h=n?typeof n=="number"?[{length:n,participants:1}]:(0,t.makeArray)(n):[],k=Math.max(0,...h.map(o=>o.length));e.on("dialogue/state",o=>{o.initiators=[]}),e.on("dialogue/receive",o=>{if(o.session._redirected)return;let s=Date.now();for(let{participants:p,length:g,debounce:T}of h){if(o.initiators.length<g)break;let v=new Set(o.initiators.slice(0,g));if(v.size<=p&&v.has(o.userId)&&!(T>s-o.loopTimestamp))return o.loopTimestamp=s,!0}}),e.before("dialogue/send",o=>{o.session._redirected||(o.initiators.unshift(o.userId),o.initiators.splice(k,1/0),o.loopTimestamp=null)})}z(j,"apply")});export default K();
