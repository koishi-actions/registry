var ye=Object.defineProperty;var kt=Object.getOwnPropertyDescriptor;var It=Object.getOwnPropertyNames;var At=Object.prototype.hasOwnProperty;var K=(e,t)=>()=>(e&&(t=e(e=0)),t);var w=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var Q=(e,t,i,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let l of It(t))!At.call(e,l)&&l!==i&&ye(e,l,{get:()=>t[l],enumerable:!(r=kt(t,l))||r.enumerable});return e},A=(e,t,i)=>(Q(e,t,"default"),i&&Q(i,t,"default"));var X=e=>Q(ye({},"__esModule",{value:!0}),e);import{Buffer as c}from"https://registry.koishi.chat/modules/buffer/index.js";import y from"https://registry.koishi.chat/modules/process/index.js";var f=K(()=>{});var U={};import*as Wi from"https://registry.koishi.chat/modules/koishi/index.js";var be=K(()=>{f();A(U,Wi)});import St from"https://registry.koishi.chat/modules/util/index.js";var N=w((Ji,we)=>{f();we.exports=St});import Rt from"https://registry.koishi.chat/modules/stream-browserify/index.js";var J=w((er,Te)=>{f();Te.exports=Rt});import Pt from"https://registry.koishi.chat/modules/browserify-zlib/index.js";var v=w((rr,Ee)=>{f();Ee.exports=Pt});var ee=w((lr,Oe)=>{"use strict";f();var xt=N(),Ce=J(),P=Oe.exports=function(){Ce.call(this),this._buffers=[],this._buffered=0,this._reads=[],this._paused=!1,this._encoding="utf8",this.writable=!0};xt.inherits(P,Ce);P.prototype.read=function(e,t){this._reads.push({length:Math.abs(e),allowLess:e<0,func:t}),y.nextTick(function(){this._process(),this._paused&&this._reads&&this._reads.length>0&&(this._paused=!1,this.emit("drain"))}.bind(this))};P.prototype.write=function(e,t){if(!this.writable)return this.emit("error",new Error("Stream not writable")),!1;let i;return c.isBuffer(e)?i=e:i=c.from(e,t||this._encoding),this._buffers.push(i),this._buffered+=i.length,this._process(),this._reads&&this._reads.length===0&&(this._paused=!0),this.writable&&!this._paused};P.prototype.end=function(e,t){e&&this.write(e,t),this.writable=!1,this._buffers&&(this._buffers.length===0?this._end():(this._buffers.push(null),this._process()))};P.prototype.destroySoon=P.prototype.end;P.prototype._end=function(){this._reads.length>0&&this.emit("error",new Error("Unexpected end of input")),this.destroy()};P.prototype.destroy=function(){this._buffers&&(this.writable=!1,this._reads=null,this._buffers=null,this.emit("close"))};P.prototype._processReadAllowingLess=function(e){this._reads.shift();let t=this._buffers[0];t.length>e.length?(this._buffered-=e.length,this._buffers[0]=t.slice(e.length),e.func.call(this,t.slice(0,e.length))):(this._buffered-=t.length,this._buffers.shift(),e.func.call(this,t))};P.prototype._processRead=function(e){this._reads.shift();let t=0,i=0,r=c.alloc(e.length);for(;t<e.length;){let l=this._buffers[i++],n=Math.min(l.length,e.length-t);l.copy(r,t,0,n),t+=n,n!==l.length&&(this._buffers[--i]=l.slice(n))}i>0&&this._buffers.splice(0,i),this._buffered-=e.length,e.func.call(this,r)};P.prototype._process=function(){try{for(;this._buffered>0&&this._reads&&this._reads.length>0;){let e=this._reads[0];if(e.allowLess)this._processReadAllowingLess(e);else if(this._buffered>=e.length)this._processRead(e);else break}this._buffers&&!this.writable&&this._end()}catch(e){this.emit("error",e)}}});var ie=w(te=>{"use strict";f();var q=[{x:[0],y:[0]},{x:[4],y:[0]},{x:[0,4],y:[4]},{x:[2,6],y:[0,4]},{x:[0,2,4,6],y:[2,6]},{x:[1,3,5,7],y:[0,2,4,6]},{x:[0,1,2,3,4,5,6,7],y:[1,3,5,7]}];te.getImagePasses=function(e,t){let i=[],r=e%8,l=t%8,n=(e-r)/8,s=(t-l)/8;for(let h=0;h<q.length;h++){let o=q[h],a=n*o.x.length,u=s*o.y.length;for(let d=0;d<o.x.length&&o.x[d]<r;d++)a++;for(let d=0;d<o.y.length&&o.y[d]<l;d++)u++;a>0&&u>0&&i.push({width:a,height:u,index:h})}return i};te.getInterlaceIterator=function(e){return function(t,i,r){let l=t%q[r].x.length,n=(t-l)/q[r].x.length*8+q[r].x[l],s=i%q[r].y.length,h=(i-s)/q[r].y.length*8+q[r].y[s];return n*4+h*e*4}}});var re=w((ar,Le)=>{"use strict";f();Le.exports=function(t,i,r){let l=t+i-r,n=Math.abs(l-t),s=Math.abs(l-i),h=Math.abs(l-r);return n<=s&&n<=h?t:s<=h?i:r}});var ne=w((ur,Ie)=>{"use strict";f();var Bt=ie(),Mt=re();function ke(e,t,i){let r=e*t;return i!==8&&(r=Math.ceil(r/(8/i))),r}var D=Ie.exports=function(e,t){let i=e.width,r=e.height,l=e.interlace,n=e.bpp,s=e.depth;if(this.read=t.read,this.write=t.write,this.complete=t.complete,this._imageIndex=0,this._images=[],l){let h=Bt.getImagePasses(i,r);for(let o=0;o<h.length;o++)this._images.push({byteWidth:ke(h[o].width,n,s),height:h[o].height,lineIndex:0})}else this._images.push({byteWidth:ke(i,n,s),height:r,lineIndex:0});s===8?this._xComparison=n:s===16?this._xComparison=n*2:this._xComparison=1};D.prototype.start=function(){this.read(this._images[this._imageIndex].byteWidth+1,this._reverseFilterLine.bind(this))};D.prototype._unFilterType1=function(e,t,i){let r=this._xComparison,l=r-1;for(let n=0;n<i;n++){let s=e[1+n],h=n>l?t[n-r]:0;t[n]=s+h}};D.prototype._unFilterType2=function(e,t,i){let r=this._lastLine;for(let l=0;l<i;l++){let n=e[1+l],s=r?r[l]:0;t[l]=n+s}};D.prototype._unFilterType3=function(e,t,i){let r=this._xComparison,l=r-1,n=this._lastLine;for(let s=0;s<i;s++){let h=e[1+s],o=n?n[s]:0,a=s>l?t[s-r]:0,u=Math.floor((a+o)/2);t[s]=h+u}};D.prototype._unFilterType4=function(e,t,i){let r=this._xComparison,l=r-1,n=this._lastLine;for(let s=0;s<i;s++){let h=e[1+s],o=n?n[s]:0,a=s>l?t[s-r]:0,u=s>l&&n?n[s-r]:0,d=Mt(a,o,u);t[s]=h+d}};D.prototype._reverseFilterLine=function(e){let t=e[0],i,r=this._images[this._imageIndex],l=r.byteWidth;if(t===0)i=e.slice(1,l+1);else switch(i=c.alloc(l),t){case 1:this._unFilterType1(e,i,l);break;case 2:this._unFilterType2(e,i,l);break;case 3:this._unFilterType3(e,i,l);break;case 4:this._unFilterType4(e,i,l);break;default:throw new Error("Unrecognised filter type - "+t)}this.write(i),r.lineIndex++,r.lineIndex>=r.height?(this._lastLine=null,this._imageIndex++,r=this._images[this._imageIndex]):this._lastLine=i,r?this.read(r.byteWidth+1,this._reverseFilterLine.bind(this)):(this._lastLine=null,this.complete())}});var Re=w((dr,Se)=>{"use strict";f();var qt=N(),Ae=ee(),Yt=ne(),Nt=Se.exports=function(e){Ae.call(this);let t=[],i=this;this._filter=new Yt(e,{read:this.read.bind(this),write:function(r){t.push(r)},complete:function(){i.emit("complete",c.concat(t))}}),this._filter.start()};qt.inherits(Nt,Ae)});var G=w((_r,Pe)=>{"use strict";f();Pe.exports={PNG_SIGNATURE:[137,80,78,71,13,10,26,10],TYPE_IHDR:1229472850,TYPE_IEND:1229278788,TYPE_IDAT:1229209940,TYPE_PLTE:1347179589,TYPE_tRNS:1951551059,TYPE_gAMA:1732332865,COLORTYPE_GRAYSCALE:0,COLORTYPE_PALETTE:1,COLORTYPE_COLOR:2,COLORTYPE_ALPHA:4,COLORTYPE_PALETTE_COLOR:3,COLORTYPE_COLOR_ALPHA:6,COLORTYPE_TO_BPP_MAP:{0:1,2:3,3:1,4:2,6:4},GAMMA_DIVISION:1e5}});var he=w((gr,xe)=>{"use strict";f();var le=[];(function(){for(let e=0;e<256;e++){let t=e;for(let i=0;i<8;i++)t&1?t=3988292384^t>>>1:t=t>>>1;le[e]=t}})();var se=xe.exports=function(){this._crc=-1};se.prototype.write=function(e){for(let t=0;t<e.length;t++)this._crc=le[(this._crc^e[t])&255]^this._crc>>>8;return!0};se.prototype.crc32=function(){return this._crc^-1};se.crc32=function(e){let t=-1;for(let i=0;i<e.length;i++)t=le[(t^e[i])&255]^t>>>8;return t^-1}});var oe=w((br,Be)=>{"use strict";f();var C=G(),Ht=he(),O=Be.exports=function(e,t){this._options=e,e.checkCRC=e.checkCRC!==!1,this._hasIHDR=!1,this._hasIEND=!1,this._emittedHeadersFinished=!1,this._palette=[],this._colorType=0,this._chunks={},this._chunks[C.TYPE_IHDR]=this._handleIHDR.bind(this),this._chunks[C.TYPE_IEND]=this._handleIEND.bind(this),this._chunks[C.TYPE_IDAT]=this._handleIDAT.bind(this),this._chunks[C.TYPE_PLTE]=this._handlePLTE.bind(this),this._chunks[C.TYPE_tRNS]=this._handleTRNS.bind(this),this._chunks[C.TYPE_gAMA]=this._handleGAMA.bind(this),this.read=t.read,this.error=t.error,this.metadata=t.metadata,this.gamma=t.gamma,this.transColor=t.transColor,this.palette=t.palette,this.parsed=t.parsed,this.inflateData=t.inflateData,this.finished=t.finished,this.simpleTransparency=t.simpleTransparency,this.headersFinished=t.headersFinished||function(){}};O.prototype.start=function(){this.read(C.PNG_SIGNATURE.length,this._parseSignature.bind(this))};O.prototype._parseSignature=function(e){let t=C.PNG_SIGNATURE;for(let i=0;i<t.length;i++)if(e[i]!==t[i]){this.error(new Error("Invalid file signature"));return}this.read(8,this._parseChunkBegin.bind(this))};O.prototype._parseChunkBegin=function(e){let t=e.readUInt32BE(0),i=e.readUInt32BE(4),r="";for(let n=4;n<8;n++)r+=String.fromCharCode(e[n]);let l=!!(e[4]&32);if(!this._hasIHDR&&i!==C.TYPE_IHDR){this.error(new Error("Expected IHDR on beggining"));return}if(this._crc=new Ht,this._crc.write(c.from(r)),this._chunks[i])return this._chunks[i](t);if(!l){this.error(new Error("Unsupported critical chunk type "+r));return}this.read(t+4,this._skipChunk.bind(this))};O.prototype._skipChunk=function(){this.read(8,this._parseChunkBegin.bind(this))};O.prototype._handleChunkEnd=function(){this.read(4,this._parseChunkEnd.bind(this))};O.prototype._parseChunkEnd=function(e){let t=e.readInt32BE(0),i=this._crc.crc32();if(this._options.checkCRC&&i!==t){this.error(new Error("Crc error - "+t+" - "+i));return}this._hasIEND||this.read(8,this._parseChunkBegin.bind(this))};O.prototype._handleIHDR=function(e){this.read(e,this._parseIHDR.bind(this))};O.prototype._parseIHDR=function(e){this._crc.write(e);let t=e.readUInt32BE(0),i=e.readUInt32BE(4),r=e[8],l=e[9],n=e[10],s=e[11],h=e[12];if(r!==8&&r!==4&&r!==2&&r!==1&&r!==16){this.error(new Error("Unsupported bit depth "+r));return}if(!(l in C.COLORTYPE_TO_BPP_MAP)){this.error(new Error("Unsupported color type"));return}if(n!==0){this.error(new Error("Unsupported compression method"));return}if(s!==0){this.error(new Error("Unsupported filter method"));return}if(h!==0&&h!==1){this.error(new Error("Unsupported interlace method"));return}this._colorType=l;let o=C.COLORTYPE_TO_BPP_MAP[this._colorType];this._hasIHDR=!0,this.metadata({width:t,height:i,depth:r,interlace:!!h,palette:!!(l&C.COLORTYPE_PALETTE),color:!!(l&C.COLORTYPE_COLOR),alpha:!!(l&C.COLORTYPE_ALPHA),bpp:o,colorType:l}),this._handleChunkEnd()};O.prototype._handlePLTE=function(e){this.read(e,this._parsePLTE.bind(this))};O.prototype._parsePLTE=function(e){this._crc.write(e);let t=Math.floor(e.length/3);for(let i=0;i<t;i++)this._palette.push([e[i*3],e[i*3+1],e[i*3+2],255]);this.palette(this._palette),this._handleChunkEnd()};O.prototype._handleTRNS=function(e){this.simpleTransparency(),this.read(e,this._parseTRNS.bind(this))};O.prototype._parseTRNS=function(e){if(this._crc.write(e),this._colorType===C.COLORTYPE_PALETTE_COLOR){if(this._palette.length===0){this.error(new Error("Transparency chunk must be after palette"));return}if(e.length>this._palette.length){this.error(new Error("More transparent colors than palette size"));return}for(let t=0;t<e.length;t++)this._palette[t][3]=e[t];this.palette(this._palette)}this._colorType===C.COLORTYPE_GRAYSCALE&&this.transColor([e.readUInt16BE(0)]),this._colorType===C.COLORTYPE_COLOR&&this.transColor([e.readUInt16BE(0),e.readUInt16BE(2),e.readUInt16BE(4)]),this._handleChunkEnd()};O.prototype._handleGAMA=function(e){this.read(e,this._parseGAMA.bind(this))};O.prototype._parseGAMA=function(e){this._crc.write(e),this.gamma(e.readUInt32BE(0)/C.GAMMA_DIVISION),this._handleChunkEnd()};O.prototype._handleIDAT=function(e){this._emittedHeadersFinished||(this._emittedHeadersFinished=!0,this.headersFinished()),this.read(-e,this._parseIDAT.bind(this,e))};O.prototype._parseIDAT=function(e,t){if(this._crc.write(t),this._colorType===C.COLORTYPE_PALETTE_COLOR&&this._palette.length===0)throw new Error("Expected palette not found");this.inflateData(t);let i=e-t.length;i>0?this._handleIDAT(i):this._handleChunkEnd()};O.prototype._handleIEND=function(e){this.read(e,this._parseIEND.bind(this))};O.prototype._parseIEND=function(e){this._crc.write(e),this._hasIEND=!0,this._handleChunkEnd(),this.finished&&this.finished()}});var ae=w(qe=>{"use strict";f();var Me=ie(),Ut=[function(){},function(e,t,i,r){if(r===t.length)throw new Error("Ran out of data");let l=t[r];e[i]=l,e[i+1]=l,e[i+2]=l,e[i+3]=255},function(e,t,i,r){if(r+1>=t.length)throw new Error("Ran out of data");let l=t[r];e[i]=l,e[i+1]=l,e[i+2]=l,e[i+3]=t[r+1]},function(e,t,i,r){if(r+2>=t.length)throw new Error("Ran out of data");e[i]=t[r],e[i+1]=t[r+1],e[i+2]=t[r+2],e[i+3]=255},function(e,t,i,r){if(r+3>=t.length)throw new Error("Ran out of data");e[i]=t[r],e[i+1]=t[r+1],e[i+2]=t[r+2],e[i+3]=t[r+3]}],vt=[function(){},function(e,t,i,r){let l=t[0];e[i]=l,e[i+1]=l,e[i+2]=l,e[i+3]=r},function(e,t,i){let r=t[0];e[i]=r,e[i+1]=r,e[i+2]=r,e[i+3]=t[1]},function(e,t,i,r){e[i]=t[0],e[i+1]=t[1],e[i+2]=t[2],e[i+3]=r},function(e,t,i){e[i]=t[0],e[i+1]=t[1],e[i+2]=t[2],e[i+3]=t[3]}];function Dt(e,t){let i=[],r=0;function l(){if(r===e.length)throw new Error("Ran out of data");let n=e[r];r++;let s,h,o,a,u,d,p,_;switch(t){default:throw new Error("unrecognised depth");case 16:p=e[r],r++,i.push((n<<8)+p);break;case 4:p=n&15,_=n>>4,i.push(_,p);break;case 2:u=n&3,d=n>>2&3,p=n>>4&3,_=n>>6&3,i.push(_,p,d,u);break;case 1:s=n&1,h=n>>1&1,o=n>>2&1,a=n>>3&1,u=n>>4&1,d=n>>5&1,p=n>>6&1,_=n>>7&1,i.push(_,p,d,u,a,o,h,s);break}}return{get:function(n){for(;i.length<n;)l();let s=i.slice(0,n);return i=i.slice(n),s},resetAfterLine:function(){i.length=0},end:function(){if(r!==e.length)throw new Error("extra data found")}}}function Gt(e,t,i,r,l,n){let s=e.width,h=e.height,o=e.index;for(let a=0;a<h;a++)for(let u=0;u<s;u++){let d=i(u,a,o);Ut[r](t,l,d,n),n+=r}return n}function Ft(e,t,i,r,l,n){let s=e.width,h=e.height,o=e.index;for(let a=0;a<h;a++){for(let u=0;u<s;u++){let d=l.get(r),p=i(u,a,o);vt[r](t,d,p,n)}l.resetAfterLine()}}qe.dataToBitMap=function(e,t){let i=t.width,r=t.height,l=t.depth,n=t.bpp,s=t.interlace,h;l!==8&&(h=Dt(e,l));let o;l<=8?o=c.alloc(i*r*4):o=new Uint16Array(i*r*4);let a=Math.pow(2,l)-1,u=0,d,p;if(s)d=Me.getImagePasses(i,r),p=Me.getInterlaceIterator(i,r);else{let _=0;p=function(){let b=_;return _+=4,b},d=[{width:i,height:r}]}for(let _=0;_<d.length;_++)l===8?u=Gt(d[_],o,p,n,e,u):Ft(d[_],o,p,n,h,a);if(l===8){if(u!==e.length)throw new Error("extra data found")}else h.end();return o}});var fe=w((Cr,Ye)=>{"use strict";f();function zt(e,t,i,r,l){let n=0;for(let s=0;s<r;s++)for(let h=0;h<i;h++){let o=l[e[n]];if(!o)throw new Error("index "+e[n]+" not in palette");for(let a=0;a<4;a++)t[n+a]=o[a];n+=4}}function jt(e,t,i,r,l){let n=0;for(let s=0;s<r;s++)for(let h=0;h<i;h++){let o=!1;if(l.length===1?l[0]===e[n]&&(o=!0):l[0]===e[n]&&l[1]===e[n+1]&&l[2]===e[n+2]&&(o=!0),o)for(let a=0;a<4;a++)t[n+a]=0;n+=4}}function $t(e,t,i,r,l){let n=255,s=Math.pow(2,l)-1,h=0;for(let o=0;o<r;o++)for(let a=0;a<i;a++){for(let u=0;u<4;u++)t[h+u]=Math.floor(e[h+u]*n/s+.5);h+=4}}Ye.exports=function(e,t,i=!1){let r=t.depth,l=t.width,n=t.height,s=t.colorType,h=t.transColor,o=t.palette,a=e;return s===3?zt(e,a,l,n,o):(h&&jt(e,a,l,n,h),r!==8&&!i&&(r===16&&(a=c.alloc(l*n*4)),$t(e,a,l,n,r))),a}});var Ue=w((Lr,He)=>{"use strict";f();var Zt=N(),ue=v(),Ne=ee(),Vt=Re(),Wt=oe(),Kt=ae(),Jt=fe(),x=He.exports=function(e){Ne.call(this),this._parser=new Wt(e,{read:this.read.bind(this),error:this._handleError.bind(this),metadata:this._handleMetaData.bind(this),gamma:this.emit.bind(this,"gamma"),palette:this._handlePalette.bind(this),transColor:this._handleTransColor.bind(this),finished:this._finished.bind(this),inflateData:this._inflateData.bind(this),simpleTransparency:this._simpleTransparency.bind(this),headersFinished:this._headersFinished.bind(this)}),this._options=e,this.writable=!0,this._parser.start()};Zt.inherits(x,Ne);x.prototype._handleError=function(e){this.emit("error",e),this.writable=!1,this.destroy(),this._inflate&&this._inflate.destroy&&this._inflate.destroy(),this._filter&&(this._filter.destroy(),this._filter.on("error",function(){})),this.errord=!0};x.prototype._inflateData=function(e){if(!this._inflate)if(this._bitmapInfo.interlace)this._inflate=ue.createInflate(),this._inflate.on("error",this.emit.bind(this,"error")),this._filter.on("complete",this._complete.bind(this)),this._inflate.pipe(this._filter);else{let i=((this._bitmapInfo.width*this._bitmapInfo.bpp*this._bitmapInfo.depth+7>>3)+1)*this._bitmapInfo.height,r=Math.max(i,ue.Z_MIN_CHUNK);this._inflate=ue.createInflate({chunkSize:r});let l=i,n=this.emit.bind(this,"error");this._inflate.on("error",function(h){l&&n(h)}),this._filter.on("complete",this._complete.bind(this));let s=this._filter.write.bind(this._filter);this._inflate.on("data",function(h){l&&(h.length>l&&(h=h.slice(0,l)),l-=h.length,s(h))}),this._inflate.on("end",this._filter.end.bind(this._filter))}this._inflate.write(e)};x.prototype._handleMetaData=function(e){this._metaData=e,this._bitmapInfo=Object.create(e),this._filter=new Vt(this._bitmapInfo)};x.prototype._handleTransColor=function(e){this._bitmapInfo.transColor=e};x.prototype._handlePalette=function(e){this._bitmapInfo.palette=e};x.prototype._simpleTransparency=function(){this._metaData.alpha=!0};x.prototype._headersFinished=function(){this.emit("metadata",this._metaData)};x.prototype._finished=function(){this.errord||(this._inflate?this._inflate.end():this.emit("error","No Inflate block"))};x.prototype._complete=function(e){if(this.errord)return;let t;try{let i=Kt.dataToBitMap(e,this._bitmapInfo);t=Jt(i,this._bitmapInfo,this._options.skipRescale),i=null}catch(i){this._handleError(i);return}this.emit("parsed",t)}});var De=w((Ir,ve)=>{"use strict";f();var S=G();ve.exports=function(e,t,i,r){let l=[S.COLORTYPE_COLOR_ALPHA,S.COLORTYPE_ALPHA].indexOf(r.colorType)!==-1;if(r.colorType===r.inputColorType){let b=function(){let T=new ArrayBuffer(2);return new DataView(T).setInt16(0,256,!0),new Int16Array(T)[0]!==256}();if(r.bitDepth===8||r.bitDepth===16&&b)return e}let n=r.bitDepth!==16?e:new Uint16Array(e.buffer),s=255,h=S.COLORTYPE_TO_BPP_MAP[r.inputColorType];h===4&&!r.inputHasAlpha&&(h=3);let o=S.COLORTYPE_TO_BPP_MAP[r.colorType];r.bitDepth===16&&(s=65535,o*=2);let a=c.alloc(t*i*o),u=0,d=0,p=r.bgColor||{};p.red===void 0&&(p.red=s),p.green===void 0&&(p.green=s),p.blue===void 0&&(p.blue=s);function _(){let b,T,m,g=s;switch(r.inputColorType){case S.COLORTYPE_COLOR_ALPHA:g=n[u+3],b=n[u],T=n[u+1],m=n[u+2];break;case S.COLORTYPE_COLOR:b=n[u],T=n[u+1],m=n[u+2];break;case S.COLORTYPE_ALPHA:g=n[u+1],b=n[u],T=b,m=b;break;case S.COLORTYPE_GRAYSCALE:b=n[u],T=b,m=b;break;default:throw new Error("input color type:"+r.inputColorType+" is not supported at present")}return r.inputHasAlpha&&(l||(g/=s,b=Math.min(Math.max(Math.round((1-g)*p.red+g*b),0),s),T=Math.min(Math.max(Math.round((1-g)*p.green+g*T),0),s),m=Math.min(Math.max(Math.round((1-g)*p.blue+g*m),0),s))),{red:b,green:T,blue:m,alpha:g}}for(let b=0;b<i;b++)for(let T=0;T<t;T++){let m=_(n,u);switch(r.colorType){case S.COLORTYPE_COLOR_ALPHA:case S.COLORTYPE_COLOR:r.bitDepth===8?(a[d]=m.red,a[d+1]=m.green,a[d+2]=m.blue,l&&(a[d+3]=m.alpha)):(a.writeUInt16BE(m.red,d),a.writeUInt16BE(m.green,d+2),a.writeUInt16BE(m.blue,d+4),l&&a.writeUInt16BE(m.alpha,d+6));break;case S.COLORTYPE_ALPHA:case S.COLORTYPE_GRAYSCALE:{let g=(m.red+m.green+m.blue)/3;r.bitDepth===8?(a[d]=g,l&&(a[d+1]=m.alpha)):(a.writeUInt16BE(g,d),l&&a.writeUInt16BE(m.alpha,d+2));break}default:throw new Error("unrecognised color Type "+r.colorType)}u+=h,d+=o}return a}});var ze=w((Sr,Fe)=>{"use strict";f();var Ge=re();function Qt(e,t,i,r,l){for(let n=0;n<i;n++)r[l+n]=e[t+n]}function Xt(e,t,i){let r=0,l=t+i;for(let n=t;n<l;n++)r+=Math.abs(e[n]);return r}function ei(e,t,i,r,l,n){for(let s=0;s<i;s++){let h=s>=n?e[t+s-n]:0,o=e[t+s]-h;r[l+s]=o}}function ti(e,t,i,r){let l=0;for(let n=0;n<i;n++){let s=n>=r?e[t+n-r]:0,h=e[t+n]-s;l+=Math.abs(h)}return l}function ii(e,t,i,r,l){for(let n=0;n<i;n++){let s=t>0?e[t+n-i]:0,h=e[t+n]-s;r[l+n]=h}}function ri(e,t,i){let r=0,l=t+i;for(let n=t;n<l;n++){let s=t>0?e[n-i]:0,h=e[n]-s;r+=Math.abs(h)}return r}function ni(e,t,i,r,l,n){for(let s=0;s<i;s++){let h=s>=n?e[t+s-n]:0,o=t>0?e[t+s-i]:0,a=e[t+s]-(h+o>>1);r[l+s]=a}}function li(e,t,i,r){let l=0;for(let n=0;n<i;n++){let s=n>=r?e[t+n-r]:0,h=t>0?e[t+n-i]:0,o=e[t+n]-(s+h>>1);l+=Math.abs(o)}return l}function si(e,t,i,r,l,n){for(let s=0;s<i;s++){let h=s>=n?e[t+s-n]:0,o=t>0?e[t+s-i]:0,a=t>0&&s>=n?e[t+s-(i+n)]:0,u=e[t+s]-Ge(h,o,a);r[l+s]=u}}function hi(e,t,i,r){let l=0;for(let n=0;n<i;n++){let s=n>=r?e[t+n-r]:0,h=t>0?e[t+n-i]:0,o=t>0&&n>=r?e[t+n-(i+r)]:0,a=e[t+n]-Ge(s,h,o);l+=Math.abs(a)}return l}var oi={0:Qt,1:ei,2:ii,3:ni,4:si},ai={0:Xt,1:ti,2:ri,3:li,4:hi};Fe.exports=function(e,t,i,r,l){let n;if(!("filterType"in r)||r.filterType===-1)n=[0,1,2,3,4];else if(typeof r.filterType=="number")n=[r.filterType];else throw new Error("unrecognised filter types");r.bitDepth===16&&(l*=2);let s=t*l,h=0,o=0,a=c.alloc((s+1)*i),u=n[0];for(let d=0;d<i;d++){if(n.length>1){let p=1/0;for(let _=0;_<n.length;_++){let b=ai[n[_]](e,o,s,l);b<p&&(u=n[_],p=b)}}a[h]=u,h++,oi[u](e,o,s,a,h,l),h+=s,o+=s}return a}});var ce=w((Pr,je)=>{"use strict";f();var k=G(),fi=he(),ui=De(),ci=ze(),di=v(),Y=je.exports=function(e){if(this._options=e,e.deflateChunkSize=e.deflateChunkSize||32*1024,e.deflateLevel=e.deflateLevel!=null?e.deflateLevel:9,e.deflateStrategy=e.deflateStrategy!=null?e.deflateStrategy:3,e.inputHasAlpha=e.inputHasAlpha!=null?e.inputHasAlpha:!0,e.deflateFactory=e.deflateFactory||di.createDeflate,e.bitDepth=e.bitDepth||8,e.colorType=typeof e.colorType=="number"?e.colorType:k.COLORTYPE_COLOR_ALPHA,e.inputColorType=typeof e.inputColorType=="number"?e.inputColorType:k.COLORTYPE_COLOR_ALPHA,[k.COLORTYPE_GRAYSCALE,k.COLORTYPE_COLOR,k.COLORTYPE_COLOR_ALPHA,k.COLORTYPE_ALPHA].indexOf(e.colorType)===-1)throw new Error("option color type:"+e.colorType+" is not supported at present");if([k.COLORTYPE_GRAYSCALE,k.COLORTYPE_COLOR,k.COLORTYPE_COLOR_ALPHA,k.COLORTYPE_ALPHA].indexOf(e.inputColorType)===-1)throw new Error("option input color type:"+e.inputColorType+" is not supported at present");if(e.bitDepth!==8&&e.bitDepth!==16)throw new Error("option bit depth:"+e.bitDepth+" is not supported at present")};Y.prototype.getDeflateOptions=function(){return{chunkSize:this._options.deflateChunkSize,level:this._options.deflateLevel,strategy:this._options.deflateStrategy}};Y.prototype.createDeflate=function(){return this._options.deflateFactory(this.getDeflateOptions())};Y.prototype.filterData=function(e,t,i){let r=ui(e,t,i,this._options),l=k.COLORTYPE_TO_BPP_MAP[this._options.colorType];return ci(r,t,i,this._options,l)};Y.prototype._packChunk=function(e,t){let i=t?t.length:0,r=c.alloc(i+12);return r.writeUInt32BE(i,0),r.writeUInt32BE(e,4),t&&t.copy(r,8),r.writeInt32BE(fi.crc32(r.slice(4,r.length-4)),r.length-4),r};Y.prototype.packGAMA=function(e){let t=c.alloc(4);return t.writeUInt32BE(Math.floor(e*k.GAMMA_DIVISION),0),this._packChunk(k.TYPE_gAMA,t)};Y.prototype.packIHDR=function(e,t){let i=c.alloc(13);return i.writeUInt32BE(e,0),i.writeUInt32BE(t,4),i[8]=this._options.bitDepth,i[9]=this._options.colorType,i[10]=0,i[11]=0,i[12]=0,this._packChunk(k.TYPE_IHDR,i)};Y.prototype.packIDAT=function(e){return this._packChunk(k.TYPE_IDAT,e)};Y.prototype.packIEND=function(){return this._packChunk(k.TYPE_IEND,null)}});var We=w((Br,Ve)=>{"use strict";f();var pi=N(),$e=J(),_i=G(),mi=ce(),Ze=Ve.exports=function(e){$e.call(this);let t=e||{};this._packer=new mi(t),this._deflate=this._packer.createDeflate(),this.readable=!0};pi.inherits(Ze,$e);Ze.prototype.pack=function(e,t,i,r){this.emit("data",c.from(_i.PNG_SIGNATURE)),this.emit("data",this._packer.packIHDR(t,i)),r&&this.emit("data",this._packer.packGAMA(r));let l=this._packer.filterData(e,t,i);this._deflate.on("error",this.emit.bind(this,"error")),this._deflate.on("data",function(n){this.emit("data",this._packer.packIDAT(n))}.bind(this)),this._deflate.on("end",function(){this.emit("data",this._packer.packIEND()),this.emit("end")}.bind(this)),this._deflate.end(l)}});import gi from"https://registry.koishi.chat/modules/assert/index.js";var Je=w((Yr,Ke)=>{f();Ke.exports=gi});var F={};import*as Ur from"https://registry.koishi.chat/modules/buffer/index.js";var Qe=K(()=>{f();A(F,Ur)});var nt=w((Z,rt)=>{"use strict";f();var Xe=Je().ok,z=v(),yi=N(),et=(Qe(),X(F)).kMaxLength;function H(e){if(!(this instanceof H))return new H(e);e&&e.chunkSize<z.Z_MIN_CHUNK&&(e.chunkSize=z.Z_MIN_CHUNK),z.Inflate.call(this,e),this._offset=this._offset===void 0?this._outOffset:this._offset,this._buffer=this._buffer||this._outBuffer,e&&e.maxLength!=null&&(this._maxLength=e.maxLength)}function bi(e){return new H(e)}function tt(e,t){t&&y.nextTick(t),e._handle&&(e._handle.close(),e._handle=null)}H.prototype._processChunk=function(e,t,i){if(typeof i=="function")return z.Inflate._processChunk.call(this,e,t,i);let r=this,l=e&&e.length,n=this._chunkSize-this._offset,s=this._maxLength,h=0,o=[],a=0,u;this.on("error",function(b){u=b});function d(b,T){if(r._hadError)return;let m=n-T;if(Xe(m>=0,"have should not go down"),m>0){let g=r._buffer.slice(r._offset,r._offset+m);if(r._offset+=m,g.length>s&&(g=g.slice(0,s)),o.push(g),a+=g.length,s-=g.length,s===0)return!1}return(T===0||r._offset>=r._chunkSize)&&(n=r._chunkSize,r._offset=0,r._buffer=c.allocUnsafe(r._chunkSize)),T===0?(h+=l-b,l=b,!0):!1}Xe(this._handle,"zlib binding closed");let p;do p=this._handle.writeSync(t,e,h,l,this._buffer,this._offset,n),p=p||this._writeState;while(!this._hadError&&d(p[0],p[1]));if(this._hadError)throw u;if(a>=et)throw tt(this),new RangeError("Cannot create final Buffer. It would be larger than 0x"+et.toString(16)+" bytes");let _=c.concat(o,a);return tt(this),_};yi.inherits(H,z.Inflate);function wi(e,t){if(typeof t=="string"&&(t=c.from(t)),!(t instanceof c))throw new TypeError("Not a string or buffer");let i=e._finishFlushFlag;return i==null&&(i=z.Z_FINISH),e._processChunk(t,i)}function it(e,t){return wi(new H(t),e)}rt.exports=Z=it;Z.Inflate=H;Z.createInflate=bi;Z.inflateSync=it});var de=w((Dr,st)=>{"use strict";f();var lt=st.exports=function(e){this._buffer=e,this._reads=[]};lt.prototype.read=function(e,t){this._reads.push({length:Math.abs(e),allowLess:e<0,func:t})};lt.prototype.process=function(){for(;this._reads.length>0&&this._buffer.length;){let e=this._reads[0];if(this._buffer.length&&(this._buffer.length>=e.length||e.allowLess)){this._reads.shift();let t=this._buffer;this._buffer=t.slice(e.length),e.func.call(this,t.slice(0,e.length))}else break}if(this._reads.length>0)throw new Error("There are some read requests waitng on finished stream");if(this._buffer.length>0)throw new Error("unrecognised content at end of stream")}});var ot=w(ht=>{"use strict";f();var Ti=de(),Ei=ne();ht.process=function(e,t){let i=[],r=new Ti(e);return new Ei(t,{read:r.read.bind(r),write:function(n){i.push(n)},complete:function(){}}).start(),r.process(),c.concat(i)}});var ct=w((jr,ut)=>{"use strict";f();var at=!0,ft=v(),Ci=nt();ft.deflateSync||(at=!1);var Oi=de(),Li=ot(),ki=oe(),Ii=ae(),Ai=fe();ut.exports=function(e,t){if(!at)throw new Error("To use the sync capability of this library in old node versions, please pin pngjs to v2.3.0");let i;function r(L){i=L}let l;function n(L){l=L}function s(L){l.transColor=L}function h(L){l.palette=L}function o(){l.alpha=!0}let a;function u(L){a=L}let d=[];function p(L){d.push(L)}let _=new Oi(e);if(new ki(t,{read:_.read.bind(_),error:r,metadata:n,gamma:u,palette:h,transColor:s,inflateData:p,simpleTransparency:o}).start(),_.process(),i)throw i;let T=c.concat(d);d.length=0;let m;if(l.interlace)m=ft.inflateSync(T);else{let $=((l.width*l.bpp*l.depth+7>>3)+1)*l.height;m=Ci(T,{chunkSize:$,maxLength:$})}if(T=null,!m||!m.length)throw new Error("bad png - invalid inflate data response");let g=Li.process(m,l);T=null;let R=Ii.dataToBitMap(g,l);g=null;let B=Ai(R,l,t.skipRescale);return l.data=B,l.gamma=a||0,l}});var mt=w((Zr,_t)=>{"use strict";f();var dt=!0,pt=v();pt.deflateSync||(dt=!1);var Si=G(),Ri=ce();_t.exports=function(e,t){if(!dt)throw new Error("To use the sync capability of this library in old node versions, please pin pngjs to v2.3.0");let i=t||{},r=new Ri(i),l=[];l.push(c.from(Si.PNG_SIGNATURE)),l.push(r.packIHDR(e.width,e.height)),e.gamma&&l.push(r.packGAMA(e.gamma));let n=r.filterData(e.data,e.width,e.height),s=pt.deflateSync(n,r.getDeflateOptions());if(n=null,!s||!s.length)throw new Error("bad png - invalid compressed data response");return l.push(r.packIDAT(s)),l.push(r.packIEND()),c.concat(l)}});var gt=w(pe=>{"use strict";f();var Pi=ct(),xi=mt();pe.read=function(e,t){return Pi(e,t||{})};pe.write=function(e,t){return xi(e,t)}});var wt=w(bt=>{"use strict";f();var Bi=N(),yt=J(),Mi=Ue(),qi=We(),Yi=gt(),I=bt.PNG=function(e){yt.call(this),e=e||{},this.width=e.width|0,this.height=e.height|0,this.data=this.width>0&&this.height>0?c.alloc(4*this.width*this.height):null,e.fill&&this.data&&this.data.fill(0),this.gamma=0,this.readable=this.writable=!0,this._parser=new Mi(e),this._parser.on("error",this.emit.bind(this,"error")),this._parser.on("close",this._handleClose.bind(this)),this._parser.on("metadata",this._metadata.bind(this)),this._parser.on("gamma",this._gamma.bind(this)),this._parser.on("parsed",function(t){this.data=t,this.emit("parsed",t)}.bind(this)),this._packer=new qi(e),this._packer.on("data",this.emit.bind(this,"data")),this._packer.on("end",this.emit.bind(this,"end")),this._parser.on("close",this._handleClose.bind(this)),this._packer.on("error",this.emit.bind(this,"error"))};Bi.inherits(I,yt);I.sync=Yi;I.prototype.pack=function(){return!this.data||!this.data.length?(this.emit("error","No data provided"),this):(y.nextTick(function(){this._packer.pack(this.data,this.width,this.height,this.gamma)}.bind(this)),this)};I.prototype.parse=function(e,t){if(t){let i,r;i=function(l){this.removeListener("error",r),this.data=l,t(null,this)}.bind(this),r=function(l){this.removeListener("parsed",i),t(l,null)}.bind(this),this.once("parsed",i),this.once("error",r)}return this.end(e),this};I.prototype.write=function(e){return this._parser.write(e),!0};I.prototype.end=function(e){this._parser.end(e)};I.prototype._metadata=function(e){this.width=e.width,this.height=e.height,this.emit("metadata",e)};I.prototype._gamma=function(e){this.gamma=e};I.prototype._handleClose=function(){!this._parser.writable&&!this._packer.readable&&this.emit("close")};I.bitblt=function(e,t,i,r,l,n,s,h){if(i|=0,r|=0,l|=0,n|=0,s|=0,h|=0,i>e.width||r>e.height||i+l>e.width||r+n>e.height)throw new Error("bitblt reading outside image");if(s>t.width||h>t.height||s+l>t.width||h+n>t.height)throw new Error("bitblt writing outside image");for(let o=0;o<n;o++)e.data.copy(t.data,(h+o)*t.width+s<<2,(r+o)*e.width+i<<2,(r+o)*e.width+i+l<<2)};I.prototype.bitblt=function(e,t,i,r,l,n,s){return I.bitblt(this,e,t,i,r,l,n,s),this};I.adjustGamma=function(e){if(e.gamma){for(let t=0;t<e.height;t++)for(let i=0;i<e.width;i++){let r=e.width*t+i<<2;for(let l=0;l<3;l++){let n=e.data[r+l]/255;n=Math.pow(n,1/2.2/e.gamma),e.data[r+l]=Math.round(n*255)}}e.gamma=0}};I.prototype.adjustGamma=function(){I.adjustGamma(this)}});var j={};import*as en from"https://registry.koishi.chat/modules/@cordiverse/fs/index.js";var Tt=K(()=>{f();A(j,en)});import Ni from"https://registry.koishi.chat/modules/@cordiverse/path/index.js";var Ct=w((rn,Et)=>{f();Et.exports=Ni});var Ot=w((ln,Hi)=>{Hi.exports={commands:{trad:{description:"Steam挂刀行情",usage:`<>
  <message forward>
    <message id=1>对于部署者行为及所产生的任何纠纷， Koishi 及 koishi-plugin-steam-trading 概不负责</message>
    <message id=2>项目地址https://github.com/initialencounter/mykoishi/blob/main/steam-trading#readme.md </message>
    <message id=2>指令如下：</message>
    <message id=3>1.[挂刀行情] 请发送 trad buff ['buff', 'igxe', 'c5', 'uupy']</message>
    <message id=4>2.[行情分析] 请发送 trad.行情分析</message>
    <message id=5>3.[网页截图] 请发送 trad.行情分析+网址</message>
  </message>
</>`,options:{order:"排序依据 ['buy', 'safe_buy','sell']--最优求购，稳定求购，最优寄售，示例：trad -o buy",game:"游戏筛选 ['dota2', 'csgo','dota2-csgo','csgo-dota2'] 示例：trad -g csgo"},messages:{"no-pptr":"未启用puppeteer, 将无法发送图片"}}}}});var Fi=w(M=>{f();Object.defineProperty(M,"__esModule",{value:!0});M.inject=M.Config=M.usage=void 0;M.apply=Gi;var E=(be(),X(U)),_e=wt(),Ui=(Tt(),X(j)),vi=Ct(),Di="steam-trading",me=new E.Logger(Di);M.usage=`${(0,Ui.readFileSync)((0,vi.resolve)(import.meta.url,"../readme.md")).toString("utf-8")}`;M.Config=E.Schema.object({text_len:E.Schema.number().default(15).description("显示条目数量"),buff:E.Schema.boolean().default(!0).description("buff"),igxe:E.Schema.boolean().default(!0).description("igxe"),c5:E.Schema.boolean().default(!1).description("c5"),uuyp:E.Schema.boolean().default(!1).description("uuyp"),game:E.Schema.union([E.Schema.const("csgo-dota2").description("全部"),E.Schema.const("dota2").description("仅看dota2"),E.Schema.const("csgo").description("仅看csgo")]).description("游戏").default("csgo-dota2"),order:E.Schema.union([E.Schema.const("buy").description("最优求购"),E.Schema.const("safe_buy").description("稳定求购"),E.Schema.const("sell").description("最优寄售")]).description("排序依据").default("safe_buy"),min_price:E.Schema.number().description("最低价格").default(1),max_price:E.Schema.number().description("最高价格").default(5e3),min_volume:E.Schema.number().description("最低成交量").default(2),buy:E.Schema.boolean().default(!1).description("最优求购比例"),safe_buy:E.Schema.boolean().default(!0).description("稳定求购比例"),sell:E.Schema.boolean().default(!0).description("寄售比例"),loadTimeout:E.Schema.natural().role("ms").description("加载页面的最长时间。当一个页面等待时间超过这个值时，如果此页面主体已经加载完成，则会发送一条提示消息“正在加载中，请稍等片刻”并继续等待加载；否则会直接提示“无法打开页面”并终止加载。").default(E.Time.second*10),idleTimeout:E.Schema.natural().role("ms").description("等待页面空闲的最长时间。当一个页面等待时间超过这个值时，将停止进一步的加载并立即发送截图。").default(E.Time.second*30)}).description("截图设置");M.inject={required:["puppeteer"]};function Gi(e,t){let i=t.buff?"buff-":"",r=t.igxe?"igxe-":"",l=t.c5?"c5-":"",n=t.uuyp?"uuyp-":"",s=t.game,h=t.order;var o=i+r+l+n;o.length<3&&(o="buff-"),o=o.slice(0,-1),e.i18n.define("zh",Ot());let{loadTimeout:a,idleTimeout:u}=t;e.command("trad.行情分析 <url:string>").action(async({session:d},p)=>{let _=p||"https://www.iflow.work/analysis",b=!1,T=await e.puppeteer.page();T.on("load",()=>b=!0),d.send("正在加载中，请稍等片刻~");try{await new Promise((g,R)=>{me.info(`navigating to ${_}`);let B=()=>{clearTimeout(L),g()};T.goto(_,{waitUntil:"networkidle0",timeout:u}).then(B,()=>b?B():R(new Error("navigation timeout")));let L=setTimeout(()=>b?d.send("正在加载中，请稍等片刻~"):R(new Error("navigation timeout")),a)})}catch(g){return T.close(),me.info(String(g)),"无法打开页面。"}let m=T;return m?m.screenshot({fullPage:!0}).then(async g=>{if(_.indexOf("https://www.iflow.work/steam?platform")==-1)return E.h.image(g,"image/png");let R=_e.PNG.sync.read(g),B=Math.ceil(t.text_len*100+850),L=c.alloc(R.width*B*4);for(let V=0;V<B;V++)for(let W=0;W<R.width;W++){let ge=R.width*V+W<<2,Lt=R.width*Math.min(V,B-1)+W<<2;R.data.copy(L,Lt,ge,ge+4)}let $=new _e.PNG({width:R.width,height:B});return $.data=L,g=_e.PNG.sync.write($),E.h.image(g,"image/png")},g=>(me.info(String(g)),"截图失败。")).finally(()=>T.close()):"找不到满足该选择器的元素。"}),e.command("trad <platform:string>","['buff', 'igxe', 'c5', 'uuyp']").option("game","-g <game:string>").option("order","-o <order:string>").action(async({session:d,options:p},_)=>{_&&o.includes(_)&&(o=_),s=p.game&&["dota2","csgo","dota2-csgo","csgo-dota2"].includes(p.game)?p.game:s,h=p.order&&["buy","safe_buy","sell"].includes(p.order)?p.order:h;let b=`https://www.iflow.work/steam?platform=${o??"buff"}&game=${s}&order=${t.order}&pagenum=1&min_price=${t.min_price}&max_price=${t.max_price}&min_volume=${t.min_volume}`;return d.execute(`trad.行情分析 ${b}`)})}});export default Fi();
