import{Buffer as m}from"https://registry.koishi.chat/modules/buffer/index.js";import d from"https://registry.koishi.chat/modules/process/index.js";import{h as j,Service as _}from"https://registry.koishi.chat/modules/koishi/index.js";var b=Object.defineProperty,w=(t,e)=>b(t,"name",{value:e,configurable:!0}),x=class extends _{static{w(this,"CanvasService")}constructor(t){super(t,"canvas")}async render(t,e,a){let n=await this.createCanvas(t,e);try{await a(n.getContext("2d"));let i=await n.toBuffer("image/png");return j.image(i,"image/png")}finally{await n.dispose()}}},p=x;import{base64ToArrayBuffer as S}from"https://registry.koishi.chat/modules/koishi/index.js";import{h as g,hyphenate as L}from"https://registry.koishi.chat/modules/koishi/index.js";var C=Object.defineProperty,o=(t,e)=>C(t,"name",{value:e,configurable:!0}),r=Symbol("canvas"),B=class{static{o(this,"CanvasElement")}[r];constructor(t){this[r]=t}get width(){return this[r].width}get height(){return this[r].height}getContext(t){let e=this[r].getContext(t);return new Proxy(e,{get(a,n,i){return n==="drawImage"?new Proxy(a[n],{apply(l,h,[s,...y]){return s[r]&&(s=s[r]),l.call(h,s,...y)}}):Reflect.get(a,n,i)}})}async toDataURL(){return this[r].toDataURL()}async toBuffer(){let t=this[r].toDataURL();return m.from(t.slice(t.indexOf(",")+1),"base64")}async dispose(){}},R=class{static{o(this,"ImageElement")}[r];constructor(t){this[r]=t}get naturalWidth(){return this[r].naturalWidth}get naturalHeight(){return this[r].naturalHeight}async dispose(){}},E=class extends p{static{o(this,"default")}async createCanvas(t,e){let a=document.createElement("canvas");return a.width=t,a.height=e,new B(a)}async loadImage(t){let e=document.createElement("img");if(typeof t=="string"||t instanceof URL)e.src=t.toString();else{m.isBuffer(t)&&(t=S(t.toString("base64")));let a=new Blob([t]);e.src=URL.createObjectURL(a)}return new Promise((a,n)=>{e.onload=()=>a(new R(e)),e.onerror=n})}};function u(t,e={}){return Object.entries({...e,...t}).map(([a,n])=>`${L(a)}: ${Array.isArray(n)?n.join(", "):n}`).join("; ")}o(u,"transformStyle");function v(t){t.component("html",async(e,a,n)=>{let i=[],l=o(c=>{if(c.type==="head"){i.push(...c.children);return}let f={...c.attrs};return typeof f.style=="object"&&(f.style=u(f.style)),g(c.type,f,c.children.map(l).filter(Boolean))},"transform"),h=typeof e.style=="object"?u({display:"inline-block"},e.style):["display: inline-block",e.style].filter(Boolean).join("; "),s=a.map(l).filter(Boolean).join("");return s=`<html${e.lang?` lang="${e.lang}"`:""}>
      <head>${i.join("")}</head>
      <body style="${h}">${s}</body>
    </html>`,g("iframe",{content:s})})}o(v,"default");var q="browser";function P(t){t.plugin(E),t.plugin(v)}o(P,"apply");export{P as apply,q as name};
