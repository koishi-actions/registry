var I=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var te=Object.getOwnPropertyNames;var ae=Object.prototype.hasOwnProperty;var F=(r,e)=>()=>(r&&(e=r(r=0)),e);var R=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var x=(r,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of te(e))!ae.call(r,o)&&o!==t&&I(r,o,{get:()=>e[o],enumerable:!(a=ee(e,o))||a.enumerable});return r},s=(r,e,t)=>(x(r,e,"default"),t&&x(t,e,"default"));var b=r=>x(I({},"__esModule",{value:!0}),r);import{Buffer as c}from"https://registry.koishi.chat/modules/buffer/index.js";import m from"https://registry.koishi.chat/modules/process/index.js";var i=F(()=>{});var g={};import*as he from"https://registry.koishi.chat/modules/@satorijs/element/jsx-runtime/index.js";var z=F(()=>{i();s(g,he)});var $={};import*as ge from"https://registry.koishi.chat/modules/koishi/index.js";var O=F(()=>{i();s($,ge)});var C=R(($e,Y)=>{i();Y.exports=typeof self=="object"?self.FormData:window.FormData});var h={};import*as Ue from"https://registry.koishi.chat/modules/axios/index.js";var E=F(()=>{i();s(h,Ue)});var w={};import*as Fe from"https://registry.koishi.chat/modules/@cordiverse/fs/index.js";var N=F(()=>{i();s(w,Fe)});import re from"https://registry.koishi.chat/modules/@cordiverse/path/index.js";var X=R((ke,W)=>{i();W.exports=re});var K=R(_=>{"use strict";i();var D=_&&_.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(_,"__esModule",{value:!0});_.FileUploader=void 0;var k=D((E(),b(h))),oe=D((N(),b(w))),J=D(C()),ie=D(X()),L=class{username;password;apiURL;otp_code;constructor(e,t,a,o){this.username=e,this.password=t,this.apiURL=a,this.otp_code=o||null}async test(){return`${this.username} | ${this.password} | ${this.apiURL}`}async getToken(){try{let e=await k.default.post(`${this.apiURL}/api/auth/login`,{username:this.username,password:this.password,otp_code:this.otp_code},{headers:{"content-type":"application/json"}});return e.data.code?e.data.data.token:void 0}catch(e){throw e}}async postMkdir(e){let t=await this.getToken();if(t)try{return(await k.default.post(`${this.apiURL}/api/fs/mkdir`,{path:`${e}`},{headers:{Authorization:`${t}`,"content-type":"application/json"}})).data.code==200?"创建成功!":void 0}catch(a){throw a}else return}async uploadLocalFile(e,t){let a=await this.getToken();if(a)try{let o=new J.default;o.append("file",oe.default.createReadStream(e));let u={Authorization:a,"File-Path":encodeURIComponent(t),"As-Task":"true",...o.getHeaders()};return(await k.default.put(`${this.apiURL}/api/fs/form`,o,{headers:u})).data}catch(o){throw o}else return}async uploadRemoteFile(e,t){let a;try{let u=await k.default.get(e,{responseType:"arraybuffer"});a=c.from(u.data)}catch(u){throw u}let o=await this.getToken();if(o&&a)try{let u=new J.default;u.append("file",a,{filename:ie.default.basename(t)});let U={Authorization:o,"File-Path":encodeURIComponent(t),"As-Task":"true",...u.getHeaders()};return(await k.default.put(`${this.apiURL}/api/fs/form`,u,{headers:U})).data}catch{}else return}};_.FileUploader=L});var ne=R(n=>{i();var G=n&&n.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(n,"__esModule",{value:!0});n.apply=n.Config=n.usage=n.name=void 0;var Q=(z(),b(g)),l=(O(),b($)),Pe=G(C()),Re=G((E(),b(h))),se=K();n.name="imgupload";n.usage=`
## 配置项参考
alistUrl: http://alist.example.com  
alistUser: admin (有上传权限的用户)  
alistPassword: password (该用户的密码)  
2FA: 2FA_KEY (如果alist开了2FA啾必须填2FA码)  
basePath: /mnt/img (alist挂载能上传文件的路径)

## 注意
* 命令imgupload <img> 中img为链接的话只能解析一个链接，图片可以解析多张
* 命令imgupload -f <folder> 的foler不能有除了下滑线与减号的符号，可以使用中文
`;var j=new l.Logger(n.name);n.Config=l.Schema.object({alistUrl:l.Schema.string().default("http://localhost:5244").role("link").description("alist地址"),alistUser:l.Schema.string().required().description("alist账号（请确认账号有权限操作）"),alistPassword:l.Schema.string().required().role("secret").description("alist密码"),alist_opt_code:l.Schema.string().role("secret").description("两步验证码(2FA), alist开了2FA就得填"),basePath:l.Schema.string().required().description("图片存储基本路径"),sendnotice:l.Schema.boolean().default(!1).description("图片上传前是否发送开始上传……"),imgshareUrl:l.Schema.string().default("http://localhost:8080").role("link").description("图片分享地址"),sendwait:l.Schema.number().default(3e4).description("等待图片发送时间(ms)"),coiledCount:l.Schema.number().default(10).description("连续发送夺少张图后退出循环")});function le(r,e){r.command("imgupload <img>",`将聊天中的图片或url分享到图床${e.imgshareUrl}`).alias("图片上传").option("folder","-f <path:string> 指定上传的文件夹").option("time","-t <time:number> 等待图片上传时间").option("gif","-g 是否为gif").option("coiled","-c 开启连续上传模式，以$或￥结束").action(async({session:t,options:a},o)=>{let u=/https?:\/\/((?:[\w-]+\.){0,}(?:[a-z]+\d*|localhost|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}))(?::\d{2,5})?\/?.*/;if(e.alistUrl.match(u)){let p="",f=new Date,T=`${f.getFullYear()}${f.getMonth()+1}${f.getDate()}${f.getHours()}${f.getMinutes()}${f.getSeconds()}`,B=0,V=/[^\w\u4e00-\u9fa5-]/,M=/\/$/.test(e.basePath)?e.basePath:e.basePath+"/",q=a.folder?a.folder.toString().match(V)?"":a.folder.toString():"",H=new se.FileUploader(e.alistUser,e.alistPassword,e.alistUrl,e.alist_opt_code?e.alist_opt_code:null),S=o?o.match(/^(\s+)?https?:\/\/(.*)/):null;if(S&&S[0])try{e.sendnotice&&t.send("图片开始上传……");let d=await H.uploadRemoteFile(S[0].replace(/(\s+)?/,""),`${M}${q?q+"/":""}${t.userId}_${T}-p${B++}.${a.gif?"gif":"png"}`);return d.code==200?`来自远程url的图片上传成功! 图片分享地址 ${e.imgshareUrl?e.imgshareUrl:"图片暂不公开分享"}`:(j.error(`图片上传失败!请检查配置是否正确${d}`),`图片上传失败!${d.code} | ${d.message}`)}catch(d){return j.error(`图片上传失败：(imgurl: ${S[0].replace(/(\s+)?/,"")})`,d),"url图片上传失败，请检查url是否可访问！"}let v=a.coiled?t.quote?1:e.coiledCount:1;for(v=t.quote?1:v,!t.quote&&!o&&await t.send(`请发送图片${a.coiled?`(连发模式,上限${e.coiledCount})张,$或￥结束`:""}>>`);v--;){if(!t.quote&&!o){let y=a.time&&Number(a.time)>0?a.time:e.sendwait;p=await t.prompt(y)}else t.quote&&(p=1);if((p.toString().includes("$")||p.toString().includes("￥"))&&a.coiled||!p)break;let d=o?l.h.select(o,"img"):t.quote?l.h.select(t.quote.content,"img"):p?l.h.select(p,"img"):null;if(d&&d[0]){let y=[];var U=0;for(let Z of d){let{src:A}=Z.attrs;try{e.sendnotice&&t.send("图片开始上传……");let P=await H.uploadRemoteFile(A,`${M}${q||""}/${t.userId}_${T}-p${B++}.${a.gif?"gif":"png"}`);P.code!=200&&(U++,j.error(`来自${A}的图片上传失败： ${P}`))}catch(P){y.push(A),j.error(`图片上传失败：(imgurl: ${A})`,P)}}y.length>0||U>0?await t.send(`图片上传失败：${y.join(", ")}, 请查看log`):a.coiled||await t.send(`所有图片上传完成，图片分享地址 ${e.imgshareUrl?e.imgshareUrl:"图片暂不公开分享"}`)}else return`未检测到图片或输入超时……${a.coiled?"已退出连发模式":""}`}if(a.coiled)return`连发退出，所有图片上传完成！图片分享地址 ${e.imgshareUrl?e.imgshareUrl:"图片暂不公开分享"}`}else return(0,Q.jsx)(Q.Fragment,{children:"错误的图片上传地址，请联系管理员……"})})}n.apply=le});export default ne();
