var x=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var U=Object.prototype.hasOwnProperty;var _=(t,e)=>()=>(t&&(e=t(t=0)),e);var W=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var h=(t,e,o,p)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of R(e))!U.call(t,r)&&r!==o&&x(t,r,{get:()=>e[r],enumerable:!(p=D(e,r))||p.enumerable});return t},i=(t,e,o)=>(h(t,e,"default"),o&&h(o,e,"default"));var P=t=>h(x({},"__esModule",{value:!0}),t);import{Buffer as y}from"https://registry.koishi.chat/modules/buffer/index.js";import b from"https://registry.koishi.chat/modules/process/index.js";var c=_(()=>{});var m={};import*as re from"https://registry.koishi.chat/modules/koishi/index.js";var $=_(()=>{c();i(m,re)});var l={};import*as ae from"https://registry.koishi.chat/modules/cheerio/index.js";var C=_(()=>{c();i(l,ae)});var K=W((ne,k)=>{c();var f=Object.defineProperty,A=Object.getOwnPropertyDescriptor,B=Object.getOwnPropertyNames,G=Object.prototype.hasOwnProperty,J=(t,e)=>f(t,"name",{value:e,configurable:!0}),M=(t,e)=>{for(var o in e)f(t,o,{get:e[o],enumerable:!0})},z=(t,e,o,p)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of B(e))!G.call(t,r)&&r!==o&&f(t,r,{get:()=>e[r],enumerable:!(p=A(e,r))||p.enumerable});return t},E=t=>z(f({},"__esModule",{value:!0}),t),j={};M(j,{Config:()=>H,apply:()=>L,name:()=>I});k.exports=E(j);var s=($(),P(m)),F=(C(),P(l)),H=s.Schema.object({strict:s.Schema.computed(s.Schema.boolean()).default(!1).description("仅匹配只含链接的消息。"),ignored:s.Schema.array(s.Schema.string()).description("忽略特定域名的链接。"),sendTitle:s.Schema.boolean().default(!1).description("同时发送标题。"),sendSiteName:s.Schema.boolean().default(!1).description("标题和原链接域名均不包含站点名的话，就发送站点名。")}),I="OpenGraph",d=new s.Logger("og");function L(t,e){t.on("message",async o=>{let p=o.resolve(e.strict)?/^https?:\/\/\S+$/g:/https?:\/\/\S+/g,r=o.content.trim().match(p);if(!r)return;d.debug("提取出的链接：",r);let N=r.map(async a=>{if(e.ignored?.some(g=>a.startsWith(g)))return"";try{let{data:g,headers:T}=await t.http(a,{responseType:"text"});if(!T.get("content-type")?.startsWith("text/html"))return d.debug(`从 ${a} 上抓取下来的数据的 content-type 不是 text/html。终止对该链接的处理流程。`),"";let n=(0,F.load)(g)('meta[property^="og:"]').toArray().reduce((w,S)=>{let q=S.attribs.property.slice(3),O=S.attribs.content;return O&&(w[q]=O),w},{}),u="";return n.site_name&&e.sendSiteName&&!n.title.toLowerCase().includes(n.site_name.toLowerCase())&&!new URL(a).host.toLowerCase().includes(n.site_name.toLowerCase())&&(u+=`${n.site_name} - `),n.title&&e.sendTitle&&(u+=`${n.title}`),n.image&&(u+=(0,s.h)("img",{src:new URL(n.image,a).href})),d.debug(`从 ${a} 生成了预览：${u}`),u}catch(g){return d.warn(`处理 ${a} 时出错：`,g),""}}),v=(await Promise.all(N)).filter(a=>a).join(`
`);d.debug(`发送：${v}`),await o.send(v)})}J(L,"apply")});export default K();
