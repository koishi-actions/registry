var g=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var j=Object.prototype.hasOwnProperty;var l=(e,t)=>()=>(e&&(t=e(e=0)),t);var x=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var f=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of O(t))!j.call(e,o)&&o!==n&&g(e,o,{get:()=>t[o],enumerable:!(s=P(t,o))||s.enumerable});return e},c=(e,t,n)=>(f(e,t,"default"),n&&f(n,t,"default"));var H=e=>f(g({},"__esModule",{value:!0}),e);import{Buffer as h}from"https://registry.koishi.chat/modules/buffer/index.js";import v from"https://registry.koishi.chat/modules/process/index.js";var p=l(()=>{});var m={};import*as L from"https://registry.koishi.chat/modules/koishi/index.js";var _=l(()=>{p();c(m,L)});var B=x((Q,w)=>{p();var T=Object.defineProperty,S=Object.getOwnPropertyDescriptor,$=Object.getOwnPropertyNames,k=Object.prototype.hasOwnProperty,u=(e,t)=>T(e,"name",{value:t,configurable:!0}),C=(e,t)=>function(){return t||(0,e[$(e)[0]])((t={exports:{}}).exports,t),t.exports},q=(e,t)=>{for(var n in t)T(e,n,{get:t[n],enumerable:!0})},z=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of $(t))!k.call(e,o)&&o!==n&&T(e,o,{get:()=>t[o],enumerable:!(s=S(t,o))||s.enumerable});return e},D=e=>z(T({},"__esModule",{value:!0}),e),M=C({"plugins/dialogue/packages/time/src/locales/zh.yml"(e,t){t.exports={commands:{teach:{options:{startTime:"起始时间",endTime:"结束时间"},messages:{time:{detail:"触发时段：","invalid-input":"请输入正确的时间。"}}}}}}}),y={};q(y,{Config:()=>J,apply:()=>b,isHours:()=>d,name:()=>N,using:()=>R});w.exports=D(y);var E=(_(),H(m));function d(e){if(!/^\d+(:\d+)?$/.test(e))throw new Error("commands.teach.messages.time.invalid-input");let[t,n="0"]=e.split(":"),s=+t,o=+n;if(s>=0&&s<24&&o>=0&&o<60)return e;throw new Error("commands.teach.messages.time.invalid-input")}u(d,"isHours");var J=E.Schema.object({}),N="koishi-plugin-dialogue-time",R=["database"];function b(e,t){e.i18n.define("zh",M()),e.model.extend("dialogue",{startTime:"integer",endTime:"integer"}),e.on("dialogue/usage",(i,r)=>{i.add("　设置起始时间：　-t time",450),i.add("　设置结束时间：　-T time",450)}),e.command("teach").option("startTime","-t <time>",{type:d}).option("endTime","-T <time>",{type:d});function n(i){let[r,a="0"]=i.split(":");return+r*60+ +a}u(n,"parseTime"),e.before("dialogue/search",(i,r)=>{let{options:a}=i.argv;a.startTime!==void 0&&(r.matchTime=n(a.startTime)),a.endTime!==void 0&&(r.mismatchTime=n(a.endTime))}),e.on("dialogue/receive",i=>{let r=new Date;i.test.matchTime=r.getHours()*60+r.getMinutes()}),e.on("dialogue/modify",async(i,r)=>{let{options:a}=i.argv;a.startTime!==void 0?r.startTime=n(a.startTime):a.action==="create"&&(r.startTime=0),a.endTime!==void 0?r.endTime=n(a.endTime):a.action==="create"&&(r.endTime=0)});function s(i){let r=Math.floor(i/60),a=i-r*60;return`${r}:${a.toString().padStart(2,"0")}`}u(s,"formatTime"),e.on("dialogue/detail",(i,r,a)=>{i.startTime!==i.endTime&&r.add(`${a.text(".time.detail")}${s(i.startTime)}-${s(i.endTime)}`,800)}),e.on("dialogue/abstract",(i,r)=>{i.startTime!==i.endTime&&r.push(`${s(i.startTime)}-${s(i.endTime)}`)});let o=u(i=>({$multiply:[{$subtract:[{$:"endTime"},{$:"startTime"}]},{$subtract:[{$:"startTime"},i]},{$subtract:[i,{$:"endTime"}]}]}),"getRangeProduct");e.on("dialogue/query",(i,r)=>{i.matchTime!==void 0&&r.$and.push({$expr:{$gte:[o(i.matchTime),0]}}),i.mismatchTime!==void 0&&r.$and.push({$expr:{$lt:[o(i.mismatchTime),0]}})})}u(b,"apply")});export default B();
