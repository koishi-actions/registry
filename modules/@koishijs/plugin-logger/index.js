var C=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var T=Object.getOwnPropertyNames;var V=Object.prototype.hasOwnProperty;var v=(e,t)=>()=>(e&&(t=e(e=0)),t);var $=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var I=(e,t,a,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of T(t))!V.call(e,r)&&r!==a&&C(e,r,{get:()=>t[r],enumerable:!(o=M(t,r))||o.enumerable});return e},s=(e,t,a)=>(I(e,t,"default"),a&&I(a,t,"default"));var y=e=>I(C({},"__esModule",{value:!0}),e);import{Buffer as h}from"https://registry.koishi.chat/modules/buffer/index.js";import u from"https://registry.koishi.chat/modules/process/index.js";var n=v(()=>{});var f={};import*as de from"https://registry.koishi.chat/modules/koishi/index.js";var N=v(()=>{n();s(f,de)});var d={};import*as _e from"https://registry.koishi.chat/modules/@koishijs/plugin-console/index.js";var q=v(()=>{n();s(d,_e)});import G from"https://registry.koishi.chat/modules/@cordiverse/path/index.js";var B=$((ye,A)=>{n();A.exports=G});var m={};import*as xe from"https://registry.koishi.chat/modules/@cordiverse/fs/promises/index.js";var j=v(()=>{n();s(m,xe)});var g={};import*as be from"https://registry.koishi.chat/modules/buffer/index.js";var L=v(()=>{n();s(g,be)});var ce=$((ke,H)=>{n();var O=Object.defineProperty,Q=Object.getOwnPropertyDescriptor,R=Object.getOwnPropertyNames,U=Object.prototype.hasOwnProperty,b=(e,t)=>O(e,"name",{value:t,configurable:!0}),X=(e,t)=>{for(var a in t)O(e,a,{get:t[a],enumerable:!0})},Y=(e,t,a,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of R(t))!U.call(e,r)&&r!==a&&O(e,r,{get:()=>t[r],enumerable:!(o=Q(t,r))||o.enumerable});return e},Z=e=>Y(O({},"__esModule",{value:!0}),e),E={};X(E,{Config:()=>pe,apply:()=>F,name:()=>ie});H.exports=Z(E);var l=(N(),y(f)),ee=(q(),y(d)),te=B(),z=(j(),y(m)),re=(j(),y(m)),ae=(L(),y(g)),oe=class{constructor(e,t){this.date=e,this.path=t,this.task=(0,re.open)(t,"a+").then(async a=>{let o=await a.readFile();return this.data=this.parse(new TextDecoder().decode(o)),this.size=o.byteLength,a}),this.task.then(()=>this.flush())}static{b(this,"FileWriter")}data;task;size;temp=[];flush(){this.temp.length&&(this.task=this.task.then(async e=>{let t=ae.Buffer.from(this.temp.map(a=>JSON.stringify(a)+`
`).join(""));return await e.write(t),this.data.push(...this.temp),this.size+=t.byteLength,this.temp=[],e}))}parse(e){return e.split(`
`).map(t=>{try{return JSON.parse(t)}catch{}}).filter(Boolean)}async read(){return await this.task,this.data}write(e){this.temp.push(e),this.flush()}async close(){await(await this.task).close()}},se={root:"存放输出日志的本地目录。",maxAge:"日志文件保存的最大天数。",maxSize:"单个日志文件的最大大小。"},ie="logger",ne=class extends ee.DataService{constructor(e,t){super(e,"logs",{authority:4}),this.getWriter=t,e.console.addEntry(["https://registry.koishi.chat/modules/@koishijs/plugin-logger/dist/index.js","https://registry.koishi.chat/modules/@koishijs/plugin-logger/dist/style.css"])}static{b(this,"LogProvider")}async get(){return this.getWriter()?.read()}},pe=l.Schema.object({root:l.Schema.path({filters:["directory"],allowCreate:!0}).default("data/logs"),maxAge:l.Schema.natural().default(30),maxSize:l.Schema.natural().default(1024*100)}).i18n({"zh-CN":se});async function F(e,t){let a=(0,te.resolve)(e.baseDir,t.root);await(0,z.mkdir)(a,{recursive:!0});let o={};for(let i of await(0,z.readdir)(a)){let c=/^(\d{4}-\d{2}-\d{2})-(\d+)\.log$/.exec(i);c&&(o[c[1]]??=[],o[c[1]].push(+c[2]))}let r;async function w(i,c){r=new oe(i,`${a}/${i}-${c}.log`);let{maxAge:p}=t;if(!p)return;let S=Date.now();for(let x of Object.keys(o))if(!(S-+new Date(x)<p*l.Time.day)){for(let W of o[x])await(0,z.rm)(`${a}/${x}-${W}.log`).catch(J=>{e.logger("logger").warn(J)});delete o[x]}}b(w,"createFile");let D=new Date().toISOString().slice(0,10);w(D,Math.max(...o[D]??[0])+1);let k=[],K=e.throttle(()=>{e.get("console")?.patch("logs",k),k=[]},100),_=e.get("loader"),P={colors:3,record:i=>{i.meta||={};let c=i.meta[l.Context.current]?.scope;_&&c&&(i.meta.paths=_.paths(c));let p=new Date(i.timestamp).toISOString().slice(0,10);if(r.date!==p&&(r.close(),o[p]=[1],w(p,1)),r.write(i),k.push(i),K(),r.size>=t.maxSize){r.close();let S=Math.max(...o[p]??[0])+1;o[p]??=[],o[p].push(S),w(p,S)}}};l.Logger.targets.push(P),e.on("dispose",()=>{r?.close(),(0,l.remove)(l.Logger.targets,P),_&&(_.prolog=[])});for(let i of _?.prolog||[])P.record(i);e.plugin(ne,()=>r)}b(F,"apply")});export default ce();
