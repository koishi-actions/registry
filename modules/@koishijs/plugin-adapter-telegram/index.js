var le=Object.create;var D=Object.defineProperty;var de=Object.getOwnPropertyDescriptor;var ce=Object.getOwnPropertyNames;var he=Object.getPrototypeOf,pe=Object.prototype.hasOwnProperty;var N=(t,e)=>()=>(t&&(e=t(t=0)),e);var me=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),fe=(t,e)=>{for(var s in e)D(t,s,{get:e[s],enumerable:!0})},R=(t,e,s,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of ce(e))!pe.call(t,a)&&a!==s&&D(t,a,{get:()=>e[a],enumerable:!(i=de(e,a))||i.enumerable});return t},m=(t,e,s)=>(R(t,e,"default"),s&&R(s,e,"default")),Q=(t,e,s)=>(s=t!=null?le(he(t)):{},R(e||!t||!t.__esModule?D(s,"default",{value:t,enumerable:!0}):s,t)),C=t=>R(D({},"__esModule",{value:!0}),t);import{Buffer as P}from"https://registry.koishi.chat/modules/buffer/index.js";import O from"https://registry.koishi.chat/modules/process/index.js";var v=N(()=>{});var b={};import*as Ee from"https://registry.koishi.chat/modules/@satorijs/core/index.js";var q=N(()=>{v();m(b,Ee)});var U={};import*as Oe from"https://registry.koishi.chat/modules/@cordiverse/url/index.js";var K=N(()=>{v();m(U,Oe)});var E={};import*as je from"https://registry.koishi.chat/modules/file-type/index.js";var X=N(()=>{v();m(E,je)});var J=me((Be,ae)=>{v();var ue=Object.create,B=Object.defineProperty,ge=Object.getOwnPropertyDescriptor,_e=Object.getOwnPropertyNames,ye=Object.getPrototypeOf,we=Object.prototype.hasOwnProperty,_=(t,e)=>B(t,"name",{value:e,configurable:!0}),Y=(t,e)=>{for(var s in e)B(t,s,{get:e[s],enumerable:!0})},Z=(t,e,s,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of _e(e))!we.call(t,a)&&a!==s&&B(t,a,{get:()=>e[a],enumerable:!(i=ge(e,a))||i.enumerable});return t},ve=(t,e,s)=>(s=t!=null?ue(ye(t)):{},Z(e||!t||!t.__esModule?B(s,"default",{value:t,enumerable:!0}):s,t)),be=t=>Z(B({},"__esModule",{value:!0}),t),ee={};Y(ee,{HttpPolling:()=>j,HttpServer:()=>A,Internal:()=>n,SenderError:()=>Me,Telegram:()=>te,TelegramBot:()=>L,TelegramMessageEncoder:()=>se,decodeGuildMember:()=>z,decodeMessage:()=>T,decodeUser:()=>I,default:()=>Ie,handleUpdate:()=>H});ae.exports=be(ee);var f=(q(),C(b)),Se=(K(),C(U)),te={};Y(te,{Internal:()=>n});var n=class ie{constructor(e){this.bot=e}static{_(this,"Internal")}static define(e){ie.prototype[e]=async function(s={}){this.bot.logger.debug("[request] %s %o",e,s);try{let i=await this.bot.http.post("/"+e,s);this.bot.logger.debug("[response] %o",i);let{ok:a,result:o}=i;if(a)return o;throw new Error(`Telegram API error ${i.data.error_code}. ${i.data.description}`)}catch(i){throw i.response?.data?.error_code&&i.response.data.description?new Error(`Telegram API error ${i.response.data.error_code}. ${i.response.data.description}`):i}}}};n.define("answerInlineQuery");n.define("answerWebAppQuery");n.define("sendGame");n.define("setGameScore");n.define("getGameHighScores");n.define("setPassportDataErrors");n.define("sendInvoice");n.define("createInvoiceLink");n.define("answerShippingQuery");n.define("answerPreCheckoutQuery");n.define("sendSticker");n.define("getStickerSet");n.define("getCustomEmojiStickers");n.define("uploadStickerFile");n.define("createNewStickerSet");n.define("addStickerToSet");n.define("setStickerPositionInSet");n.define("deleteStickerFromSet");n.define("setStickerSetThumb");n.define("getUpdates");n.define("setWebhook");n.define("deleteWebhook");n.define("getWebhookInfo");n.define("getMe");n.define("logOut");n.define("close");n.define("sendMessage");n.define("forwardMessage");n.define("copyMessage");n.define("sendPhoto");n.define("sendAudio");n.define("sendDocument");n.define("sendVideo");n.define("sendAnimation");n.define("sendVoice");n.define("sendVideoNote");n.define("sendMediaGroup");n.define("sendLocation");n.define("editMessageLiveLocation");n.define("stopMessageLiveLocation");n.define("sendVenue");n.define("sendContact");n.define("sendPoll");n.define("sendDice");n.define("sendChatAction");n.define("getUserProfilePhotos");n.define("getFile");n.define("banChatMember");n.define("unbanChatMember");n.define("restrictChatMember");n.define("promoteChatMember");n.define("setChatAdministratorCustomTitle");n.define("banChatSenderChat");n.define("unbanChatSenderChat");n.define("setChatPermissions");n.define("exportChatInviteLink");n.define("createChatInviteLink");n.define("editChatInviteLink");n.define("revokeChatInviteLink");n.define("approveChatJoinRequest");n.define("declineChatJoinRequest");n.define("setChatPhoto");n.define("deleteChatPhoto");n.define("setChatTitle");n.define("setChatDescription");n.define("pinChatMessage");n.define("unpinChatMessage");n.define("unpinAllChatMessages");n.define("leaveChat");n.define("getChat");n.define("getChatAdministrators");n.define("getChatMemberCount");n.define("getChatMember");n.define("setChatStickerSet");n.define("deleteChatStickerSet");n.define("getForumTopicIconStickers");n.define("createForumTopic");n.define("editForumTopic");n.define("closeForumTopic");n.define("reopenForumTopic");n.define("deleteForumTopic");n.define("unpinAllForumTopicMessages");n.define("editGeneralForumTopic");n.define("closeGeneralForumTopic");n.define("reopenGeneralForumTopic");n.define("hideGeneralForumTopic");n.define("unhideGeneralForumTopic");n.define("answerCallbackQuery");n.define("setMyCommands");n.define("deleteMyCommands");n.define("getMyCommands");n.define("setChatMenuButton");n.define("getChatMenuButton");n.define("setMyDefaultAdministratorRights");n.define("getMyDefaultAdministratorRights");n.define("editMessageText");n.define("editMessageCaption");n.define("editMessageMedia");n.define("editMessageReplyMarkup");n.define("stopPoll");n.define("deleteMessage");var h=(q(),C(b)),I=_(t=>({id:t.id.toString(),name:t.username,nick:t.first_name+(t.last_name?" "+t.last_name:""),isBot:t.is_bot}),"decodeUser"),z=_(t=>({user:I(t.user),title:t.custom_title}),"decodeGuildMember"),x=new Map;async function H(t,e){e.logger.debug("receive %s",JSON.stringify(t));let s=Object.keys(t).filter(r=>r!=="update_id")[0];s&&e.dispatch(e.session({type:"internal",_type:`telegram/${s.replace(/_/g,"-")}`,_data:t[s]}));let i=e.session();i.setInternal("telegram",t);let a=t.message||t.edited_message||t.channel_post||t.edited_channel_post,o=t.message&&t.message.entities?.[0].type==="bot_command",c=a?.from?.language_code;if(c&&(c==="zh-hans"?i.locales=["zh-CN"]:c==="zh-hant"?i.locales=["zh-TW"]:i.locales=[c.slice(0,2)]),o){i.type="interaction/command",await T(e,a,i.event.message={},i.event);let[r]=i.content.split(" ",1),[l,d]=r.slice(1).split("@");if(d&&d!==e.user.name)return;i.content=l+i.content.slice(r.length)}else if(a)if(t.message?.media_group_id){x.has(t.message.media_group_id)||x.set(t.message.media_group_id,[new Date,[]]);let[,r]=x.get(t.message.media_group_id);i.type=t.message||t.channel_post?"message":"message-updated",await T(e,a,i.event.message={},i.event),r.push({id:t.message.message_id,elements:i.event.message.elements});let l=new Date;if(x.set(t.message.media_group_id,[l,r]),await new Promise(d=>setTimeout(d,1200)),x.get(t.message.media_group_id)[0]===l)x.delete(t.message.media_group_id),i.event.message.elements=r.sort((d,u)=>d.id-u.id).reduce((d,u)=>d.concat(u.elements),[]),i.event.message.content=i.event.message.elements.join(""),i.event.message.id=Math.min(...r.map(d=>d.id)).toString(),i.event._data.mediaGroup=r.map(d=>d.id);else return}else i.type=t.message||t.channel_post?"message":"message-updated",await T(e,a,i.event.message={},i.event);else if(t.chat_join_request)i.timestamp=t.chat_join_request.date*1e3,i.type="guild-member-request",i.messageId=`${t.chat_join_request.chat.id}@${t.chat_join_request.from.id}`,i.content="",i.channelId=t.chat_join_request.chat.id.toString(),i.guildId=i.channelId;else if(t.my_chat_member)i.timestamp=t.my_chat_member.date*1e3,i.messageId=`${t.my_chat_member.chat.id}@${t.my_chat_member.from.id}`,i.content="",i.channelId=t.my_chat_member.chat.id.toString(),i.guildId=i.channelId,t.my_chat_member.old_chat_member.user.id.toString()===e.selfId&&(t.my_chat_member.new_chat_member.status==="left"?i.type="group-deleted":t.my_chat_member.old_chat_member.status==="left"&&(i.type="group-added"));else if(t.callback_query){i.type="interaction/button",i.userId=t.callback_query.from.id.toString(),i.messageId=t.callback_query.id.toString(),i.event.button={id:t.callback_query.data};let r=t.callback_query.message;r.chat.type==="private"?i.event.channel={id:r.chat.id.toString(),type:h.Universal.Channel.Type.DIRECT}:(i.event.guild={id:r.chat.id.toString(),name:r.chat.title},i.event.channel={id:r.is_topic_message?r.message_thread_id.toString():r.chat.id.toString(),type:h.Universal.Channel.Type.TEXT}),await e.internal.answerCallbackQuery({callback_query_id:t.callback_query.id})}e.dispatch(i)}_(H,"handleUpdate");async function T(t,e,s,i=s){let a=_((l,d)=>{if(!l)return[];let u=new Set;for(let g of d)u.add(g.offset),u.add(g.offset+g.length);u.add(l.length);for(let g=0;g<l.length;g++)l[g]===`
`&&(u.add(g),u.add(g+1));let oe=_(g=>{let y=[],k=null,F=null;for(let w of d)w.offset<=g&&w.offset+w.length>g&&(y.push(w.type),w.type==="text_link"?k=w.url:w.type==="text_mention"&&(F=w.user));return{attr:y,url:k,user:F}},"obtainAttributeAtBP"),V=[],G=0;for(let g of Array.from(u).sort((y,k)=>y-k)){if(G<g){let{attr:y,url:k,user:F}=oe(G),w=l.slice(G,g),p=(0,h.h)("text",{content:w});y.includes("bold")&&(p=(0,h.h)("b",{},p)),y.includes("italic")&&(p=(0,h.h)("i",{},p)),y.includes("underline")&&(p=(0,h.h)("u",{},p)),y.includes("strikethrough")&&(p=(0,h.h)("s",{},p)),y.includes("code")&&(p=(0,h.h)("code",{},p)),y.includes("pre")&&(p=(0,h.h)("pre",{},p)),y.includes("spoiler")&&(p=(0,h.h)("spl",{},p)),y.includes("mention")&&(p=(0,h.h)("at",{name:w.slice(1)})),k&&(p=(0,h.h)("a",{href:k},p)),F&&(p=(0,h.h)("at",{id:F.id,name:F.username},p)),w===`
`&&(p=(0,h.h)("br")),V.push(p)}G=g}return V},"parseText"),o=[];e.reply_to_message&&!(e.is_topic_message&&e.reply_to_message.forum_topic_created)&&(await T(t,e.reply_to_message,s.quote={},null),s.quote.user=I(e.reply_to_message.from));let c=e.text||e.caption;o.push(...a(c,[...e.entities??[],...e.caption_entities??[]])),e.caption&&o.push((0,h.h)("text",{content:" "}));let r=_(async(l,d)=>{let u=await t.$getFileFromId(d.file_id);d.file_name&&(u.filename=d.file_name),o.push((0,h.h)(l,u))},"addResource");if(e.location)o.push((0,h.h)("location",{lat:e.location.latitude,lon:e.location.longitude}));else if(e.photo){let l=e.photo.sort((d,u)=>u.file_size-d.file_size)[0];o.push((0,h.h)("img",await t.$getFileFromId(l.file_id)))}else if(e.sticker)try{let l=await t.internal.getFile({file_id:e.sticker.file_id});if(l.file_path.endsWith(".tgs"))throw new Error("tgs is not supported now");o.push((0,h.h)("img",await t.$getFileFromPath(l.file_path)))}catch(l){t.logger.warn("get file error",l),o.push((0,h.h)("text",{content:`[${e.sticker.set_name||"sticker"} ${e.sticker.emoji||""}]`}))}else e.voice?await r("audio",e.voice):e.animation?await r("img",e.animation):e.video?await r("video",e.video):e.document?await r("file",e.document):e.audio&&await r("audio",e.audio);s.elements=o,s.content=o.join(""),s.id=s.messageId=e.message_id.toString(),i&&(i.timestamp=e.date*1e3,i.user=e.from?I(e.from):{},e.chat.type==="private"?i.channel={id:e.chat.id.toString(),type:h.Universal.Channel.Type.DIRECT}:(i.guild={id:e.chat.id.toString(),name:e.chat.title},i.member={},i.channel={id:e.is_topic_message?e.message_thread_id.toString():e.chat.id.toString(),type:h.Universal.Channel.Type.TEXT}))}_(T,"decodeMessage");var W=(q(),C(b)),ke=["b","strong","i","em","u","ins","s","del","a"],se=class extends W.MessageEncoder{static{_(this,"TelegramMessageEncoder")}asset=[];payload;mode="default";rows=[];async prepare(){let t=this.session.guildId||this.channelId;this.payload={chat_id:t,parse_mode:"html",caption:""},this.session.guildId&&this.channelId!==this.session.guildId&&(this.payload.message_thread_id=+this.channelId)}async addResult(t){let e=this.bot.session();await T(this.bot,t,e.event.message={},e.event),e.event._data??={},e.event._data.message=t,this.results.push(e.event.message),e.app.emit(e,"send",e)}async flush(){if(this.payload.caption||this.asset.length>0)if(this.trimButtons(),this.asset.length>0){let t=[],e={img:"photo",image:"photo",audio:"audio",video:"video",file:"document"},s=0;for(let a of this.asset){let{filename:o,data:c,type:r}=await this.bot.ctx.http.file(a.attrs.src||a.attrs.url,a.attrs);t.push({filename:s+++o,data:c,mime:r,type:o.endsWith("gif")?"animation":e[a.type]??a.type,element:a})}let i=[];for(let{filename:a,type:o,element:c}of t){let r="attach://"+a;i.push({media:r,type:o,has_spoiler:c.attrs.spoiler})}if(t.length>1){i[0].caption=this.payload.caption,i[0].parse_mode=this.payload.parse_mode;let a=new FormData,o={chat_id:this.payload.chat_id,reply_to_message_id:this.payload.reply_to_message_id,message_thread_id:this.payload.message_thread_id,media:JSON.stringify(i)};for(let r in o)a.append(r,o[r]);for(let{filename:r,data:l,mime:d}of t)a.append(r,new Blob([l],{type:d}),r);let c=await this.bot.internal.sendMediaGroup(a);for(let r of c)await this.addResult(r);if(this.rows.length>0&&this.rows[0].length>0){let r=await this.bot.internal.sendMessage({chat_id:this.payload.chat_id,text:this.payload.caption,parse_mode:this.payload.parse_mode,reply_to_message_id:c[0].message_id,message_thread_id:this.payload.message_thread_id,disable_web_page_preview:!this.options.linkPreview,reply_markup:{inline_keyboard:this.rows}});await this.addResult(r),delete this.payload.reply_to_message_id,this.payload.caption="",this.rows=[]}delete this.payload.reply_to_message_id,this.payload.caption="",this.rows=[]}else{let a=[["audio",["sendAudio","audio"]],["voice",["sendAudio","audio"]],["video",["sendVideo","video"]],["animation",["sendAnimation","animation"]],["image",["sendPhoto","photo"]],["photo",["sendPhoto","photo"]],["document",["sendDocument","document"]],["",["sendDocument","document"]]],[,[o,c]]=a.find(([d])=>t[0].type.startsWith(d))||[],r=new FormData;r.append("chat_id",this.payload.chat_id),r.append("caption",this.payload.caption),r.append("parse_mode",this.payload.parse_mode),r.append("reply_to_message_id",this.payload.reply_to_message_id),r.append("message_thread_id",this.payload.message_thread_id),r.append("has_spoiler",t[0].element.attrs.spoiler?"true":"false"),r.append(c,"attach://"+t[0].filename),r.append(t[0].filename,new Blob([t[0].data],{type:t[0].mime}),t[0].filename);let l=await this.bot.internal[o](r);await this.addResult(l),this.payload.caption="",this.rows=[],delete this.payload.reply_to_message_id}}else{let t=await this.bot.internal.sendMessage({chat_id:this.payload.chat_id,text:this.payload.caption,parse_mode:this.payload.parse_mode,reply_to_message_id:this.payload.reply_to_message_id,message_thread_id:this.payload.message_thread_id,disable_web_page_preview:!this.options.linkPreview,reply_markup:{inline_keyboard:this.rows}});await this.addResult(t),delete this.payload.reply_to_message_id,this.payload.caption="",this.rows=[]}}decodeButton(t,e){return t.type==="link"?{text:e,url:t.href}:t.type==="input"?{text:e,switch_inline_query_current_chat:t.text}:{text:e,callback_data:t.id}}lastRow(){this.rows.length||this.rows.push([]);let t=this.rows[this.rows.length-1];return t.length>=5&&(this.rows.push([]),t=this.rows[this.rows.length-1]),t}trimButtons(){this.rows.length&&this.rows[this.rows.length-1].length===0&&this.rows.pop()}async visit(t){let{type:e,attrs:s,children:i}=t;if(e==="text")this.payload.caption+=W.h.escape(s.content);else if(e==="br")this.payload.caption+=`
`;else if(e==="p")this.payload.caption.endsWith(`
`)||(this.payload.caption+=`
`),await this.render(i),this.payload.caption.endsWith(`
`)||(this.payload.caption+=`
`);else if(ke.includes(e))this.payload.caption+=t.toString();else if(e==="spl")this.payload.caption+="<tg-spoiler>",await this.render(i),this.payload.caption+="</tg-spoiler>";else if(e==="code")this.payload.caption+=`<code>${s.content?W.h.escape(s.content):i.toString()}</code>`;else if(e==="code-block"){let{lang:a}=s;this.payload.caption+=`<pre><code${a?` class="language-${a}"`:""}>${i.toString()}</code></pre>`}else e==="at"?s.id&&(this.payload.caption+=`<a href="tg://user?id=${s.id}">@${s.name||s.id}</a>`):["img","image","audio","video","file"].includes(e)?this.asset.push(t):e==="figure"?(await this.flush(),this.mode="figure",await this.render(i),await this.flush(),this.mode="default"):e==="quote"?"id"in s?(await this.flush(),this.payload.reply_to_message_id=s.id):(this.payload.caption+="<blockquote>",await this.render(i),this.payload.caption+="</blockquote>"):e==="button"?this.lastRow().push(this.decodeButton(s,i.join(""))):e==="button-group"?(this.rows.push([]),await this.render(i),this.rows.push([])):e==="message"?this.mode==="figure"?(await this.render(i),this.payload.caption+=`
`):(await this.flush(),await this.render(i),await this.flush()):await this.render(i)}},M=(q(),C(b)),A=class extends M.Adapter{static{_(this,"HttpServer")}static inject=["server"];async connect(t){let{token:e,path:s,selfUrl:i}=t.config;s=(0,M.sanitize)(s||"/telegram"),i?i=(0,M.trimSlash)(i):i=this.ctx.server.config.selfUrl,this.ctx.server.post(s,async a=>{let o=a.request.body,c=a.request.query.token,[r]=c.split(":"),l=this.bots.find(d=>d.selfId===r);if(l?.config?.token!==c)return a.status=403;a.body="OK",await H(o,l)}),t.initialize(async a=>{if(!await a.internal.setWebhook({url:i+s+"?token="+e,drop_pending_updates:!0}))throw new Error("Set webhook failed");a.logger.debug("listening updates %c","telegram: "+a.selfId)})}};(t=>{t.Options=M.Schema.object({protocol:M.Schema.const("server").required(),path:M.Schema.string().description("服务器监听的路径。").default("/telegram"),selfUrl:M.Schema.string().role("link").description("服务器暴露在公网的地址。缺省时将使用全局配置。")})})(A||(A={}));var S=(q(),C(b)),j=class extends S.Adapter{static{_(this,"HttpPolling")}static reusable=!0;offset=0;timeout;async connect(t){t.initialize(async()=>{let e=0,s=!0,{retryTimes:i,retryInterval:a}=t.config,{url:o}=await t.internal.getWebhookInfo();o&&(t.logger.warn("Bot currently has a webhook set up, trying to remove it..."),await t.internal.setWebhook({url:""})),(await t.internal.getUpdates({allowed_updates:[],timeout:0})).forEach(l=>{this.offset=Math.max(this.offset,l.update_id)});let r=_(async()=>{try{let l=await t.internal.getUpdates({offset:this.offset+1,timeout:Math.ceil(t.config.pollingTimeout/1e3)});if(!t.isActive)return;t.online(),e=0,s=!1;for(let d of l)this.offset=Math.max(this.offset,d.update_id),H(d,t);this.timeout=setTimeout(r,0)}catch(l){if(!t.http.isError(l)||!l.response?.data)t.logger.warn("failed to get updates. reason: %s",l.message);else{let{error_code:d,description:u}=l.response.data;t.logger.warn("failed to get updates: %c %s",d,u)}if(s&&e>i)return t.error=l,t.status=S.Universal.Status.OFFLINE;if(!t.isActive)return;e++,t.status=S.Universal.Status.RECONNECT,this.timeout=setTimeout(r,a)}},"polling");r(),t.logger.debug("listening updates %c","telegram: "+t.selfId)})}async disconnect(){clearTimeout(this.timeout)}};(t=>{t.Options=S.Schema.object({protocol:S.Schema.const("polling").required(!1),pollingTimeout:S.Schema.natural().role("ms").default(S.Time.second*25).description("通过长轮询获取更新时请求的超时 (单位为毫秒)。"),retryTimes:S.Schema.natural().description("初次连接时的最大重试次数。").default(6),retryInterval:S.Schema.natural().role("ms").default(S.Time.second*5).description("长轮询断开后的重试时间间隔 (单位为毫秒)。")})})(j||(j={}));var Ce=ve((X(),C(E)),1),Me=class extends Error{static{_(this,"SenderError")}constructor(t,e,s,i){super(`Error when trying to send to ${e}, args: ${JSON.stringify(t)}, retcode: ${s}`),Object.defineProperties(this,{name:{value:"SenderError"},selfId:{value:i},code:{value:s},args:{value:t},url:{value:e}})}},L=class ne extends f.Bot{static{_(this,"TelegramBot")}static MessageEncoder=se;static inject=["http"];http;file;internal;local;server;constructor(e,s){super(e,s,"telegram"),this.selfId=s.token.split(":")[0],this.local=s.files.local,this.http=this.ctx.http.extend({...s,endpoint:`${s.endpoint}/bot${s.token}`}),this.file=this.ctx.http.extend({...s,endpoint:`${s.files.endpoint||s.endpoint}/file/bot${s.token}`}),this.internal=new n(this),s.protocol==="server"?e.plugin(A,this):s.protocol==="polling"&&e.plugin(j,this);let i=s.selfUrl||e.get("server")?.config.selfUrl;if(s.files.server??i){let a=`/telegram/${this.selfId}`;this.server=i+a,e.get("server").get(a+"/:file+",async o=>{let{data:c,type:r}=await this.$getFile(o.params.file);o.set("content-type",r),o.body=P.from(c)})}}async initialize(e){await this.getLogin(),await e(this),this.logger.debug("connected to %c","telegram:"+this.selfId),this.online()}async deleteMessage(e,s){s=+s,await this.internal.deleteMessage({chat_id:e,message_id:s})}async editMessage(e,s,i){s=+s;let a={chat_id:e,message_id:s,parse_mode:"html"};a.text=f.h.normalize(i).join(""),await this.internal.editMessageText(a)}static adaptGroup(e){return e.guildId=e.id+"",e.guildName=e.title,e}async getGuild(e){let s=await this.internal.getChat({chat_id:e});return ne.adaptGroup(s)}async getGuildMember(e,s){if(s=+s,Number.isNaN(s))return null;let i=await this.internal.getChatMember({chat_id:e,user_id:s}),a=z(i);return await this.setAvatarUrl(a.user),a}async getGuildMemberList(e){return{data:(await this.internal.getChatAdministrators({chat_id:e})).map(z)}}async kickGuildMember(e,s,i){s=+s,await this.internal.banChatMember({chat_id:e,user_id:s,until_date:Date.now()+(i?0:f.Time.minute),revoke_messages:!0})}setGroupLeave(e){return this.internal.leaveChat({chat_id:e})}async handleGuildMemberRequest(e,s,i){let[a,o]=e.split("@"),c=s?"approveChatJoinRequest":"declineChatJoinRequest",r=await this.internal[c]({chat_id:a,user_id:+o});if(!r)throw new Error(`handel guild member request field ${r}`)}async getLogin(){let e=await this.internal.getMe(),s=I(e);return await this.setAvatarUrl(s),this.user=s,this.toJSON()}async $getFile(e){return this.local?await this.ctx.http.file((0,Se.pathToFileURL)(e).href):await this.file.file(`/${e}`)}async $getFileFromId(e){try{let s=await this.internal.getFile({file_id:e});return await this.$getFileFromPath(s.file_path)}catch(s){this.logger.warn("get file error",s)}}async $getFileFromPath(e){if(this.server)return{src:`${this.server}/${e}`};let{type:s,data:i}=await this.$getFile(e);return s==="application/octet-stream"&&(s=(await Ce.default.fromBuffer(i))?.mime),{src:`data:${s};base64,`+f.Binary.toBase64(i)}}async setAvatarUrl(e){let{photos:[s]}=await this.internal.getUserProfilePhotos({user_id:+e.id});if(!s)return;let{file_id:i}=s[s.length-1],a=await this.internal.getFile({file_id:i});if(this.server)e.avatar=`${this.server}/${a.file_path}`;else{let{endpoint:o}=this.file.config;e.avatar=`${o}/${a.file_path}`}}async getUser(e,s){let i=await this.internal.getChat({chat_id:e});if(!i.photo?.big_file_id&&!i.photo?.small_file_id)return I(i);let{src:a}=await this.$getFileFromId(i.photo?.big_file_id||i.photo?.small_file_id);return{...I(i),avatar:a}}async createDirectChannel(e){return{id:e,type:f.Universal.Channel.Type.DIRECT}}async updateCommands(e){if(!this.config.slash)return;e=e.filter(i=>/^[\w-]{1,32}$/g.test(i.name));let s={};for(let i of e){let{name:a,description:o}=i,c={};for(let r in o){if(!r||!o[r])continue;let l=r.slice(0,2);c[l]||=o[r]}for(let r in c)(s[r]??=[]).push({command:a.toLowerCase().replace(/[^\w]/g,"_"),description:c[r]})}for(let i in s)await this.internal.setMyCommands({commands:s[i],language_code:i});await this.internal.setMyCommands({commands:e.map(({name:i,description:a})=>({command:i.toLowerCase().replace(/[^\w]/g,"_"),description:a[""]||i}))})}};(t=>{t.Config=f.Schema.intersect([f.Schema.object({token:f.Schema.string().description("机器人的用户令牌。").role("secret").required(),protocol:f.Schema.const("polling").default("polling")}),f.Schema.union([A.Options,j.Options]).description("推送设置"),f.Schema.object({slash:f.Schema.boolean().description("是否启用斜线指令。").default(!0)}).description("功能设置"),f.HTTP.createConfig("https://api.telegram.org"),f.Schema.object({files:f.Schema.object({endpoint:f.Schema.string().description("文件请求的终结点。"),local:f.Schema.boolean().description("是否启用 [Telegram Bot API](https://github.com/tdlib/telegram-bot-api) 本地模式。"),server:f.Schema.boolean().description("是否启用文件代理。若开启将会使用 `selfUrl` 进行反代，否则会下载所有资源文件 (包括图片、视频等)。当配置了 `selfUrl` 时将默认开启。")})}).hidden(!0).description("文件设置")])})(L||(L={}));var Ie=L});var $={};fe($,{default:()=>Te});v();var re=Q(J(),1);m($,Q(J(),1));var Te=re.TelegramBot;export{Te as default};
