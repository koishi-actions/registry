var I=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var O=(e,s)=>()=>(e&&(s=e(e=0)),s);var L=(e,s)=>()=>(s||e((s={exports:{}}).exports,s),s.exports);var E=(e,s,n,d)=>{if(s&&typeof s=="object"||typeof s=="function")for(let a of k(s))!A.call(e,a)&&a!==n&&I(e,a,{get:()=>s[a],enumerable:!(d=N(s,a))||d.enumerable});return e},o=(e,s,n)=>(E(e,s,"default"),n&&E(n,s,"default"));var g=e=>E(I({},"__esModule",{value:!0}),e);import{Buffer as y}from"https://registry.koishi.chat/modules/buffer/index.js";import v from"https://registry.koishi.chat/modules/process/index.js";var u=O(()=>{});var p={};import*as he from"https://registry.koishi.chat/modules/koishi/index.js";var j=O(()=>{u();o(p,he)});var _={};import*as fe from"https://registry.koishi.chat/modules/@koishijs/console/index.js";var P=O(()=>{u();o(_,fe)});import H from"https://registry.koishi.chat/modules/@cordiverse/path/index.js";var T=L((ye,B)=>{u();B.exports=H});var x={};import*as xe from"https://registry.koishi.chat/modules/@cordiverse/fs/index.js";var D=O(()=>{u();o(x,xe)});var S={};import*as we from"https://registry.koishi.chat/modules/@cordiverse/url/index.js";var G=O(()=>{u();o(S,we)});var de=L((Oe,K)=>{u();var q=Object.defineProperty,$=Object.getOwnPropertyDescriptor,z=Object.getOwnPropertyNames,W=Object.prototype.hasOwnProperty,b=(e,s)=>q(e,"name",{value:s,configurable:!0}),J=(e,s)=>{for(var n in s)q(e,n,{get:s[n],enumerable:!0})},V=(e,s,n,d)=>{if(s&&typeof s=="object"||typeof s=="function")for(let a of z(s))!W.call(e,a)&&a!==n&&q(e,a,{get:()=>s[a],enumerable:!(d=$(s,a))||d.enumerable});return e},X=e=>V(q({},"__esModule",{value:!0}),e),U={};J(U,{Config:()=>ae,apply:()=>R,filter:()=>re,inject:()=>ie,name:()=>ne});K.exports=X(U);var h=(j(),g(p)),F=(P(),g(_)),Q=T(),M=(j(),g(p)),C=(j(),g(p)),Y=class extends C.MessageEncoder{static{b(this,"SandboxMessenger")}buffer="";rules=Object.fromEntries(["image","img","audio","video","file"].map(e=>[e,async s=>{let n=s.src||s.url,d=e==="image"?"img":e;return n.startsWith("file:")?(0,C.h)(d,{...s,src:`${this.bot.ctx.server.selfUrl}/sandbox/${n}`}):(0,C.h)(d,{...s,src:n})}]));async flush(){if(!this.buffer.trim())return;let e=await C.h.transformAsync(this.buffer.trim(),this.rules),s=this.bot.session(this.session.event);s.messageId=C.Random.id(),this.bot.client.send({type:"sandbox/message",body:{content:e,user:"Koishi",channel:s.channelId,id:s.messageId,platform:s.platform}}),this.results.push(s.event.message),this.buffer=""}async visit(e){let{type:s,children:n}=e;s==="message"||s==="figure"?(await this.flush(),await this.render(n),await this.flush()):this.buffer+=e.toString()}},Z=class extends M.Bot{constructor(e,s,n){super(e,n),this.client=s,this.selfId=n.selfId,this.platform=n.platform,this.user.name="koishi"}static{b(this,"SandboxBot")}static MessageEncoder=Y;hidden=!0;internal={};async request(e,s={}){let n=Math.random().toString(36).slice(2);return new Promise((d,a)=>{let t=this.ctx.on("sandbox/response",(i,m)=>{n===i&&(t(),r(),d(m))}),r=this.ctx.setTimeout(()=>{t(),r(),a(new Error("timeout"))},M.Time.second*5);this.client.send({type:"sandbox/request",body:{method:e,data:s,nonce:n}})})}async createDirectChannel(e){return{id:"@"+e,type:M.Universal.Channel.Type.DIRECT}}async deleteMessage(e,s){return this.request("deleteMessage",{channelId:e,messageId:s})}async getMessage(e,s){return this.request("getMessage",{channelId:e,messageId:s})}async getChannel(e,s){return this.request("getChannel",{channelId:e,guildId:s})}async getChannelList(e){return this.request("getChannelList",{guildId:e})}async getGuild(e){return this.request("getGuild",{guildId:e})}async getGuildList(){return this.request("getGuildList")}async getGuildMember(e,s){return this.request("getGuildMember",{guildId:e,userId:s})}async getGuildMemberList(e){return this.request("getGuildMemberList",{guildId:e})}},ee={commands:{clear:{description:"清空聊天记录"}}},se=(D(),g(x)),te=(G(),g(S)),re=!1,ne="sandbox",ie=["console","server"],ae=h.Schema.object({fileServer:h.Schema.object({enabled:h.Schema.boolean().default(!1).description("是否提供本地静态文件服务 (请勿在暴露在公网的设备上开启此选项)。")})}),oe=class extends F.DataService{static{b(this,"SandboxService")}static inject=["database"];constructor(e){super(e,"sandbox")}async get(){let e=await this.ctx.database.select("binding").groupBy("platform",{count:b(s=>h.$.count(s.pid),"count")}).execute();return Object.fromEntries(e.map(({platform:s,count:n})=>[s,n]))}};function R(e,s){e.plugin(oe),e.console.addEntry(["https://registry.koishi.chat/modules/@koishijs/plugin-sandbox/dist/index.js","https://registry.koishi.chat/modules/@koishijs/plugin-sandbox/dist/style.css"]);let n={},d=b((t,r)=>{let i=r==="@"+t;return{user:{id:t,name:t},channel:{id:r,type:i?h.Universal.Channel.Type.DIRECT:h.Universal.Channel.Type.TEXT},guild:i?void 0:{id:r},timestamp:Date.now()}},"createEvent"),a=b((t,r)=>n[t]||=new Z(e,r,{platform:t,selfId:"koishi"}),"ensureBot");e.console.addListener("sandbox/send-message",async function(t,r,i,m,l){let c=a(t,this),f=h.Random.id();this.send({type:"sandbox/message",body:{id:f,content:m,user:r,channel:i,platform:t,quote:l}});let w=c.session(d(r,i));w.type="message",w.messageId=f,w.quote=l&&{content:l.content,id:l.id},w.content=m,c.dispatch(w)},{authority:4}),e.console.addListener("sandbox/delete-message",async function(t,r,i,m){let l=a(t,this),c=l.session(d(r,i));c.type="message-deleted",c.messageId=m,l.dispatch(c)},{authority:4}),e.console.addListener("sandbox/get-user",async function(t,r){let i=e.get("database");if(!i)return;let[m]=await i.get("binding",{platform:t,pid:r},["aid"]);return m?i.getUser(t,r):i.createUser(t,r,{authority:1})},{authority:4}),e.console.addListener("sandbox/set-user",async function(t,r,i){let l=a(t,this).session(d(r,"#"));i?(l.type="guild-member-added",e.emit("guild-member-added",l)):(l.type="guild-member-removed",e.emit("guild-member-removed",l));let c=e.get("database");if(!c)return;let[f]=await c.get("binding",{platform:t,pid:r},["aid"]);if(f)i?await c.upsert("user",[{id:f.aid,...i}]):(await c.remove("user",f.aid),await c.remove("binding",{platform:t,pid:r}));else{if(!i)return;await c.createUser(t,r,{authority:1,...i})}},{authority:4}),e.console.addListener("sandbox/response",(t,r)=>{e.emit("sandbox/response",t,r)},{authority:4}),e.on("console/connection",async t=>{if(!e.console.clients[t.id])for(let[r,i]of Object.entries(n))i.client===t&&(delete n[r],delete e.bots[i.sid])}),s.fileServer.enabled&&e.server.get("/sandbox/:url(file:.+)",async t=>{let{url:r}=t.params;t.type=(0,Q.extname)(r),t.body=(0,se.createReadStream)((0,te.fileURLToPath)(r))}),e.i18n.define("zh-CN",ee),e.intersect(t=>t.platform.startsWith("sandbox:")).command("clear").action(({session:t})=>{t.bot.client.send({type:"sandbox/clear"})})}b(R,"apply")});export default de();
