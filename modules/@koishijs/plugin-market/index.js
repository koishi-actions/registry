import{Buffer as a}from"https://registry.koishi.chat/modules/buffer/index.js";import s from"https://registry.koishi.chat/modules/process/index.js";import{Schema as i}from"https://registry.koishi.chat/modules/koishi/index.js";import{Logger as n,Time as c}from"https://registry.koishi.chat/modules/koishi/index.js";import{DataService as l}from"https://registry.koishi.chat/modules/@koishijs/console/index.js";var o=Object.defineProperty,t=(e,r)=>o(e,"name",{value:r,configurable:!0}),p=new n("market"),m=class extends l{static{t(this,"MarketProvider")}_task;_timestamp=0;_error;constructor(e){super(e,"market",{authority:4}),e.console.addListener("market/refresh",()=>this.start(!0),{authority:4}),e.on("console/connection",async r=>{e.console.clients[r.id]&&(Date.now()-this._timestamp<=c.hour*12||await this.ctx.serial("console/intercept",r,{authority:4})||this.start())})}start(e=!1){this._task=null,this._timestamp=Date.now(),this.refresh()}async prepare(){return this._task||=this.collect().catch(e=>{p.warn(e),this._error=e})}},f=class extends m{static{t(this,"MarketProvider")}async collect(){return this.ctx.loader.market}async get(){let e=await this.prepare();return e?{data:Object.fromEntries(e.objects.map(r=>[r.package.name,r])),failed:0,total:e.objects.length,progress:e.objects.length}:{data:{},failed:0,total:0,progress:0}}},y=!1,j="market",S=["console"],b=i.object({});function h(e,r){e.plugin(f),e.console.addEntry(["https://registry.koishi.chat/modules/@koishijs/plugin-market/dist/index.js","https://registry.koishi.chat/modules/@koishijs/plugin-market/dist/style.css"])}t(h,"apply");export{b as Config,f as MarketProvider,h as apply,y as filter,S as inject,j as name};
