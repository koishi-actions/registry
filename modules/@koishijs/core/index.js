import{Buffer as V}from"https://registry.koishi.chat/modules/buffer/index.js";import G from"https://registry.koishi.chat/modules/process/index.js";var De="4.18.0";export*from"https://registry.koishi.chat/modules/@koishijs/utils/index.js";export*from"https://registry.koishi.chat/modules/minato/index.js";import{defineProperty as X,Time as ee}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{HTTP as He,Schema as S}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import*as U from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import*as Se from"https://registry.koishi.chat/modules/cordis/index.js";import*as Ee from"https://registry.koishi.chat/modules/minato/index.js";import{defineProperty as Be}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{defineProperty as te,Time as Fe}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{h as M,Schema as ie,Universal as pe}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{camelize as Ke,isNullable as se,remove as R}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{coerce as Re}from"https://registry.koishi.chat/modules/@koishijs/utils/index.js";import{Logger as Qe,Schema as P}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{camelCase as ge,paramCase as ye}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{escapeRegExp as _e}from"https://registry.koishi.chat/modules/@koishijs/utils/index.js";import{h as be}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{coerce as Xe,makeArray as Ve,Random as Ge}from"https://registry.koishi.chat/modules/@koishijs/utils/index.js";import{defineProperty as Je,Time as oe}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{h as we}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{Universal as Ye}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{isNullable as it}from"https://registry.koishi.chat/modules/cosmokit/index.js";var D=new Uint32Array(65536),Le=(e,t)=>{let i=e.length,s=t.length,n=1<<i-1,r=-1,c=0,a=i,l=i;for(;l--;)D[e.charCodeAt(l)]|=1<<l;for(l=0;l<s;l++){let u=D[t.charCodeAt(l)],g=u|c;u|=(u&r)+r^r,c|=~(u|r),r&=u,c&n&&a++,r&n&&a--,c=c<<1|1,r=r<<1|~(g|c),c&=g}for(l=i;l--;)D[e.charCodeAt(l)]=0;return a},qe=(e,t)=>{let i=t.length,s=e.length,n=[],r=[],c=Math.ceil(i/32),a=Math.ceil(s/32);for(let o=0;o<c;o++)r[o]=-1,n[o]=0;let l=0;for(;l<a-1;l++){let o=0,d=-1,h=l*32,f=Math.min(32,s)+h;for(let p=h;p<f;p++)D[e.charCodeAt(p)]|=1<<p;for(let p=0;p<i;p++){let w=D[t.charCodeAt(p)],y=r[p/32|0]>>>p&1,x=n[p/32|0]>>>p&1,A=w|o,T=((w|x)&d)+d^d|w|x,k=o|~(T|d),j=d&T;k>>>31^y&&(r[p/32|0]^=1<<p),j>>>31^x&&(n[p/32|0]^=1<<p),k=k<<1|y,j=j<<1|x,d=j|~(A|k),o=k&A}for(let p=h;p<f;p++)D[e.charCodeAt(p)]=0}let u=0,g=-1,b=l*32,v=Math.min(32,s-b)+b;for(let o=b;o<v;o++)D[e.charCodeAt(o)]|=1<<o;let _=s;for(let o=0;o<i;o++){let d=D[t.charCodeAt(o)],h=r[o/32|0]>>>o&1,f=n[o/32|0]>>>o&1,p=d|u,w=((d|f)&g)+g^g|d|f,y=u|~(w|g),x=g&w;_+=y>>>s-1&1,_-=x>>>s-1&1,y>>>31^h&&(r[o/32|0]^=1<<o),x>>>31^f&&(n[o/32|0]^=1<<o),y=y<<1|h,x=x<<1|f,g=x|~(p|y),u=y&p}for(let o=b;o<v;o++)D[e.charCodeAt(o)]=0;return _},fe=(e,t)=>{if(e.length<t.length){let i=t;t=e,e=i}return t.length===0?e.length:e.length<=32?Le(e,t):qe(e,t)};import{isNullable as ot}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{deduplicate as ze}from"https://registry.koishi.chat/modules/cosmokit/index.js";var Ue=Object.defineProperty,K=(e,t)=>Ue(e,"name",{value:t,configurable:!0}),F;(e=>{function t(i){let s={};for(let n of i.filter(Boolean)){let r=n.split("-"),c=s;for(let a=0;a<r.length;a++){let l=r.slice(0,a+1).join("-");c=c[l]=c[l]||{}}}return s}e.from=t,K(t,"from")})(F||(F={}));function J(e,t){return[e,[[e,[]],...Object.entries(t).map(([i,s])=>J(i,s))]]}K(J,"toLocaleEntry");function*Y([e,t],i){if(!t.length)return yield e;for(let s of t)i.includes(s)||(yield*Y(s,i))}K(Y,"traverse");function Z(e,t){let i=J("",e),s=[];for(let r of ze(t).filter(Boolean).reverse()){let c="",a=i[1],l=r?r.split("-"):[];for(let u=0;u<l.length;u++){let g=l[u],b=c+g,v=a.findIndex(([o])=>o===b);if(v<0)break;let _=a[v];v>0&&(a.splice(v,1),a.unshift(_)),a=_[1],c=b+"-",b===r&&s.unshift(_)}}s.push(i);let n=[];for(let r of s)n.push(...Y(r,s));return n}K(Z,"fallback");import{h as ce,Logger as at,Schema as H}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{observe as le}from"https://registry.koishi.chat/modules/@koishijs/utils/index.js";import{isNullable as $e,makeArray as ut}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{h as Q,Logger as dt}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{executeEval as mt,isEvalExpr as ft}from"https://registry.koishi.chat/modules/minato/index.js";import{Logger as yt}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{defineProperty as _t,remove as bt}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{sleep as vt}from"https://registry.koishi.chat/modules/@koishijs/utils/index.js";import{defineProperty as Te}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{Adapter as $t,Bot as kt}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{remove as Et}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{Schema as C}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{Adapter as bi,Bot as wi,Element as xi,h as vi,HTTP as $i,Logger as ki,MessageEncoder as Ci,Messenger as Si,Quester as Ei,Schema as Ai,segment as ji,Universal as Ii,z as Oi}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{resolveConfig as Pi}from"https://registry.koishi.chat/modules/cordis/index.js";var Ne=Object.defineProperty,m=(e,t)=>Ne(e,"name",{value:t,configurable:!0});function z(e,t,...i){return e.intersect(s=>i.length?i.includes(s[t]):!!s[t])}m(z,"property");var We=class{constructor(e){this.ctx=e,Be(this,$.current,e),e.filter=()=>!0,e.on("internal/runtime",t=>{t.uid&&(t.ctx.filter=i=>t.children.some(s=>s.ctx.filter(i)))})}static{m(this,"FilterService")}any(){return this.ctx.extend({filter:m(()=>!0,"filter")})}never(){return this.ctx.extend({filter:m(()=>!1,"filter")})}union(e){let t=typeof e=="function"?e:e.filter;return this.ctx.extend({filter:m(i=>this.ctx.filter(i)||t(i),"filter")})}intersect(e){let t=typeof e=="function"?e:e.filter;return this.ctx.extend({filter:m(i=>this.ctx.filter(i)&&t(i),"filter")})}exclude(e){let t=typeof e=="function"?e:e.filter;return this.ctx.extend({filter:m(i=>this.ctx.filter(i)&&!t(i),"filter")})}user(...e){return z(this.ctx,"userId",...e)}self(...e){return z(this.ctx,"selfId",...e)}guild(...e){return z(this.ctx,"guildId",...e)}channel(...e){return z(this.ctx,"channelId",...e)}platform(...e){return z(this.ctx,"platform",...e)}private(){return this.ctx.intersect(e=>e.isDirect)}},ne=`"'“‘`,re=`"'”’`,B;(e=>{let t={};function i(_,o,d){t[_]={terminator:o,parse:d}}e.interpolate=i,m(i,"interpolate"),i("$(",")");let s;(_=>{_.unescape=m(o=>o.replace(/@__KOISHI_SPACE__@/g," ").replace(/@__KOISHI_NEWLINE__@/g,`
`).replace(/@__KOISHI_RETURN__@/g,"\r").replace(/@__KOISHI_TAB__@/g,"	"),"unescape"),_.escape=m(o=>o.replace(/ /g,"@__KOISHI_SPACE__@").replace(/\n/g,"@__KOISHI_NEWLINE__@").replace(/\r/g,"@__KOISHI_RETURN__@").replace(/\t/g,"@__KOISHI_TAB__@"),"escape")})(s=e.whitespace||(e.whitespace={}));class n{static{m(this,"Tokenizer")}bracs;constructor(){this.bracs=Object.create(t)}interpolate(o,d,h){this.bracs[o]={terminator:d,parse:h}}parseToken(o,d="$"){let h={inters:[]},f=ne.indexOf(o[0]),p=re[f],w="";p&&(o=o.slice(1),d=`${p}(?=${d})|$`),d+=`|${Object.keys({...this.bracs,...t}).map(_e).join("|")}`;let y=new RegExp(d);for(;;){let x=y.exec(o);if(w+=s.unescape(o.slice(0,x.index)),x[0]in this.bracs){o=o.slice(x.index+x[0].length).trimStart();let{parse:A,terminator:T}=this.bracs[x[0]],k=A?.(o)||this.parse(o,T);o=k.rest,h.inters.push({...k,pos:w.length,initiator:x[0]})}else{let A=x[0]===p,T=o.slice(x.index+ +A);return h.rest=T.trimStart(),h.quoted=A,h.terminator=x[0],A?h.terminator+=T.slice(0,-h.rest.length):p&&(w=ne[f]+w,h.inters.forEach(k=>k.pos+=1)),h.content=w,p==="'"&&e.revert(h),h}}}parse(o,d=""){let h=[];o=be.parse(o).map(y=>y.type==="text"?y.toString():s.escape(y.toString())).join("");let f=o,p="",w=`\\s+|[${_e(d)}]|$`;for(;f&&!(d&&f.startsWith(d));){let y=this.parseToken(f,w);h.push(y),f=y.rest,p=y.terminator,delete y.rest}return f.startsWith(d)&&(f=f.slice(1)),o=o.slice(0,-(f+p).length),f=s.unescape(f),o=s.unescape(o),{tokens:h,rest:f,source:o}}stringify(o){let d=o.tokens.reduce((h,f)=>(f.quoted&&(h+=ne[re.indexOf(f.terminator[0])]||""),h+f.content+f.terminator),"");return o.rest&&!re.includes(d[d.length-1])||o.initiator?d.slice(0,-1):d}}e.Tokenizer=n;let r=new n;function c(_,o=""){return r.parse(_,o)}e.parse=c,m(c,"parse");function a(_){return r.stringify(_)}e.stringify=a,m(a,"stringify");function l(_){for(;_.inters.length;){let{pos:o,source:d,initiator:h}=_.inters.pop();_.content=_.content.slice(0,o)+h+d+t[h].terminator+_.content.slice(o)}}e.revert=l,m(l,"revert");let u=/(?:-[\w\x80-\uffff-]*|[^,\s\w\x80-\uffff]+)/.source,g=/((?:\s*\[[^\]]+?\]|\s*<[^>]+?>)*)/.source,b=new RegExp(`^(${u}(?:,\\s*${u})*(?=\\s|$))?${g}(.*)$`);class v{constructor(o,d,h,f){if(this.name=o,this.ctx=h,this.config=f,!o)throw new Error("expect a command name");let p=this._arguments=h.$commander.parseDecl(d);this.declaration=p.stripped;for(let w of p)this._disposables.push(this.ctx.i18n.define("",`commands.${this.name}.arguments.${w.name}`,w.name))}static{m(this,"CommandBase")}declaration;_arguments;_options={};_disposables=[];_namedOptions={};_symbolicOptions={};_createOption(o,d,h){let f=b.exec(d),p=ye(o),w=f[1]||"--"+p,y=f[2]||"",x=f[3].trim(),A=h.aliases??[],T=h.symbols??[];for(let E of w.trim().split(",")){E=E.trimStart();let q=E.replace(/^-+/,"");!q||!E.startsWith("-")?T.push(be.escape(E)):A.push(q)}!("value"in h)&&!A.includes(p)&&(w+=", --"+p);let k=this.ctx.$commander.parseDecl(y.trimStart());k.stripped&&(w+=" "+k.stripped);let j=this._options[o]||={...k[0],...h,name:o,values:{},valuesSyntax:{},variants:{},syntax:w},I=`commands.${this.name}.options.${o}`,O=typeof j.fallback;"value"in h?(I+="."+h.value,j.variants[h.value]={...h,syntax:w},j.valuesSyntax[h.value]=w,A.forEach(E=>j.values[E]=h.value)):y.trim()?!j.type&&(O==="string"||O==="number")&&(j.type=O):j.type="boolean",this._disposables.push(this.ctx.i18n.define("",I,x)),this._assignOption(j,A,this._namedOptions),this._assignOption(j,T,this._symbolicOptions),this._namedOptions[p]||(this._namedOptions[p]=j)}_assignOption(o,d,h){for(let f of d){if(f in h)throw new Error(`duplicate option name "${f}" for command "${this.name}"`);h[f]=o}}removeOption(o){if(!this._options[o])return!1;let d=this._options[o];delete this._options[o];for(let h in this._namedOptions)this._namedOptions[h]===d&&delete this._namedOptions[h];for(let h in this._symbolicOptions)this._symbolicOptions[h]===d&&delete this._symbolicOptions[h];return!0}parse(o,d){typeof o=="string"&&(o=e.parse(o,d));let h=[...o.args||[]],f={...o.options};!o.source&&o.tokens&&(o.source=this.name+" "+e.stringify(o));let p;for(;!o.error&&o.tokens?.length;){let w=o.tokens[0],{content:y,quoted:x}=w,A=this._arguments[h.length]||p||{};if(h.length===this._arguments.length-1&&A.variadic&&(p=A),y[0]!=="-"&&this.ctx.$commander.resolveDomain(A.type).greedy){h.push(this.ctx.$commander.parseValue(e.stringify(o),"argument",o,A));break}o.tokens.shift();let T,k,j;if(!x&&(T=this._symbolicOptions[y]))k=[ye(T.name)];else{if(y[0]!=="-"||x||+y*0===0&&this.ctx.$commander.resolveDomain(A.type).numeric){h.push(this.ctx.$commander.parseValue(y,"argument",o,A));continue}let I=0;for(;I<y.length&&y.charCodeAt(I)===45;++I);let O=I+1;for(;O<y.length&&y.charCodeAt(O)!==61;O++);let E=y.slice(I,O);if(this.config.strictOptions&&!this._namedOptions[E]){h.push(this.ctx.$commander.parseValue(y,"argument",o,A));continue}if(I>1&&E.startsWith("no-")&&!this._namedOptions[E]){f[ge(E.slice(3))]=!1;continue}k=I>1?[E]:E,j=y.slice(++O),T=this._namedOptions[k[k.length-1]]}if(x=!1,!j){let{type:I,values:O}=T||{};if(this.ctx.$commander.resolveDomain(I).greedy)j=e.stringify(o),x=!0,o.tokens=[];else if(!(k[k.length-1]in(O||{})||I==="boolean")&&o.tokens.length&&(I||o.tokens[0]?.content!=="-")){let q=o.tokens.shift();j=q.content,x=q.quoted}}for(let I=0;I<k.length;I++){let O=k[I],E=this._namedOptions[O],q=E?E.name:ge(O);if(E&&O in E.values)f[q]=E.values[O];else{let Pe=I+1<k.length?"":j;f[q]=this.ctx.$commander.parseValue(Pe,"option",o,E)}if(o.error)break}}for(let{name:w,fallback:y}of Object.values(this._options))y!==void 0&&!(w in f)&&(f[w]=y);return delete o.tokens,{...o,options:f,args:h,error:o.error||"",command:this}}stringifyArg(o){return o=""+o,o.includes(" ")?`"${o}"`:o}stringify(o,d){let h=this.name;for(let f in d){let p=d[f];p===!0?h+=` --${f}`:p===!1?h+=` --no-${f}`:h+=` --${f} ${this.stringifyArg(p)}`}for(let f of o)h+=" "+this.stringifyArg(f);return h}}e.CommandBase=v})(B||(B={}));var he;(e=>{let t;(i=>{i[i.ignore=1]="ignore"})(t=e.Flag||(e.Flag={}))})(he||(he={}));var ue;(e=>{let t;(i=>{i[i.ignore=1]="ignore",i[i.silent=4]="silent"})(t=e.Flag||(e.Flag={}))})(ue||(ue={}));var Ze=class{constructor(e){this.ctx=e,e.mixin(this,{getUser:"database.getUser",setUser:"database.setUser",createUser:"database.createUser",getChannel:"database.getChannel",getAssignedChannels:"database.getAssignedChannels",setChannel:"database.setChannel",createChannel:"database.createChannel",broadcast:"database.broadcast"}),e.mixin("database",["broadcast"]),e.model.extend("user",{id:"unsigned(8)",name:{type:"string",length:255},flag:"unsigned(8)",authority:"unsigned(4)",locales:"list(255)",permissions:"list",createdAt:"timestamp"},{autoInc:!0}),e.model.extend("binding",{aid:"unsigned(8)",bid:"unsigned(8)",pid:"string(255)",platform:"string(255)"},{primary:["pid","platform"]}),e.model.extend("channel",{id:"string(255)",platform:"string(255)",flag:"unsigned(8)",assignee:"string(255)",guildId:"string(255)",locales:"list(255)",permissions:"list",createdAt:"timestamp"},{primary:["id","platform"]}),e.on("login-added",({platform:t})=>{t in e.model.tables.user.fields||e.model.migrate("user",{[t]:"string(255)"},async i=>{let s=await i.get("user",{[t]:{$exists:!0}},["id",t]);await i.upsert("binding",s.filter(n=>n[t]).map(n=>({aid:n.id,bid:n.id,pid:n[t],platform:t})))})})}static{m(this,"KoishiDatabase")}async getUser(e,t,i){let[s]=await this.get("binding",{platform:e,pid:t},["aid"]);if(!s)return;let[n]=await this.get("user",{id:s.aid},i);return n}async setUser(e,t,i){let[s]=await this.get("binding",{platform:e,pid:t},["aid"]);if(!s)throw new Error("user not found");return this.set("user",s.aid,i)}async createUser(e,t,i){let s=await this.create("user",i);return await this.create("binding",{aid:s.id,bid:s.id,pid:t,platform:e}),s}async getChannel(e,t,i){let s=await this.get("channel",{platform:e,id:t},i);return Array.isArray(t)?s:(s[0]&&Object.assign(s[0],{platform:e,id:t}),s[0])}getSelfIds(e){let t=Object.create(null);for(let i of this.ctx.bots)e&&!e.includes(i.platform)||(t[i.platform]||=[]).push(i.selfId);return t}async getAssignedChannels(e,t=this.getSelfIds()){return this.get("channel",{$or:Object.entries(t).map(([i,s])=>({platform:i,assignee:s}))},e)}setChannel(e,t,i){return this.set("channel",{platform:e,id:t},i)}createChannel(e,t,i){return this.create("channel",{platform:e,id:t,...i})}async broadcast(...e){let t,i;Array.isArray(e[0])&&(t=e.shift(),i=t.map(l=>l.split(":")[0]));let[s,n]=e;if(!s)return[];let r=this.getSelfIds(i),c=await this.getAssignedChannels(["id","assignee","flag","platform","guildId","locales"],r),a={};for(let l of c){let{platform:u,id:g,assignee:b,flag:v}=l;if(t){let _=t?.indexOf(`${u}:${g}`);if(_<0)continue;t.splice(_,1)}!n&&v&4||((a[u]||={})[b]||=[]).push(l)}return t?.length&&this.ctx.logger("app").warn("broadcast","channel not found: ",t.join(", ")),(await Promise.all(this.ctx.bots.map(l=>{let u=a[l.platform]?.[l.selfId];if(!u)return Promise.resolve([]);let g=u.map(({id:b,guildId:v,locales:_})=>{let o=l.session({type:"message",channel:{id:b,type:Ye.Channel.Type.TEXT},guild:{id:v}});return o.locales=_,o});return l.broadcast(g,s)}))).flat(1)}},et=Ze,Ae=class extends Error{constructor(e,t){super(Ve(e)[0]),this.path=e,this.param=t}static{m(this,"SessionError")}},L;(e=>{e.MAX_DEPTH=64;async function t(i,s){return typeof i=="function"?i(s):i}e.compose=t,m(t,"compose")})(L||(L={}));var tt=class{constructor(e){this.ctx=e,Je(this,$.current,e),this.middleware(this.attach.bind(this),!0),e.on("message",this._handleMessage.bind(this)),e.before("attach-user",(i,s)=>{i.collect("user",i.argv,s)}),e.before("attach-channel",(i,s)=>{i.collect("channel",i.argv,s)}),e.component("execute",async(i,s,n)=>n.execute(s.join(""),!0),{session:!0}),e.component("prompt",async(i,s,n)=>(await n.send(s),n.prompt()),{session:!0}),e.component("i18n",async(i,s,n)=>n.i18n(i.path,s),{session:!0}),e.component("random",async(i,s)=>Ge.pick(s)),e.component("plural",async(i,s)=>{let n=i.count in s?i.count:s.length-1;return s[n]});let t=["day","hour","minute","second"];e.component("i18n:time",(i,s,n)=>{let r=+i.value;for(let c=0;c<3;c++){let a=oe[t[c]],l=oe[t[c+1]];if(r>=a-l/2){r+=l/2;let u=Math.floor(r/a)+" "+n.text("general."+t[c]);return r%a>l&&(u+=` ${Math.floor(r%a/l)} `+n.text("general."+t[c+1])),u}}return Math.round(r/oe.second)+" "+n.text("general.second")},{session:!0}),e.before("attach",i=>{for(let s of this._matchers)if(this._executeMatcher(i,s),i.response)return})}static{m(this,"Processor")}_hooks=[];_sessions=Object.create(null);_userCache=new xe;_channelCache=new xe;_matchers=new Set;middleware(e,t){return typeof t!="object"&&(t={prepend:t}),this.ctx.lifecycle.register("middleware",this._hooks,e,t)}match(e,t,i){let s={...i,context:this.ctx,pattern:e,response:t};return this._matchers.add(s),this.ctx.collect("shortcut",()=>this._matchers.delete(s))}_executeMatcher(e,t){let{stripped:i,quote:s}=e,{appel:n,context:r,i18n:c,regex:a,fuzzy:l,pattern:u,response:g}=t;if((n||i.hasAt)&&!i.appel||!r.filter(e))return;let b=i.content;s?.content&&(b+=" "+s.content);let v=null,_=m(o=>{if(o)if(typeof o=="string"){if(!l&&b!==o||!b.startsWith(o))return;v=[b,b.slice(o.length)],l&&!i.appel&&v[1].match(/^\S/)&&(v=null)}else v=o.exec(b)},"match");if(!c)_(u);else for(let o of this.ctx.i18n.fallback([])){let h=this.ctx.i18n._data[o]?.[u];if(h){if(a){let f=l?`(?:${i.appel?"":"\\s+"}([\\s\\S]*))?`:"";h=new RegExp(`^(?:${h})${f}$`)}if(_(h),!!v){e.locales=[o];break}}}v&&(e.response=async()=>{let o=await e.resolve(g,v);return we.normalize(o,v.map(d=>d?we.parse(d):""))})}async attach(e,t){if(this.ctx.emit(e,"before-attach",e),this.ctx.database){if(!e.isDirect){let n=new Set(["flag","assignee","guildId","permissions","locales"]);this.ctx.emit("before-attach-channel",e,n);let r=await e.observeChannel(n);if(r.guildId=e.guildId,await this.ctx.serial(e,"attach-channel",e)||r.flag&ue.Flag.ignore||r.assignee!==e.selfId&&!e.stripped.atSelf)return}let i=new Set(["id","flag","authority","permissions","locales"]);this.ctx.emit("before-attach-user",e,i);let s=await e.observeUser(i);if(await this.ctx.serial(e,"attach-user",e)||s.flag&he.Flag.ignore)return}return this.ctx.emit(e,"attach",e),e.response?e.response():t()}async _handleMessage(e){if(e.selfId===e.userId)return;this._sessions[e.id]=e;let t=this.ctx.lifecycle.filterHooks(this._hooks,e).map(({callback:n})=>n.bind(null,e)),i=0,s=m(async n=>{try{if(!this._sessions[e.id])throw new Error("isolated next function detected");if(n!==void 0&&(t.push(r=>L.compose(n,r)),t.length>L.MAX_DEPTH))throw new Error(`middleware stack exceeded ${L.MAX_DEPTH}`);return await t[i++]?.(s)}catch(r){if(r instanceof Ae)return e.text(r.path,r.param);let c=Xe(r);this.ctx.logger("session").warn(`${e.content}
${c}`)}},"next");try{let n=await s();n&&await e.send(n)}finally{delete this._sessions[e.id],this._userCache.delete(e.id),this._channelCache.delete(e.id),await e.user?.$update(),await e.channel?.$update(),await e.guild?.$update(),this.ctx.emit(e,"middleware",e)}}},xe=class{static{m(this,"SharedCache")}#e=new Map;get(e,t){let i=this.#e.get(t);if(i)return i.refs.add(e),i.value}set(e,t,i){let s=this.#e.get(t);s?s.value=i:(s={value:i,key:t,refs:new Set},this.#e.set(t,s)),s.refs.add(e)}delete(e){for(let t of[...this.#e.keys()]){let{refs:i}=this.#e.get(t);i.delete(e),i.size||this.#e.delete(t)}}},ae=new Qe("command"),N=class je extends B.CommandBase{static{m(this,"Command")}children=[];_parent=null;_aliases=Object.create(null);_examples=[];_usage;_userFields=[["locales"]];_channelFields=[["locales"]];_actions=[];_checkers=[async t=>this.ctx.serial(t.session,"command/before-execute",t)];constructor(t,i,s,n){super(t,i,s,{showWarning:!0,handleError:!0,slash:!0,...n}),this.config.permissions??=[`authority:${n?.authority??1}`],this._registerAlias(t),s.$commander._commandList.push(this)}get caller(){return this[$.current]||this.ctx}get displayName(){return Object.keys(this._aliases)[0]}set displayName(t){this._registerAlias(t,!0)}get parent(){return this._parent}set parent(t){this._parent!==t&&(this._parent&&R(this._parent.children,this),this._parent=t,t&&t.children.push(this))}static normalize(t){return t.toLowerCase().replace(/_/g,"-")}_registerAlias(t,i=!1,s={}){t=je.normalize(t),t.startsWith(".")&&(t=this.parent.name+t);let n=this.ctx.$commander.get(t);if(n&&n!==this)throw new Error(`duplicate command names: "${t}"`);let r=this._aliases[t];r?i&&(this._aliases={[t]:r,...this._aliases}):i?this._aliases={[t]:s,...this._aliases}:this._aliases[t]=s}[Symbol.for("nodejs.util.inspect.custom")](){return`Command <${this.name}>`}userFields(t){return this._userFields.push(t),this}channelFields(t){return this._channelFields.push(t),this}alias(...t){if(typeof t[1]=="object")this._registerAlias(t[0],!1,t[1]);else for(let i of t)this._registerAlias(i);return this.caller.emit("command-updated",this),this}_escape(t){return typeof t!="string"?t:t.replace(/\$\$/g,"@@__PLACEHOLDER__@@").replace(/\$\d/g,i=>`{${i[1]}}`).replace(/@@__PLACEHOLDER__@@/g,"$")}shortcut(t,i={}){let s=this.displayName;for(let c in i.options||{}){s+=` --${Ke(c)}`;let a=i.options[c];a!==!0&&(s+=" "+this._escape(a))}for(let c of i.args||[])s+=" "+this._escape(c);i.fuzzy&&(s+=" {1}");let n=i.i18n;if(typeof t=="string")if(i.i18n)t=`commands.${this.name}.shortcuts.${t}`;else{i.i18n=!0;let c=`commands.${this.name}.shortcuts._${Math.random().toString(36).slice(2)}`;this.ctx.i18n.define("",c,t),t=c}let r=this.ctx.match(t,`<execute>${s}</execute>`,{appel:i.prefix,fuzzy:i.fuzzy,i18n:i.i18n,regex:n});return this._disposables.push(r),this}subcommand(t,...i){t=this.name+(t.charCodeAt(0)===46?"":"/")+t;let s=typeof i[0]=="string"?i.shift():"",n=i[0]||{};return this.ctx.command(t,s,n)}usage(t){return this._usage=t,this}example(t){return this._examples.push(t),this}option(t,...i){let s="";typeof i[0]=="string"&&(s=i.shift());let n={...i[0]};return n.permissions??=[`authority:${n.authority??0}`],this._createOption(t,s,n),this.caller.emit("command-updated",this),this.caller.collect("option",()=>this.removeOption(t)),this}match(t){return this.ctx.filter(t)}check(t,i=!1){return this.before(t,i)}before(t,i=!1){return i?this._checkers.push(t):this._checkers.unshift(t),this.caller.scope.disposables?.push(()=>R(this._checkers,t)),this}action(t,i=!1){return i?this._actions.unshift(t):this._actions.push(t),this.caller.scope.disposables?.push(()=>R(this._actions,t)),this}use(t,...i){return t(this,...i)}async execute(t,i=L.compose){t.command??=this,t.args??=[],t.options??={};let{args:s,options:n,error:r}=t;if(r)return r;ae.level>=3&&ae.debug(t.source||=this.stringify(s,n));for(let u of this._checkers){let g=await u.call(this,t,...s);if(!se(g))return g}if(!this._actions.length)return"";let c=0,a=this._actions.map(u=>async()=>await u.call(this,t,...s));a.push(i);let l=a.length;t.next=async u=>{if(u!==void 0&&(a.push(g=>L.compose(u,g)),a.length>L.MAX_DEPTH))throw new Error(`middleware stack exceeded ${L.MAX_DEPTH}`);return a[c++]?.(t.next)};try{let u=await t.next();if(!se(u))return u}catch(u){if(c===l)throw u;if(u instanceof Ae)return t.session.text(u.path,u.param);let g=Re(u);if(ae.warn(`${t.source||=this.stringify(s,n)}
${g}`),this.ctx.emit(t.session,"command-error",t,u),typeof this.config.handleError=="function"){let b=await this.config.handleError(u,t);if(!se(b))return b}else if(this.config.handleError)return t.session.text("internal.error-encountered")}return""}dispose(){this._disposables.splice(0).forEach(t=>t()),this.ctx.emit("command-removed",this);for(let t of this.children.slice())t.dispose();R(this.ctx.$commander._commandList,this),this.parent=null}toJSON(){return{name:this.name,description:this.ctx.i18n.get(`commands.${this.name}.description`),arguments:this._arguments.map(t=>({name:t.name,type:de(t.type),description:this.ctx.i18n.get(`commands.${this.name}.arguments.${t.name}`),required:t.required})),options:Object.entries(this._options).map(([t,i])=>({name:t,type:de(i.type),description:this.ctx.i18n.get(`commands.${this.name}.options.${t}`),required:i.required})),children:this.children.filter(t=>t.name.includes(".")).map(t=>t.toJSON())}}};function de(e){return typeof e=="string"?e:"string"}m(de,"toStringType");(e=>{e.Config=P.object({permissions:P.array(String).role("perms").default(["authority:1"]).description("权限继承。"),dependencies:P.array(String).role("perms").description("权限依赖。"),slash:P.boolean().description("启用斜线指令功能。").default(!0),captureQuote:P.boolean().description("是否捕获引用文本。").default(!0).hidden(),checkUnknown:P.boolean().description("是否检查未知选项。").default(!1).hidden(),checkArgCount:P.boolean().description("是否检查参数数量。").default(!1).hidden(),showWarning:P.boolean().description("是否显示警告。").default(!0).hidden(),handleError:P.union([P.boolean(),P.function()]).description("是否处理错误。").default(!0).hidden()})})(N||(N={}));function Ie(e){e.permissions.define("command:(name)",{depends:m(({name:t})=>{let i=e.$commander.get(t);if(!i)return;let s=[...i.config.dependencies??[]];return i.parent&&s.push(`command:${i.parent.name}`),s},"depends"),inherits:m(({name:t})=>e.$commander.get(t)?.config.permissions,"inherits"),list:m(()=>e.$commander._commandList.map(t=>`command:${t.name}`),"list")}),e.permissions.define("command:(name):option:(name2)",{depends:m(({name:t,name2:i})=>e.$commander.get(t)?._options[i]?.dependencies,"depends"),inherits:m(({name:t,name2:i})=>e.$commander.get(t)?._options[i]?.permissions,"inherits"),list:m(()=>e.$commander._commandList.flatMap(t=>Object.keys(t._options).map(i=>`command:${t.name}:option:${i}`)),"list")}),e.before("command/execute",async t=>{let{session:i,options:s,command:n}=t;if(!i.user)return;function r(a,...l){return n.config.showWarning?i.text(a,l):""}m(r,"sendHint");let c=[`command:${n.name}`];for(let a of Object.values(n._options))a.name in s&&c.push(`command:${n.name}:option:${a.name}`);if(!await e.permissions.test(c,i))return r("internal.low-authority")},!0),e.before("command/execute",async t=>{let{args:i,options:s,command:n,session:r}=t;function c(a,...l){return n.config.showWarning?r.text(a,l):""}if(m(c,"sendHint"),n.config.checkArgCount){let a=i.length;for(;n._arguments[a]?.required;){let u=n._arguments[a];await r.send(r.text("internal.prompt-argument",[r.text(`commands.${n.name}.arguments.${u.name}`)]));let g=await r.prompt();if(it(g))return c("internal.insufficient-arguments",u.name);i.push(e.$commander.parseValue(g,"argument",t,u)),a++}let l=n._arguments[n._arguments.length-1]||{};if(i.length>n._arguments.length&&!l.variadic)return c("internal.redunant-arguments")}if(n.config.checkUnknown){let a=Object.keys(s).filter(l=>!n._options[l]);if(a.length)return c("internal.unknown-option",a.join(", "))}},!0)}m(Ie,"validate");var st=Array.isArray,nt=/<[^>]+>|\[[^\]]+\]/g,rt=class{constructor(e,t={}){this.ctx=e,this.config=t,te(this,$.current,e),e.plugin(Ie),e.before("parse",(i,s)=>{let{isDirect:n,stripped:{prefix:r,appel:c}}=s;if(!(!n&&typeof r!="string"&&!c))return B.parse(i)}),e.on("interaction/command",i=>{if(i.event?.argv){let{name:s,options:n,arguments:r}=i.event.argv;i.execute({name:s,args:r,options:n})}else{if(i.stripped.hasAt=!0,i.stripped.appel=!0,i.stripped.atSelf=!0,i.stripped.prefix="",te(i,"argv",e.bail("before-parse",i.content,i)),!i.argv){e.logger("command").warn("failed to parse interaction command:",i.content);return}i.argv.root=!0,i.argv.session=i,i.execute(i.argv)}}),e.before("attach",i=>{let{hasAt:s,appel:n}=i.stripped;if(!n&&s)return;let r=i.stripped.content;for(let c of this._resolvePrefixes(i))if(r.startsWith(c)){i.stripped.prefix=c,r=r.slice(c.length);break}te(i,"argv",e.bail("before-parse",r,i)),i.argv&&(i.argv.root=!0,i.argv.session=i)}),e.middleware((i,s)=>this.resolveCommand(i.argv)?i.execute(i.argv,s):s()),e.middleware((i,s)=>{let{argv:n,quote:r,isDirect:c,stripped:{prefix:a,appel:l}}=i;if(n?.command||!c&&!a&&!l)return s();let u=i.stripped.content.slice((a??"").length),g=u.split(/\s/,1)[0].toLowerCase();return g?s(async b=>{let v=new Map,_=await i.suggest({actual:g,expect:this.available(i),suffix:i.text("internal.suggest-command"),filter:m(d=>(d=this.resolve(d).name,e.permissions.test(`command:${d}`,i,v)),"filter")});if(!_)return b();let o=_+u.slice(g.length)+(r?.content?" "+r.content:"");return i.execute(o,b)}):s()}),e.schema.extend("command",N.Config,1e3),e.schema.extend("command-option",ie.object({permissions:ie.array(String).role("perms").default(["authority:0"]).description("权限继承。"),dependencies:ie.array(String).role("perms").description("权限依赖。")}),1e3),e.on("ready",()=>{e.bots.filter(s=>s.status===pe.Status.ONLINE&&s.updateCommands).forEach(s=>this.updateCommands(s))}),e.on("bot-status-updated",async i=>{i.status!==pe.Status.ONLINE||!i.updateCommands||this.updateCommands(i)}),this.domain("el",i=>M.parse(i),{greedy:!0}),this.domain("elements",i=>M.parse(i),{greedy:!0}),this.domain("string",i=>M.unescape(i)),this.domain("text",i=>M.unescape(i),{greedy:!0}),this.domain("rawtext",i=>M("",M.parse(i)).toString(!0),{greedy:!0}),this.domain("boolean",()=>!0),this.domain("number",(i,s)=>{let n=+i.replace(/[,_]/g,"");if(Number.isFinite(n))return n;throw new Error("internal.invalid-number")},{numeric:!0}),this.domain("integer",(i,s)=>{let n=+i.replace(/[,_]/g,"");if(n*0===0&&Math.floor(n)===n)return n;throw new Error("internal.invalid-integer")},{numeric:!0}),this.domain("posint",(i,s)=>{let n=+i.replace(/[,_]/g,"");if(n*0===0&&Math.floor(n)===n&&n>0)return n;throw new Error("internal.invalid-posint")},{numeric:!0}),this.domain("natural",(i,s)=>{let n=+i.replace(/[,_]/g,"");if(n*0===0&&Math.floor(n)===n&&n>=0)return n;throw new Error("internal.invalid-natural")},{numeric:!0}),this.domain("bigint",(i,s)=>{try{return BigInt(i.replace(/[,_]/g,""))}catch{throw new Error("internal.invalid-integer")}},{numeric:!0}),this.domain("date",(i,s)=>{let n=Fe.parseDate(i);if(+n)return n;throw new Error("internal.invalid-date")}),this.domain("user",(i,s)=>{if(i.startsWith("@"))return i=i.slice(1),i.includes(":")?i:`${s.platform}:${i}`;let n=M.from(i);if(n&&n.type==="at")return`${s.platform}:${n.attrs.id}`;throw new Error("internal.invalid-user")}),this.domain("channel",(i,s)=>{if(i.startsWith("#"))return i=i.slice(1),i.includes(":")?i:`${s.platform}:${i}`;let n=M.from(i);if(n&&n.type==="sharp")return`${s.platform}:${n.attrs.id}`;throw new Error("internal.invalid-channel")}),this.defineElementDomain("image","image","img"),this.defineElementDomain("img","image","img"),this.defineElementDomain("audio"),this.defineElementDomain("video"),this.defineElementDomain("file")}static{m(this,"Commander")}_commandList=[];defineElementDomain(e,t=e,i=e){this.domain(e,(s,n)=>{let r=M.from(s,{type:i});if(r&&r.type===i)return r.attrs;throw new Error(`internal.invalid-${t}`)})}get(e,t){return this._commandList.find(i=>{let s=i._aliases[e];return s&&(t?.resolve(s.filter)??!0)})}updateCommands(e){return e.updateCommands(this._commandList.filter(t=>!t.name.includes(".")&&t.config.slash).map(t=>t.toJSON()))}_resolvePrefixes(e){let t=e.resolve(this.config.prefix);return(Array.isArray(t)?t:[t||""]).map(s=>M.escape(s)).sort().reverse()}available(e){return this._commandList.filter(t=>t.match(e)).flatMap(t=>Object.keys(t._aliases))}resolve(e){return this._resolve(e).command}_resolve(e){if(!e)return{};let t=N.normalize(e).split("."),i=1,s=t[0],n;for(;(n=this.get(s))&&i<t.length;)s=n.name+"."+t[i++];return{command:n,name:s}}inferCommand(e){if(!e)return;if(e.command)return e.command;if(e.name)return e.command=this.resolve(e.name);let{stripped:t,isDirect:i,quote:s}=e.session,n=this.config.prefixMode==="strict"||!i&&!t.appel;if(e.root&&t.prefix===null&&n)return;let r=[];for(;e.tokens.length;){let{content:c}=e.tokens[0];r.push(c);let{name:a,command:l}=this._resolve(r.join("."));if(!l||(e.tokens.shift(),e.command=l,e.args=l._aliases[a].args,e.options=l._aliases[a].options,l._arguments.length))break}return e.root&&e.command?.config.captureQuote!==!1&&s?.content&&e.tokens.push({content:s.content,quoted:!0,inters:[],terminator:""}),e.command}resolveCommand(e){if(this.inferCommand(e)){if(e.tokens?.every(t=>!t.inters.length)){let{options:t,args:i,error:s}=e.command.parse(e);e.options=t,e.args=i,e.error=s}return e.command}}command(e,...t){let i=typeof t[0]=="string"?t.shift():"",s=t[0],n=N.normalize(e.split(" ",1)[0]),r=e.slice(n.length),c=n.split(/(?=[./])/g),a,l,u=[];return c.forEach((g,b)=>{let v=g.charCodeAt(0),_=v===46?a.name+g:v===47?g.slice(1):g,o=this.get(_);if(o){if(a){if(o===a)throw new Error(`cannot set a command (${o.name}) as its own subcommand`);if(o.parent){if(o.parent!==a)throw new Error(`cannot create subcommand ${n}: ${o.parent.name}/${o.name} already exists`)}else o.parent=a}return a=o}let d=b===c.length-1;o=new N(_,d?r:"",this.ctx,d?s:{}),o._disposables.push(this.ctx.i18n.define("",{[`commands.${o.name}.$`]:"",[`commands.${o.name}.description`]:d?i:""})),u.push(o),l||=o,a&&(o.parent=a),a=o}),Object.assign(a.config,s),u.forEach(g=>this.ctx.emit("command-added",g)),a[$.current]=this.ctx,l&&this.ctx.collect(`command <${l.name}>`,()=>l.dispose()),a}domain(e,t,i){let s="domain:"+e;return t?this.ctx.set(s,{transform:t,...i}):this.ctx.get(s)}resolveDomain(e){return typeof e=="function"?{transform:e}:e instanceof RegExp?{transform:m(i=>{if(e.test(i))return i;throw new Error},"transform")}:st(e)?{transform:m(i=>{if(e.includes(i))return i;throw new Error},"transform")}:typeof e=="object"?e??{}:this.ctx.get(`domain:${e}`)??{}}parseValue(e,t,i,s={}){let{name:n,type:r="string"}=s,c=this.resolveDomain(r);try{return c.transform(e,i.session)}catch(a){if(!i.session)i.error=`internal.invalid-${t}`;else{let l=i.session.text(a.message||"internal.check-syntax");i.error=i.session.text(`internal.invalid-${t}`,[n,l])}}}parseDecl(e){let t,i=[];for(;t=nt.exec(e);){let s=t[0].slice(1,-1),n=!1;s.startsWith("...")&&(s=s.slice(3),n=!0);let[r,c]=s.split(":"),a=c?c.trim():void 0;i.push({name:r,variadic:n,type:a,required:t[0][0]==="<"})}return i.stripped=e.replace(/:[\w-]+(?=[>\]])/g,s=>this.ctx.get(`domain:${s.slice(1)}`)?.greedy?"...":"").trimEnd(),i}},ct={general:{$:"通用设置",name:"中文",paren:"（{0}）",quote:"“{0}”",comma:"，",and:"和",or:"或",day:"天",hour:"小时",minute:"分钟",second:"秒"},internal:{$:"核心文本","error-encountered":"发生未知错误。","low-authority":"权限不足。","prompt-argument":"请发送{0}。","insufficient-arguments":"缺少参数，输入帮助以查看用法。","redunant-arguments":"存在多余参数，输入帮助以查看用法。","invalid-argument":"参数 {0} 输入无效，{1}","unknown-option":"存在未知选项 {0}，输入帮助以查看用法。","invalid-option":"选项 {0} 输入无效，{1}","check-syntax":"输入帮助以查看用法。","invalid-number":"请提供一个数字。","invalid-integer":"请提供一个整数。","invalid-posint":"请提供一个正整数。","invalid-natural":"请提供一个非负整数。","invalid-date":"请输入合法的时间。","invalid-user":"请指定正确的用户。","invalid-channel":"请指定正确的频道。","invalid-image":"请上传图片。","invalid-audio":"请上传音频。","invalid-video":"请上传视频。","invalid-file":"请上传文件。","suggest-hint":"您要找的是不是{0}？","suggest-command":"回复句号以使用推测的指令。"},commands:{$:"指令系统"}},lt={general:{$:"General Settings",name:"English",paren:" ({0}) ",quote:'"{0}"',comma:"，",and:"and",or:"or",day:"day",hour:"hour",minute:"minute",second:"second"},internal:{$:"Internal Text","error-encountered":"An unknown error has occurred.","low-authority":"Low authority.","prompt-argument":"请发送{0}。","insufficient-arguments":"Insufficient arguments, type help to see usage.","redunant-arguments":"Redunant arguments, type help to see usage.","invalid-argument":"Invalid argument {0}, {1}","unknown-option":"Unknown option {0}, type help to see usage.","invalid-option":"Invalid option {0}, {1}","check-syntax":"Type help to see usage.","invalid-number":"Expect a number.","invalid-integer":"Expect an integer.","invalid-posint":"Expect a positive integer.","invalid-natural":"Expect a non-negative integer.","invalid-date":"Expect a valid date.","invalid-user":"Expect a valid user.","invalid-channel":"Expect a valid channel.","invalid-image":"Expect an image.","invalid-audio":"Expect an audio.","invalid-video":"Expect a video.","invalid-file":"Expect a file.","suggest-hint":"Do you mean {0}?","suggest-command":"Send a period to apply the suggestion."},commands:{$:"Command System"}},ve=new at("i18n"),ht=Symbol("template");function me(e){let t=[],i=e.replace(/\(([^)]+)\)/g,(n,r)=>(t.push(r),"(.+)")),s=new RegExp(`^${i}$`);return n=>{let r=s.exec(n);if(!r)return;let c={};for(let a=0;a<t.length;a++)c[t[a]]=r[a+1];return c}}m(me,"createMatch");var W=class{constructor(e,t){this.ctx=e,this.locales=F.from(t.locales),this.define("",{"":""}),this.define("zh-CN",ct),this.define("en-US",lt)}static{m(this,"I18n")}_data={};_presets={};locales;fallback(e){return Z(this.locales,e)}compare(e,t,i={}){let s=1-fe(e,t)/e.length,n=i.minSimilarity??this.ctx.root.config.minSimilarity;return s>=n?s:0}get(e,t=[]){let i={};for(let s of this.fallback(t)){let n=this._data[s]?.[e];n&&(i[s]=n)}return i}*set(e,t,i){if(typeof i=="object"&&i&&!t.includes("@"))for(let s in i)s.startsWith("_")||(yield*this.set(e,t+s+".",i[s]));else{if(t.includes("@"))throw new Error("preset is deprecated");if(typeof i=="string"){let s=this._data[e],n=t.slice(0,-1);!ot(s[n])&&!e.startsWith("$")&&s[n]!==i&&ve.warn("override",e,n),s[n]=i,yield n}else delete this._data[e][t.slice(0,-1)]}}define(e,...t){let i=this._data[e]||={},s=[...typeof t[0]=="string"?this.set(e,t[0]+".",t[1]):this.set(e,"",t[0])];return this.ctx.emit("internal/i18n"),this.ctx.collect("i18n",()=>{for(let n of s)delete i[n];this.ctx.emit("internal/i18n")})}find(e,t,i={}){if(!t)return[];let s=me(e),n=[];for(let r in this._data)for(let c in this._data[r]){let a=s(c);if(!a)continue;let l=this._data[r][c];if(typeof l!="string")continue;let u=this.compare(l,t,i);u&&n.push({locale:r,data:a,similarity:u})}return n}_render(e,t,i){if(e!==void 0){if(typeof e!="string"){let s=e[ht],n=this._presets[s];if(!n)throw new Error(`Preset "${s}" not found`);return[ce.text(n(e,t,i))]}return ce.parse(e,t)}}text(e,t,i){return this.render(e,t,i).join("")}render(e,t,i){e=this.fallback(e);for(let s of t)for(let n of e)for(let r of["$"+n,n]){let c=this._data[r]?.[s];if(!(c===void 0||!c&&!n&&s!==""))return this._render(c,i,n)}return ve.warn("missing",t[0]),[ce.text(t[0])]}};(e=>{e.Config=H.object({locales:H.array(String).role("table").default(["zh-CN","en-US","fr-FR","ja-JP","de-DE","ru-RU"]).description("可用的语言列表。按照回退顺序排列。"),output:H.union([H.const("prefer-user").description("优先使用用户语言"),H.const("prefer-channel").description("优先使用频道语言")]).default("prefer-channel").description("输出语言偏好设置。")}).description("国际化设置")})(W||(W={}));var ke=new dt("session");function Oe(e,t,i){for(let s of t){if(typeof s=="function"){s(e,i);continue}for(let n of s)i.add(n)}return i}m(Oe,"collectFields");var pt=class{static{m(this,"KoishiSession")}constructor(e){e.mixin(this,{resolve:"session.resolve",stripped:"session.stripped",username:"session.username",send:"session.send",cancelQueued:"session.cancelQueued",sendQueued:"session.sendQueued",getChannel:"session.getChannel",observeChannel:"session.observeChannel",getUser:"session.getUser",observeUser:"session.observeUser",withScope:"session.withScope",resolveScope:"session.resolveScope",text:"session.text",i18n:"session.i18n",collect:"session.collect",execute:"session.execute",middleware:"session.middleware",prompt:"session.prompt",suggest:"session.suggest"})}resolve(e,...t){return typeof e=="function"?Reflect.apply(e,null,[this,...t]):ft(e)?mt({_:this},e):e}_stripNickname(e){e.startsWith("@")&&(e=e.slice(1));for(let t of this.resolve(this.app.koishi.config.nickname)??[]){if(!e.startsWith(t))continue;let i=e.slice(t.length),s=/^([,，]\s*|\s+)/.exec(i);if(s)return i.slice(s[0].length)}}get parsed(){return this.stripped}get stripped(){if(this._stripped)return this._stripped;if(!this.elements)return{};let e=!1,t=!1,i=!1,s=this.elements.slice();for(;s[0]?.type==="at";){let{attrs:r}=s.shift();r.id===this.selfId&&(e=t=!0),(!this.quote?.user?.id||this.quote.user.id!==r.id)&&(i=!0),s[0]?.type==="text"&&!s[0].attrs.content.trim()&&s.shift()}let n=s.join("").trim();if(!i){let r=this._stripNickname(n);r&&(t=!0,n=r)}return this._stripped={hasAt:i,content:n,appel:t,atSelf:e,prefix:null}}get username(){return this.user&&this.user.name?this.user.name:this.author.nick||this.author.name||this.userId}async send(e,t={}){if(e)return t.session=this,this.bot.sendMessage(this.channelId,e,this.guildId,t).catch(i=>(ke.warn(i),[]))}cancelQueued(e=this.app.koishi.config.delay.cancel){clearTimeout(this._queuedTimeout),this._queuedTasks=[],this._queuedTimeout=setTimeout(()=>this._next(),e)}_next(){let e=this._queuedTasks?.shift();if(!e){this._queuedTimeout=null;return}this.send(e.content).then(e.resolve,e.reject),this._queuedTimeout=setTimeout(()=>this._next(),e.delay)}async sendQueued(e,t){let i=Q.normalize(e).join("");if(i){if($e(t)){let{message:s,character:n}=this.app.koishi.config.delay;t=Math.max(s,n*i.length)}return new Promise((s,n)=>{(this._queuedTasks??=[]).push({content:e,delay:t,resolve:s,reject:n}),this._queuedTimeout||this._next()})}}async getChannel(e=this.channelId,t=[]){let{app:i,platform:s,guildId:n}=this;if(!t.length)return{platform:s,id:e,guildId:n};let r=await i.database.getChannel(s,e,t);if(r)return r;let c=this.resolve(i.koishi.config.autoAssign)?this.selfId:"";if(c)return i.database.createChannel(s,e,{assignee:c,guildId:n,createdAt:new Date});{let a=i.model.tables.channel.create();return Object.assign(a,{platform:s,id:e,guildId:n,$detached:!0}),a}}async _observeChannelLike(e,t=[]){let i=new Set(t),{platform:s}=this,n=`${s}:${e}`,r=this.app.$processor._channelCache.get(this.id,n);if(r){for(let a in r)i.delete(a);if(!i.size)return r}let c=await this.getChannel(e,[...i]);return r=this.app.$processor._channelCache.get(this.id,n),r?r.$merge(c):(r=le(c,async a=>{c.$detached||await this.app.database.setChannel(s,e,a)},`channel ${n}`),this.app.$processor._channelCache.set(this.id,n,r)),r}async observeChannel(e){let t=[this._observeChannelLike(this.channelId,e)];this.channelId!==this.guildId&&t.push(this._observeChannelLike(this.guildId,e));let[i,s=i]=await Promise.all(t);return this.guild=s,this.channel=i,i}async getUser(e=this.userId,t=[]){let{app:i,platform:s}=this;if(!t.length)return{};let n=await i.database.getUser(s,e,t);if(n)return n;let r=this.resolve(i.koishi.config.autoAuthorize),c={locales:this.locales,authority:r,createdAt:new Date};if(r)return i.database.createUser(s,e,c);{let a=i.model.tables.user.create();return Object.assign(a,{...c,$detached:!0}),a}}async observeUser(e){let t=new Set(e),{userId:i}=this,s=this.user||this.app.$processor._userCache.get(this.id,this.uid);if(s){for(let r in s)t.delete(r);if(!t.size)return this.user=s}if(this.author?.anonymous){let r=this.app.model.tables.user.create();r.authority=this.resolve(this.app.koishi.config.autoAuthorize);let c=le(r,()=>Promise.resolve());return this.user=c}let n=await this.getUser(i,[...t]);return s=this.user||this.app.$processor._userCache.get(this.id,this.uid),s?s.$merge(n):(s=le(n,async r=>{n.$detached||await this.app.database.setUser(this.platform,i,r)},`user ${this.uid}`),this.app.$processor._userCache.set(this.id,this.uid,s)),this.user=s}async withScope(e,t){let i=this.scope;try{this.scope=e;let s=await t();return Q.transform(s,{i18n:m((n,r)=>Q.i18n({...n,path:this.resolveScope(n.path)},r),"i18n")},this)}finally{this.scope=i}}resolveScope(e){return e.startsWith(".")?this.scope?this.scope+e:(this.app.logger("i18n").warn(new Error(`missing scope for "${e}"`)),""):e}text(e,t={}){return this.i18n(e,t).join("")}i18n(e,t={}){let i=[...this.channel?.locales||[],...this.guild?.locales||[]];this.app.koishi.config.i18n.output==="prefer-user"?i.unshift(...this.user?.locales||[]):i.push(...this.user?.locales||[]),i.unshift(...this.locales||[]);let s=ut(e).map(n=>this.resolveScope(n));return this.app.i18n.render(i,s,t)}collect(e,t,i=new Set){let s=m(n=>{if(n.session=this,n.tokens)for(let{inters:r}of n.tokens)r.forEach(s);this.app.$commander.resolveCommand(n)&&(this.app.emit(n.session,`command/before-attach-${e}`,n,i),Oe(n,n.command[`_${e}Fields`],i))},"collect");return t&&s(t),i}async execute(e,t){if(typeof e=="string"&&(e=B.parse(e)),e.session=this,e.tokens){for(let n of e.tokens){let{inters:r}=n,c=[];for(let a=0;a<r.length;++a){let l=await this.execute(r[a],!0),u=await this.transform(l);c.push(u.join(""))}for(let a=r.length-1;a>=0;--a){let{pos:l}=r[a];n.content=n.content.slice(0,l)+c[a]+n.content.slice(l)}n.inters=[]}if(!this.app.$commander.resolveCommand(e))return[]}else if(e.command||=this.app.$commander.get(e.name),!e.command)return ke.warn(new Error(`cannot find command ${e.name}`)),[];let{command:i}=e;if(!i.ctx.filter(this))return[];this.app.database&&(this.isDirect||await this.observeChannel(this.collect("channel",e,new Set(["permissions","locales"]))),await this.observeUser(this.collect("user",e,new Set(["authority","permissions","locales"]))));let s=!0;return t===!0&&(s=!1,t=void 0),this.withScope(`commands.${i.name}.messages`,async()=>{let n=await i.execute(e,t);return s?(await this.send(n),[]):Q.normalize(n)})}middleware(e){let t=this.fid;return this.app.middleware(async(i,s)=>t&&i.fid!==t?s():e(i,s),!0)}prompt(...e){let t=typeof e[0]=="function"?e.shift():s=>{let n=s.elements.slice();return n[0]?.type==="at"&&n[0].attrs.id===s.selfId&&n.shift(),n.join("").trim()},i=typeof e[0]=="number"?{timeout:e[0]}:e[0]??{};return new Promise(s=>{let n=this.middleware(async(c,a)=>{clearTimeout(r),n();let l=await t(c);if(s(l),$e(l))return a()}),r=setTimeout(()=>{n(),s(void 0)},i.timeout??this.app.koishi.config.delay.prompt)})}async suggest(e){let{expect:t,filter:i,prefix:s=""}=e;if(e.actual&&(t=t.filter(n=>n&&this.app.i18n.compare(n,e.actual,e)),i&&(t=(await Promise.all(t.map(async n=>[n,await i(n)]))).filter(([,n])=>n).map(([n])=>n))),!t.length){await this.send(s);return}if(s+=this.text("internal.suggest-hint",[t.map(n=>this.text("general.quote",[n])).join(this.text("general.or"))]),t.length>1){await this.send(s);return}return await this.send(s+e.suffix),this.prompt(n=>{let{content:r,atSelf:c,hasAt:a}=n.stripped;if(!(!c&&a)&&(r==="."||r==="。"))return t[0]},e)}},gt=pt,wt=new yt("app"),xt=class{constructor(e){this.ctx=e,_t(this,$.current,e),e.alias("permissions",["perms"]),this.define("authority:(value)",{check:m(({value:t},{user:i})=>!i||i.authority>=+t,"check"),list:m(()=>Array(5).fill(0).map((t,i)=>`authority:${i}`),"list")}),this.provide("(name)",({name:t},i)=>i.bot?.checkPermission(t,i)),this.provide("(name)",({name:t},i)=>i.permissions?.includes(t)||i.user?.permissions?.includes(t)||i.channel?.permissions?.includes(t))}static{m(this,"Permissions")}store=[];define(e,t){let i={...t,match:me(e)};return e.includes("(")||(i.list||=()=>[e]),this.ctx.effect(()=>(this.store.push(i),()=>bt(this.store,i)))}provide(e,t){return this.define(e,{check:t})}inherit(e,t){return this.define(e,{inherits:t})}depend(e,t){return this.define(e,{depends:t})}list(e=new Set){for(let{list:t}of this.store)if(t)for(let i of t())e.add(i);return[...e]}async check(e,t){return(await Promise.all(this.store.map(async({match:s,check:n})=>{if(!n)return!1;let r=s(e);if(!r)return!1;try{return await n(r,t)}catch(c){return wt.warn(c),!1}}))).some(Boolean)}subgraph(e,t,i=new Set){let s,n=[...t];for(;s=n.shift();)if(!i.has(s)){i.add(s);for(let r of this.store){let c=r.match(s);if(!c)continue;let a=r[e];typeof a=="function"&&(a=a(c)),Array.isArray(a)&&n.push(...a)}}return i}async test(e,t={},i=new Map){t=t[$.shadow]||t,typeof e=="string"&&(e=[e]);for(let s of this.subgraph("depends",e)){let n=[...this.subgraph("inherits",[s])];if(!(await Promise.all(n.map(c=>{let a=i.get(c);return a||(a=this.check(c,t),i.set(c,a)),a}))).some(c=>c))return!1}return!0}};Te(kt,"filter",!1);Te($t,"filter",!1);var Ct=class{static{m(this,"KoishiBot")}constructor(e){e.mixin(this,{getGuildMemberMap:"bot.getGuildMemberMap",broadcast:"bot.broadcast"})}async getGuildMemberMap(e){let t={};for await(let i of this.getGuildMemberIter(e))t[i.user.id]=i.name||i.user.name;return t}async broadcast(e,t,i=this.ctx.root.config.delay.broadcast){let s=[];for(let n=0;n<e.length;n++){n&&i&&await vt(i);try{let r=e[n];s.push(...typeof r=="string"?await this.sendMessage(r,t):Array.isArray(r)?await this.sendMessage(r[0],t,r[1]):await this.sendMessage(r.channelId,t,r.guildId,{session:r}))}catch(r){this.ctx.logger("bot").warn(r)}}return s}},St=Ct;C.dynamic=m(function(t){return C.any().role("dynamic",{name:t})},"dynamic");C.filter=m(function(){return C.any().role("filter")},"filter");C.computed=m(function(t,i={}){return C.union([C.from(t),C.object({$switch:C.object({branches:C.array(C.object({case:C.any(),then:C.from(t)})),default:C.from(t)})}).hidden(),C.any().hidden()]).role("computed",i)},"computed");C.path=m(function(t={}){return C.string().role("path",t)},"path");C.prototype.computed=m(function(t={}){return C.computed(this,t).default(this.meta.default)},"computed");var Ce=Symbol("schema-order"),At=class{constructor(e){this.ctx=e,this.extend("intercept.http",C.object({timeout:C.natural().role("ms").description("等待连接建立的最长时间。"),proxyAgent:C.string().description("使用的代理服务器地址。"),keepAlive:C.boolean().description("是否保持连接。")}))}static{m(this,"SchemaService")}_data=Object.create(null);extend(e,t,i=0){let s=this[$.current],n=this.get(e),r=n.list.findIndex(c=>c[Ce]<i);t[Ce]=i,r>=0?n.list.splice(r,0,t):n.list.push(t),this.ctx.emit("internal/schema",e),s?.on("dispose",()=>{Et(n.list,t),this.ctx.emit("internal/schema",e)})}get(e){return this._data[e]||=C.intersect([])}set(e,t){let i=this[$.current];this._data[e]=t,this.ctx.emit("internal/schema",e),i?.on("dispose",()=>{delete this._data[e],this.ctx.emit("internal/schema",e)})}},$=class extends U.Context{static{m(this,"Context")}static shadow=Symbol.for("session.shadow");constructor(e={}){super(e),this.mixin("$processor",["match","middleware"]),this.mixin("$filter",["any","never","union","intersect","exclude","user","self","guild","channel","platform","private"]),this.mixin("$commander",["command"]),this.provide("$filter",new We(this),!0),this.provide("schema",new At(this),!0),this.provide("$processor",new tt(this),!0),this.provide("i18n",new W(this,this.config.i18n),!0),this.provide("permissions",new xt(this),!0),this.provide("model",void 0,!0),this.provide("http",void 0,!0),this.provide("$commander",new rt(this,this.config),!0),this.plugin(Ee.Database),this.plugin(jt,this.config)}get app(){return this.root}get options(){return this.root.config}async waterfall(...e){let t=typeof e[0]=="object"||typeof e[0]=="function"?e.shift():null,i=e.shift();for(let s of this.lifecycle.filterHooks(this.lifecycle._hooks[i]||[],t)){let n=await s.callback.apply(t,e);e[0]=n}return e[0]}chain(...e){let t=typeof e[0]=="object"||typeof e[0]=="function"?e.shift():null,i=e.shift();for(let s of this.lifecycle.filterHooks(this.lifecycle._hooks[i]||[],t)){let n=s.callback.apply(t,e);e[0]=n}return e[0]}before(e,t,i=!1){let s=e.split("/");return s[s.length-1]="before-"+s[s.length-1],this.on(s.join("/"),t,!i)}},jt=class extends Se.Service{constructor(e,t){super(e,"koishi",!0),this.config=t}static{m(this,"Koishi")}bot=new St(this.ctx);database=new et(this.ctx);session=new gt(this.ctx)};U.Session.prototype[$.filter]=function(e){return e.filter(this)};(e=>{e.Config=S.intersect([S.object({})])})($||($={}));X($.Config,"Basic",S.object({prefix:S.array(S.string().default("")).default([""]).role("table").computed().description("指令前缀字符构成的数组。将被用于指令的匹配。"),prefixMode:S.union([S.const("auto").description("默认：当存在称呼时允许无前缀触发。"),S.const("strict").description("严格：只有在指令前缀匹配时才允许触发。")]).experimental().role("radio").default("auto").description("指令前缀匹配模式。"),nickname:S.array(String).role("table").computed().description("机器人昵称构成的数组。将被用于指令的匹配。"),autoAssign:S.boolean().default(!0).computed().description("当获取不到频道数据时，是否使用接受者作为受理人。"),autoAuthorize:S.natural().default(1).computed().description("当获取不到用户数据时默认使用的权限等级。"),minSimilarity:S.percent().default(1).description("用于模糊匹配的相似系数，应该是一个 0 到 1 之间的数值。数值越高，模糊匹配越严格。设置为 1 可以完全禁用模糊匹配。")}).description("基础设置"));X($.Config,"I18n",W.Config);X($.Config,"Delay",S.object({character:S.natural().role("ms").default(0).description("调用 `session.sendQueued()` 时消息间发送的最小延迟，按前一条消息的字数计算。"),message:S.natural().role("ms").default(.1*ee.second).description("调用 `session.sendQueued()` 时消息间发送的最小延迟，按固定值计算。"),cancel:S.natural().role("ms").default(0).description("调用 `session.cancelQueued()` 时默认的延迟。"),broadcast:S.natural().role("ms").default(.5*ee.second).description("调用 `bot.broadcast()` 时默认的延迟。"),prompt:S.natural().role("ms").default(ee.minute).description("调用 `session.prompt()` 时默认的等待时间。")}));X($.Config,"Advanced",S.object({maxListeners:S.natural().default(64).description("每种监听器的最大数量。如果超过这个数量，Koishi 会认定为发生了内存泄漏，将产生一个警告。")}).description("高级设置"));$.Config.list.push($.Config.Basic);$.Config.list.push(S.object({i18n:W.Config}));$.Config.list.push(S.object({delay:$.Config.Delay}).description("延迟设置"));$.Config.list.push($.Config.Advanced);$.Config.list.push(S.object({request:He.Config}));var Mi=class extends U.Service{static{m(this,"Service")}[U.Service.setup](){this.ctx=new $}};function It(e){return e}m(It,"defineConfig");export{bi as Adapter,$ as App,B as Argv,wi as Bot,ue as Channel,N as Command,rt as Commander,$ as Context,xi as Element,We as FilterService,$i as HTTP,W as I18n,ki as Logger,Ci as MessageEncoder,Si as Messenger,L as Next,xt as Permissions,tt as Processor,Ei as Quester,Ai as Schema,At as SchemaService,Mi as Service,Ae as SessionError,xe as SharedCache,Ii as Universal,he as User,me as createMatch,It as defineConfig,vi as h,Pi as resolveConfig,ji as segment,De as version,Oi as z};
