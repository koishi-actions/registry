var D=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var B=Object.prototype.hasOwnProperty;var L=(a,e)=>()=>(a&&(e=a(a=0)),e);var A=(a,e)=>()=>(e||a((e={exports:{}}).exports,e),e.exports);var k=(a,e,t,d)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of J(e))!B.call(a,o)&&o!==t&&D(a,o,{get:()=>e[o],enumerable:!(d=$(e,o))||d.enumerable});return a},b=(a,e,t)=>(k(a,e,"default"),t&&k(t,e,"default"));var F=a=>k(D({},"__esModule",{value:!0}),a);import{Buffer as v}from"https://registry.koishi.chat/modules/buffer/index.js";import _ from"https://registry.koishi.chat/modules/process/index.js";var h=L(()=>{});var p={};import*as ce from"https://registry.koishi.chat/modules/koishi/index.js";var O=L(()=>{h();b(p,ce)});import G from"https://registry.koishi.chat/modules/crypto-browserify/index.js";var q=A((le,P)=>{h();P.exports=G});import K from"https://registry.koishi.chat/modules/@cordiverse/path/index.js";var C=A((fe,N)=>{h();N.exports=K});var ne=A((be,H)=>{h();var w=Object.defineProperty,Q=Object.getOwnPropertyDescriptor,M=Object.getOwnPropertyNames,R=Object.prototype.hasOwnProperty,V=(a,e,t)=>e in a?w(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,x=(a,e)=>w(a,"name",{value:e,configurable:!0}),W=(a,e)=>function(){return e||(0,a[M(a)[0]])((e={exports:{}}).exports,e),e.exports},X=(a,e)=>{for(var t in e)w(a,t,{get:e[t],enumerable:!0})},Y=(a,e,t,d)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of M(e))!R.call(a,o)&&o!==t&&w(a,o,{get:()=>e[o],enumerable:!(d=Q(e,o))||d.enumerable});return a},Z=a=>Y(w({},"__esModule",{value:!0}),a),ee=(a,e,t)=>(V(a,typeof e!="symbol"?e+"":e,t),t),te=W({"external/webui/plugins/auth/src/locales/zh-CN.yml"(a,e){e.exports=[{$description:"管理员设置",admin:{enabled:"启用管理员账号。",username:"管理员用户名。",password:"管理员密码。"}},{$description:"高级设置",authTokenExpire:"用户令牌有效期。",loginTokenExpire:"登录令牌有效期。"}]}}),z={};X(z,{default:()=>re,randomId:()=>S});H.exports=Z(z);var s=(O(),F(p)),ae=q(),I=C(),U="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";function S(a=40){return Array(a).fill(0).map(()=>U[Math.floor(Math.random()*U.length)]).join("")}x(S,"randomId");function y(a){return(0,ae.createHash)("sha256").update(a).digest("hex")}x(y,"toHash");var T=class extends s.Service{constructor(e,t){super(e,"auth"),this.config=t,e.model.extend("user",{password:"string(255)",config:{type:"json",length:65535,initial:null}}),e.model.extend("token",{inc:"unsigned",id:"unsigned",type:"string(255)",token:"string(255)",expiredAt:"unsigned(8)",createdAt:"timestamp",lastUsedAt:"timestamp",userAgent:"string(255)",address:"string(255)"},{primary:"inc",autoInc:!0,unique:["token"]}),e.console.addEntry({dev:(0,I.resolve)(import.meta.url,"../client/index.ts"),prod:(0,I.resolve)(import.meta.url,"../dist")}),this.initLogin()}async start(){let{enabled:e,username:t,password:d}=this.config.admin;e&&(this.logger.info("creating admin account"),await this.ctx.database.upsert("user",[{id:0,name:t,authority:5,password:y(d),createdAt:new Date}]))}async setAuth(e,t=e.auth,d=!1){if(e.auth=t,!d){if(t){let o=await this.ctx.database.get("binding",{aid:t.id});o.forEach(n=>delete n.aid);let r=await this.ctx.database.get("token",{id:t.id});r.reverse().forEach(n=>(delete n.id,delete n.token)),e.send({type:"data",body:{key:"user",value:{...t,bindings:o,tokens:r}}})}else e.send({type:"data",body:{key:"user",value:null}});e.ctx.emit("console/connection",e),e.refresh()}}async createToken(e,t,d){var o,r;let{headers:n,socket:i}=e.request,u=new Date,c=new Date,l=(o=n["user-agent"])==null?void 0:o.toString(),g=((r=n["x-forwarded-for"])==null?void 0:r.toString())||i.remoteAddress,m=Date.now()+this.config.authTokenExpire,f=S();await this.ctx.database.create("token",{id:d.id,type:t,expiredAt:m,token:f,createdAt:u,lastUsedAt:c,userAgent:l,address:g}),await this.setAuth(e,{...d,expiredAt:m,token:f})}initLogin(){let e=this,{ctx:t,config:d}=this,o={};t.console.addListener("login/password",async function(r,n){n=y(n);let[i]=await t.database.get("user",{name:r},["password","name","id","authority","config"]);if(!i||i.password!==n)throw new Error("用户名或密码错误。");await e.createToken(this,"password",(0,s.omit)(i,["password"]))}),t.console.addListener("login/token",async function(r,n){let[i]=await t.database.get("token",{id:r,token:n},["expiredAt"]);if(!i||i.expiredAt<=Date.now())throw new Error("令牌已失效。");let[u]=await t.database.get("user",{id:r},["id","name","authority","config"]);if(!u)throw new Error("用户不存在。");await t.database.set("token",{token:n},{lastUsedAt:new Date}),await e.setAuth(this,{...u,...i,token:n})}),t.console.addListener("login/platform",async function(r,n){var i;let u=await t.database.getUser(r,n,["id","name"]);if(!u)throw new Error("找不到此账户。");if(((i=this.auth)==null?void 0:i.id)===u.id)throw new Error("你已经绑定了此账户。");let c=`${r}:${n}`,l=Math.random().toString().slice(2,8),g=Date.now()+d.loginTokenExpire;o[c]=[l,g,this];let m=x(()=>{delete o[c],f(),this.socket.removeEventListener("close",f)},"listener"),f=t.setTimeout(()=>{var j;((j=o[c])==null?void 0:j[1])>=Date.now()&&m()},d.loginTokenExpire);return this.socket.addEventListener("close",m),{id:u.id,name:u.name,token:l,expiredAt:g}}),t.middleware(async(r,n)=>{let i=o[r.uid];if(!i||i[0]!==r.stripped.content)return n();let{platform:u,userId:c}=r;if(i[2].auth)return await t.database.set("binding",{platform:u,pid:c},{aid:i[2].auth.id}),e.setAuth(i[2],i[2].auth);{let l=await r.observeUser(["id","name","authority","config"]);return e.createToken(i[2],"platform",l)}},!0),t.on("console/intercept",async(r,n)=>{if(!n.authority)return!1;if(!r.auth||r.auth.expiredAt<=Date.now()||r.auth.authority<n.authority)return!0}),t.console.addListener("user/delete-token",async function(r){if(!this.auth)throw new Error("请先登录。");let[n]=await t.database.get("token",{id:this.auth.id,inc:r});if(!n)throw new Error("令牌不存在。");await t.database.remove("token",{inc:r}),await e.setAuth(this)}),t.console.addListener("user/logout",async function(){this.auth&&await t.database.remove("token",{token:this.auth.token}),await e.setAuth(this,null)}),t.console.addListener("user/update",async function(r){if(!this.auth)throw new Error("请先登录。");r.password&&(r.password=y(r.password)),await t.database.set("user",{id:this.auth.id},r),Object.assign(this.auth,r),await e.setAuth(this,void 0,!0)}),t.console.addListener("user/unbind",async function(r,n){if(!this.auth)throw new Error("请先登录。");let i=await t.database.get("binding",{aid:this.auth.id}),u=i.find(c=>c.platform===r&&c.pid===n);if(u.aid!==u.bid)await t.database.set("binding",{platform:r,pid:n},{aid:u.bid});else{if(i.filter(c=>c.aid===c.bid).length===1)throw new Error("无法解除绑定。");await t.database.remove("binding",{platform:r,pid:n})}await e.setAuth(this)})}};x(T,"AuthService");ee(T,"inject",["console","database"]);var E=T;(a=>{a.filter=!1,a.Admin=s.Schema.intersect([s.Schema.object({enabled:s.Schema.boolean().default(!0)}),s.Schema.union([s.Schema.object({enabled:s.Schema.const(!0),username:s.Schema.string().default("admin"),password:s.Schema.string().role("secret").required()}),s.Schema.object({})])]),a.Config=s.Schema.intersect([s.Schema.object({admin:a.Admin}),s.Schema.object({authTokenExpire:s.Schema.natural().role("ms").default(s.Time.week).min(s.Time.hour),loginTokenExpire:s.Schema.natural().role("ms").default(s.Time.minute*10).min(s.Time.minute)})]).i18n({"zh-CN":te()})})(E||(E={}));var re=E});export default ne();
