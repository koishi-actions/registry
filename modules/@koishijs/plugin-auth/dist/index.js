import{useStorage as Y,store as p,send as C,Schema as D,message as z,useConfig as q,icons as L,router as U,pick as Z,deepEqual as ee}from"../client.js";import{ref as K,defineComponent as B,resolveComponent as h,openBlock as i,createElementBlock as _,Fragment as S,unref as r,createElementVNode as a,toDisplayString as y,createVNode as c,withCtx as d,createTextVNode as k,withKeys as R,withModifiers as E,createCommentVNode as F,createBlock as j,computed as A,renderList as W,isRef as G,pushScopeId as oe,popScopeId as te,h as ne,watch as T}from"../vue.js";import{useRouter as se}from"../vue-router.js";const e=Y("auth",2,()=>({authType:0})),M=K(false),I=K(false),le={class:"login-form"},ae={key:0},re=a("span",null,"\u5E73\u53F0\u8D26\u6237\u7ED1\u5B9A",-1),ce=[re],ie={key:1},ue=a("span",null,"\u5E73\u53F0\u8D26\u6237\u767B\u5F55",-1),de=[ue],_e={class:"hint"},pe=a("p",{class:"hint"},"\u8BF7\u7528\u4E0A\u8FF0\u8D26\u53F7\u5C06\u4E0B\u9762\u7684\u9A8C\u8BC1\u7801\u53D1\u9001\u7ED9\u4EFB\u610F\u6B63\u5728\u8FD0\u884C\u7684\u673A\u5668\u4EBA",-1),me={class:"token"},fe={class:"control"},he={key:0},ve=a("span",null,"\u5E73\u53F0\u8D26\u6237\u7ED1\u5B9A",-1),ge=[ve],ke={key:1},ye={key:0,class:"error"},Ce={class:"control"},we={key:0,class:"error"},$e={class:"control"},J=B({__name:"login-form",setup(s){const u=K(),l=K();let o=0;async function t(){const f=Date.now();if(f<o)return;const{platform:n,userId:g}=e.value;if(!(!n||!g)){o=f+1e3;try{l.value=await C("login/platform",n,g)}catch(w){u.value=w.message}}}async function v(){const{name:f,password:n}=e.value;try{await C("login/password",f,n)}catch(g){u.value=g.message}}const H=se();function x(){p.user?M.value=false:H.back()}return(f,n)=>{const g=h("k-button"),w=h("k-tab"),$=h("k-icon"),V=h("el-input");return i(),_("div",le,[l.value?(i(),_(S,{key:0},[r(p).user?(i(),_("h1",ae,ce)):(i(),_("h1",ie,de)),a("p",_e,"\u6B22\u8FCE\u4F60\uFF0C"+y(l.value.name||"Koishi \u7528\u6237")+"\uFF01",1),pe,a("p",me,y(l.value.token),1),a("div",fe,[c(g,{onClick:n[0]||(n[0]=m=>l.value.token=null)},{default:d(()=>[k("\u8FD4\u56DE\u4E0A\u4E00\u6B65")]),_:1})])],64)):(i(),_(S,{key:1},[r(p).user?(i(),_("h1",he,ge)):(i(),_("h1",ke,[c(w,{data:["\u7528\u6237\u5BC6\u7801\u767B\u5F55","\u5E73\u53F0\u8D26\u6237\u767B\u5F55"],modelValue:r(e).authType,"onUpdate:modelValue":n[1]||(n[1]=m=>r(e).authType=m)},null,8,["modelValue"])])),r(p).user||r(e).authType===1?(i(),_(S,{key:2},[c(V,{placeholder:"\u5E73\u53F0\u540D",modelValue:r(e).platform,"onUpdate:modelValue":n[2]||(n[2]=m=>r(e).platform=m)},{prefix:d(()=>[c($,{name:"at"})]),_:1},8,["modelValue"]),c(V,{placeholder:"\u8D26\u53F7",modelValue:r(e).userId,"onUpdate:modelValue":n[3]||(n[3]=m=>r(e).userId=m),onKeypress:R(E(t,["stop"]),["enter"])},{prefix:d(()=>[c($,{name:"user"})]),_:1},8,["modelValue","onKeypress"]),u.value?(i(),_("p",ye,y(u.value),1)):F("v-if",true),a("div",Ce,[c(g,{onClick:x},{default:d(()=>[k("\u8FD4\u56DE")]),_:1}),c(g,{onClick:t},{default:d(()=>[k("\u83B7\u53D6\u9A8C\u8BC1\u7801")]),_:1})])],64)):(i(),_(S,{key:3},[c(V,{placeholder:"\u7528\u6237\u540D",modelValue:r(e).name,"onUpdate:modelValue":n[4]||(n[4]=m=>r(e).name=m)},{prefix:d(()=>[c($,{name:"user"})]),_:1},8,["modelValue"]),c(V,{placeholder:"\u5BC6\u7801",modelValue:r(e).password,"onUpdate:modelValue":n[6]||(n[6]=m=>r(e).password=m),onKeypress:R(E(v,["stop"]),["enter"]),type:r(e).showPass?"text":"password"},{prefix:d(()=>[c($,{name:"lock"})]),suffix:d(()=>[c($,{name:r(e).showPass?"eye":"eye-slash",onClick:n[5]||(n[5]=m=>r(e).showPass=!r(e).showPass)},null,8,["name"])]),_:1},8,["modelValue","onKeypress","type"]),u.value?(i(),_("p",we,y(u.value),1)):F("v-if",true),a("div",$e,[c(g,{onClick:x},{default:d(()=>[k("\u8FD4\u56DE")]),_:1}),c(g,{onClick:v},{default:d(()=>[k("\u767B\u5F55")]),_:1})])],64))],64))])}}});const be=B({__name:"login",setup(s){return(u,l)=>{const o=h("k-card"),t=h("k-layout");return i(),j(t,{main:"darker page-login"},{default:d(()=>[c(o,null,{default:d(()=>[c(J)]),_:1})]),_:1})}}});const xe={class:"k-schema-header"},Ve={class:"k-schema-item"},Se={class:"header"},ze={class:"left"},Me={class:"right"},Le=a("h2",{class:"k-schema-header"},"\u767B\u5F55\u5386\u53F2",-1),Be=B({__name:"profile",setup(s){const u={platform:"\u5E73\u53F0\u8D26\u6237",password:"\u7528\u6237\u5BC6\u7801"},l=K({}),o=A(()=>D.object({name:D.string().description("\u7528\u6237\u540D").default(e.value.name),password:D.string().role("secret").description("\u5BC6\u7801").default(e.value.password)}).description("\u57FA\u672C\u8D44\u6599"));async function t(){return p.user=null,delete e.value.id,delete e.value.token,delete e.value.expiredAt,C("user/logout")}async function v(){try{await C("user/update",l.value),z.success("\u4FEE\u6539\u6210\u529F\uFF01"),Object.assign(e.value,l.value),Object.assign(p.user,l.value),l.value={}}catch(f){z.error(f.message)}}const H=A(()=>{var f;return(f=p.user)==null?void 0:f.bindings.filter(n=>p.user.id===n.bid)}),x=A(()=>[{icon:"check",label:"\u5E94\u7528\u66F4\u6539",disabled:!l.value||!Object.keys(l.value).length,action:v},{type:"danger",icon:"sign-out",label:"\u9000\u51FA\u767B\u5F55",action:t}]);return(f,n)=>{const g=h("k-form"),w=h("el-button"),$=h("k-content"),V=h("k-layout");return i(),j(V,{main:"page-profile",menu:x.value},{default:d(()=>[c($,null,{default:d(()=>[c(g,{schema:o.value,modelValue:l.value,"onUpdate:modelValue":n[0]||(n[0]=m=>l.value=m)},null,8,["schema","modelValue"]),a("h2",xe,[k(" \u5E73\u53F0\u7ED1\u5B9A "),c(w,{solid:"",class:"right",onClick:n[1]||(n[1]=m=>M.value=true)},{default:d(()=>[k("\u6DFB\u52A0")]),_:1})]),(i(true),_(S,null,W(r(p).user.bindings,({platform:m,pid:O,bid:P})=>(i(),_("div",Ve,[a("div",Se,[a("div",ze,y(m)+" ("+y(O)+")",1),a("div",Me,[H.value.length>1||P!==r(p).user.id?(i(),j(w,{key:0,onClick:E(N=>r(C)("user/unbind",m,O),["stop","prevent"])},{default:d(()=>[k("\u89E3\u7ED1")]),_:2},1032,["onClick"])):F("v-if",true)])])]))),256)),Le,a("ul",null,[(i(true),_(S,null,W(r(p).user.tokens,({inc:m,type:O,createdAt:P,lastUsedAt:N,address:Q,userAgent:X})=>(i(),_("li",{key:m},[a("div",null,"\u767B\u5F55\u7C7B\u578B\uFF1A"+y(u[O]),1),a("div",null,"\u767B\u5F55\u65F6\u95F4\uFF1A"+y(P),1),a("div",null,"\u6700\u540E\u8BBF\u95EE\uFF1A"+y(N),1),a("div",null,"IP \u5730\u5740\uFF1A"+y(Q),1),a("div",null,"\u5BA2\u6237\u7AEF\uFF1A"+y(X),1),a("div",null,[c(w,{onClick:yo=>r(C)("user/delete-token",m)},{default:d(()=>[k("\u79FB\u9664\u4F1A\u8BDD")]),_:2},1032,["onClick"])])]))),128))])]),_:1})]),_:1},8,["menu"])}}});const b=(s,u)=>{const l=s.__vccOpts||s;for(const[o,t]of u)l[o]=t;return l},He={},Ue={class:"k-icon k-icon-at",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},Ie=a("path",{fill:"currentColor",d:"M256 8C118.941 8 8 118.919 8 256c0 137.059 110.919 248 248 248 48.154 0 95.342-14.14 135.408-40.223 12.005-7.815 14.625-24.288 5.552-35.372l-10.177-12.433c-7.671-9.371-21.179-11.667-31.373-5.129C325.92 429.757 291.314 440 256 440c-101.458 0-184-82.542-184-184S154.542 72 256 72c100.139 0 184 57.619 184 160 0 38.786-21.093 79.742-58.17 83.693-17.349-.454-16.91-12.857-13.476-30.024l23.433-121.11C394.653 149.75 383.308 136 368.225 136h-44.981a13.518 13.518 0 0 0-13.432 11.993l-.01.092c-14.697-17.901-40.448-21.775-59.971-21.775-74.58 0-137.831 62.234-137.831 151.46 0 65.303 36.785 105.87 96 105.87 26.984 0 57.369-15.637 74.991-38.333 9.522 34.104 40.613 34.103 70.71 34.103C462.609 379.41 504 307.798 504 232 504 95.653 394.023 8 256 8zm-21.68 304.43c-22.249 0-36.07-15.623-36.07-40.771 0-44.993 30.779-72.729 58.63-72.729 22.292 0 35.601 15.241 35.601 40.77 0 45.061-33.875 72.73-58.161 72.73z"},null,-1),De=[Ie];function Ke(s,u){return i(),_("svg",Ue,De)}const je=b(He,[["render",Ke]]),Oe={},Pe={class:"k-icon check",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512"},Ae=a("path",{fill:"currentColor",d:"M438.6 105.4C451.1 117.9 451.1 138.1 438.6 150.6L182.6 406.6C170.1 419.1 149.9 419.1 137.4 406.6L9.372 278.6C-3.124 266.1-3.124 245.9 9.372 233.4C21.87 220.9 42.13 220.9 54.63 233.4L159.1 338.7L393.4 105.4C405.9 92.88 426.1 92.88 438.6 105.4H438.6z"},null,-1),Te=[Ae];function Ee(s,u){return i(),_("svg",Pe,Te)}const Fe=b(Oe,[["render",Ee]]),Ne={},Re={class:"k-icon k-icon-lock",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512"},We=a("path",{fill:"currentColor",d:"M400 224h-24v-72C376 68.2 307.8 0 224 0S72 68.2 72 152v72H48c-26.5 0-48 21.5-48 48v192c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V272c0-26.5-21.5-48-48-48zm-104 0H152v-72c0-39.7 32.3-72 72-72s72 32.3 72 72v72z"},null,-1),qe=[We];function Ge(s,u){return i(),_("svg",Re,qe)}const Je=b(Ne,[["render",Ge]]),Qe={},Xe={class:"k-icon k-icon-sign-in",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},Ye=a("path",{fill:"currentColor",d:"M384 256c0-8.188-3.125-16.38-9.375-22.62l-128-128C237.5 96.22 223.7 93.47 211.8 98.44C199.8 103.4 192 115.1 192 128v64H48C21.49 192 0 213.5 0 240v32C0 298.5 21.49 320 48 320H192v64c0 12.94 7.797 24.62 19.75 29.56c11.97 4.969 25.72 2.219 34.88-6.938l128-128C380.9 272.4 384 264.2 384 256zM224 384V288H48C39.18 288 32 280.8 32 272v-32C32 231.2 39.18 224 48 224H224L223.1 128l128 128L224 384zM432 32h-96C327.2 32 320 39.16 320 48S327.2 64 336 64h96C458.5 64 480 85.53 480 112v288c0 26.47-21.53 48-48 48h-96c-8.844 0-16 7.156-16 16s7.156 16 16 16h96c44.13 0 80-35.88 80-80v-288C512 67.88 476.1 32 432 32z"},null,-1),Ze=[Ye];function eo(s,u){return i(),_("svg",Xe,Ze)}const oo=b(Qe,[["render",eo]]),to={},no={class:"k-icon k-icon-sign-out",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},so=a("path",{fill:"currentColor",d:"M176 448h-96C53.53 448 32 426.5 32 400v-288C32 85.53 53.53 64 80 64h96C184.8 64 192 56.84 192 48S184.8 32 176 32h-96C35.88 32 0 67.88 0 112v288C0 444.1 35.88 480 80 480h96C184.8 480 192 472.8 192 464S184.8 448 176 448zM502.6 233.4l-128-128c-9.156-9.156-22.91-11.91-34.88-6.938C327.8 103.4 320 115.1 320 128l.0918 63.1L176 192C149.5 192 128 213.5 128 240v32C128 298.5 149.5 320 176 320l144.1-.001L320 384c0 12.94 7.797 24.62 19.75 29.56c11.97 4.969 25.72 2.219 34.88-6.938l128-128C508.9 272.4 512 264.2 512 256S508.9 239.6 502.6 233.4zM352 384V288H176C167.2 288 160 280.8 160 272v-32C160 231.2 167.2 224 176 224H352l-.0039-96l128 128L352 384z"},null,-1),lo=[so];function ao(s,u){return i(),_("svg",no,lo)}const ro=b(to,[["render",ao]]),co={},io={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},uo=a("path",{fill:"currentColor",d:"M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256s256-114.6 256-256S397.4 0 256 0zM256 480c-47.24 0-91.04-14.78-127.2-39.84C132.9 390.9 173.8 352 224 352h64c50.25 0 91.14 38.94 95.21 88.16C347 465.2 303.2 480 256 480zM411.7 416.7C397.6 361.3 347.7 320 288 320H224c-59.73 0-109.6 41.3-123.7 96.72C58.27 375.1 32 319 32 256c0-123.5 100.5-224 224-224s224 100.5 224 224C480 319 453.7 375.1 411.7 416.7zM256 128C211.8 128 176 163.8 176 208C176 252.2 211.8 288 256 288s80-35.82 80-80C336 163.8 300.2 128 256 128zM256 256C229.5 256 208 234.5 208 208S229.5 160 256 160s48 21.53 48 48S282.5 256 256 256z"},null,-1),_o=[uo];function po(s,u){return i(),_("svg",io,_o)}const mo=b(co,[["render",po]]),fo=B({__name:"bind-dialog",setup(s){return(u,l)=>{const o=h("el-dialog");return i(),j(o,{center:"",modelValue:r(M),"onUpdate:modelValue":l[0]||(l[0]=t=>G(M)?M.value=t:null),class:"bind-dialog"},{default:d(()=>[c(J)]),_:1},8,["modelValue"])}}}),ho=s=>(oe("data-v-9c6a52e6"),s=s(),te(),s),vo=ho(()=>a("p",{class:"text-center"},"\u68C0\u6D4B\u5230\u4F60\u672C\u5730\u7684\u914D\u7F6E\u4E0E\u4E91\u7AEF\u4E0D\u540C\u6B65\uFF0C\u662F\u5426\u540C\u6B65\u914D\u7F6E\uFF1F",-1)),go=B({__name:"sync-dialog",setup(s){const u=q();async function l(o){if(e.value.sync=!!o,I.value=false,!!o){if(o==="download"){u.value=p.user.config;return}try{await C("user/update",{config:u.value})}catch(t){z.error(t.message)}}}return(o,t)=>{const v=h("el-button"),H=h("el-button-group"),x=h("el-dialog");return i(),j(x,{class:"sync-dialog",onClose:t[3]||(t[3]=f=>{var n;return(n=r(u)).sync??(n.sync=false)}),"show-close":false,"close-on-click-modal":false,"close-on-press-escape":false,modelValue:r(I),"onUpdate:modelValue":t[4]||(t[4]=f=>G(I)?I.value=f:null)},{default:d(()=>[vo,c(H,{class:"text-center"},{default:d(()=>[c(v,{onClick:t[0]||(t[0]=f=>l("upload"))},{default:d(()=>[k("\u4E0A\u4F20\u5F53\u524D\u914D\u7F6E")]),_:1}),c(v,{onClick:t[1]||(t[1]=f=>l("download"))},{default:d(()=>[k("\u4E0B\u8F7D\u4E91\u7AEF\u914D\u7F6E")]),_:1}),c(v,{onClick:t[2]||(t[2]=f=>l())},{default:d(()=>[k("\u5173\u95ED\u914D\u7F6E\u540C\u6B65")]),_:1})]),_:1})]),_:1},8,["modelValue"])}}});const ko=b(go,[["__scopeId","data-v-9c6a52e6"]]);L.register("at",je);L.register("check",Fe);L.register("lock",Je);L.register("sign-in",oo);L.register("sign-out",ro);L.register("user-full",mo);const bo=s=>{e.value.token&&e.value.expiredAt>Date.now()&&C("login/token",e.value.id,e.value.token).catch(o=>z.error(o.message)),s.on("activity",o=>o.authority>0&&(!p.user||p.user.authority<o.authority)),s.scope.disposables.push(U.beforeEach(o=>{const{activity:t}=o.meta;if(t){if((t.authority||t.fields.includes("user"))&&!p.user)return history.state.forward==="/login"?"/":"/login";if(t.authority&&t.authority>p.user.authority)return z.error("\u6743\u9650\u4E0D\u8DB3\u3002"),false}})),s.page({path:"/login",name:"\u767B\u5F55",icon:"sign-in",position:"bottom",order:500,disabled:()=>!!p.user,component:be}),s.page({path:"/profile",name:"\u7528\u6237\u8D44\u6599",icon:"user-full",fields:["user"],position:"bottom",order:500,component:Be}),s.slot({type:"global",component:fo}),s.slot({type:"global",component:ko}),s.settings({id:"user",title:"\u7528\u6237\u8BBE\u7F6E",component:B(()=>()=>ne(h("k-form"),{schema:D.object({sync:D.boolean().description("\u5728\u591A\u4E2A\u5BA2\u6237\u7AEF\u95F4\u540C\u6B65\u8BBE\u7F6E\u3002")}).description("\u540C\u6B65\u8BBE\u7F6E"),initial:e.value,modelValue:e.value,"onUpdate:modelValue":o=>e.value=o}))});const u=q();function l(){ee(p.user.config,u.value)||(I.value=true)}s.on("dispose",T(u,async o=>{!o||!p.user||!e.value.sync||await C("user/update",{config:o})},{deep:true})),s.on("dispose",T(()=>e.value.sync,async o=>{o&&p.user&&l()})),s.on("dispose",T(()=>p.user,(o,t)=>{if(M.value=false,!o)return U.push("/login");if(e.value.sync&&l(),t)return;Object.assign(e.value,Z(o,["id","name","token","expiredAt"])),z.success(`\u6B22\u8FCE\u56DE\u6765\uFF0C${o.name||"Koishi \u7528\u6237"}\uFF01`);const v=U.currentRoute.value.redirectedFrom;v&&!v.path.startsWith("/login")?U.push(v):U.push("/profile")}))};export{bo as default};
