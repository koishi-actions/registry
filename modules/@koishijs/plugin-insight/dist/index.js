import{ref as B,computed as J,reactive as Nt,defineComponent as yt,openBlock as T,createElementBlock as j,createElementVNode as b,withModifiers as V,normalizeClass as Z,createCommentVNode as _t,onMounted as Dt,watch as Xt,resolveComponent as Yt,createBlock as ut,withCtx as dt,unref as U,mergeProps as bt,Fragment as lt,renderList as ct,createVNode as jt,Transition as Ot,withDirectives as Bt,normalizeStyle as Pt,toDisplayString as Ft,vShow as Vt}from"vue";import{store as ft,icons as Gt}from"@koishijs/client";import{useEventListener as G,useElementSize as Ht,watchThrottled as qt}from"@vueuse/core";function et(t){return t.type.startsWith("touch")?[...t.targetTouches,...t.changedTouches][0]:t}function Wt(){const t=B(""),e=B(false),n=B(true),r=B(0),i=B(0),s=J(()=>!r.value||!i.value?{display:"none"}:{left:r.value+"px",top:i.value+"px"});function u(v,y){const m=et(y);t.value=v,e.value=true,n.value=false,r.value=m.clientX,i.value=m.clientY}function o(v=0,y=false){n.value=true,setTimeout(()=>{n.value&&(e.value=false,y&&(r.value=null,i.value=null))},v)}G("mousemove",l),G("touchmove",l);function l(v){if(n.value)return;const y=et(v);i.value=y.clientY,r.value=y.clientX}return Nt({style:s,content:t,active:e,inactive:n,activate:u,deactivate:o})}function Qt(t){const e=+this._x.call(null,t),n=+this._y.call(null,t);return kt(this.cover(e,n),e,n,t)}function kt(t,e,n,r){if(isNaN(e)||isNaN(n))return t;var i,s=t._root,u={data:r},o=t._x0,l=t._y0,v=t._x1,y=t._y1,m,d,h,w,f,a,c,g;if(!s)return t._root=u,t;for(;s.length;)if((f=e>=(m=(o+v)/2))?o=m:v=m,(a=n>=(d=(l+y)/2))?l=d:y=d,i=s,!(s=s[c=a<<1|f]))return i[c]=u,t;if(h=+t._x.call(null,s.data),w=+t._y.call(null,s.data),e===h&&n===w)return u.next=s,i?i[c]=u:t._root=u,t;do i=i?i[c]=new Array(4):t._root=new Array(4),(f=e>=(m=(o+v)/2))?o=m:v=m,(a=n>=(d=(l+y)/2))?l=d:y=d;while((c=a<<1|f)===(g=(w>=d)<<1|h>=m));return i[g]=s,i[c]=u,t}function Rt(t){var e,n,r=t.length,i,s,u=new Array(r),o=new Array(r),l=1/0,v=1/0,y=-1/0,m=-1/0;for(n=0;n<r;++n)isNaN(i=+this._x.call(null,e=t[n]))||isNaN(s=+this._y.call(null,e))||(u[n]=i,o[n]=s,i<l&&(l=i),i>y&&(y=i),s<v&&(v=s),s>m&&(m=s));if(l>y||v>m)return this;for(this.cover(l,v).cover(y,m),n=0;n<r;++n)kt(this,u[n],o[n],t[n]);return this}function Jt(t,e){if(isNaN(t=+t)||isNaN(e=+e))return this;var n=this._x0,r=this._y0,i=this._x1,s=this._y1;if(isNaN(n))i=(n=Math.floor(t))+1,s=(r=Math.floor(e))+1;else{for(var u=i-n||1,o=this._root,l,v;n>t||t>=i||r>e||e>=s;)switch(v=(e<r)<<1|t<n,l=new Array(4),l[v]=o,o=l,u*=2,v){case 0:i=n+u,s=r+u;break;case 1:n=i-u,s=r+u;break;case 2:i=n+u,r=s-u;break;case 3:n=i-u,r=s-u;break}this._root&&this._root.length&&(this._root=o)}return this._x0=n,this._y0=r,this._x1=i,this._y1=s,this}function Kt(){var t=[];return this.visit(function(e){if(!e.length)do t.push(e.data);while(e=e.next)}),t}function Ut(t){return arguments.length?this.cover(+t[0][0],+t[0][1]).cover(+t[1][0],+t[1][1]):isNaN(this._x0)?void 0:[[this._x0,this._y0],[this._x1,this._y1]]}function $(t,e,n,r,i){this.node=t,this.x0=e,this.y0=n,this.x1=r,this.y1=i}function Zt(t,e,n){var r,i=this._x0,s=this._y0,u,o,l,v,y=this._x1,m=this._y1,d=[],h=this._root,w,f;for(h&&d.push(new $(h,i,s,y,m)),n==null?n=1/0:(i=t-n,s=e-n,y=t+n,m=e+n,n*=n);w=d.pop();)if(!(!(h=w.node)||(u=w.x0)>y||(o=w.y0)>m||(l=w.x1)<i||(v=w.y1)<s))if(h.length){var a=(u+l)/2,c=(o+v)/2;d.push(new $(h[3],a,c,l,v),new $(h[2],u,c,a,v),new $(h[1],a,o,l,c),new $(h[0],u,o,a,c)),(f=(e>=c)<<1|t>=a)&&(w=d[d.length-1],d[d.length-1]=d[d.length-1-f],d[d.length-1-f]=w)}else{var g=t-+this._x.call(null,h.data),M=e-+this._y.call(null,h.data),_=g*g+M*M;if(_<n){var k=Math.sqrt(n=_);i=t-k,s=e-k,y=t+k,m=e+k,r=h.data}}return r}function te(t){if(isNaN(y=+this._x.call(null,t))||isNaN(m=+this._y.call(null,t)))return this;var e,n=this._root,r,i,s,u=this._x0,o=this._y0,l=this._x1,v=this._y1,y,m,d,h,w,f,a,c;if(!n)return this;if(n.length)for(;;){if((w=y>=(d=(u+l)/2))?u=d:l=d,(f=m>=(h=(o+v)/2))?o=h:v=h,e=n,!(n=n[a=f<<1|w]))return this;if(!n.length)break;(e[a+1&3]||e[a+2&3]||e[a+3&3])&&(r=e,c=a)}for(;n.data!==t;)if(i=n,!(n=n.next))return this;return(s=n.next)&&delete n.next,i?(s?i.next=s:delete i.next,this):e?(s?e[a]=s:delete e[a],(n=e[0]||e[1]||e[2]||e[3])&&n===(e[3]||e[2]||e[1]||e[0])&&!n.length&&(r?r[c]=n:this._root=n),this):(this._root=s,this)}function ee(t){for(var e=0,n=t.length;e<n;++e)this.remove(t[e]);return this}function ne(){return this._root}function re(){var t=0;return this.visit(function(e){if(!e.length)do++t;while(e=e.next)}),t}function ie(t){var e=[],n,r=this._root,i,s,u,o,l;for(r&&e.push(new $(r,this._x0,this._y0,this._x1,this._y1));n=e.pop();)if(!t(r=n.node,s=n.x0,u=n.y0,o=n.x1,l=n.y1)&&r.length){var v=(s+o)/2,y=(u+l)/2;(i=r[3])&&e.push(new $(i,v,y,o,l)),(i=r[2])&&e.push(new $(i,s,y,v,l)),(i=r[1])&&e.push(new $(i,v,u,o,y)),(i=r[0])&&e.push(new $(i,s,u,v,y))}return this}function oe(t){var e=[],n=[],r;for(this._root&&e.push(new $(this._root,this._x0,this._y0,this._x1,this._y1));r=e.pop();){var i=r.node;if(i.length){var s,u=r.x0,o=r.y0,l=r.x1,v=r.y1,y=(u+l)/2,m=(o+v)/2;(s=i[0])&&e.push(new $(s,u,o,y,m)),(s=i[1])&&e.push(new $(s,y,o,l,m)),(s=i[2])&&e.push(new $(s,u,m,y,v)),(s=i[3])&&e.push(new $(s,y,m,l,v))}n.push(r)}for(;r=n.pop();)t(r.node,r.x0,r.y0,r.x1,r.y1);return this}function se(t){return t[0]}function ae(t){return arguments.length?(this._x=t,this):this._x}function ue(t){return t[1]}function le(t){return arguments.length?(this._y=t,this):this._y}function At(t,e,n){var r=new gt(e??se,n??ue,NaN,NaN,NaN,NaN);return t==null?r:r.addAll(t)}function gt(t,e,n,r,i,s){this._x=t,this._y=e,this._x0=n,this._y0=r,this._x1=i,this._y1=s,this._root=void 0}function xt(t){for(var e={data:t.data},n=e;t=t.next;)n=n.next={data:t.data};return e}var z=At.prototype=gt.prototype;z.copy=function(){var t=new gt(this._x,this._y,this._x0,this._y0,this._x1,this._y1),e=this._root,n,r;if(!e)return t;if(!e.length)return t._root=xt(e),t;for(n=[{source:e,target:t._root=new Array(4)}];e=n.pop();)for(var i=0;i<4;++i)(r=e.source[i])&&(r.length?n.push({source:r,target:e.target[i]=new Array(4)}):e.target[i]=xt(r));return t};z.add=Qt;z.addAll=Rt;z.cover=Jt;z.data=Kt;z.extent=Ut;z.find=Zt;z.remove=te;z.removeAll=ee;z.root=ne;z.size=re;z.visit=ie;z.visitAfter=oe;z.x=ae;z.y=le;function E(t){return function(){return t}}function H(t){return(t()-.5)*1e-6}function ce(t){return t.index}function wt(t,e){var n=t.get(e);if(!n)throw new Error("node not found: "+e);return n}function fe(t){var e=ce,n=m,r,i=E(30),s,u,o,l,v,y=1;t==null&&(t=[]);function m(a){return 1/Math.min(o[a.source.index],o[a.target.index])}function d(a){for(var c=0,g=t.length;c<y;++c)for(var M=0,_,k,A,L,S,O,P;M<g;++M)_=t[M],k=_.source,A=_.target,L=A.x+A.vx-k.x-k.vx||H(v),S=A.y+A.vy-k.y-k.vy||H(v),O=Math.sqrt(L*L+S*S),O=(O-s[M])/O*a*r[M],L*=O,S*=O,A.vx-=L*(P=l[M]),A.vy-=S*P,k.vx+=L*(P=1-P),k.vy+=S*P}function h(){if(u){var a,c=u.length,g=t.length,M=new Map(u.map((k,A)=>[e(k,A,u),k])),_;for(a=0,o=new Array(c);a<g;++a)_=t[a],_.index=a,typeof _.source!="object"&&(_.source=wt(M,_.source)),typeof _.target!="object"&&(_.target=wt(M,_.target)),o[_.source.index]=(o[_.source.index]||0)+1,o[_.target.index]=(o[_.target.index]||0)+1;for(a=0,l=new Array(g);a<g;++a)_=t[a],l[a]=o[_.source.index]/(o[_.source.index]+o[_.target.index]);r=new Array(g),w(),s=new Array(g),f()}}function w(){if(u)for(var a=0,c=t.length;a<c;++a)r[a]=+n(t[a],a,t)}function f(){if(u)for(var a=0,c=t.length;a<c;++a)s[a]=+i(t[a],a,t)}return d.initialize=function(a,c){u=a,v=c,h()},d.links=function(a){return arguments.length?(t=a,h(),d):t},d.id=function(a){return arguments.length?(e=a,d):e},d.iterations=function(a){return arguments.length?(y=+a,d):y},d.strength=function(a){return arguments.length?(n=typeof a=="function"?a:E(+a),w(),d):n},d.distance=function(a){return arguments.length?(i=typeof a=="function"?a:E(+a),f(),d):i},d}var he={value:()=>{}};function $t(){for(var t=0,e=arguments.length,n={},r;t<e;++t){if(!(r=arguments[t]+"")||r in n||/[\s.]/.test(r))throw new Error("illegal type: "+r);n[r]=[]}return new tt(n)}function tt(t){this._=t}function ve(t,e){return t.trim().split(/^|\s+/).map(function(n){var r="",i=n.indexOf(".");if(i>=0&&(r=n.slice(i+1),n=n.slice(0,i)),n&&!e.hasOwnProperty(n))throw new Error("unknown type: "+n);return{type:n,name:r}})}tt.prototype=$t.prototype={constructor:tt,on:function(t,e){var n=this._,r=ve(t+"",n),i,s=-1,u=r.length;if(arguments.length<2){for(;++s<u;)if((i=(t=r[s]).type)&&(i=ye(n[i],t.name)))return i;return}if(e!=null&&typeof e!="function")throw new Error("invalid callback: "+e);for(;++s<u;)if(i=(t=r[s]).type)n[i]=mt(n[i],t.name,e);else if(e==null)for(i in n)n[i]=mt(n[i],t.name,null);return this},copy:function(){var t={},e=this._;for(var n in e)t[n]=e[n].slice();return new tt(t)},call:function(t,e){if((i=arguments.length-2)>0)for(var n=new Array(i),r=0,i,s;r<i;++r)n[r]=arguments[r+2];if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(s=this._[t],r=0,i=s.length;r<i;++r)s[r].value.apply(e,n)},apply:function(t,e,n){if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(var r=this._[t],i=0,s=r.length;i<s;++i)r[i].value.apply(e,n)}};function ye(t,e){for(var n=0,r=t.length,i;n<r;++n)if((i=t[n]).name===e)return i.value}function mt(t,e,n){for(var r=0,i=t.length;r<i;++r)if(t[r].name===e){t[r]=he,t=t.slice(0,r).concat(t.slice(r+1));break}return n!=null&&t.push({name:e,value:n}),t}var q=0,Q=0,W=0,zt=1e3,nt,R,rt=0,F=0,it=0,K=typeof performance=="object"&&performance.now?performance:Date,Lt=typeof window=="object"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(t){setTimeout(t,17)};function It(){return F||(Lt(ge),F=K.now()+it)}function ge(){F=0}function ht(){this._call=this._time=this._next=null}ht.prototype=Tt.prototype={constructor:ht,restart:function(t,e,n){if(typeof t!="function")throw new TypeError("callback is not a function");n=(n==null?It():+n)+(e==null?0:+e),!this._next&&R!==this&&(R?R._next=this:nt=this,R=this),this._call=t,this._time=n,vt()},stop:function(){this._call&&(this._call=null,this._time=1/0,vt())}};function Tt(t,e,n){var r=new ht;return r.restart(t,e,n),r}function pe(){It(),++q;for(var t=nt,e;t;)(e=F-t._time)>=0&&t._call.call(void 0,e),t=t._next;--q}function Mt(){F=(rt=K.now())+it,q=Q=0;try{pe()}finally{q=0,de(),F=0}}function _e(){var t=K.now(),e=t-rt;e>zt&&(it-=e,rt=t)}function de(){for(var t,e=nt,n,r=1/0;e;)e._call?(r>e._time&&(r=e._time),t=e,e=e._next):(n=e._next,e._next=null,e=t?t._next=n:nt=n);R=t,vt(r)}function vt(t){if(!q){Q&&(Q=clearTimeout(Q));var e=t-F;e>24?(t<1/0&&(Q=setTimeout(Mt,t-K.now()-it)),W&&(W=clearInterval(W))):(W||(rt=K.now(),W=setInterval(_e,zt)),q=1,Lt(Mt))}}const xe=1664525,we=1013904223,Ct=4294967296;function me(){let t=1;return()=>(t=(xe*t+we)%Ct)/Ct}function Me(t){return t.x}function Ce(t){return t.y}var Ne=10,ke=Math.PI*(3-Math.sqrt(5));function Ae(t){var e,n=1,r=.001,i=1-Math.pow(r,1/300),s=0,u=.6,o=new Map,l=Tt(m),v=$t("tick","end"),y=me();t==null&&(t=[]);function m(){d(),v.call("tick",e),n<r&&(l.stop(),v.call("end",e))}function d(f){var a,c=t.length,g;f===void 0&&(f=1);for(var M=0;M<f;++M)for(n+=(s-n)*i,o.forEach(function(_){_(n)}),a=0;a<c;++a)g=t[a],g.fx==null?g.x+=g.vx*=u:(g.x=g.fx,g.vx=0),g.fy==null?g.y+=g.vy*=u:(g.y=g.fy,g.vy=0);return e}function h(){for(var f=0,a=t.length,c;f<a;++f){if(c=t[f],c.index=f,c.fx!=null&&(c.x=c.fx),c.fy!=null&&(c.y=c.fy),isNaN(c.x)||isNaN(c.y)){var g=Ne*Math.sqrt(.5+f),M=f*ke;c.x=g*Math.cos(M),c.y=g*Math.sin(M)}(isNaN(c.vx)||isNaN(c.vy))&&(c.vx=c.vy=0)}}function w(f){return f.initialize&&f.initialize(t,y),f}return h(),e={tick:d,restart:function(){return l.restart(m),e},stop:function(){return l.stop(),e},nodes:function(f){return arguments.length?(t=f,h(),o.forEach(w),e):t},alpha:function(f){return arguments.length?(n=+f,e):n},alphaMin:function(f){return arguments.length?(r=+f,e):r},alphaDecay:function(f){return arguments.length?(i=+f,e):+i},alphaTarget:function(f){return arguments.length?(s=+f,e):s},velocityDecay:function(f){return arguments.length?(u=1-f,e):1-u},randomSource:function(f){return arguments.length?(y=f,o.forEach(w),e):y},force:function(f,a){return arguments.length>1?(a==null?o.delete(f):o.set(f,w(a)),e):o.get(f)},find:function(f,a,c){var g=0,M=t.length,_,k,A,L,S;for(c==null?c=1/0:c*=c,g=0;g<M;++g)L=t[g],_=f-L.x,k=a-L.y,A=_*_+k*k,A<c&&(S=L,c=A);return S},on:function(f,a){return arguments.length>1?(v.on(f,a),e):v.on(f)}}}function $e(){var t,e,n,r,i=E(-30),s,u=1,o=1/0,l=.81;function v(h){var w,f=t.length,a=At(t,Me,Ce).visitAfter(m);for(r=h,w=0;w<f;++w)e=t[w],a.visit(d)}function y(){if(t){var h,w=t.length,f;for(s=new Array(w),h=0;h<w;++h)f=t[h],s[f.index]=+i(f,h,t)}}function m(h){var w=0,f,a,c=0,g,M,_;if(h.length){for(g=M=_=0;_<4;++_)(f=h[_])&&(a=Math.abs(f.value))&&(w+=f.value,c+=a,g+=a*f.x,M+=a*f.y);h.x=g/c,h.y=M/c}else{f=h,f.x=f.data.x,f.y=f.data.y;do w+=s[f.data.index];while(f=f.next)}h.value=w}function d(h,w,f,a){if(!h.value)return true;var c=h.x-e.x,g=h.y-e.y,M=a-w,_=c*c+g*g;if(M*M/l<_)return _<o&&(c===0&&(c=H(n),_+=c*c),g===0&&(g=H(n),_+=g*g),_<u&&(_=Math.sqrt(u*_)),e.vx+=c*h.value*r/_,e.vy+=g*h.value*r/_),true;if(h.length||_>=o)return;(h.data!==e||h.next)&&(c===0&&(c=H(n),_+=c*c),g===0&&(g=H(n),_+=g*g),_<u&&(_=Math.sqrt(u*_)));do h.data!==e&&(M=s[h.data.index]*r/_,e.vx+=c*M,e.vy+=g*M);while(h=h.next)}return v.initialize=function(h,w){t=h,n=w,y()},v.strength=function(h){return arguments.length?(i=typeof h=="function"?h:E(+h),y(),v):i},v.distanceMin=function(h){return arguments.length?(u=h*h,v):Math.sqrt(u)},v.distanceMax=function(h){return arguments.length?(o=h*h,v):Math.sqrt(o)},v.theta=function(h){return arguments.length?(l=h*h,v):Math.sqrt(l)},v}function ze(t){var e=E(.1),n,r,i;typeof t!="function"&&(t=E(t==null?0:+t));function s(o){for(var l=0,v=n.length,y;l<v;++l)y=n[l],y.vx+=(i[l]-y.x)*r[l]*o}function u(){if(n){var o,l=n.length;for(r=new Array(l),i=new Array(l),o=0;o<l;++o)r[o]=isNaN(i[o]=+t(n[o],o,n))?0:+e(n[o],o,n)}}return s.initialize=function(o){n=o,u()},s.strength=function(o){return arguments.length?(e=typeof o=="function"?o:E(+o),u(),s):e},s.x=function(o){return arguments.length?(t=typeof o=="function"?o:E(+o),u(),s):t},s}function Le(t){var e=E(.1),n,r,i;typeof t!="function"&&(t=E(t==null?0:+t));function s(o){for(var l=0,v=n.length,y;l<v;++l)y=n[l],y.vy+=(i[l]-y.y)*r[l]*o}function u(){if(n){var o,l=n.length;for(r=new Array(l),i=new Array(l),o=0;o<l;++o)r[o]=isNaN(i[o]=+t(n[o],o,n))?0:+e(n[o],o,n)}}return s.initialize=function(o){n=o,u()},s.strength=function(o){return arguments.length?(e=typeof o=="function"?o:E(+o),u(),s):e},s.y=function(o){return arguments.length?(t=typeof o=="function"?o:E(+o),u(),s):t},s}var Y;(t=>{t.arrowLength=10,t.arrowOffset=10,t.arrowAngle=Math.PI/6})(Y||(Y={}));const Ie={class:"link"},Te=["x1","y1","x2","y2"],Ee=["x1","y1","x2","y2"],Se=["x1","y1","x2","y2"],De=["x1","y1","x2","y2"],Xe=yt({__name:"link",props:{link:{}},emits:["mouseenter","mouseleave"],setup(t){const e=t,n=J(()=>{const{source:r,target:i}=e.link,s=i.x-r.x,u=i.y-r.y,o=Math.atan2(u,s),l=i.x-Y.arrowOffset*Math.cos(o),v=i.y-Y.arrowOffset*Math.sin(o),y=l-Y.arrowLength*Math.cos(o-Y.arrowAngle),m=v-Y.arrowLength*Math.sin(o-Y.arrowAngle),d=l-Y.arrowLength*Math.cos(o+Y.arrowAngle),h=v-Y.arrowLength*Math.sin(o+Y.arrowAngle);return{x0:l,y0:v,x1:y,y1:m,x2:d,y2:h}});return(r,i)=>(T(),j("g",Ie,[b("line",{x1:r.link.source.x,y1:r.link.source.y,x2:r.link.target.x,y2:r.link.target.y,class:"shadow",onMouseenter:i[0]||(i[0]=V(s=>r.$emit("mouseenter",r.link,s),["stop","prevent"])),onMouseleave:i[1]||(i[1]=V(s=>r.$emit("mouseleave",r.link,s),["stop","prevent"]))},null,40,Te),b("line",{x1:r.link.source.x,y1:r.link.source.y,x2:n.value.x0,y2:n.value.y0,class:Z(r.link.type)},null,10,Ee),b("line",{x1:n.value.x0,y1:n.value.y0,x2:n.value.x1,y2:n.value.y1},null,8,Se),b("line",{x1:n.value.x0,y1:n.value.y0,x2:n.value.x2,y2:n.value.y2},null,8,De)]))}});const ot=(t,e)=>{const n=t.__vccOpts||t;for(const[r,i]of e)n[r]=i;return n},Ye=ot(Xe,[["__scopeId","data-v-b104a9ce"]]),be={class:"node"},je=["r","cx","cy"],Oe=["r","cx","cy"],Be={key:1,class:"service"},Pe=["x1","y1","x2","y2"],Fe=["x1","y1","x2","y2"],Ve=yt({__name:"node",props:{node:{},isActive:{type:Boolean}},setup(t){return(e,n)=>(T(),j("g",be,[b("circle",{r:e.isActive?12:9,cx:e.node.x,cy:e.node.y},null,8,je),e.node.isGroup||e.node.isRoot?(T(),j("circle",{key:0,r:e.isActive?8:5,cx:e.node.x,cy:e.node.y},null,8,Oe)):_t("v-if",true),e.node.services?(T(),j("g",Be,[b("line",{x1:e.node.x-(e.isActive?5:4),y1:e.node.y,x2:e.node.x+(e.isActive?5:4),y2:e.node.y},null,8,Pe),b("line",{x1:e.node.x,y1:e.node.y-(e.isActive?5:4),x2:e.node.x,y2:e.node.y+(e.isActive?5:4)},null,8,Fe)])):_t("v-if",true)]))}});const Ge=ot(Ve,[["__scopeId","data-v-39ce2522"]]),He={class:"links"},qe={class:"nodes"},We=yt({__name:"index",setup(t){const e=B(),{width:n,height:r}=Ht(e),i=Wt(),s=B(null),u=B(null),o=B(null),l=Nt(ft.insight.nodes),v=J(()=>ft.insight.edges),y=J(()=>{let p=1/0,x=1/0,C=-1/0,N=-1/0;for(const X of l)p=Math.min(p,X.x),x=Math.min(x,X.y),C=Math.max(C,X.x),N=Math.max(N,X.y);const I=C-p+200,D=N-x+200;let st;if(n.value/I>r.value/D){const X=r.value/D,at=I*X;st=`scale(${X}) translateX(${(n.value-at)/2/X}px)`}else{const X=n.value/I,at=D*X;st=`scale(${X}) translateY(${(r.value-at)/2/X}px)`}return{width:I+"px",height:D+"px",viewBox:`${p-100} ${x-100} ${I} ${D}`,style:{transform:st,transformOrigin:"top left"}}});function m(p){return p.type==="solid"?1:.2}function d(p){let x=0;for(const C of v.value)C.source!==p&&C.target!==p||(x+=m(C));return x}const h=fe(v.value).id(p=>p.uid).strength(p=>m(p)/Math.min(d(p.source),d(p.target))),w=$e(),f=ze(),a=Le(),c=Ae(l).force("link",h).force("charge",w).force("x",f).force("y",a).stop();function g(){h.distance(100),w.strength(-200),f.strength(.1*(r.value/(n.value+r.value)||1)),a.strength(.1*(n.value/(n.value+r.value)||1));const p=Math.exp(-6),x=Math.exp(7);c.alpha(1).alphaMin(p).alphaDecay(1-Math.pow(p,1/x))}Dt(()=>{g(),c.restart(),qt(()=>[n.value,r.value],()=>{g(),c.restart()},{deep:true,throttle:100,trailing:true})}),Xt(()=>ft.insight,p=>{if(p){l.slice().forEach((x,C)=>{p.nodes.find(I=>I.uid===x.uid)||l.splice(C,1)});for(const x of p.nodes){const C=l.find(N=>N.uid===x.uid);C?Object.assign(C,x):l.push(x)}c.nodes(l),h.links(p.edges),c.alpha(.3).restart()}}),G("mousemove",S),G("touchmove",S),G("mouseup",O),G("touchend",O);function M(p,x){u.value=p;const C=["插件："+p.name];p.services&&C.push("提供服务："+p.services.join("，")),i.activate(C.join(`
`),x)}function _(p,x){s.value!==p&&(u.value=null,i.deactivate(300))}function k(p,x){o.value=p;const N=`${p.type==="dashed"?"服务":"调用"}：${p.source.name} → ${p.target.name}`;i.activate(N,x)}function A(p,x){o.value=null,i.deactivate(300)}function L(p,x){s.value=p,c.alphaTarget(.3).restart();const C=et(x);p.lastX=C.clientX,p.lastY=C.clientY,p.fx=p.x,p.fy=p.y}function S(p){const x=s.value;if(!x)return;const C=et(p);x.fx+=C.clientX-x.lastX,x.fy+=C.clientY-x.lastY,x.lastX=C.clientX,x.lastY=C.clientY}function O(p){c.alphaTarget(0);const x=s.value;x&&(x.fx=null,x.fy=null,u.value=null,s.value=null)}const P=()=>({nodes:new Set,links:new Set}),Et=p=>({nodes:new Set([p.source,p.target]),links:new Set([p])}),St=p=>{const x={nodes:new Set([p]),links:new Set};let C=true;for(;C;){C=false;for(const N of v.value)x.links.has(N)||x.nodes.has(N.target)&&(x.nodes.add(N.source),x.links.add(N),C=true)}return x},pt=J(()=>o.value?Et(o.value):u.value?St(u.value):P());return(p,x)=>{const C=Yt("k-layout");return T(),ut(C,{main:"darker"},{default:dt(()=>[b("div",{ref_key:"root",ref:e,class:Z({insight:true,"has-highlight":U(i).active})},[(T(),j("svg",bt({ref:"svg",id:"couple"},y.value),[b("g",He,[(T(true),j(lt,null,ct(v.value,(N,I)=>(T(),ut(Ye,{key:I,link:N,class:Z({highlight:pt.value.links.has(N)}),onMouseenter:k,onMouseleave:A},null,8,["link","class"]))),128))]),b("g",qe,[(T(true),j(lt,null,ct(l,(N,I)=>(T(),ut(Ge,{key:I,class:Z({highlight:pt.value.nodes.has(N)}),node:N,"is-active":N===u.value,onMouseenter:V(D=>M(N,D),["stop","prevent"]),onMouseleave:V(D=>_(N),["stop","prevent"]),onMousedown:V(D=>L(N,D),["stop","prevent"]),onTouchstart:V(D=>L(N,D),["stop","prevent"])},null,8,["class","node","is-active","onMouseenter","onMouseleave","onMousedown","onTouchstart"]))),128))])],16)),jt(Ot,{name:"fade",persisted:""},{default:dt(()=>[Bt(b("div",{class:"tooltip",style:Pt(U(i).style)},[(T(true),j(lt,null,ct(U(i).content.split(`
`),(N,I)=>(T(),j("div",{key:I},Ft(N),1))),128))],4),[[Vt,U(i).active]])]),_:1})],2)]),_:1})}}});const Qe=ot(We,[["__scopeId","data-v-3960524a"]]),Re={},Je={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 640 512"},Ke=b("path",{fill:"currentColor",d:"M160 64C160 28.65 188.7 0 224 0C259.3 0 288 28.65 288 64C288 83.36 279.4 100.7 265.8 112.5L304.3 196.5C314.4 193.6 325 192 336 192C367.7 192 396.2 205.1 416.6 226.2L517.4 153.7C513.9 145.8 512 137.1 512 128C512 92.65 540.7 64 576 64C611.3 64 640 92.65 640 128C640 163.3 611.3 192 576 192C561.4 192 547.9 187.1 537.2 178.9L435.3 252.2C443.4 267.7 448 285.3 448 304C448 319.4 444.9 334 439.3 347.3L531.1 402.4C542.6 391 558.5 384 576 384C611.3 384 640 412.7 640 448C640 483.3 611.3 512 576 512C540.7 512 512 483.3 512 448C512 441.7 512.9 435.6 514.6 429.8L422.8 374.8C402.3 399.9 371 416 336 416C279.6 416 232.9 374.3 225.1 320H125.1C118.9 347.6 93.82 368 64 368C28.65 368 0 339.3 0 304C0 268.7 28.65 240 64 240C93.82 240 118.9 260.4 125.1 288H225.1C229.8 255.3 248.7 227.1 275.3 209.9L237.1 126.7C232.9 127.5 228.5 128 224 128C188.7 128 160 99.35 160 64V64zM224 96C241.7 96 256 81.67 256 64C256 46.33 241.7 32 224 32C206.3 32 192 46.33 192 64C192 81.67 206.3 96 224 96zM576 160C593.7 160 608 145.7 608 128C608 110.3 593.7 96 576 96C558.3 96 544 110.3 544 128C544 145.7 558.3 160 576 160zM576 416C558.3 416 544 430.3 544 448C544 465.7 558.3 480 576 480C593.7 480 608 465.7 608 448C608 430.3 593.7 416 576 416zM64 336C81.67 336 96 321.7 96 304C96 286.3 81.67 272 64 272C46.33 272 32 286.3 32 304C32 321.7 46.33 336 64 336zM336 384C380.2 384 416 348.2 416 304C416 259.8 380.2 224 336 224C291.8 224 256 259.8 256 304C256 348.2 291.8 384 336 384z"},null,-1),Ue=[Ke];function Ze(t,e){return T(),j("svg",Je,Ue)}const tn=ot(Re,[["render",Ze]]);Gt.register("activity:network",tn);const on=t=>{t.page({path:"/graph",name:"依赖图",icon:"activity:network",order:550,fields:["insight"],component:Qe})};export{on as default};
