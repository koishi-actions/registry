var he=Object.create;var B=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var pe=Object.getOwnPropertyNames;var ge=Object.getPrototypeOf,_e=Object.prototype.hasOwnProperty;var ae=(e,t)=>()=>(e&&(t=e(e=0)),t);var me=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Ee=(e,t)=>{for(var i in t)B(e,i,{get:t[i],enumerable:!0})},x=(e,t,i,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of pe(t))!_e.call(e,s)&&s!==i&&B(e,s,{get:()=>t[s],enumerable:!(a=fe(t,s))||a.enumerable});return e},h=(e,t,i)=>(x(e,t,"default"),i&&x(i,t,"default")),se=(e,t,i)=>(i=e!=null?he(ge(e)):{},x(t||!e||!e.__esModule?B(i,"default",{value:e,enumerable:!0}):i,e)),y=e=>x(B({},"__esModule",{value:!0}),e);import{Buffer as V}from"https://registry.koishi.chat/modules/buffer/index.js";import K from"https://registry.koishi.chat/modules/process/index.js";var m=ae(()=>{});var f={};import*as Le from"https://registry.koishi.chat/modules/@satorijs/core/index.js";var T=ae(()=>{m();h(f,Le)});var ie=me((Re,ce)=>{m();var P=Object.defineProperty,Ge=Object.getOwnPropertyDescriptor,Se=Object.getOwnPropertyNames,Te=Object.prototype.hasOwnProperty,l=(e,t)=>P(e,"name",{value:t,configurable:!0}),ne=(e,t)=>{for(var i in t)P(e,i,{get:t[i],enumerable:!0})},ke=(e,t,i,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Se(t))!Te.call(e,s)&&s!==i&&P(e,s,{get:()=>t[s],enumerable:!(a=Ge(t,s))||a.enumerable});return e},we=e=>ke(P({},"__esModule",{value:!0}),e),re={};ne(re,{Card:()=>N,GuildMute:()=>D,HttpServer:()=>C,Internal:()=>n,Kook:()=>de,KookBot:()=>q,KookMessageEncoder:()=>I,Permissions:()=>Y,Signal:()=>J,Type:()=>F,UserStatus:()=>z,WsClient:()=>A,adaptGroup:()=>X,adaptMessage:()=>v,adaptSession:()=>L,adaptUser:()=>G,decodeGuildMember:()=>M,decodeRole:()=>O,default:()=>Ne,encodeRole:()=>Z,hasPermission:()=>Q,isDirectChannel:()=>u});ce.exports=we(re);var _=(T(),y(f)),de={};ne(de,{Card:()=>N,GuildMute:()=>D,Internal:()=>n,Permissions:()=>Y,Signal:()=>J,Type:()=>F,UserStatus:()=>z,adaptGroup:()=>X,adaptMessage:()=>v,adaptSession:()=>L,adaptUser:()=>G,decodeGuildMember:()=>M,decodeRole:()=>O,encodeRole:()=>Z,hasPermission:()=>Q});var c=(T(),y(f)),J=(e=>(e[e.event=0]="event",e[e.hello=1]="hello",e[e.ping=2]="ping",e[e.pong=3]="pong",e[e.reconnect=4]="reconnect",e[e.resume=5]="resume",e))(J||{}),F=(e=>(e[e.text=1]="text",e[e.image=2]="image",e[e.video=3]="video",e[e.file=4]="file",e[e.unknown=7]="unknown",e[e.audio=8]="audio",e[e.kmarkdown=9]="kmarkdown",e[e.card=10]="card",e[e.system=255]="system",e))(F||{}),N;(e=>{e.Theme=["primary","secondary","warning","danger","info","none","success"];let t;(i=>{i.Theme=["primary","secondary","warning","danger","info","none","success"]})(t=e.Button||(e.Button={}))})(N||(N={}));var z=(e=>(e[e.normal=0]="normal",e[e.normal_1=1]="normal_1",e[e.banned=10]="banned",e))(z||{}),Y=(e=>(e[e.GUILD_ADMIN=0]="GUILD_ADMIN",e[e.GUILD_MANAGE=1]="GUILD_MANAGE",e[e.GUILD_LOG=2]="GUILD_LOG",e[e.GUILD_INVITE_CREATE=3]="GUILD_INVITE_CREATE",e[e.GUILD_INVITE_MANAGE=4]="GUILD_INVITE_MANAGE",e[e.CHANNEL_MANAGE=5]="CHANNEL_MANAGE",e[e.GUILD_USER_KICK=6]="GUILD_USER_KICK",e[e.GUILD_USER_BAN=7]="GUILD_USER_BAN",e[e.GUILD_EMOJI_MANAGE=8]="GUILD_EMOJI_MANAGE",e[e.GUILD_USER_NAME_CHANGE=9]="GUILD_USER_NAME_CHANGE",e[e.GUILD_ROLE_MANAGE=10]="GUILD_ROLE_MANAGE",e[e.CHANNEL_VIEW=11]="CHANNEL_VIEW",e[e.CHANNEL_MESSAGE=12]="CHANNEL_MESSAGE",e[e.CHANNEL_MANAGE_MESSAGE=13]="CHANNEL_MANAGE_MESSAGE",e[e.CHANNEL_UPLOAD=14]="CHANNEL_UPLOAD",e[e.CHANNEL_VOICE_CONNECT=15]="CHANNEL_VOICE_CONNECT",e[e.CHANNEL_VOICE_MANAGE=16]="CHANNEL_VOICE_MANAGE",e[e.CHANNEL_MESSAGE_AT_ALL=17]="CHANNEL_MESSAGE_AT_ALL",e[e.CHANNEL_MESSAGE_REACTION_CREATE=18]="CHANNEL_MESSAGE_REACTION_CREATE",e[e.CHANNEL_MESSAGE_REACTION_FOLLOW=19]="CHANNEL_MESSAGE_REACTION_FOLLOW",e[e.CHANNEL_VOICE_CONNECT_PASSIVE=20]="CHANNEL_VOICE_CONNECT_PASSIVE",e[e.CHANNEL_VOICE_SPEAK_KEY_ONLY=21]="CHANNEL_VOICE_SPEAK_KEY_ONLY",e[e.CHANNEL_VOICR_SPEAK_FREE=22]="CHANNEL_VOICR_SPEAK_FREE",e[e.CHANNEL_VOICE_SPEAK=23]="CHANNEL_VOICE_SPEAK",e[e.GUILD_USER_DEAFEN=24]="GUILD_USER_DEAFEN",e[e.GUILD_USER_MUTEGUILD_USER_NAME_CHANGE_OTHER=25]="GUILD_USER_MUTEGUILD_USER_NAME_CHANGE_OTHER",e[e.GUILD_USER_NAME_CHANGE_OTHER=26]="GUILD_USER_NAME_CHANGE_OTHER",e[e.CHANNEL_VOICE_BGM=27]="CHANNEL_VOICE_BGM",e))(Y||{});function Q(e,t){return(e&1<<t)===1<<t}l(Q,"hasPermission");var D;(e=>{let t;(i=>{i[i.mic=1]="mic",i[i.headset=2]="headset"})(t=e.Type||(e.Type={}))})(D||(D={}));var n=class le{constructor(t){this.http=t}static{l(this,"Internal")}static define(t,i,a){le.prototype[t]=async function(...s){let r={};i==="GET"||i==="DELETE"?r.params=s[0]:r.data=s[0];let{data:d}=await this.http(i,a,r);if(d?.code!==0)throw new Error(d?.message||"Unexpected Error");return d?.data}}};n.define("getGuildList","GET","/guild/list");n.define("getGuildView","GET","/guild/view");n.define("getGuildUserList","GET","/guild/user-list");n.define("setGuildUserNickname","POST","/guild/nickname");n.define("leaveGuild","POST","/guild/leave");n.define("kickoutGuildUser","POST","/guild/kickout");n.define("getGuildMuteList","GET","/guild-mute/list");n.define("createGuildMute","POST","/guild-mute/create");n.define("deleteGuildMute","POST","/guild-mute/delete");n.define("getGuildBoostHistory","GET","/guild-boost/history");n.define("getChannelList","GET","/channel/list");n.define("getChannelView","GET","/channel/view");n.define("createChannel","POST","/channel/create");n.define("updateChannel","POST","/channel/update");n.define("deleteChannel","POST","/channel/delete");n.define("getChannelUserList","GET","/channel/user-list");n.define("kickChannelUser","POST","/channel/kickout");n.define("moveChannelUser","POST","/channel/move-user");n.define("getChannelRoleIndex","GET","/channel-role/index");n.define("createChannelRole","POST","/channel-role/create");n.define("updateChannelRole","POST","/channel-role/update");n.define("deleteChannelRole","POST","/channel-role/delete");n.define("getMessageList","GET","/message/list");n.define("getMessageView","GET","/message/view");n.define("createMessage","POST","/message/create");n.define("updateMessage","POST","/message/update");n.define("deleteMessage","POST","/message/delete");n.define("getMessageReactionList","GET","/message/reaction-list");n.define("addMessageReaction","POST","/message/add-reaction");n.define("deleteMessageReaction","POST","/message/delete-reaction");n.define("getChannelJoinedUserList","GET","/channel-user/get-joined-channel");n.define("getPrivateChatList","GET","/user-chat/list");n.define("getPrivateChatView","GET","/user-chat/view");n.define("createPrivateChat","POST","/user-chat/create");n.define("deletePrivateChat","POST","/user-chat/delete");n.define("getDirectMessageList","GET","/direct-message/list");n.define("createDirectMessage","POST","/direct-message/create");n.define("updateDirectMessage","POST","/direct-message/update");n.define("deleteDirectMessage","POST","/direct-message/delete");n.define("getDirectMessageReactionList","GET","/direct-message/reaction-list");n.define("addDirectMessageReaction","POST","/direct-message/add-reaction");n.define("deleteDirectMessageReaction","POST","/direct-message/delete-reaction");n.define("getGateway","GET","/gateway/index");n.define("getToken","POST","/oauth2/token");n.define("createAsset","POST","/asset/create");n.define("getUserMe","GET","/user/me");n.define("getUserView","GET","/user/view");n.define("offline","POST","/user/offline");n.define("getGuildRoleList","GET","/guild-role/list");n.define("createGuildRole","POST","/guild-role/create");n.define("updateGuildRole","POST","/guild-role/update");n.define("deleteGuildRole","POST","/guild-role/delete");n.define("grantGuildRole","POST","/guild-role/grant");n.define("revokeGuildRole","POST","/guild-role/revoke");n.define("getIntimacy","GET","/intimacy/index");n.define("updateIntimacy","POST","/intimacy/update");n.define("getGuildEmojiList","GET","/guild-emoji/list");n.define("createGuildEmoji","POST","/guild-emoji/create");n.define("updateGuildEmoji","POST","/guild-emoji/update");n.define("deleteGuildEmoji","POST","/guild-emoji/delete");n.define("getInviteList","GET","/invite/list");n.define("createInvite","POST","/invite/create");n.define("deleteInvite","POST","/invite/delete");n.define("getBlacklist","GET","/blacklist/list");n.define("createBlacklist","POST","/blacklist/create");n.define("deleteBlacklist","POST","/blacklist/delete");n.define("getGuildBadge","GET","/badge/guild");n.define("getGameList","GET","/game");n.define("createGame","POST","/game/create");n.define("updateGame","POST","/game/update");n.define("deleteGame","POST","/game/delete");n.define("createGameActivity","POST","/game/activity");n.define("deleteGameActivity","POST","/game/delete-activity");var X=l(e=>({id:e.id,name:e.name}),"adaptGroup"),G=l(e=>({id:e.id,name:e.username,userId:e.id,avatar:e.avatar,username:e.username,discriminator:e.identify_num}),"adaptUser"),M=l(e=>({user:G(e),nick:e.nickname}),"decodeGuildMember"),O=l(e=>({...e,id:""+e.role_id,permissions:BigInt(e.permissions),hoist:!!e.hoist,mentionable:!!e.mentionable}),"decodeRole");function j(e){return(0,c.isNullable)(e)?e:e?1:0}l(j,"encodeBit");var Z=l(e=>({...e,role_id:+e.id,permissions:e.permissions&&Number(e.permissions),hoist:j(e.hoist),mentionable:j(e.mentionable)}),"encodeRole");function ee(e){let{type:t,modules:i,text:a,elements:s,fields:r,...d}=e,o=i||s||r||(a?[a]:[]);return(0,c.h)(t,d,o.map(ee))}l(ee,"transformCardElement");function H(e,t,i={},a=i){if(e.type===1)i.content=e.content.replace(/@(.+?)#(\d+)/,(s,r,d)=>(0,c.h)("at",{id:d,name:r}).toString()).replace(/@全体成员/,()=>(0,c.h)("at",{type:"all"}).toString()).replace(/@在线成员/,()=>(0,c.h)("at",{type:"here"}).toString()).replace(/@role:(\d+);/,(s,r)=>(0,c.h)("at",{role:r}).toString()).replace(/#channel:(\d+);/,(s,r)=>c.h.sharp(r).toString()),i.elements=c.h.parse(i.content);else if(e.type===2){let s=(0,c.h)("img",{src:e.content,file:t.attachments?.name});i.elements=[s],i.content=s.toString()}else if(e.type===10){let s=JSON.parse(e.content);i.elements=s.map(ee),i.content=i.elements.join("")}else if(e.type===9){let s=e.content,r="",d,o=[],R=l(()=>{r&&(o.push(c.h.text(r.replace(/\\(.)/g,(b,w)=>w))),r="")},"flushText");for(;s;)if(s.startsWith("\\")&&s.length>1)r+=s[1],s=s.slice(2);else if(d=/^(\((met|chn|rol)\))(\w+)\1/.exec(s)){if(s=s.slice(d[0].length),R(),d[2]==="met")if(d[3]==="all"||d[3]==="here")o.push((0,c.h)("at",{type:d[3]}));else{let b=t.kmarkdown.mention_part.find(w=>w.id===d[3])?.username;o.push((0,c.h)("at",{id:d[3],name:b}))}else if(d[2]==="chn")o.push(c.h.sharp(d[3]));else if(d[2]==="rol"){let b=t.kmarkdown.mention_role_part.find(w=>w.role_id+""===d[3])?.name;o.push((0,c.h)("at",{role:d[3],name:b}))}}else r+=s[0],s=s.slice(1);R(),i.content=o.join(""),i.elements=o}return t.author&&(a.user=G(t.author),a.member=M(t.author)),i}l(H,"adaptMessageMeta");function v(e,t={},i=t){return H(e,e,t,i),t.id=t.messageId=e.id,t}l(v,"adaptMessage");function te(e,t,i={},a=i){return H(e,t,i),i.id=i.messageId=e.msg_id,i.timestamp=e.msg_timestamp,t.quote&&(i.quote=H(t.quote,t.quote),i.quote.messageId=i.quote.id=t.quote.rong_id),i}l(te,"adaptMessageSession");function oe(e,t,i){i.guildId=t.guild_id,e.channel_type==="GROUP"?(i.isDirect=!1,i.channelId=e.target_id):(i.isDirect=!0,i.channelId=t.code),i.event.channel.name=t.channel_name,i.event.member=M(e.extra.author),i.event.user=i.event.member.user,delete i.event.member.user,te(e,t,i.event.message={},i.event)}l(oe,"adaptMessageCreate");async function U(e,t,i,a){a.guildId=i.guild_id,a.event.user=i.user_info&&G(i.user_info),a.userId=i.author_id,(i.channel_type||t.channel_type)==="GROUP"?(a.isDirect=!1,a.channelId=i.channel_id||i.target_id):(a.isDirect=!0,a.channelId=i.chat_code||(await e.createDirectChannel(a.userId)).id),te(t,i,a.event.message={},a.event)}l(U,"adaptMessageModify");function W(e,t){t.channelId=e.channel_id,t.messageId=e.msg_id,t.userId=e.user_id,t.emoji=e.emoji.id}l(W,"adaptReaction");async function L(e,t){let i=e.session();if(i.setInternal("kook",t),t.type===255){let{type:a,body:s}=t.extra;switch(e.dispatch(e.session({type:"internal",_type:"kook/"+a.replace(/_/g,"-"),_data:s})),a){case"message_btn_click":i.type="interaction/button",await U(e,t,s,i),i.event.button={id:s.value};break;case"updated_message":case"updated_private_message":i.type="message-updated",await U(e,t,s,i);break;case"deleted_message":case"deleted_private_message":i.type="message-deleted",await U(e,t,s,i);break;case"added_reaction":case"private_added_reaction":i.type="reaction-added",W(s,i);break;case"deleted_reaction":case"private_deleted_reaction":i.type="reaction-deleted",W(s,i);break;case"updated_channel":case"deleted_channel":i.type="channel-deleted",i.subtype="group",i.channelId=s.id;break;case"pinned_message":case"unpinned_message":i.type=a==="pinned_message"?"message-pinned":"message-unpinned",i.operatorId=s.operator_id,i.messageId=s.msg_id,i.channelId=s.channel_id;break;case"joined_guild":case"exited_guild":case"updated_guild":case"deleted_guild":case"self_joined_guild":case"self_exited_guild":case"updated_guild_member":i.type={joined_guild:"guild-member-added",exited_guild:"guild-member-deleted",updated_guild:"guild-updated",deleted_guild:"guild-deleted",self_joined_guild:"guild-added",self_exited_guild:"guild-deleted",updated_guild_member:"guild-member-updated"}[a],i.guildId=t.target_id,i.userId=s.user_id||e.selfId;break;case"added_role":case"deleted_role":case"updated_role":i.type={added_role:"guild-role-added",deleted_role:"guild-role-deleted",updated_role:"guild-role-updated"}[a],i.guildId=t.target_id,i.roleId=""+s.role_id,i.event.role=O(s);break;default:return}}else if(i.type="message",oe(t,t.extra,i),!i.content)return;return i}l(L,"adaptSession");var p=(T(),y(f)),ye=[6,2,4],A=class extends p.Adapter.WsClient{static{l(this,"WsClient")}_sn=0;_ping;_heartbeat;async prepare(){let{url:e}=await this.bot.request("GET","/gateway/index?compress=0"),t={Authorization:`Bot ${this.bot.config.token}`};return this.bot.ctx.http.ws(e,{headers:t})}heartbeat(){if(!this.socket||this.bot.status!==p.Universal.Status.ONLINE){clearInterval(this._heartbeat);return}let e=0,t=l(()=>{if(this.socket){if(e>=2)return this.socket.close(1e3);this.socket.send(JSON.stringify({s:2,sn:this._sn})),this._ping=setTimeout(t,ye[e++]*p.Time.second)}},"send");t()}async accept(){this._sn=0,clearInterval(this._heartbeat),this.socket.addEventListener("message",async({data:e})=>{let t;e=e.toString();try{t=JSON.parse(e)}catch{return this.bot.logger.warn("cannot parse message",e)}if(this.bot.logger.debug("[receive] %o",t),t.s===0){this._sn=Math.max(this._sn,t.sn);let i=await L(this.bot,t.d);i&&this.bot.dispatch(i)}else t.s===1?(this._heartbeat=setInterval(()=>this.heartbeat(),p.Time.minute*.5),await this.bot.getLogin(),this.bot.online()):t.s===3?clearTimeout(this._ping):t.s===5&&this.socket.close(1e3)})}};(e=>{e.Options=p.Schema.intersect([p.Schema.object({protocol:p.Schema.const("ws").required(!1),token:p.Schema.string().description("机器人的用户令牌。").role("secret").required()}),p.Adapter.WsClientConfig])})(A||(A={}));var E=(T(),y(f)),C=class extends E.Adapter{static{l(this,"HttpServer")}static inject=["server"];logger;constructor(e,t){super(e),this.logger=e.logger("kook");let{path:i}=t.config;i=(0,E.sanitize)(i),e.server.post(i,async a=>{let{body:s}=a.request;this.logger.debug("receive %o",s);let{challenge:r}=s.d;if(a.status=200,r){a.body={challenge:r};return}let d=this.bots.find(R=>R.config.verifyToken===s.d.verify_token);if(!d)return;let o=await L(d,s.d);o&&d.dispatch(o)})}async connect(e){await e.getLogin(),e.online()}};(e=>{e.Options=E.Schema.object({protocol:E.Schema.const("http").required(),token:E.Schema.string().description("机器人令牌。").role("secret").required(),verifyToken:E.Schema.string().description("验证令牌。").role("secret").required(),path:E.Schema.string().description("服务器监听的路径。").default("/kook")})})(C||(C={}));var k=(T(),y(f));function u(e){return e.length>30}l(u,"isDirectChannel");var I=class extends k.MessageEncoder{static{l(this,"KookMessageEncoder")}path;params={};additional={};textBuffer="";cardBuffer={type:"card",modules:[]};async prepare(){u(this.session.channelId)?(this.session.isDirect=!0,this.params.chat_code=this.session.channelId,this.path="/user-chat/create-msg"):(this.session.isDirect=!1,this.params.target_id=this.session.channelId,this.path="/message/create")}async post(e,t){try{let i={...this.params,...this.additional,type:e,content:t},a=await this.bot.request("POST",this.path,i);if(!a.msg_id)return;let s=this.bot.session();s.type="send",s.content="",s.messageId=a.msg_id,s.timestamp=a.timestamp,this.results.push(s.event.message),s.app.emit(s,"send",s)}catch(i){this.errors.push(i)}}async transformUrl({type:e,attrs:t}){let i=t.src||t.url;if(await this.bot.http.isLocal(i)){let a=new FormData,{data:s,type:r,filename:d}=await this.bot.http.file(i,t);a.append("file",new Blob([s],{type:r}),t.file||d);let{data:{url:o}}=await this.bot.http.post("/asset/create",a);return o}else{if(i.includes("kookapp.cn"))return i;{let{data:a,headers:s}=await this.bot.ctx.http("GET",i,{headers:{accept:e+"/*"},responseType:"arraybuffer",timeout:+t.timeout||void 0}),r=new FormData;r.append("file",new Blob([a],{type:s.get("Content-Type")}),"file");let{data:{url:d}}=await this.bot.http.post("/asset/create",r);return d}}}flushText(){let e=this.textBuffer.trim();e&&(this.textBuffer="",this.cardBuffer.modules.push({type:"section",text:{type:"kmarkdown",content:e}}))}async flush(e=!1){if(this.cardBuffer.modules.length||e)this.flushText(),await this.post(10,JSON.stringify([this.cardBuffer])),this.cardBuffer={type:"card",modules:[]};else{let t=this.textBuffer.trim();if(!t)return;this.textBuffer="",await this.post(9,t)}this.additional={}}async visit(e){let{type:t,attrs:i,children:a}=e;if(t==="text")this.textBuffer+=i.content.replace(/[\\*`~()]/g,"\\$&");else if(t==="b"||t==="strong")this.textBuffer+="**",await this.render(a),this.textBuffer+="**";else if(t==="i"||t==="em")this.textBuffer+="*",await this.render(a),this.textBuffer+="*";else if(t==="u"||t==="ins")this.textBuffer+="(ins)",await this.render(a),this.textBuffer+="(ins)";else if(t==="s"||t==="del")this.textBuffer+="~~",await this.render(a),this.textBuffer+="~~";else if(t==="spl")this.textBuffer+="(spl)",await this.render(a),this.textBuffer+="(spl)";else if(t==="code")this.textBuffer+="`",await this.render(a),this.textBuffer+="`";else if(t==="a")this.textBuffer+="[",await this.render(a),this.textBuffer+=`](${i.href})`;else if(t==="br")this.textBuffer+=`
`;else if(t==="p")this.textBuffer.endsWith(`
`)||(this.textBuffer+=`
`),await this.render(a),this.textBuffer.endsWith(`
`)||(this.textBuffer+=`
`);else if(t==="at")i.id?this.textBuffer+=`(met)${i.id}(met)`:i.type==="all"?this.textBuffer+="(met)all(met)":i.type==="here"?this.textBuffer+="(met)here(met)":i.role&&(this.textBuffer+=`(rol)${i.role}(rol)`);else if(t==="code")this.textBuffer+=`\`${e.toString(!0)}\``;else if(t==="sharp")this.textBuffer+=`(chn)${i.id}(chn)`;else if(["video","audio","file","kook:video","kook:audio","kook:file"].includes(t))this.flushText(),this.cardBuffer.modules.push({type:t.startsWith("kook:")?t.slice(5):t,src:await this.transformUrl(e),title:i.title,cover:i.poster});else if(t==="img"||t==="image"||t==="kook:image")this.flushText(),this.cardBuffer.modules.push({type:"container",elements:[{type:"image",src:await this.transformUrl(e)}]});else if(t==="kook:image-group"){this.flushText();let s=await Promise.all(e.children.map(async r=>({type:"image",src:await this.transformUrl(r),title:r.attrs.title})));for(;s.length;)this.cardBuffer.modules.push({type:"image-group",elements:s.splice(0,9)})}else if(t==="button"||t==="kook:button")this.flushText(),this.cardBuffer.modules.push({type:"action-group",elements:[$(e)]});else if(t==="button-group"||t==="kook:action-group"){this.flushText();let s=e.children.map($);for(;s.length;)this.cardBuffer.modules.push({type:"action-group",elements:s.splice(0,4)})}else t==="hr"||t==="kook:divider"?(this.flushText(),this.cardBuffer.modules.push({type:"divider"})):t==="kook:header"?(this.flushText(),this.cardBuffer.modules.push({type:"header",text:{type:i.type,content:i.content}})):t==="kook:countdown"?(this.flushText(),this.cardBuffer.modules.push({type:"countdown",startTime:+i.startTime,endTime:+i.endTime,mode:i.mode})):t==="kook:invite"?(this.flushText(),this.cardBuffer.modules.push({type:"invite",code:i.code})):t==="kook:card"?(await this.flush(),this.cardBuffer.theme=i["kook:theme"]??(N.Theme.includes(i.class)?i.class:"primary"),this.cardBuffer.size=i["kook:size"],await this.render(a),await this.flush(!0)):t==="quote"?(await this.flush(),this.additional.quote=i.id):t==="message"?(await this.flush(),await this.render(a),await this.flush()):await this.render(a)}};(e=>{e.Config=k.Schema.object({handleMixedContent:k.Schema.union([k.Schema.const("separate").description("将每个不同形式的内容分开发送"),k.Schema.const("card").description("使用卡片发送内容"),k.Schema.const("mixed").description("使用混合模式发送内容")]).role("radio").description("发送图文等混合内容时采用的方式。").default("separate")}).description("发送设置")})(I||(I={}));function $({attrs:e,children:t}){let i="primary";return e.class==="secondary"&&(i="info"),e.class==="warning"&&(i="warning"),e.class==="danger"&&(i="danger"),e.class==="success"&&(i="success"),{type:"button",theme:i,value:e.type==="link"?e.href:e.id,click:e.type==="link"?"link":"return-val",text:{type:"kmarkdown",content:g(t)}}}l($,"encodeButton");function g(e){let t="";for(let i of e){let{type:a,attrs:s,children:r}=i;a==="text"?t+=s.content.replace(/[\\*`~()]/g,"\\$&"):a==="b"||a==="strong"?t+="**"+g(r)+"**":a==="i"||a==="em"?t+="*"+g(r)+"*":a==="u"||a==="ins"?t+="(ins)"+g(r)+"(ins)":a==="s"||a==="del"?t+="~~"+g(r)+"~~":a==="spl"?t+="(spl)"+g(r)+"(spl)":a==="code"?t+="`"+i.toString(!0)+"`":a==="a"&&(t+=`[${g(r)}](${s.href})`)}return t}l(g,"encodeMarkdown");var q=class extends _.Bot{static{l(this,"KookBot")}static MessageEncoder=I;static inject=["http"];http;internal;constructor(e,t){super(e,t,"kook"),this.http=e.http.extend({headers:{Authorization:`Bot ${t.token}`}}).extend(t),this.proxyUrls.push("https://www.kookapp.cn/"),this.internal=new n(this.http),t.protocol==="http"?e.plugin(C,this):t.protocol==="ws"&&e.plugin(A,this)}async request(e,t,i={},a={}){return e==="GET"?(await this.http.get(t,{params:i,headers:a})).data:(await this.http(e,t,{data:i,headers:a})).data?.data}async deleteMessage(e,t){u(e)?await this.request("POST","/user-chat/delete-msg",{msg_id:t}):await this.request("POST","/message/delete",{msg_id:t})}async editMessage(e,t,i){i=_.h.normalize(i).join(""),u(e)?await this.request("POST","/user-chat/update-msg",{msg_id:t,content:i}):await this.request("POST","/message/update",{msg_id:t,content:i})}async getMessage(e,t){return u(e)?v(await this.request("POST","/user-chat/view",{msg_id:t})):v(await this.request("POST","/message/view",{msg_id:t}))}async $createReaction(e,t,i){u(e)?await this.request("POST","/direct-message/add-reaction",{msg_id:t,emoji:i}):await this.request("POST","/message/add-reaction",{msg_id:t,emoji:i})}async $deleteReaction(e,t,i,a){u(e)?await this.request("POST","/direct-message/delete-reaction",{msg_id:t,emoji:i}):await this.request("POST","/message/delete-reaction",{msg_id:t,emoji:i,user_id:a})}async getLogin(){return this.user=G(await this.request("GET","/user/me")),this.toJSON()}async getGuildList(){let{items:e}=await this.request("GET","/guild/list");return{data:e.map(X)}}async getGuildMemberList(e){let{items:t}=await this.request("GET","/guild/user-list",{guild_id:e});return{data:t.map(M)}}async setGroupNickname(e,t,i){await this.request("POST","/guild/nickname",{guild_id:e,user_id:t,nickname:i})}async leaveGroup(e){await this.request("POST","/guild/leave",{guild_id:e})}async kickGroup(e,t){await this.request("POST","/guild/kickout",{guild_id:e,user_id:t})}async createDirectChannel(e){let{code:t}=await this.request("POST","/user-chat/create",{target_id:e});return{id:t,type:_.Universal.Channel.Type.DIRECT}}createReaction(e,t,i){return u(e)?this.internal.addDirectMessageReaction({msg_id:t,emoji:i}):this.internal.addMessageReaction({msg_id:t,emoji:i})}deleteReaction(e,t,i,a){return u(e)?this.internal.deleteDirectMessageReaction({msg_id:t,emoji:i,user_id:a}):this.internal.deleteMessageReaction({msg_id:t,emoji:i,user_id:a})}async getReactionList(e,t,i){let a;return u(e)?a=await this.internal.getDirectMessageReactionList({msg_id:t,emoji:i}):a=await this.internal.getMessageReactionList({msg_id:t,emoji:i}),{data:a.map(G)}}async setGuildMemberRole(e,t,i){await this.internal.grantGuildRole({guild_id:e,user_id:t,role_id:+i})}async unsetGuildMemberRole(e,t,i){await this.internal.revokeGuildRole({guild_id:e,user_id:t,role_id:+i})}async getGuildRoles(e){let{items:t}=await this.internal.getGuildRoleList({guild_id:e});return{data:t.map(O)}}async createGuildRole(e,t){let i=await this.internal.createGuildRole({guild_id:e,...t});return O(i)}async updateGuildRole(e,t,i){await this.internal.updateGuildRole({guild_id:e,...Z(i),role_id:+t})}async deleteGuildRole(e,t){await this.internal.deleteGuildRole({guild_id:e,role_id:+t})}};(e=>{e.Config=_.Schema.intersect([_.Schema.object({protocol:_.Schema.const("ws").default("ws")}),_.Schema.union([A.Options,C.Options]),I.Config,_.HTTP.createConfig("https://www.kookapp.cn/api/v3")])})(q||(q={}));var Ne=q});var S={};Ee(S,{default:()=>Oe});m();var ue=se(ie(),1);h(S,se(ie(),1));var Oe=ue.KookBot;export{Oe as default};
