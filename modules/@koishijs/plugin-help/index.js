var $=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var H=(e,t)=>()=>(e&&(t=e(e=0)),t);var L=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var _=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of D(t))!E.call(e,i)&&i!==n&&$(e,i,{get:()=>t[i],enumerable:!(o=B(t,i))||o.enumerable});return e},v=(e,t,n)=>(_(e,t,"default"),n&&_(n,t,"default"));var T=e=>_($({},"__esModule",{value:!0}),e);import{Buffer as P}from"https://registry.koishi.chat/modules/buffer/index.js";import A from"https://registry.koishi.chat/modules/process/index.js";var b=H(()=>{});var y={};import*as re from"https://registry.koishi.chat/modules/koishi/index.js";var k=H(()=>{b();v(y,re)});var Z=L((ie,U)=>{b();var x=Object.defineProperty,V=Object.getOwnPropertyDescriptor,J=Object.getOwnPropertyNames,G=Object.prototype.hasOwnProperty,g=(e,t)=>x(e,"name",{value:t,configurable:!0}),I=(e,t)=>{for(var n in t)x(e,n,{get:t[n],enumerable:!0})},K=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of J(t))!G.call(e,i)&&i!==n&&x(e,i,{get:()=>t[i],enumerable:!(o=V(t,i))||o.enumerable});return e},Q=e=>K(x({},"__esModule",{value:!0}),e),N={};I(N,{Config:()=>X,apply:()=>F,name:()=>Y});U.exports=Q(N);var h=(k(),T(y)),R={commands:{help:{description:"显示帮助信息",shortcuts:{help:"帮助"},options:{help:"显示此信息",authority:"显示权限设置",showHidden:"查看隐藏的选项和指令"},messages:{"not-found":"指令未找到。","hint-authority":"括号内为对应的最低权限等级","hint-subcommand":"标有星号的表示含有子指令","command-title":"指令：{0}","command-aliases":"别名：{0}。","command-examples":"使用示例：","command-authority":"最低权限：{0} 级。","subcommand-prolog":"可用的子指令有{0}：","global-prolog":"当前可用的指令有{0}：","global-epilog":"输入“{0}help 指令名”查看特定指令的语法和使用示例。","available-options":"可用的选项有：","available-options-with-authority":"可用的选项有（括号内为额外要求的权限等级）："}}}},W={commands:{help:{description:"Show help",shortcuts:{help:"<></>"},options:{help:"show this message",authority:"show authority requirements",showHidden:"show hidden options and commands"},messages:{"not-found":"Command not found.","hint-authority":"this minimum authority is marked in parentheses","hint-subcommand":"those marked with an asterisk have subcommands","command-title":"Command: {0}","command-aliases":"Aliases: {0}.","command-examples":"Examples:","command-authority":"Minimal authority: {0}.","subcommand-prolog":"Available subcommands{0}:","global-prolog":"Available commands{0}:","global-epilog":'Type "{0}help <command>" to see syntax and examples for a specific command.',"available-options":"Available options:","available-options-with-authority":"Available options (parentheses indicate additional authority requirement):"}}}},X=h.Schema.object({shortcut:h.Schema.boolean().default(!0).description("是否启用快捷调用。"),options:h.Schema.boolean().default(!0).description("是否为每个指令添加 `-h, --help` 选项。")});function w(e,t){if(e.app.$commander.get("help"))return e.execute({name:"help",args:[t]})}g(w,"executeHelp");var Y="help";function F(e,t){e.i18n.define("zh-CN",R),e.i18n.define("en-US",W);function n(r){r[h.Context.current]=e,r.option("help","-h",{hidden:!0,notUsage:!0,descPath:"commands.help.options.help"})}g(n,"enableHelp"),e.schema.extend("command",h.Schema.object({hideOptions:h.Schema.boolean().description("是否隐藏所有选项。").default(!1).hidden(),hidden:h.Schema.computed(h.Schema.boolean()).description("在帮助菜单中隐藏指令。").default(!1),params:h.Schema.any().description("帮助信息的本地化参数。").hidden()}),900),e.schema.extend("command-option",h.Schema.object({hidden:h.Schema.computed(h.Schema.boolean()).description("在帮助菜单中隐藏选项。").default(!1),params:h.Schema.any().description("帮助信息的本地化参数。").hidden()}),900),t.options!==!1&&(e.$commander._commandList.forEach(n),e.on("command-added",n)),e.before("command/execute",r=>{let{command:a,options:p,session:c}=r;if(p.help&&a._options.help)return w(c,a.name);if(!a._actions.length)return w(c,a.name)});let o=e.$commander;function i(r,a){let p=o.resolve(r);if(p?.ctx.filter(a))return p;let c=e.i18n.find("commands.(name).shortcuts.(variant)",r).map(u=>({...u,command:o.resolve(u.data.name)})).filter(u=>u.command?.match(a)),f=c.filter(u=>u.similarity===1);return f.length?f[0].command:c}g(i,"findCommand");let l=g(r=>(a,p)=>{let{args:[c],session:f}=a,u=i(c,f);if(!Array.isArray(u)){f.collect(r,{...a,command:u,args:[],options:{help:!0}},p);return}for(let{command:s}of u)f.collect(r,{...a,command:s,args:[],options:{help:!0}},p)},"createCollector");async function d(r,a){let p=i(r,a);if(!Array.isArray(p))return p;let c=o.available(a).filter(s=>s&&a.app.i18n.compare(s,r));for(let s of p)c.includes(s.data.name)||c.push(s.data.name);let f=new Map,u=await a.suggest({expect:c,prefix:a.text(".not-found"),suffix:a.text("internal.suggest-command"),filter:s=>(s=o.resolve(s).name,e.permissions.test(`command:${s}`,a,f))});return o.resolve(u)}g(d,"inferCommand");let m=e.command("help [command:string]",{authority:0,...t}).userFields(["authority"]).userFields(l("user")).channelFields(l("channel")).option("showHidden","-H").action(async({session:r,options:a},p)=>{if(!p){let f=r.resolve(r.app.koishi.config.prefix)[0]??"",u=o._commandList.filter(q=>q.parent===null),s=await j(".global-prolog",r,u,a),S=r.text(".global-epilog",[f]);return S&&s.push(S),s.filter(Boolean).join(`
`)}let c=await d(p,r);if(c)return await e.permissions.test(`command:${c.name}`,r)?M(c,r,a):r.text("internal.low-authority")});t.shortcut!==!1&&m.shortcut("help",{i18n:!0,fuzzy:!0})}g(F,"apply");function*C(e,t,n=!1){for(let o of t)!n&&e.resolve(o.config.hidden)||(o.match(e)?yield o:yield*C(e,o.children,n))}g(C,"getCommands");async function j(e,t,n,o){let i=new Map;if(n=Array.from(C(t,n,o.showHidden)),n=(await Promise.all(n.map(async a=>[a,await t.app.permissions.test(`command:${a.name}`,t,i)]))).filter(([,a])=>a).map(([a])=>a),n.sort((a,p)=>a.displayName>p.displayName?1:-1),!n.length)return[];let l=t.resolve(t.app.koishi.config.prefix)[0]??"",d=n.map(({name:a,displayName:p,config:c})=>{let f="    "+l+p.replace(/\./g," ");return f+="  "+t.text([`commands.${a}.description`,""],c.params),f}),m=[],r=m.length?t.text("general.paren",[m.join(t.text("general.comma"))]):"";return d.unshift(t.text(e,[r])),d}g(j,"formatCommands");function O(e,t){return t.user&&e.authority>t.user.authority?!1:!t.resolve(e.hidden)}g(O,"getOptionVisibility");function z(e,t,n){if(e.config.hideOptions&&!n.showHidden)return[];if(!(n.showHidden?Object.values(e._options):Object.values(e._options).filter(l=>O(l,t))).length)return[];let i=[];return Object.values(e._options).forEach(l=>{function d(m,r){if(!n.showHidden&&!O(m,t))return;let a=`${h.h.escape(m.syntax)}`,p=t.text(m.descPath??[`commands.${e.name}.options.${r}`,""],m.params);p&&(a+="  "+p),a=e.ctx.chain("help/option",a,m,e,t),i.push("    "+a)}g(d,"pushOption"),"value"in l||d(l,l.name);for(let m in l.variants)d(l.variants[m],`${l.name}.${m}`)}),i.length?(i.unshift(t.text(".available-options")),i):[]}g(z,"getOptions");async function M(e,t,n){let o=[t.text(".command-title",[e.displayName.replace(/\./g," ")+e.declaration])],i=t.text([`commands.${e.name}.description`,""],e.config.params);if(i&&o.push(i),t.app.database){let l={command:e,args:[],options:{help:!0}},d=t.collect("user",l);if(await t.observeUser(d),!t.isDirect){let m=t.collect("channel",l);await t.observeChannel(m)}}if(Object.keys(e._aliases).length>1&&o.push(t.text(".command-aliases",[Array.from(Object.keys(e._aliases).slice(1)).join("，")])),t.app.emit(t,"help/command",o,e,t),e._usage)o.push(typeof e._usage=="string"?e._usage:await e._usage(t));else{let l=t.text([`commands.${e.name}.usage`,""],e.config.params);l&&o.push(l)}if(o.push(...z(e,t,n)),e._examples.length)o.push(t.text(".command-examples"),...e._examples.map(l=>"    "+l));else{let l=t.text([`commands.${e.name}.examples`,""],e.config.params);l&&o.push(...l.split(`
`).map(d=>"    "+d))}return o.push(...await j(".subcommand-prolog",t,e.children,n)),o.filter(Boolean).join(`
`)}g(M,"showHelp")});export default Z();
