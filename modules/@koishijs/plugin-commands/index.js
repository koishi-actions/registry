var g=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var y=(e,t)=>()=>(e&&(t=e(e=0)),t);var v=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var d=(e,t,i,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of C(t))!x.call(e,n)&&n!==i&&g(e,n,{get:()=>t[n],enumerable:!(s=P(t,n))||s.enumerable});return e},f=(e,t,i)=>(d(e,t,"default"),i&&d(i,t,"default"));var E=e=>d(g({},"__esModule",{value:!0}),e);import{Buffer as u}from"https://registry.koishi.chat/modules/buffer/index.js";import _ from"https://registry.koishi.chat/modules/process/index.js";var l=y(()=>{});var h={};import*as Q from"https://registry.koishi.chat/modules/koishi/index.js";var b=y(()=>{l();f(h,Q)});import N from"https://registry.koishi.chat/modules/@cordiverse/path/index.js";var S=v((X,O)=>{l();O.exports=N});var V=v((ee,I)=>{l();var m=Object.defineProperty,L=Object.getOwnPropertyDescriptor,A=Object.getOwnPropertyNames,K=Object.prototype.hasOwnProperty,j=(e,t)=>m(e,"name",{value:t,configurable:!0}),M=(e,t)=>{for(var i in t)m(e,i,{get:t[i],enumerable:!0})},B=(e,t,i,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of A(t))!K.call(e,n)&&n!==i&&m(e,n,{get:()=>t[n],enumerable:!(s=L(t,n))||s.enumerable});return e},H=e=>B(m({},"__esModule",{value:!0}),e),k={};M(k,{CommandManager:()=>w,default:()=>U});I.exports=H(k);var a=(b(),E(h)),q={"commands.command":{description:"指令管理",options:{create:"创建指令",alias:"添加指令别名",unalias:"移除指令别名",name:"修改显示名称",parent:"设置父指令","parent.":"移除父指令",option:"修改选项"},messages:{"not-found":"指令不存在。",created:"已创建指令。",updated:"已更新指令配置。"}}};function $(e,t){e.i18n.define("zh-CN",q),e.command("command <name>",{authority:4,checkArgCount:!0}).option("create","-c").option("alias","-a [name]").option("unalias","-A [name]").option("rename","-n [name]").option("parent","-p [name]").option("parent","-P, --no-parent",{value:""}).action(async({options:i,session:s},n)=>{if(i.create&&t.create(n),!e.$commander.resolve(n))return s.text(".not-found");let r=t.ensure(n).command;if(typeof i.alias=="string"){let c=r._aliases[i.rename]||{},p={...r._aliases,[i.alias]:c};t.alias(r,p,!0),delete i.alias}if(typeof i.unalias=="string"){let c={...r._aliases};delete c[i.unalias],t.alias(r,c,!0),delete i.unalias}if(typeof i.rename=="string"){let c=r._aliases[i.rename]||{},p={[i.rename]:c,...r._aliases};t.alias(r,p,!0),delete i.rename}return typeof i.parent=="string"&&(t.teleport(r,i.parent,!0),delete i.parent),i.create?s.text(".created"):s.text(".updated")})}j($,"default");var Z=S(),z=a.Schema.object({name:a.Schema.string(),create:a.Schema.boolean(),aliases:a.Schema.union([a.Schema.dict(a.Schema.union([a.Schema.object({args:a.Schema.array(null).default(null),options:a.Schema.dict(null).default(null),filter:a.Schema.any()}),a.Schema.transform(!1,()=>({filter:!1}))]).default({})),a.Schema.transform(a.Schema.array(String),e=>Object.fromEntries(e.map(t=>[t,{}])))]),options:a.Schema.dict(null).default(null),config:a.Schema.any()}),D=a.Schema.union([z,a.Schema.transform(String,e=>({name:e,aliases:{},config:{},options:{}}))]),w=class{constructor(e,t){this.ctx=e,this.config=t,this.refresh=this.ctx.debounce(()=>{this._cache=null,this.entry?.refresh()},0);for(let i in t){let s=e.$commander.get(i);if(s)this.accept(s,t[i]);else if(t[i].create){let n=e.command(i);this.accept(n,t[i])}}e.on("command-added",async i=>{this.init(i);for(let{command:s,pending:n}of Object.values(this.snapshots)){let o=this.ctx.$commander.get(n);!o||!n||(this.snapshots[s.name].pending=null,this._teleport(s,o))}}),e.on("command-updated",i=>{this.init(i)}),e.on("command-removed",i=>{delete this._tasks[i.name],delete this.snapshots[i.name];for(let s of i.children){let n=this.snapshots[s.name]?.parent;!n||n===i||this._teleport(s,n)}this.refresh()}),e.on("dispose",()=>{this._tasks=Object.create(null);for(let i in this.snapshots){let{command:s,parent:n,initial:o}=this.snapshots[i];s.config=o.config,s._aliases=o.aliases,Object.assign(s._options,o.options),this._teleport(s,n)}},!0),e.plugin($,this),this.installWebUI()}static{j(this,"CommandManager")}static filter=!1;static schema=a.Schema.dict(D).hidden();_tasks=Object.create(null);_cache;entry;refresh;snapshots=Object.create(null);init(e){this.config[e.name]&&(this._tasks[e.name]||=this.ctx.setTimeout(()=>{delete this._tasks[e.name],this.accept(e,this.config[e.name],!0)},0))}ensure(e,t,i){let s=this.ctx.$commander.get(e),n=this.snapshots[s.name];if(i&&n){n.initial.options=(0,a.mapValues)(s._options,(o,r)=>n.initial.options[r]||(0,a.clone)(o));for(let o of Object.keys(s._aliases))n.initial.aliases[o]||n.override.aliases[o]||(n.initial.aliases[o]=s._aliases[o]);return n.override.aliases=s._aliases,n}return this.snapshots[s.name]||={create:t,command:s,parent:s.parent,initial:{aliases:{...s._aliases},options:(0,a.clone)(s._options),config:(0,a.clone)(s.config)},override:{aliases:s._aliases,options:{},config:{}}}}_teleport(e,t=null){e.parent!==t&&(e.parent&&(0,a.remove)(e.parent.children,e),e.parent=t)}teleport(e,t,i=!1){this.snapshots[e.name].pending=null;let s=this.ctx.$commander.get(t);t&&!s?this.snapshots[e.name].pending=t:this._teleport(e,s),i&&(this.config[e.name]||={},this.config[e.name].name=`${t||""}/${e.displayName}`,this.write(e))}alias(e,t,i=!1){let{initial:s,override:n}=this.snapshots[e.name];e._aliases=n.aliases=t,i&&(this.config[e.name]||={},this.config[e.name].name=`${e.parent?.name||""}/${e.displayName}`,this.config[e.name].aliases=(0,a.filterKeys)(t,(o,r)=>!(0,a.deepEqual)(s.aliases[o],r,!0)),this.write(e))}update(e,t,i=!1){let{initial:s,override:n}=this.snapshots[e.name];n.config=t.config||{},n.options=t.options||{},e.config=Object.assign({...s.config},n.config);for(let o in n.options)s.options[o]&&(e._options[o]=Object.assign({...s.options[o]},n.options[o]));i&&(this.config[e.name]||={},this.config[e.name].config=n.config,this.config[e.name].options=n.options,this.write(e))}create(e){this.ctx.command(e),this.ensure(e,!0),this.config[e]={create:!0},this.write()}remove(e){let t=this.snapshots[e],i=t.command.children.slice();delete this.snapshots[e],delete this.config[e];for(let s of i){let{parent:n}=this.snapshots[s.name];this._teleport(s,n),this.config[s.name].name=`${n?.name||""}/${s.displayName}`}t.command.dispose(),this.write(...i)}accept(e,t,i){let{create:s,options:n={},config:o={}}=t;this.ensure(e.name,s,i),this.update(e,{options:n,config:o});let r=t.name;if(r?.includes("/")){let[c,p]=r.split("/");r=p,this.teleport(e,c)}this.alias(e,{...r?{[r]:{}}:{},...e._aliases,...t.aliases}),this.refresh()}write(...e){for(let t of e){let i=this.ensure(t.name),s=this.config[t.name];s.config&&!Object.keys(s.config).length&&delete s.config;for(let n in s.options)s.options[n]&&!Object.keys(s.options[n]).length&&delete s.options[n];if(s.options&&!Object.keys(s.options).length&&delete s.options,s.aliases&&!Object.keys(s.aliases).length&&delete s.aliases,s.name){let n=(i.parent?.name||"")+"/"+t.name;(s.name===n||s.name===t.name)&&delete this.config[t.name].name}Object.keys(s).length||delete this.config[t.name]}this.ctx.scope.update(this.config,!1)}installWebUI(){this.ctx.inject(["console"],e=>{e.on("dispose",()=>this.entry=void 0),this.entry=e.console.addEntry(["https://registry.koishi.chat/modules/@koishijs/plugin-commands/dist/index.js","https://registry.koishi.chat/modules/@koishijs/plugin-commands/dist/style.css"],()=>this._cache||=Object.fromEntries(e.$commander._commandList.map(t=>[t.name,{name:t.name,children:t.children.map(i=>i.name),create:this.snapshots[t.name]?.create,initial:this.snapshots[t.name]?.initial||{aliases:t._aliases,config:t.config,options:t._options},override:this.snapshots[t.name]?.override||{aliases:t._aliases,config:null,options:{}},paths:this.ctx.get("loader")?.paths(t.ctx.scope)||[]}]))),e.console.addListener("command/update",(t,i)=>{let{command:s}=this.ensure(t);this.update(s,i,!0),this.refresh()},{authority:4}),e.console.addListener("command/teleport",(t,i)=>{let{command:s}=this.ensure(t);this.teleport(s,i,!0),this.refresh()},{authority:4}),e.console.addListener("command/aliases",(t,i)=>{let{command:s}=this.ensure(t);this.alias(s,i,!0),this.refresh()},{authority:4}),e.console.addListener("command/create",t=>{this.create(t),this.refresh()},{authority:4}),e.console.addListener("command/remove",t=>{this.remove(t),this.refresh()},{authority:4}),e.console.addListener("command/parse",(t,i)=>this.ctx.$commander.get(t).parse(i))})}},U=w});export default V();
