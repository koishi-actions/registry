var j=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var F=Object.prototype.hasOwnProperty;var A=(a,r)=>()=>(a&&(r=a(a=0)),r);var H=(a,r)=>()=>(r||a((r={exports:{}}).exports,r),r.exports);var y=(a,r,i,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of X(r))!F.call(a,n)&&n!==i&&j(a,n,{get:()=>r[n],enumerable:!(e=D(r,n))||e.enumerable});return a},C=(a,r,i)=>(y(a,r,"default"),i&&y(i,r,"default"));var I=a=>y(j({},"__esModule",{value:!0}),a);import{Buffer as M}from"https://registry.koishi.chat/modules/buffer/index.js";import _ from"https://registry.koishi.chat/modules/process/index.js";var h=A(()=>{});var m={};import*as Z from"https://registry.koishi.chat/modules/koishi/index.js";var $=A(()=>{h();C(m,Z)});var k=H(z=>{"use strict";h();Object.defineProperty(z,"__esModule",{value:!0});z.ColorBias=void 0;var b=($(),I(m)),P=new b.Logger("color-ident");function q(){return b.Random.int(2)*2-1}function R(a){return a*=256,a>255?"ff":a<0?"00":Math.floor(a).toString(16).padStart(2,"0")}function S(a,r,i){return`#${R(a)}${R(r)}${R(i)}`}function V(a,r=1,i=1){let e=i*r,n=a/60,t=i-e,s=e*(1-Math.abs(n%2-1))+t;switch(e=e+t,Math.floor(n)){case 0:return S(e,s,t);case 1:return S(s,e,t);case 2:return S(t,e,s);case 3:return S(t,s,e);case 4:return S(s,t,e);case 5:return S(e,t,s)}}var T=class{level;size;line;row;base;biased;bgColor;fgColor;constructor(r){this.level=r,this.size=4+Math.floor(r/2),this.line=b.Random.int(this.size),this.row=b.Random.int(this.size);let i=b.Random.real(360),e=b.Random.real(.2,1),n=b.Random.real(.2,1);this.base=V(i,e,n),P.debug("base = hsv(%d, %d, %d) = %s",i,e,n,this.base);let t=Math.random()*.3+.1,s=1-t,o=Math.random()*s*.6+s*.2,l=s-o,c=30*Math.exp(-.2*r),g=.5*Math.exp(-.1*r),v=.2*Math.exp(-.1*r),d=o*g;d+e>1?d*=-1:d<=e&&(d*=q());let u=l*v;u+n>1?u*=-1:u<=n&&(u*=q());let E=e+n+d/2+u/2,O=t*c*q()/E,p=i+O;p<0?p+=360:p>=360&&(p-=360),this.biased=V(p,e+d,n+u),P.debug("biased = hsv(%d, %d, %d) = %s",p,e+d,n+u,this.biased);let B=e<.2&&n>.8;this.bgColor=B?"#000000":"#ffffff",this.fgColor=B?"#ffffff":"#000000"}async render(r){let e=this.size+1.5;return["请输入与其他色块不同的色块坐标。",await r.app.canvas.render(e*64,e*64,t=>{t.fillStyle=this.bgColor,t.fillRect(0,0,e*64,e*64),t.textAlign="center",t.textBaseline="middle",t.font="32px sans-serif",t.fillStyle=this.fgColor;for(let o=1;o<=this.size;++o)t.fillText(String(o),(o+.5)*64,.7*64),t.fillText(String.fromCharCode(o+64),.7*64,(o+.5)*64);let s=.4;for(let o=0;o<this.size;o+=1)for(let l=0;l<this.size;l+=1){let c=l+1.5,g=o+1.5,v=o===this.line&&l===this.row?this.biased:this.base;t.fillStyle=v,t.beginPath(),t.moveTo((c-s)*64,(g-s)*64),t.lineTo((c+s)*64,(g-s)*64),t.lineTo((c+s)*64,(g+s)*64),t.lineTo((c-s)*64,(g+s)*64),t.closePath(),t.fill()}})]}};z.ColorBias=T});var K=H(f=>{h();Object.defineProperty(f,"__esModule",{value:!0});f.apply=f.Config=f.using=f.name=void 0;var w=($(),I(m)),L=k(),G=9;f.name="color-bias";f.using=["canvas"];f.Config=w.Schema.object({submission:w.Schema.union([w.Schema.const("strict").description("只接受指令输入"),w.Schema.const("loose").description("允许直接输入答案文本"),w.Schema.const("mention").description("仅在私聊或被提及时接受直接输入")]).role("radio").description("答案提交方式。").default("mention")});function J(a,r){let i={};a.middleware(async(e,n)=>{if(!i[e.channelId]||r.submission==="strict")return n();let{content:s,atSelf:o}=e.stripped;return!e.isDirect&&!o&&r.submission!=="loose"||!/^([a-z]\d|\d[a-z])$/i.test(s)?n():e.execute({name:"color-bias",args:[s]})}),a.command("color-bias [position]","色觉敏感度测试").alias("色觉测试").option("quit","-q  停止测试").action(async({session:e,options:n},t)=>{let s=e.channelId;if(!i[s])return t||n.quit?"没有正在进行的色觉敏感度测试。输入“色觉测试”开始一轮测试。":(i[s]=new L.ColorBias(0),await e.send("测试开始。"),await i[s].render(e));if(n.quit)return delete i[s],"测试已停止。";let o=i[s];if(!t)return await i[s].render(e);if(!/^([a-z]\d|\d[a-z])$/i.test(t))return"请输入由字母+数字构成的坐标。";let l,c;return t[0]>"9"?(l=t.charCodeAt(0)%32-1,c=parseInt(t.slice(1))-1):(l=t.charCodeAt(t.length-1)%32-1,c=parseInt(t.slice(0,-1))-1),l!==o.line||c!==o.row?"回答错误。":o.level===G?(delete i[s],`恭喜 ${e.username} 成功通关，本次测试结束。`):(i[s]=new L.ColorBias(o.level+1),await e.send(`恭喜 ${e.username} 回答正确，下面进入第 ${o.level+2} 题。`),await i[s].render(e))})}f.apply=J});export default K();
