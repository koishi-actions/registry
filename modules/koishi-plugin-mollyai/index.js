var g=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var k=Object.prototype.hasOwnProperty;var f=(t,e)=>()=>(t&&(e=t(t=0)),e);var w=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var p=(t,e,r,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of N(e))!k.call(t,o)&&o!==r&&g(t,o,{get:()=>e[o],enumerable:!(a=A(e,o))||a.enumerable});return t},m=(t,e,r)=>(p(t,e,"default"),r&&p(r,e,"default"));var $=t=>p(g({},"__esModule",{value:!0}),t);import{Buffer as b}from"https://registry.koishi.chat/modules/buffer/index.js";import s from"https://registry.koishi.chat/modules/process/index.js";var n=f(()=>{});var u={};import*as v from"https://registry.koishi.chat/modules/koishi/index.js";var S=f(()=>{n();m(u,v)});var _=w(i=>{n();Object.defineProperty(i,"__esModule",{value:!0});i.apply=i.schema=i.name=void 0;var l=(S(),$(u));i.name="mollyai";var I="https://api.mlyai.com/reply",y="https://files.molicloud.com/";i.schema=l.Schema.object({apiKey:l.Schema.string().description("茉莉云的 Api key").required(),apiSecret:l.Schema.string().role("secret").required(),botName:l.Schema.string().description("机器人名称, 提及此名称后会触发回复, 为空则跳过").required(),replyAt:l.Schema.boolean().description("是否在at机器人后触发回复").default(!0)});function q(t,e,r){return t.bots[e.uid]?null:e.parsed.appel&&r.replyAt?e.parsed.content:r.botName.trim()!==""&&e.content.includes(r.botName)?e.content.replace(RegExp(`^${r.botName}[, ，]+`),""):null}async function P(t,e,r){r.code==="00000"?(t.logger("mollyai").debug("收到 api 响应: "+JSON.stringify(r)),r.data.forEach(async a=>{switch(t.logger("mollyai").info(`API -> ${e.username}: ${a.content}`),a.typed){case 1:case 8:await e.sendQueued(a.content);break;case 2:await e.sendQueued(l.h.image(y+a.content));break;case 4:await e.sendQueued(l.h.audio(y+a.content));break;case 3:case 9:await e.sendQueued(l.h.file(y+a.content));break;default:break}})):r.code==="C1001"?(t.logger("mollyai").info("接口调用到达上限"),await e.sendQueued("今天累了呢，明天再聊吧🥱")):t.logger("mollyai").warn("未知响应: "+r.message)}function Q(t,e){t.command("茉莉云设置",{authority:4}).action(()=>`API key: ${e.apiKey}
API secret: ${e.apiSecret}`);let r=t.http.extend({headers:{"Api-Key":e.apiKey,"Api-Secret":e.apiSecret,"Content-Type":"application/json;charset=UTF-8"}});t.middleware(async(a,o)=>{let d=q(t,a,e);if(d===null)return t.logger("mollyai").debug("收到消息，但是不应该回复"),o();let h=JSON.stringify({content:d.trim(),type:a.subtype==="group"?2:1,from:a.userId,fromName:a.username,to:a.guildId,toName:a.guildName});t.logger("mollyai").debug("发起请求: "+h),t.logger("mollyai").info(`API <- ${a.username}: ${d.trim()}`),r.post(I,h).then(c=>{P(t,a,c)}).catch(c=>{t.logger("mollyai").error(c)})})}i.apply=Q});export default _();
