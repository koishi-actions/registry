var k=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var O=(t,e)=>()=>(t&&(e=t(t=0)),e);var M=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var b=(t,e,a,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of q(e))!A.call(t,r)&&r!==a&&k(t,r,{get:()=>e[r],enumerable:!(n=$(e,r))||n.enumerable});return t},h=(t,e,a)=>(b(t,e,"default"),a&&b(a,e,"default"));var W=t=>b(k({},"__esModule",{value:!0}),t);import{Buffer as w}from"https://registry.koishi.chat/modules/buffer/index.js";import N from"https://registry.koishi.chat/modules/process/index.js";var l=O(()=>{});var p={};import*as ne from"https://registry.koishi.chat/modules/koishi/index.js";var S=O(()=>{l();h(p,ne)});var V=M((ae,T)=>{l();var v=Object.defineProperty,z=Object.getOwnPropertyDescriptor,H=Object.getOwnPropertyNames,L=Object.prototype.hasOwnProperty,m=(t,e)=>v(t,"name",{value:e,configurable:!0}),I=(t,e)=>{for(var a in e)v(t,a,{get:e[a],enumerable:!0})},R=(t,e,a,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of H(e))!L.call(t,r)&&r!==a&&v(t,r,{get:()=>e[r],enumerable:!(n=z(e,r))||n.enumerable});return t},B=t=>R(v({},"__esModule",{value:!0}),t),P={};I(P,{Config:()=>Q,apply:()=>F,checkTimer:()=>j,checkUsage:()=>U,getUsage:()=>x,getUsageName:()=>y,inject:()=>K,name:()=>G});T.exports=B(P);var f=(S(),W(p)),C={};I(C,{apply:()=>D,name:()=>J});var J="usage-admin";function D(t){t.command("usage [key] [value:posint]").userFields(["usage"]).option("set","-s",{authority:4}).option("clear","-c",{authority:4}).action(({session:e,options:a},n,r)=>{let{user:i}=e;if(a.clear)return n?delete i.usage[n]:i.usage={},e.text(".updated");if(a.set)return r?(i.usage[n]=r,e.text(".updated")):e.text("internal.insufficient-arguments");if(n)return e.text(".present",[n,i.usage[n]||0]);let o=[];for(let u of Object.keys(i.usage).sort())u.startsWith("_")||o.push(`${u}：${i.usage[u]}`);return o.length?(o.unshift(e.text(".list")),o.join(`
`)):e.text(".none")}),t.command("timer [key] [value:date]").userFields(["timers"]).option("set","-s",{authority:4}).option("clear","-c",{authority:4}).action(({session:e,options:a},n,r)=>{let{user:i}=e;if(a.clear)return n?delete i.timers[n]:i.timers={},e.text(".updated");if(a.set)return r?(i.timers[n]=+r,e.text(".updated")):e.text("internal.insufficient-arguments");let o=Date.now();if(n){let s=i.timers[n]-o;return s>0?e.text(".present",[n,s]):e.text(".absent",[n])}let u=[];for(let s of Object.keys(i.timers).sort()){if(s.startsWith("_"))continue;let c=i.timers[s]-o;c>0&&u.push(e.text(".item",[s,c]))}return u.length?(u.unshift(e.text(".list")),u.join(`
`)):e.text(".none")})}m(D,"apply");var E={internal:{"usage-exhausted":"调用次数已达上限。","too-frequent":"调用过于频繁，请稍后再试。","option-not-usage":" (不计入调用)","command-max-usage":"已调用次数：{0}/{1}。","command-min-interval":"距离下次调用还需：{0}/{1} 秒。"},commands:{usage:{description:"调用次数信息",options:{set:"设置调用次数",clear:"清空调用次数"},messages:{present:"今日 {0} 功能的调用次数为：{1}",list:"今日各功能的调用次数为：",none:"今日没有调用过消耗次数的功能。",updated:"设置成功。"}},timer:{description:"定时器信息",options:{set:"设置定时器",clear:"清空定时器"},messages:{present:"定时器 {0} 的生效时间为：剩余 <i18n:time value={1}/>",absent:"定时器 {0} 当前并未生效。",list:"各定时器的生效时间为：",item:"<p>{0}：剩余 <i18n:time value={1}/></p>",none:"当前没有生效的定时器。",updated:"设置成功。"}}}},G="rate-limit",K=["database"],Q=f.Schema.object({});function F(t){t.i18n.define("zh-CN",E),t.model.extend("user",{usage:"json",timers:"json"}),t.schema.extend("command",f.Schema.object({usageName:f.Schema.string().description("调用次数的标识符。"),maxUsage:f.Schema.computed(f.Schema.number(),{userFields:["authority"]}).default(0).description("每天的调用次数上限。"),minInterval:f.Schema.computed(f.Schema.number(),{userFields:["authority"]}).default(0).description("连续调用的最小间隔。")}),800),t.schema.extend("command-option",f.Schema.object({notUsage:f.Schema.boolean().default(!1).description("不计入调用次数。")}),800),t.before("command/attach-user",({command:a,options:n={}},r)=>{if(!a)return;let{maxUsage:i,minInterval:o,bypassAuthority:u}=a.config,s=!!(i||o);for(let{name:c,notUsage:g}of Object.values(a._options))c!=="help"&&c in n&&g&&(s=!1);s&&(r.add("authority"),i&&r.add("usage"),o&&r.add("timers")),u&&r.add("authority")});function e(a,n){if(!a.user)return!0;let r=a.resolve(n.config.bypassAuthority);if(a.user.authority>=r)return!0}m(e,"bypassRateLimit"),t.before("command/execute",a=>{let{session:n,options:r,command:i}=a;if(e(n,i))return;function o(d,..._){return i.config.showWarning?n.text([`.${d}`,`internal.${d}`],_):""}m(o,"sendHint");let u=!0;for(let{name:d,notUsage:_}of Object.values(i._options))d in r&&_&&(u=!1);if(!u)return;let s=y(i),c=n.resolve(i.config.minInterval),g=n.resolve(i.config.maxUsage);if(c>0&&j(s,n.user,c))return o("too-frequent");if(g>0&&U(s,n.user,g))return o("usage-exhausted")}),t.on("help/command",(a,n,r)=>{if(e(r,n))return;let i=r.user,o=y(n),u=r.resolve(n.config.maxUsage)??1/0,s=r.resolve(n.config.minInterval)??0;if(u<1/0){let c=x(o,i);a.push(r.text("internal.command-max-usage",[Math.min(c,u),u]))}if(s>0){let c=i.timers[o],g=c?(Math.max(0,c-Date.now())/1e3).toFixed():0;a.push(r.text("internal.command-min-interval",[g,s/1e3]))}}),t.on("help/option",(a,n,r,i)=>{if(e(i,r))return a;let o=i.resolve(r.config.maxUsage);return n.notUsage&&o!==1/0&&(a+=i.text("internal.option-not-usage")),a}),t.plugin(C)}m(F,"apply");function y(t){return t.config.usageName||t.name.replace(/\./g,":")}m(y,"getUsageName");function x(t,e){let a=f.Time.getDateNumber();return e.usage._date!==a&&(e.usage={_date:a}),e.usage[t]||0}m(x,"getUsage");function U(t,e,a){if(!e.usage)return;let n=x(t,e);if(n>=a)return!0;a&&(e.usage[t]=n+1)}m(U,"checkUsage");function j(t,{timers:e},a){let n=Date.now();if(!(n<=e._date)){for(let r in e)n>e[r]&&delete e[r];e._date=n+f.Time.day}if(n<=e[t])return!0;a!==void 0&&(e[t]=n+a)}m(j,"checkTimer")});export default V();
