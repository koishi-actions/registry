var E=Object.defineProperty;var ge=Object.getOwnPropertyDescriptor;var pe=Object.getOwnPropertyNames;var be=Object.prototype.hasOwnProperty;var k=(e,t)=>()=>(e&&(t=e(e=0)),t);var we=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var _=(e,t,a,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of pe(t))!be.call(e,o)&&o!==a&&E(e,o,{get:()=>t[o],enumerable:!(r=ge(t,o))||r.enumerable});return e},h=(e,t,a)=>(_(e,t,"default"),a&&_(a,t,"default"));var b=e=>_(E({},"__esModule",{value:!0}),e);import{Buffer as A}from"https://registry.koishi.chat/modules/buffer/index.js";import $ from"https://registry.koishi.chat/modules/process/index.js";var g=k(()=>{});var f={};import*as Ge from"https://registry.koishi.chat/modules/koishi/index.js";var w=k(()=>{g();h(f,Ge)});var y={};import*as Te from"https://registry.koishi.chat/modules/buffer/index.js";var G=k(()=>{g();h(y,Te)});var Be=we((Qe,me)=>{g();var M=Object.defineProperty,ye=Object.getOwnPropertyDescriptor,Ce=Object.getOwnPropertyNames,Ie=Object.prototype.hasOwnProperty,n=(e,t)=>M(e,"name",{value:t,configurable:!0}),T=(e,t)=>{for(var a in t)M(e,a,{get:t[a],enumerable:!0})},De=(e,t,a,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Ce(t))!Ie.call(e,o)&&o!==a&&M(e,o,{get:()=>t[o],enumerable:!(r=ye(t,o))||r.enumerable});return e},Me=e=>De(M({},"__esModule",{value:!0}),e),Q={};T(Q,{Config:()=>qe,apply:()=>fe,inject:()=>Fe,name:()=>se,reusable:()=>Se,usage:()=>Pe});me.exports=Me(Q);var d=(w(),b(f)),ve=n(()=>d.Schema.intersect([d.Schema.object({WithChannelName:d.Schema.boolean().description("是否包含频道名称").default(!1),WithPlatformName:d.Schema.boolean().description("是否包含平台名称").default(!0)}).description("转发格式").hidden(),d.Schema.object({CacheTimeout:d.Schema.number().description("消息缓存时间（分钟）- 影响跨平台删除与回复等功能").default(120).min(120).max(1440*7)}).description("消息缓存"),d.Schema.object({ForwardGroups:d.Schema.array(d.Schema.object({Note:d.Schema.string().description("互通组备注"),Nodes:d.Schema.array(d.Schema.object({Platform:d.Schema.string().role("").required().description("平台"),Guild:d.Schema.string().required().description("频道ID"),BotID:d.Schema.string().required().description("机器人ID")})).role("table").description("转发节点")})).description("互通转发组")}).description("互通组")]),"createConfig"),x=(w(),b(f)),l=new x.Logger("forward-hime");l.level=x.Logger.INFO;var m=(w(),b(f)),q={};T(q,{kook:()=>Ae,onebot:()=>$e});var R=(w(),b(f)),_e=(G(),b(y)),ke=_e.Buffer.from("R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==","base64");function L({head:e,content:t}){let a=[],r=!1;for(let o in t)t[o].type==="image"&&(r=!0);return a=a.concat(e,(0,R.h)("br"),t),r||(a=a.concat(R.h.image(ke,"image/gif"))),a}n(L,"Decorator");var Ae={Decorator:L},s=(w(),b(f));function H(e,t){let a=JSON.parse(t.attrs.data),r=0;a&&(a.prompt&&(r+=1,e.push((0,s.h)("p",`${a.prompt}`))),a.meta&&a.meta.detail_1&&(a.meta.detail_1.preview&&(r+=1,e.push(s.h.image(a.meta.detail_1.preview,"image/jpeg"))),a.meta.detail_1.qqdocurl&&(r+=1,e.push((0,s.h)("span",`${a.meta.detail_1.qqdocurl}`))))),r===0&&e.push((0,s.h)("span","[CQ:JSON消息]"))}n(H,"cqJsonTranslator");var P=new Map;function J(e){let t=e.attrs.name;if(t)return t;let a=e.attrs.id;return P.has(a)?P.get(a):a}n(J,"getNameFromQQat");function K(e){let t=W(e),a=[],r=[(0,s.h)("b",`${e.username}`),(0,s.h)("span"," 转发自 "),(0,s.h)("i",`${t}`),(0,s.h)("span","：")];if(t==="QQ"){P.set(e.userId,e.username);for(let o in e.elements)switch(e.elements[o].type){case"at":a.push((0,s.h)("span",`@${J(e.elements[o])}`));break;case"forward":a.push((0,s.h)("span","[CQ:转发消息]"));break;case"json":H(a,e.elements[o]);break;case"mface":a.push(s.h.image(e.elements[o].attrs.url));break;default:a.push(e.elements[o]);break}return{head:r,content:a}}return{head:r,content:e.elements}}n(K,"Middleware");function W(e){return e.event.user&&e.event.user.avatar&&e.event.user.avatar.includes("q.qlogo.cn")?"QQ":e.platform}n(W,"guessPlatform");var $e={Middleware:K},p,z=86400*1e3;function C(){return!p.cache}n(C,"cacheNotEnabled");function V(e,t){p=e,z=60*t.CacheTimeout*1e3}n(V,"msgCacheInit");async function B(e){if(C())return;let t=e.guild+":"+e.msgid;l.debug(`[message-cache] ${e.platform} ${t}`),await p.cache.set("msgCache",t,e,z)}n(B,"msgCache");async function S(e){C()||await p.cache.delete("msgCache",e)}n(S,"msgCacheDelete");async function N(e){if(!C())return await p.cache.get("msgCache",e)}n(N,"msgCacheFindByKey");async function X(e){if(C())return;let t=await p.cache.entries("msgCache"),a=[];for await(let r of t)r[1].uuid===e&&a.push(r);return a}n(X,"msgCacheFindByUUID");async function Y(e,t){if(C())return;let a=await p.cache.entries("msgCache");for await(let r of a)if(r[1].uuid===t&&r[1].platform===e.Platform&&r[1].guild===e.Guild&&r[1].bot===e.BotID)return r[1].msgid}n(Y,"msgCacheGetLocalIDByUUID");function Z({head:e,content:t}){let a=[];return a=a.concat(e,(0,m.h)("br"),t),a}n(Z,"defaultDecorator");function O(e){return{head:[(0,m.h)("b",`${e.username}`),(0,m.h)("span"," 转发自 "),(0,m.h)("i",`${e.platform}`),(0,m.h)("span","：")],content:e.elements}}n(O,"defaultMiddleware");var ee=[ie,le],D=[];function te(e){D.push(e),D.length>16&&D.shift(),l.debug("[msgMiddleCache]",D.length)}n(te,"msgMiddleCacheAppend");function ae(e){for(let t of D)if(t.UUID===e)return t.msg;return null}n(ae,"msgMiddleCacheFind");function U(e){let t={head:[],content:[]},a=q[e.platform];return a&&typeof a.Middleware=="function"?t=a.Middleware(e):t=O(e),t}n(U,"MsgToMiddleware");async function re(e){let t=U(e);te({UUID:v(e),msg:t}),l.debug("[msgMiddleCache] CACHED")}n(re,"MsgMiddlewareCache");async function oe(e,t){let a,r=q[t.Platform],o=ae(v(e));o?(l.debug("[msgMiddleCache] HIT"),a=o):(l.debug("[msgMiddleCache] MISSED"),a=U(e));for(let c of ee)a=await c(e,t,a);return r&&typeof r.Decorator=="function"?r.Decorator(a):Z(a)}n(oe,"MsgDecorator");function ne({head:e,content:t}){let a=[],r=[];r.push((0,m.h)("span","[消息降级] "));for(let o in t)["img","audio","video","file"].includes(t[o].type)?r.push((0,m.h)("span",` [${t[o].type}] `)):r.push(t[o]);return a=a.concat(e,(0,m.h)("br"),r),a}n(ne,"defaultDecoratorFallback");async function ce(e,t){let a={head:[],content:[]};a=O(e);for(let r of ee)a=await r(e,t,a);return ne(a)}n(ce,"MsgDecoratorFallback");async function ie(e,t,{head:a,content:r}){return await new Promise((c,i)=>{let u=[];for(let he in r){let I=r[he];I.type==="at"?I.attrs.id!==e.selfId&&u.push((0,m.h)("span",`@${I.attrs.name||I.attrs.id}`)):u.push(I)}c({head:a,content:u})})}n(ie,"atTranslator");async function le(e,t,{head:a,content:r}){if(!e.quote||!e.quote.id)return{head:a,content:r};let o=e.channelId+":"+e.quote.id,c=await N(o);if(c){let i=await Y(t,c.uuid);if(i)return{head:[(0,m.h)("quote",{id:i})].concat(a),content:r};l.error(`[msgCacheGetLocalIDByUUID] ${c.uuid} not found`)}return{head:a,content:r}}n(le,"quoteTranslator");async function F(e,t,a,r){let o=a.channelId+":"+a.messageId,c=await r(a,t);await e.bots[`${t.Platform}:${t.BotID}`].sendMessage(t.Guild,c).then(i=>{let u={platform:t.Platform,bot:t.BotID,guild:t.Guild,msgid:i[0],uuid:o};if(u.msgid)B(u),l.debug(`[MessageForward] to ${u.platform} ${u.uuid}`);else throw new Error("Empty Message ID")}).catch(i=>{throw l.error(`content: ${c}`),i})}n(F,"MessageSendWithDecorator");async function ue(e,t,a){j(e,t)&&F(e,t,a,oe).catch(r=>{l.error(`ERROR:<MessageSend ${t.Platform}> ${r}`),F(e,t,a,ce).catch(o=>{l.error(`ERROR:<MessageSendFallback ${t.Platform}> ${o}`)})})}n(ue,"MessageForward");async function de(e,t){j(e,{Platform:t.platform,BotID:t.bot,Guild:t.guild})&&await e.bots[`${t.platform}:${t.bot}`].deleteMessage(t.guild,t.msgid).catch(a=>{l.error(`ERROR:<MessageDelete> ${a}`)})}n(de,"MessageDelete");function j(e,t){return e.bots[`${t.Platform}:${t.BotID}`]==null?(l.error(`ERROR:<BOT not Exist> ${t.Platform}:${t.BotID}`),!1):!0}n(j,"botExistsCheck");function v(e){return e.channelId+":"+e.messageId}n(v,"MsgUUIDFromSession");var se="forward hime - 转发姬",Pe=`
# ${se}
## 配置说明
1. 添加 \`互通转发组\`
2. 为添加的 \`互通转发组\` 配置转发节点。每个转发节点对应某个平台的一个频道或群组

注意：当未配置\`cache\`时，跨平台删除、跨平台回复等功能将无法正常工作。
## 特性
- 可以配置多个 \`互通转发组\`，每个 \`互通转发组\` 之间相互独立
- 启用插件后，当一个 \`互通转发组\` 中的任意节点收到消息时，插件会自动将消息转发给**这个**\`互通转发组\`中的其他节点。
---`,Se=!0,Fe={optional:["cache"]},qe=ve();function fe(e,t){V(e,t),e.on("message-created",async a=>{let r=[];for(let o in t.ForwardGroups){let c=t.ForwardGroups[o];for(let i in c.Nodes)if(c.Nodes[i].Guild===a.channelId&&c.Nodes[i].Platform===a.platform&&c.Nodes[i].BotID!==a.userId){if(!a.channelId||!a.messageId)continue;l.debug("[message-created]",a.platform,a.channelId+":"+a.messageId);let u=v(a);B({platform:a.platform,bot:c.Nodes[i].BotID,guild:a.channelId,msgid:a.messageId,uuid:u}),r.push(o);break}}r.length>0&&await re(a);for(let o in r){let c=t.ForwardGroups[r[o]];for(let i in c.Nodes)c.Nodes[i].Guild!==a.channelId&&ue(e,c.Nodes[i],a)}}),e.on("message-deleted",async a=>{let r=a.channelId+":"+a.messageId;l.debug("[message-deleted]",r),N(r).then(o=>{if(o){l.debug("[msgCacheFindByKey]",o),S(r);let c=o.uuid;X(c).then(i=>{if(i)for(let u in i)l.debug("[message-delete]",i[u][1]),S(i[u][0]).then(()=>{de(e,i[u][1])})})}})}),e.on("message-updated",async a=>{l.debug("[message-updated]",a.messageId,a)})}n(fe,"apply")});export default Be();
