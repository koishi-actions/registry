var D=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var K=Object.prototype.hasOwnProperty;var P=(t,e)=>()=>(t&&(e=t(t=0)),e);var Q=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var j=(t,e,r,d)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of H(e))!K.call(t,n)&&n!==r&&D(t,n,{get:()=>e[n],enumerable:!(d=G(e,n))||d.enumerable});return t},v=(t,e,r)=>(j(t,e,"default"),r&&j(r,e,"default"));var N=t=>j(D({},"__esModule",{value:!0}),t);import{Buffer as A}from"https://registry.koishi.chat/modules/buffer/index.js";import W from"https://registry.koishi.chat/modules/process/index.js";var S=P(()=>{});var f={};import*as pe from"https://registry.koishi.chat/modules/koishi/index.js";var C=P(()=>{S();v(f,pe)});var de=Q((_e,M)=>{S();var q=Object.defineProperty,V=Object.getOwnPropertyDescriptor,B=Object.getOwnPropertyNames,X=Object.prototype.hasOwnProperty,z=(t,e)=>q(t,"name",{value:e,configurable:!0}),Y=(t,e)=>function(){return e||(0,t[B(t)[0]])((e={exports:{}}).exports,e),e.exports},Z=(t,e)=>{for(var r in e)q(t,r,{get:e[r],enumerable:!0})},ee=(t,e,r,d)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of B(e))!X.call(t,n)&&n!==r&&q(t,n,{get:()=>e[n],enumerable:!(d=V(e,n))||d.enumerable});return t},te=t=>ee(q({},"__esModule",{value:!0}),t),ae=Y({"src/locales/zh-CN.yml"(t,e){e.exports=[{$description:"常量设置",constants:{$description:"常量列表 (「对应规则」中的参数)",$value:{$description:"常量名称 (可随意填写)",$value:[{type:{$description:"常量类型",$value:["仅适用「来源」","仅适用「目标」","适用「来源」或「目标」(通常用以双向转发)"]}},[{name:"来源代称 (可随意填写)",blockingWords:{$description:"屏蔽词 (消息包含屏蔽词时不转发, 支持正则表达式)",$value:"正则表达式 (无需斜杠包围)"},platform:"平台名",channelId:"频道 ID",selfId:"自身 ID"},{selfId:"自身 ID",disabled:"是否禁用",platform:"平台名",channelId:"频道 ID",simulateOriginal:"模拟原始作者 (仅在 discord 平台生效)"},{name:"来源代称 (可随意填写)",selfId:"自身 ID",blockingWords:{$description:"屏蔽词 (消息包含屏蔽词时不转发, 支持正则表达式)"},disabled:"是否禁用 (仅在「目标」生效)",platform:"平台名",channelId:"频道 ID",simulateOriginal:"模拟原始作者 (仅在 discord 平台生效, 仅在「目标」生效)"}]]}}},{$description:"转发规则设置",rules:{$description:"对应规则",$value:{source:"来源 (此处填入「常量名称」)",targets:"目标 (此处填入「常量名称」)"}},delay:{$description:"发送间隔 (默认 200 毫秒)",$value:"平台名"}}]}}),F={};Z(F,{Config:()=>oe,apply:()=>J,inject:()=>ce,name:()=>ie,usage:()=>le});M.exports=te(F);var a=(C(),N(f)),k={platform:a.Schema.string().required(),channelId:a.Schema.string().required()},re=a.Schema.object({type:a.Schema.const("source").required(),name:a.Schema.string(),...k,selfId:a.Schema.string().default("*"),blockingWords:a.Schema.array(String).role("table").default([])}),ne=a.Schema.object({type:a.Schema.const("target").required(),...k,selfId:a.Schema.string().required(),simulateOriginal:a.Schema.boolean().default(!1),disabled:a.Schema.boolean().default(!1)}),se=a.Schema.object({type:a.Schema.const("full").required(),name:a.Schema.string(),...k,selfId:a.Schema.string().required(),blockingWords:a.Schema.array(String).role("table").default([]),simulateOriginal:a.Schema.boolean().default(!1),disabled:a.Schema.boolean().default(!1)}),oe=a.Schema.intersect([a.Schema.object({constants:a.Schema.dict(a.Schema.intersect([a.Schema.object({type:a.Schema.union([a.Schema.const("source"),a.Schema.const("target"),a.Schema.const("full")]).role("radio").required()}),a.Schema.union([re,ne,se])])).collapse(!0)}),a.Schema.object({rules:a.Schema.array(a.Schema.object({source:a.Schema.string().required(),targets:a.Schema.array(String).role("table")})),delay:a.Schema.dict(a.Schema.natural().role("ms").default(.2*a.Time.second))})]).i18n({"zh-CN":ae()}),l=(C(),N(f));function E(t){return l.h.transform(t,{at(e){let r=e.name||e.id;return l.h.text(`@${r}`)},face(e){let r=e.name||"表情";return l.h.text(`[${r}]`)},audio(e){return l.h.text("[语音]")}})}z(E,"transform");function J(t,e){t.model.extend("myrtus_forward_sent",{id:"unsigned",time:"timestamp",from:"string(64)",to:"string(64)",from_sid:"string(64)",to_sid:"string(64)",from_channel_id:"string(64)",to_channel_id:"string(64)"},{autoInc:!0});let{logger:r}=t;for(let d of e.rules){let n=e.constants[d.source];if(!n)continue;let I=[];for(let h of d.targets){let s=e.constants[h];s&&!s.disabled&&I.push(s)}if(I.length===0)continue;let _=t.platform(n.platform);n.selfId!=="*"&&(_=_.self(n.selfId)),n.channelId!=="*"&&(_=_.channel(n.channelId)),_.on("message-created",async h=>{let{event:s,sid:w}=h;for(let g of n.blockingWords){let c=new RegExp(g);if(h.elements.some(p=>p.type==="text"?c.test(p.attrs.content):!1))return}let y=[],{quote:$}=s.message;$&&(s.selfId===$.user.id?y=await t.database.get("myrtus_forward_sent",{to:$.id,to_sid:w,to_channel_id:s.channel.id}):y=await t.database.get("myrtus_forward_sent",{from:$.id,from_sid:w,from_channel_id:s.channel.id}),r.debug("%C","=== inspect quote ==="),r.debug(`from sid: ${w}`));let R=E(s.message.elements),x=[];for(let g=0;g<I.length;g++){let c=I[g],m=`${c.platform}:${c.selfId}`,p=t.bots[m];if(!p){r.warn("暂时找不到机器人实例 %c, 等待一会儿说不定就有了呢!",m);continue}if(p.status!==l.Universal.Status.ONLINE){r.warn("机器人实例 %c 处于非在线状态，可能与网络环境有关。",m);continue}let O;if(c.simulateOriginal&&c.platform==="discord"){let o=s.user.avatar;s.platform==="telegram"&&(o="https://discord.com/assets/5d6a5e9d7d77ac29116e.png"),O=(0,l.h)("author",{name:`[${n.name??""}] ${h.username}`,avatar:o})}else{let o=n.name?`${n.name} - `:"";O=l.h.text(`[${o}${h.username}]
`)}let L=e.delay[c.platform]??200;g&&await t.sleep(L);let b=[O,...R];if(s.message.quote){let o;if(s.selfId===s.message.quote.user.id){r.debug("selfId = quote.userId");let i=y.find(u=>u.from_sid===m&&u.from_channel_id===c.channelId);i&&(o=i.from,r.debug(`channelId: ${i.from_channel_id}`))}else{r.debug("selfId != quote.userId");let i=y.find(u=>u.to_sid===m&&u.to_channel_id===c.channelId);i&&(o=i.to,r.debug(`channelId: ${i.to_channel_id}`))}if(o)b[0].type==="author"?b.splice(1,0,l.h.quote(o)):b.unshift(l.h.quote(o)),r.debug(`msgId: ${o}`),r.debug("quote added");else{let{user:i,elements:u=[],member:T}=s.message.quote,U=T?.nick||i.nick||i.name;b.unshift(l.h.text(`Re ${U} ⌈`),...E(u),l.h.text(`⌋
`)),r.debug("quote not added")}r.debug(`to sid: ${m}`)}try{let o=await p.sendMessage(c.channelId,b);for(let i of o)x.push({from:s.message.id,from_sid:`${s.platform}:${s.selfId}`,to:i,to_sid:m,from_channel_id:s.channel.id,to_channel_id:c.channelId,time:new Date})}catch(o){r.error(o)}}x.length!==0&&t.database.upsert("myrtus_forward_sent",x)})}}z(J,"apply");var ie="forward",ce=["database"],le=`
这是用于在不同群组间转发消息的插件。

入门教程<a href="https://github.com/bot-myrtus/forward?tab=readme-ov-file#%E8%AE%BE%E5%AE%9A%E6%B6%88%E6%81%AF%E8%BD%AC%E5%8F%91%E8%A7%84%E5%88%99" target="_blank">点此查阅</a>，如有疑问可<a href="https://github.com/bot-myrtus/forward/issues/new" target="_blank">提交 issue</a>。
`});export default de();
