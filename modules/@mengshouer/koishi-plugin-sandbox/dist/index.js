import{computed as se,defineComponent as he,openBlock as E,createElementBlock as H,createElementVNode as j,toDisplayString as X,withModifiers as je,unref as B,createVNode as T,createCommentVNode as pe,withKeys as Te,ref as Q,watch as ke,resolveComponent as P,createBlock as ee,withCtx as K,Fragment as Ae,renderList as He,normalizeClass as Re,KeepAlive as Pe}from"vue";import{useStorage as Ke,receive as ye,send as q,useMenu as qe,MessageContent as Se,useContext as Ge,Schema as Ce,clone as Oe,deepEqual as We,VirtualList as Ye,message as Xe,icons as Ze}from"@koishijs/client";import{useEventListener as De}from"@vueuse/core";var Je=Object.defineProperty,m=(e,t)=>Je(e,"name",{value:t,configurable:true});function Qe(){}m(Qe,"noop");function I(e){return e==null}m(I,"isNullable");function et(e){return e&&typeof e=="object"&&!Array.isArray(e)}m(et,"isPlainObject");function tt(e,t){return Object.fromEntries(Object.entries(e).filter(([o,d])=>t(o,d)))}m(tt,"filterKeys");function Le(e,t){return Object.fromEntries(Object.entries(e).map(([o,d])=>[o,t(d,o)]))}m(Le,"mapValues");function nt(e,t,o){if(!t)return{...e};const d={};for(const c of t)(o||e[c]!==void 0)&&(d[c]=e[c]);return d}m(nt,"pick");function rt(e,t){if(!t)return{...e};const o={...e};for(const d of t)Reflect.deleteProperty(o,d);return o}m(rt,"omit");function de(e,t,o){return Object.defineProperty(e,t,{writable:true,value:o,enumerable:false})}m(de,"defineProperty");function at(e,t){return t.every(o=>e.includes(o))}m(at,"contain");function st(e,t){return e.filter(o=>t.includes(o))}m(st,"intersection");function ot(e,t){return e.filter(o=>!t.includes(o))}m(ot,"difference");function it(e,t){return Array.from(new Set([...e,...t]))}m(it,"union");function lt(e){return[...new Set(e)]}m(lt,"deduplicate");function ut(e,t){const o=e.indexOf(t);return o>=0?(e.splice(o,1),true):false}m(ut,"remove");function Be(e){return Array.isArray(e)?e:I(e)?[]:[e]}m(Be,"makeArray");function z(e,t){return arguments.length===1?o=>z(e,o):e in globalThis&&t instanceof globalThis[e]||Object.prototype.toString.call(t).slice(8,-1)===e}m(z,"is");function te(e){return z("ArrayBuffer",e)||z("SharedArrayBuffer",e)}m(te,"isArrayBufferLike");function Ee(e){return te(e)||ArrayBuffer.isView(e)}m(Ee,"isArrayBufferSource");var Z;(e=>{e.is=te,e.isSource=Ee;function t(y){return ArrayBuffer.isView(y)?y.buffer.slice(y.byteOffset,y.byteOffset+y.byteLength):y}e.fromSource=t,m(t,"fromSource");function o(y){if(typeof Buffer<"u")return Buffer.from(y).toString("base64");let a="";const p=new Uint8Array(y);for(let b=0;b<p.byteLength;b++)a+=String.fromCharCode(p[b]);return btoa(a)}e.toBase64=o,m(o,"toBase64");function d(y){return typeof Buffer<"u"?t(Buffer.from(y,"base64")):Uint8Array.from(atob(y),a=>a.charCodeAt(0))}e.fromBase64=d,m(d,"fromBase64");function c(y){return typeof Buffer<"u"?Buffer.from(y).toString("hex"):Array.from(new Uint8Array(y),a=>a.toString(16).padStart(2,"0")).join("")}e.toHex=c,m(c,"toHex");function w(y){if(typeof Buffer<"u")return t(Buffer.from(y,"hex"));const a=y.length%2===0?y:y.slice(0,y.length-1),p=[];for(let b=0;b<a.length;b+=2)p.push(parseInt(`${a[b]}${a[b+1]}`,16));return Uint8Array.from(p).buffer}e.fromHex=w,m(w,"fromHex")})(Z||(Z={}));Z.fromBase64;var $e=Z.toBase64;Z.fromHex;Z.toHex;function ge(e){return!e||typeof e!="object"?e:Array.isArray(e)?e.map(ge):z("Date",e)?new Date(e.valueOf()):z("RegExp",e)?new RegExp(e.source,e.flags):te(e)?e.slice(0):ArrayBuffer.isView(e)?e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength):Le(e,ge)}m(ge,"clone");function me(e,t,o){if(e===t||!o&&I(e)&&I(t))return true;if(typeof e!=typeof t||typeof e!="object"||!e||!t)return false;function d(c,w){return c(e)?c(t)?w(e,t):false:c(t)?false:void 0}return m(d,"check"),d(Array.isArray,(c,w)=>c.length===w.length&&c.every((y,a)=>me(y,w[a])))??d(z("Date"),(c,w)=>c.valueOf()===w.valueOf())??d(z("RegExp"),(c,w)=>c.source===w.source&&c.flags===w.flags)??d(te,(c,w)=>{if(c.byteLength!==w.byteLength)return false;const y=new Uint8Array(c),a=new Uint8Array(w);for(let p=0;p<y.length;p++)if(y[p]!==a[p])return false;return true})??Object.keys({...e,...t}).every(c=>me(e[c],t[c],o))}m(me,"deepEqual");function ct(e){return e.charAt(0).toUpperCase()+e.slice(1)}m(ct,"capitalize");function ve(e){return e.charAt(0).toLowerCase()+e.slice(1)}m(ve,"uncapitalize");function Ve(e){return e.replace(/[_-][a-z]/g,t=>t.slice(1).toUpperCase())}m(Ve,"camelCase");function Ie(e){return ve(e).replace(/_/g,"-").replace(/.[A-Z]+/g,t=>t[0]+"-"+t.slice(1).toLowerCase())}m(Ie,"paramCase");function ft(e){return ve(e).replace(/-/g,"_").replace(/.[A-Z]+/g,t=>t[0]+"_"+t.slice(1).toLowerCase())}m(ft,"snakeCase");var pt=Ve,dt=Ie;function ze(e){return e.replace(/\/$/,"")}m(ze,"trimSlash");function gt(e){return e.startsWith("/")||(e="/"+e),ze(e)}m(gt,"sanitize");var Ne;(e=>{e.millisecond=1,e.second=1e3,e.minute=e.second*60,e.hour=e.minute*60,e.day=e.hour*24,e.week=e.day*7;let t=new Date().getTimezoneOffset();function o(s){t=s}e.setTimezoneOffset=o,m(o,"setTimezoneOffset");function d(){return t}e.getTimezoneOffset=d,m(d,"getTimezoneOffset");function c(s=new Date,u){return typeof s=="number"&&(s=new Date(s)),u===void 0&&(u=t),Math.floor((s.valueOf()/e.minute-u)/1440)}e.getDateNumber=c,m(c,"getDateNumber");function w(s,u){const $=new Date(s*e.day);return u===void 0&&(u=t),new Date(+$+u*e.minute)}e.fromDateNumber=w,m(w,"fromDateNumber");const y=/\d+(?:\.\d+)?/.source,a=new RegExp(`^${["w(?:eek(?:s)?)?","d(?:ay(?:s)?)?","h(?:our(?:s)?)?","m(?:in(?:ute)?(?:s)?)?","s(?:ec(?:ond)?(?:s)?)?"].map(s=>`(${y}${s})?`).join("")}$`);function p(s){const u=a.exec(s);return u?(parseFloat(u[1])*e.week||0)+(parseFloat(u[2])*e.day||0)+(parseFloat(u[3])*e.hour||0)+(parseFloat(u[4])*e.minute||0)+(parseFloat(u[5])*e.second||0):0}e.parseTime=p,m(p,"parseTime");function b(s){const u=p(s);return u?s=Date.now()+u:/^\d{1,2}(:\d{1,2}){1,2}$/.test(s)?s=`${new Date().toLocaleDateString()}-${s}`:/^\d{1,2}-\d{1,2}-\d{1,2}(:\d{1,2}){1,2}$/.test(s)&&(s=`${new Date().getFullYear()}-${s}`),s?new Date(s):new Date}e.parseDate=b,m(b,"parseDate");function D(s){const u=Math.abs(s);return u>=e.day-e.hour/2?Math.round(s/e.day)+"d":u>=e.hour-e.minute/2?Math.round(s/e.hour)+"h":u>=e.minute-e.second/2?Math.round(s/e.minute)+"m":u>=e.second?Math.round(s/e.second)+"s":s+"ms"}e.format=D,m(D,"format");function f(s,u=2){return s.toString().padStart(u,"0")}e.toDigits=f,m(f,"toDigits");function h(s,u=new Date){return s.replace("yyyy",u.getFullYear().toString()).replace("yy",u.getFullYear().toString().slice(2)).replace("MM",f(u.getMonth()+1)).replace("dd",f(u.getDate())).replace("hh",f(u.getHours())).replace("mm",f(u.getMinutes())).replace("ss",f(u.getSeconds())).replace("SSS",f(u.getMilliseconds(),3))}e.template=h,m(h,"template")})(Ne||(Ne={}));var mt=Object.defineProperty,ht=Object.getOwnPropertyNames,k=(e,t)=>mt(e,"name",{value:t,configurable:true}),yt=(e,t)=>function(){return t||(0,e[ht(e)[0]])((t={exports:{}}).exports,t),t.exports},vt=yt({"src/index.ts"(e,t){var y;var o=Symbol.for("satori.element"),d=(y=class{get data(){return this.attrs}getTagName(){var p;return this.type==="component"?((p=this.attrs.is)==null?void 0:p.name)??"component":this.type}toAttrString(){return Object.entries(this.attrs).map(([p,b])=>I(b)?"":(p=dt(p),b===true?` ${p}`:b===false?` no-${p}`:` ${p}="${c.escape(""+b,true)}"`)).join("")}toString(p=false){if(this.type==="text"&&"content"in this.attrs)return p?this.attrs.content:c.escape(this.attrs.content);const b=this.children.map(h=>h.toString(p)).join("");if(p)return b;const D=this.toAttrString(),f=this.getTagName();return this.children.length?`<${f}${D}>${b}</${f}>`:`<${f}${D}/>`}},k(y,"ElementConstructor"),y);de(d,"name","Element"),de(d.prototype,o,true);function c(a,...p){const b=Object.create(d.prototype),D={},f=[];if(p[0]&&typeof p[0]=="object"&&!c.isElement(p[0])&&!Array.isArray(p[0])){const h=p.shift();for(const[s,u]of Object.entries(h))I(u)||(s==="children"?p.push(...Be(u)):D[pt(s)]=u)}for(const h of p)f.push(...c.toElementArray(h));return typeof a=="function"&&(D.is=a,a="component"),Object.assign(b,{type:a,attrs:D,children:f})}k(c,"Element");var w=new Function("expr","context",`
  try {
    with (context) {
      return eval(expr)
    }
  } catch {}
`);(a=>{a.jsx=a,a.jsxs=a,a.jsxDEV=a,a.Fragment="template";function p(r){return r&&typeof r=="object"&&r[o]}a.isElement=p,k(p,"isElement");function b(r){if(typeof r=="string"||typeof r=="number"||typeof r=="boolean"){if(r=""+r,r)return a("text",{content:r})}else{if(p(r))return r;if(!I(r))throw new TypeError(`Invalid content: ${r}`)}}a.toElement=b,k(b,"toElement");function D(r){return Array.isArray(r)?r.map(b).filter(n=>n):[b(r)].filter(n=>n)}a.toElementArray=D,k(D,"toElementArray");function f(r,n){return typeof r=="string"?F(r,n):D(r)}a.normalize=f,k(f,"normalize");function h(r,n=false){const i=r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return n?i.replace(/"/g,"&quot;"):i}a.escape=h,k(h,"escape");function s(r){return r.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#(\d+);/g,(n,i)=>i==="38"?n:String.fromCharCode(+i)).replace(/&#x([0-9a-f]+);/gi,(n,i)=>i==="26"?n:String.fromCharCode(parseInt(i,16))).replace(/&(amp|#38|#x26);/g,"&")}a.unescape=s,k(s,"unescape");function u(r,n={}){var l;const i=F(r);return n.caret?n.type&&((l=i[0])==null?void 0:l.type)!==n.type?void 0:i[0]:A(i,n.type||"*")[0]}a.from=u,k(u,"from");const $=/ *([ >+~]) */g;function g(r){return r.split(",").map(n=>{const i=[];n=n.trim();let l,x=" ";for(;l=$.exec(n);)i.push({type:n.slice(0,l.index),combinator:x}),x=l[1],n=n.slice(l.index+l[0].length);return i.push({type:n,combinator:x}),i})}a.parseSelector=g,k(g,"parseSelector");function A(r,n){if(!r||!n)return[];if(typeof r=="string"&&(r=F(r)),typeof n=="string"&&(n=g(n)),!n.length)return[];let i=[];const l=[];for(const[x,v]of r.entries()){const S=[],M=[...n,...i];i=[];let O=false;for(const C of M){const{type:U,combinator:fe}=C[0];(U===v.type||U==="*")&&(C.length===1?O=true:[" ",">"].includes(C[1].combinator)?S.push(C.slice(1)):C[1].combinator==="+"?i.push(C.slice(1)):n.push(C.slice(1))),fe===" "&&S.push(C)}O&&l.push(r[x]),l.push(...A(v.children,S))}return l}a.select=A,k(A,"select");function L(r,n){if(r=r.trim(),!/^[\w.]+$/.test(r))return w(r,n)??"";let i=n;for(const l of r.split("."))if(i=i[l],I(i))return"";return i??""}a.interpolate=L,k(L,"interpolate");const R=/(?<comment><!--[\s\S]*?-->)|(?<tag><(\/?)([^!\s>/]*)([^>]*?)\s*(\/?)>)/,oe=/(?<comment><!--[\s\S]*?-->)|(?<tag><(\/?)([^!\s>/]*)([^>]*?)\s*(\/?)>)|(?<curly>\{(?<derivative>[@:/#][^\s}]*)?[\s\S]*?\})/,ie=/([^\s=]+)(?:="(?<value1>[^"]*)"|='(?<value2>[^']*)')?/g,le=/([^\s=]+)(?:="(?<value1>[^"]*)"|='(?<value2>[^']*)'|=(?<curly>\{([^}]+)\}))?/g;let ne;(r=>{r[r.OPEN=0]="OPEN",r[r.CLOSE=1]="CLOSE",r[r.EMPTY=2]="EMPTY",r[r.CONTINUE=3]="CONTINUE"})(ne||(ne={}));function F(r,n){const i=[];function l(O){O&&i.push(O)}k(l,"pushText");const x=n?oe:R;let v,S=true;for(;v=x.exec(r);){const O=!v.groups.curly;M(r.slice(0,v.index),S,O),S=O,r=r.slice(v.index+v[0].length);const[C,,,U,fe,Fe,Ue]=v;if(!v.groups.comment){if(v.groups.curly){let xe="",we=2;v.groups.derivative&&(xe=v.groups.derivative.slice(1),we={"@":2,"#":0,"/":1,":":3}[v.groups.derivative[0]]),i.push({type:"curly",name:xe,position:we,source:v.groups.curly,extra:v.groups.curly.slice(1+(v.groups.derivative??"").length,-1)});continue}i.push({type:"angle",source:C,name:fe||a.Fragment,position:U?1:Ue?2:0,extra:Fe})}}M(r,S,true);function M(O,C,U){O=s(O),C&&(O=O.replace(/^\s*\n\s*/,"")),U&&(O=O.replace(/\s*\n\s*$/,"")),l(O)}return k(M,"parseContent"),V(N(i),n)}a.parse=F,k(F,"parse");function N(r){const n=[[{type:"angle",name:a.Fragment,position:0,source:"",extra:"",children:{default:[]}},"default"]];function i(...l){const[x,v]=n[0];x.children[v].push(...l)}k(i,"pushToken");for(const l of r){if(typeof l=="string"){i(l);continue}const{name:x,position:v}=l;v===1?n[0][0].name===x&&n.shift():v===3?(n[0][0].children[x]=[],n[0][1]=x):v===0?(i(l),l.children={default:[]},n.unshift([l,"default"])):i(l)}return n[n.length-1][0].children.default}k(N,"foldTokens");function V(r,n){const i=[];for(const l of r)if(typeof l=="string")i.push(a("text",{content:l}));else if(l.type==="angle"){const x={},v=n?le:ie;let S;for(;S=v.exec(l.extra);){const[,M,O,C=O,U]=S;U?x[M]=L(U,n):I(C)?M.startsWith("no-")?x[M.slice(3)]=false:x[M]=true:x[M]=s(C)}i.push(a(l.name,x,l.children&&V(l.children.default,n)))}else if(!l.name)i.push(...D(L(l.extra,n)));else if(l.name==="if")w(l.extra,n)?i.push(...V(l.children.default,n)):i.push(...V(l.children.else||[],n));else if(l.name==="each"){const[x,v]=l.extra.split(/\s+as\s+/),S=L(x,n);if(!S||!S[Symbol.iterator])continue;for(const M of S)i.push(...V(l.children.default,{...n,[v]:M}))}return i}k(V,"parseTokens");function re(r,n,i){const{type:l,attrs:x,children:v}=r;if(typeof n=="function")return n(r,i);{let S=n[typeof l=="string"?l:""]??n.default??true;return typeof S=="function"&&(S=S(x,v,i)),S}}k(re,"visit");function ue(r,n,i){const l=typeof r=="string"?F(r):r,x=[];return l.forEach(v=>{const{type:S,attrs:M,children:O}=v,C=re(v,n,i);C===true?x.push(a(S,M,ue(O,n,i))):C!==false&&x.push(...D(C))}),typeof r=="string"?x.join(""):x}a.transform=ue,k(ue,"transform");async function ce(r,n,i){const l=typeof r=="string"?F(r):r,x=(await Promise.all(l.map(async v=>{const{type:S,attrs:M,children:O}=v,C=await re(v,n,i);return C===true?[a(S,M,await ce(O,n,i))]:C!==false?D(C):[]}))).flat(1);return typeof r=="string"?x.join(""):x}a.transformAsync=ce,k(ce,"transformAsync");function J(r,...n){return(...i)=>{const l=a(r);return n.forEach((x,v)=>{I(i[v])||(l.attrs[x]=i[v])}),i[n.length]&&Object.assign(l.attrs,i[n.length]),l}}k(J,"createFactory"),a.warn=k(()=>{},"warn");function W(r){return(n,...i)=>{let l="base64://";return typeof i[0]=="string"&&(l=`data:${i.shift()};base64,`),z("Buffer",n)?n=l+n.toString("base64"):z("ArrayBuffer",n)?n=l+$e(n):ArrayBuffer.isView(n)&&(n=l+$e(n.buffer)),n.startsWith("base64://")&&(0,a.warn)('protocol "base64:" is deprecated and will be removed in the future, please use "data:" instead'),a(r,{...i[0],src:n})}}k(W,"createAssetFactory"),a.text=J("text","content"),a.at=J("at","id"),a.sharp=J("sharp","id"),a.quote=J("quote","id"),a.image=W("img"),a.img=W("img"),a.video=W("video"),a.audio=W("audio"),a.file=W("file");function be(r,n){return a("i18n",typeof r=="string"?{path:r}:r,n)}a.i18n=be,k(be,"i18n")})(c||(c={})),t.exports=c}});const G=vt(),_t={private:"私聊模式",guild:"群聊模式",profile:"用户设置"},_=Ke("sandbox",1.1,()=>({platform:"sandbox:"+Math.random().toString(36).slice(2),user:"",index:0,messages:{},panelType:"private"})),Y=se(()=>_.value.panelType==="guild"?"#":"@"+_.value.user);ye("sandbox/message",e=>{var t,o;e.platform===_.value.platform&&((t=_.value.messages)[o=e.channel]||(t[o]=[])).push(e)});ye("sandbox/clear",()=>{_.value.messages[Y.value]=[]});const ae={deleteMessage({messageId:e,channelId:t}){const o=_.value.messages[t];o&&(_.value.messages[t]=o.filter(d=>d.id!==e))},getMessage({messageId:e,channelId:t}){var o;return(o=_.value.messages[t])==null?void 0:o.find(d=>d.id===e)},getChannel({channelId:e,guildId:t}){return{channelId:"#"}},getChannelList({guildId:e}){return{data:{channelId:"#"}}},getGuild({guildId:e}){return{guildId:"#"}},getGuildList(){return{data:{guildId:"#"}}},getGuildMember({guildId:e,userId:t}){return{userId:t,username:t}},getGuildMemberList({guildId:e}){return{data:Object.keys(_.value.messages).filter(o=>o.startsWith("@")).map(o=>{const d=o.slice(1);return{userId:d,username:d}})}}};ye("sandbox/request",({method:e,nonce:t,data:o})=>{var c;const d=(c=ae[e])==null?void 0:c.call(ae,o);q("sandbox/response",t,d)});const bt=["Alice","Bob","Carol","Dave","Eve","Frank","Grace","Hank","Ivy","Jack","Kathy","Lily","Mandy","Nancy","Oscar","Peggy","Quinn","Randy","Sandy","Toby","Uma","Vicky","Wendy","Xander","Yvonne","Zoe"],xt={class:"chat-message"},wt={class:"avatar"},kt={class:"nickname"},At={key:0,class:"quote"},St={class:"abstract"},Ct=he({__name:"message",props:{data:{}},setup(e){const t=qe("sandbox.message");return(o,d)=>(E(),H("div",xt,[j("div",wt,X(o.data.user[0]),1),j("div",kt,X(o.data.user),1),j("div",{class:"message-box",onContextmenu:d[0]||(d[0]=je(c=>B(t)(c,o.data),["stop"]))},[o.data.quote?(E(),H("blockquote",At,[j("span",St,[T(B(Se),{content:o.data.quote.content},null,8,["content"])])])):pe("v-if",true),T(B(Se),{content:o.data.content},null,8,["content"])],32)]))}});const _e=(e,t)=>{const o=e.__vccOpts||e;for(const[d,c]of t)o[d]=c;return o},Ot=_e(Ct,[["__scopeId","data-v-70b0e88c"]]),Dt={class:"textarea"},$t=["innerHTML","placeholder","onKeydown"],Nt=he({__name:"input",props:{target:{default:()=>document},modelValue:{default:""},placeholder:{}},emits:["send","update:modelValue"],setup(e,{emit:t}){const o=t,d=e,c=se({get:()=>d.modelValue,set:f=>o("update:modelValue",f)});function w(f){f.preventDefault();const h=f.target.childNodes;if(!h.length)return;let s="";for(const u of h)if(u.nodeType===Node.TEXT_NODE)s+=G.escape(u.textContent);else if(u.nodeType===Node.ELEMENT_NODE){const $=u;$.tagName==="BR"?s+=`
`:$.tagName==="IMG"?s+=G("img",{src:$.getAttribute("src")}).toString():$.tagName==="AUDIO"?s+=G("audio",{src:$.getAttribute("src")}).toString():$.tagName==="VIDEO"&&(s+=G("video",{src:$.getAttribute("src")}).toString())}o("send",s),f.target.innerHTML="",c.value=""}function y(f){const h=f.target.innerHTML,s=["","<br>"].includes(h);if(["ArrowUp","ArrowDown"].includes(f.key)){if(!s&&c.value===""){f.stopPropagation();return}c.value=h}s&&["Delete","Backspace"].includes(f.key)&&(f.target.innerHTML="",c.value="")}function a(f,h){for(const s of h.items){f.preventDefault();const u=s.getAsFile(),[$]=u.type.split("/",1);if(!["image","audio","video"].includes($)){console.warn("Unsupported file type:",u.type);return}const g=new FileReader;g.addEventListener("load",function(){o("send",G($,{src:g.result}).toString())},false),g.readAsDataURL(u)}}De(d.target,"drop",f=>{a(f,f.dataTransfer)}),De(d.target,"dragover",f=>{f.preventDefault()});function p(f){const h=window.getSelection();h&&(h.deleteFromDocument(),h.getRangeAt(0).insertNode(f),h.collapseToEnd())}function b(f){if(f.nodeType===Node.TEXT_NODE){const h=f.textContent;if(h){const s=document.createTextNode(h);p(s)}}else if(f.nodeType===Node.ELEMENT_NODE){const h=f;if(h.tagName==="IMG"){const s=h.getAttribute("src");if(!s)return;const u=document.createElement("img");u.setAttribute("src",s),p(u)}else for(const s of h.childNodes)b(s)}}async function D(f){const s=f.clipboardData.getData("text/html");if(!s)return;f.preventDefault();const $=new DOMParser().parseFromString(s,"text/html");b($.body)}return(f,h)=>(E(),H("div",Dt,[j("div",{class:"input-box",contenteditable:"true",innerHTML:c.value,placeholder:f.placeholder,onKeydown:[y,Te(je(w,["exact"]),["enter"])],onPaste:D},null,40,$t)]))}});const Mt=_e(Nt,[["__scopeId","data-v-3e418c67"]]),jt={class:"user-container"},Lt={class:"avatar"},Bt={class:"nick"},Et=["onClick"],Vt={class:"card-header"},It=["onClick"],zt=j("div",null,"点击「添加用户」开始体验",-1),Ft={class:"card-footer"},Ut={key:0,class:"quote"},Tt={class:"left"},Me=10,Ht=he({__name:"layout",setup(e){const t=Ge();t.action("sandbox.message.delete",{action:({sandbox:g})=>$(g.message)}),t.action("sandbox.message.quote",{action:({sandbox:g})=>b.value=g.message});const o=Ce.object({authority:Ce.natural().description("权限等级")}),d=se(()=>Object.keys(_.value.messages).filter(g=>g.startsWith("@")).map(g=>g.slice(1))),c=se(()=>Object.fromEntries(d.value.map(g=>[g,{name:g}])));function w(){if(d.value.length>=Me)return Xe.error("可创建的用户数量已达上限。");let g;do g=bt[_.value.index++],_.value.index%=Me;while(d.value.includes(g));_.value.user=g,_.value.messages["@"+g]=[],q("sandbox/set-user",_.value.platform,_.value.user,{})}function y(g){const A=d.value.indexOf(g);delete _.value.messages["@"+g],q("sandbox/set-user",_.value.platform,_.value.user,null),_.value.user===g&&(_.value.user=d.value[A]||"")}const a=Q(""),p=Q(0),b=Q();function D(g){return g.replace(/<image url=(.+?)\/>/g,"<img src=$1/>")}function f(g){if(g.key==="ArrowUp"){const A=_.value.messages[Y.value].filter(R=>R.user===_.value.user);let L=A.length-p.value;A[L-1]&&(p.value++,a.value=D(G.unescape(A[L-1].content)))}else if(g.key==="ArrowDown"){const A=_.value.messages[Y.value].filter(R=>R.user===_.value.user);let L=A.length-p.value;A[L+1]?(p.value--,a.value=D(G.unescape(A[L+1].content))):p.value&&(p.value=0,a.value="")}}const h=Q(),s=Q();ke(()=>_.value.user,async g=>{g&&(h.value=await q("sandbox/get-user",_.value.platform,_.value.user),s.value=Oe(h.value))},{immediate:true}),ke(s,async g=>{We(g,h.value)||(await q("sandbox/set-user",_.value.platform,_.value.user,g),h.value=Oe(g))},{deep:true});function u(g){p.value=0,q("sandbox/send-message",_.value.platform,_.value.user,Y.value,g,b.value),b.value=null}async function $(g){await q("sandbox/delete-message",g.platform,g.user,g.channel,g.id),ae.deleteMessage({messageId:g.id,channelId:g.channel})}return(g,A)=>{const L=P("k-icon"),R=P("k-tab-group"),oe=P("el-scrollbar"),ie=P("k-empty"),le=P("k-form"),ne=P("k-content"),F=P("k-layout");return E(),ee(F,{class:"page-sandbox"},{left:K(()=>[j("div",{class:"card-header k-tab-menu-item",onClick:w}," 添加用户 "),j("div",jt,[T(oe,null,{default:K(()=>[T(R,{data:c.value,modelValue:B(_).user,"onUpdate:modelValue":A[0]||(A[0]=N=>B(_).user=N)},{default:K(({name:N})=>[j("div",Lt,X(N[0]),1),j("div",Bt,X(N),1),j("div",{class:"close",onClick:V=>y(N)},[T(L,{name:"times-full"})],8,Et)]),_:1},8,["data","modelValue"])]),_:1})])]),default:K(()=>[j("div",Vt,[(E(true),H(Ae,null,He(B(_t),(N,V)=>(E(),H("span",{key:V,class:Re(["k-horizontal-tab-item",{active:B(_).panelType===V}]),onClick:re=>B(_).panelType=V},X(N),11,It))),128))]),(E(),ee(Pe,null,[d.value.length?B(_).panelType==="profile"?(E(),ee(ne,{key:"profile"+B(Y)},{default:K(()=>[h.value?(E(),ee(le,{key:0,initial:h.value,modelValue:s.value,"onUpdate:modelValue":A[1]||(A[1]=N=>s.value=N),schema:B(o),"show-header":false},null,8,["initial","modelValue","schema"])):pe("v-if",true)]),_:1})):(E(),H(Ae,{key:2},[T(B(Ye),{data:B(_).messages[B(Y)]||[],pinned:""},{default:K(N=>[T(Ot,{data:N},null,8,["data"])]),_:1},8,["data"]),j("div",Ft,[b.value?(E(),H("div",Ut,[j("span",Tt,"正在回复 @"+X(b.value.user),1),T(L,{name:"times-full",onClick:A[2]||(A[2]=N=>b.value=null)})])):pe("v-if",true),T(Mt,{modelValue:a.value,"onUpdate:modelValue":A[3]||(A[3]=N=>a.value=N),onSend:u,onKeydown:f,placeholder:"发送消息到沙盒"},null,8,["modelValue"])])],64)):(E(),ee(ie,{key:"empty"},{default:K(()=>[zt]),_:1}))],1024))]),_:1})}}});const Rt={},Pt={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512"},Kt=j("path",{fill:"currentColor",d:"M437.2 403.5L319.1 215l.0001-135C319.1 71.16 312.8 64 303.1 64S288 71.16 288 79.1L287.1 215c0 5.973 1.672 11.83 4.826 16.9L347.6 320H100.4l54.79-88.1C158.3 226.8 160 220.1 160 215L160 79.1C160 71.16 152.8 64 144 64S128 71.16 128 79.1L128 215l-117.2 188.5C-18.48 450.6 15.27 512 70.89 512h306.2C432.7 512 466.5 450.5 437.2 403.5zM410.9 460C407.6 466 397.6 480 377.1 480H70.89c-20.51 0-30.48-13.95-33.82-19.95c-7.025-12.63-6.691-27.46 .873-39.65L80.48 352h287l42.55 68.41C417.6 432.6 417.1 447.4 410.9 460zM112 32h224C344.8 32 352 24.84 352 16S344.8 0 336 0h-224C103.2 0 96 7.156 96 16S103.2 32 112 32z"},null,-1),qt=[Kt];function Gt(e,t){return E(),H("svg",Pt,qt)}const Wt=_e(Rt,[["render",Gt]]);Ze.register("activity:flask",Wt);const Jt=e=>{e.page({name:"第三方沙盒",path:"/unofficial/sandbox",icon:"activity:flask",order:300,authority:4,component:Ht}),e.menu("uSandbox.message",[{id:".delete",label:"删除消息"},{id:".quote",label:"引用回复"}])};export{Jt as default};
