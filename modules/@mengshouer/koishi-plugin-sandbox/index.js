var E=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var J=Object.prototype.hasOwnProperty;var M=(s,e)=>()=>(s&&(e=s(s=0)),e);var L=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports);var C=(s,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of F(e))!J.call(s,r)&&r!==t&&E(s,r,{get:()=>e[r],enumerable:!(a=A(e,r))||a.enumerable});return s},o=(s,e,t)=>(C(s,e,"default"),t&&C(t,e,"default"));var v=s=>C(E({},"__esModule",{value:!0}),s);import{Buffer as f}from"https://registry.koishi.chat/modules/buffer/index.js";import _ from"https://registry.koishi.chat/modules/process/index.js";var c=M(()=>{});var b={};import*as ye from"https://registry.koishi.chat/modules/koishi/index.js";var O=M(()=>{c();o(b,ye)});var h={};import*as _e from"https://registry.koishi.chat/modules/@koishijs/console/index.js";var T=M(()=>{c();o(h,_e)});import K from"https://registry.koishi.chat/modules/@cordiverse/path/index.js";var D=L((Se,B)=>{c();B.exports=K});var p={};import*as Oe from"https://registry.koishi.chat/modules/file-type/index.js";var G=M(()=>{c();o(p,Oe)});var be=L((Pe,$)=>{c();var X=Object.create,g=Object.defineProperty,H=Object.getOwnPropertyDescriptor,Q=Object.getOwnPropertyNames,V=Object.getPrototypeOf,Y=Object.prototype.hasOwnProperty,Z=(s,e,t)=>e in s?g(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,S=(s,e)=>g(s,"name",{value:e,configurable:!0}),ee=(s,e)=>{for(var t in e)g(s,t,{get:e[t],enumerable:!0})},N=(s,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Q(e))!Y.call(s,r)&&r!==t&&g(s,r,{get:()=>e[r],enumerable:!(a=H(e,r))||a.enumerable});return s},se=(s,e,t)=>(t=s!=null?X(V(s)):{},N(e||!s||!s.__esModule?g(t,"default",{value:s,enumerable:!0}):t,s)),te=s=>N(g({},"__esModule",{value:!0}),s),k=(s,e,t)=>(Z(s,typeof e!="symbol"?e+"":e,t),t),R={};ee(R,{Config:()=>ce,apply:()=>W,filter:()=>oe,inject:()=>ue,name:()=>de});$.exports=te(R);var w=(O(),v(b)),re=(T(),v(h)),I=D(),q=(O(),v(b)),m=(O(),v(b)),ne=se((G(),v(p))),z=class extends m.MessageEncoder{buffer="";rules=Object.fromEntries(["image","audio","video","file"].map(e=>[e,async t=>{if(t.url.startsWith("base64://")){let{mime:a}=await ne.default.fromBuffer(f.from(t.url.slice(9),"base64"));return(0,m.h)(e,{...t,url:`data:${a};base64,${t.url.slice(9)}`})}else if(t.url.startsWith("file:")&&this.bot.ctx.assets)return(0,m.h)(e,{...t,url:await this.bot.ctx.assets.upload(t.url,t.url)});return(0,m.h)(e,t)}]));async flush(){if(!this.buffer.trim())return;let e=await m.h.transformAsync(this.buffer.trim(),this.rules),t=this.bot.session(this.session.event);t.messageId=m.Random.id();for(let a of this.bot.clients)a.send({type:"sandbox/message",body:{content:e,user:"Koishi",channel:t.channelId,id:t.messageId,platform:t.platform}});this.results.push(t.event.message),this.buffer=""}async visit(e){let{type:t,children:a}=e;t==="message"||t==="figure"?(await this.flush(),await this.render(a),await this.flush()):this.buffer+=e.toString()}};S(z,"SandboxMessenger");var ie=z,j=class extends q.Bot{hidden=!0;internal={};clients=new Set;constructor(e,t){super(e,t),this.selfId=t.selfId,this.platform=t.platform,this.user.name="koishi"}async request(e,t={}){let a=[...this.clients][0],r=Math.random().toString(36).slice(2);return new Promise((n,i)=>{let d=this.ctx.on("sandbox/response",(l,x)=>{r===l&&(d(),u(),n(x))}),u=this.ctx.setTimeout(()=>{d(),u(),i(new Error("timeout"))},q.Time.second*5);a.send({type:"sandbox/request",body:{method:e,data:t,nonce:r}})})}async createDirectChannel(e){return{id:"@"+e,type:q.Universal.Channel.Type.DIRECT}}async deleteMessage(e,t){return this.request("deleteMessage",{channelId:e,messageId:t})}async getMessage(e,t){return this.request("getMessage",{channelId:e,messageId:t})}async getChannel(e,t){return this.request("getChannel",{channelId:e,guildId:t})}async getChannelList(e){return this.request("getChannelList",{guildId:e})}async getGuild(e){return this.request("getGuild",{guildId:e})}async getGuildList(){return this.request("getGuildList")}async getGuildMember(e,t){return this.request("getGuildMember",{guildId:e,userId:t})}async getGuildMemberList(e){return this.request("getGuildMemberList",{guildId:e})}};S(j,"SandboxBot");k(j,"MessageEncoder",ie);var U=j,ae={commands:{clear:{description:"清空聊天记录"}}},oe=!1,de="uSandbox",ue=["console"],ce=w.Schema.object({}),P=class extends re.DataService{constructor(e){super(e,"uSandbox")}async get(){let e=await this.ctx.database.select("binding").groupBy("platform",{count:t=>w.$.count(t.pid)}).execute();return Object.fromEntries(e.map(({platform:t,count:a})=>[t,a]))}};S(P,"SandboxService");k(P,"inject",["database"]);var le=P;function W(s,e){s.plugin(le),s.console.addEntry({dev:(0,I.resolve)(import.meta.url,"../client/index.ts"),prod:(0,I.resolve)(import.meta.url,"../dist")});let t={},a=S((r,n)=>{let i=n==="@"+r;return{user:{id:r,name:r},channel:{id:n,type:i?w.Universal.Channel.Type.DIRECT:w.Universal.Channel.Type.TEXT},guild:i?void 0:{id:n},timestamp:Date.now()}},"createEvent");s.console.addListener("sandbox/send-message",async function(r,n,i,d,u){let l=t[r]||(t[r]=new U(s,{platform:r,selfId:"koishi"}));l.clients.add(this);let x=w.Random.id();this.send({type:"sandbox/message",body:{id:x,content:d,user:n,channel:i,platform:r,quote:u}});let y=l.session(a(n,i));y.type="message",y.messageId=x,y.quote=u&&{content:u.content,id:u.id},y.content=d,l.dispatch(y)},{authority:4}),s.console.addListener("sandbox/delete-message",async function(r,n,i,d){let u=t[r]||(t[r]=new U(s,{platform:r,selfId:"koishi"}));u.clients.add(this);let l=u.session(a(n,i));l.type="message-deleted",l.messageId=d,u.dispatch(l)},{authority:4}),s.console.addListener("sandbox/get-user",async function(r,n){if(!s.database)return;let[i]=await s.database.get("binding",{platform:r,pid:n},["aid"]);return i?s.database.getUser(r,n):s.database.createUser(r,n,{authority:1})},{authority:4}),s.console.addListener("sandbox/set-user",async function(r,n,i){if(!s.database)return;let[d]=await s.database.get("binding",{platform:r,pid:n},["aid"]);if(d)i?await s.database.upsert("user",[{id:d.aid,...i}]):(await s.database.remove("user",d.aid),await s.database.remove("binding",{platform:r,pid:n}));else{if(!i)return;await s.database.createUser(r,n,{authority:1,...i})}},{authority:4}),s.console.addListener("sandbox/response",(r,n)=>{s.emit("sandbox/response",r,n)},{authority:4}),s.on("console/connection",async r=>{if(!s.console.clients[r.id])for(let n of Object.keys(t)){let i=t[n];i.clients.delete(r),i.clients.size||(delete t[n],delete s.bots[i.sid])}}),s.i18n.define("zh-CN",ae),s.intersect(r=>r.platform.startsWith("sandbox:")).command("clear").action(({session:r})=>{for(let n of r.bot.clients)n.send({type:"sandbox/clear"})})}S(W,"apply")});export default be();
