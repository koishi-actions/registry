import{ref as y,defineComponent as B,computed as x,openBlock as u,createElementBlock as C,createElementVNode as c,createCommentVNode as D,toDisplayString as b,normalizeClass as P,withModifiers as Q,unref as f,Fragment as E,createVNode as p,withCtx as i,watch as U,resolveComponent as w,createBlock as L,createSlots as R,createTextVNode as W,KeepAlive as X}from"../vue.js";import{receive as F,useMenu as Z,MessageContent as ee,ChatImage as ae,useContext as te,store as h,send as M,VirtualList as A,ChatInput as ne,icons as se}from"../client.js";import{useIntersectionObserver as le}from"../vueuse.js";const S=y({}),$=y({});F("chat/message",({key:s,messages:l,history:n})=>{var r;((r=S.value)[s]||(r[s]=[]))[n?"unshift":"push"](...l)});F("chat/member",({key:s,value:l})=>{$.value[s]?($.value[s].data.push(...l.data),$.value[s].next=l.next):$.value[s]=l});const oe={class:"member-view"},ce={class:"left"},re=["src"],ie={class:"right"},ue=B({__name:"member",props:{data:{}},setup(s){const l=s,n=x(()=>l.data.avatar||l.data.user.avatar),r=x(()=>l.data.name||l.data.user.name);return(N,a)=>(u(),C("div",oe,[c("div",ce,[n.value?(u(),C("img",{key:0,class:"avatar",src:n.value},null,8,re)):D("",true)]),c("div",ie,b(r.value),1)]))}});const z=(s,l)=>{const n=s.__vccOpts||s;for(const[r,N]of l)n[r]=N;return n},de=z(ue,[["__scopeId","data-v-589373c1"]]),he=["src"],me={class:"username"},_e={class:"abstract"},ve={key:1,class:"timestamp"},pe=["src"],fe={class:"header"},ge={class:"username"},Ce={class:"timestamp"},ye=B({__name:"message",props:{data:{},successive:{type:Boolean}},emits:["locate"],setup(s){const l=Z("chat.message");function n(a){return a.length<50?a:a.slice(0,48)+"\u2026\u2026"}function r(a){return Number.isNaN(+a)?"":`${a.getHours()}:${a.getMinutes().toString().padStart(2,"0")}:${a.getSeconds().toString().padStart(2,"0")}`}function N(a){if(Number.isNaN(+a))return"";const m=new Date;let g=r(a);return a.toLocaleDateString()===m.toLocaleDateString()?g:`${a.getFullYear()}-${a.getMonth()+1}-${a.getDate()} ${g}`}return(a,m)=>(u(),C("div",{class:P(["chat-message",{successive:a.successive}]),onContextmenu:m[1]||(m[1]=Q(g=>f(l)(g,a.data),["stop"]))},[a.data.quote?(u(),C("div",{key:0,class:"quote",onClick:m[0]||(m[0]=g=>a.$emit("locate",a.data.quote.messageId))},[a.data.quote.author.avatar?(u(),C("img",{key:0,class:"quote-avatar",src:a.data.quote.author.avatar},null,8,he)):D("",true),c("span",me,b(a.data.quote.author.username),1),c("span",_e,b(n(a.data.quote.abstract)),1)])):D("",true),a.successive?(u(),C("span",ve,b(r(new Date(a.data.timestamp))),1)):(u(),C(E,{key:2},[a.data.avatar?(u(),C("img",{key:0,class:"avatar",src:a.data.avatar},null,8,pe)):D("",true),c("div",fe,[c("span",ge,b(a.data.username),1),c("span",Ce,b(N(new Date(a.data.timestamp))),1)])],64)),p(f(ee),{content:a.data.content},{image:i(({url:g})=>[p(f(ae),{src:g},null,8,["src"])]),_:1},8,["content"])],34))}});const $e=z(ye,[["__scopeId","data-v-a73161fe"]]),ke={class:"search"},Ie={class:"header-title"},be=c("div",{class:"footer-padding"},null,-1),Ne=c("div",{class:"footer-padding"},null,-1),we={class:"card-footer"},Se=c("div",null,"\u8BF7\u5728\u5DE6\u4FA7\u9009\u62E9\u9891\u9053",-1),Ve=B({__name:"chat",setup(s){const l=y(),n=y(""),r=y(""),N=y(null),a=y(null),m=y(""),g=y(""),T=te();T.action("chat.message.delete",{action:({chat:e})=>{}}),T.action("chat.message.quote",{action:({chat:e})=>{}}),U(m,e=>{var t;(t=N.value)==null||t.filter(e)});const K=x(()=>{const e=[],t={};for(const o in h.chat.channels){const[d,_,k]=o.split("/");if(_===k)e.push({id:o,label:h.chat.channels[o].channelName||"\u672A\u77E5\u9891\u9053",data:h.chat.channels[o]});else{let I=t[d+"/"+_];I||e.push(I=t[d+"/"+_]={id:d+"/"+_,label:h.chat.channels[o].guildName||"\u672A\u77E5\u7FA4\u7EC4",children:[]}),I.children.push({id:o,label:h.chat.channels[o].channelName||"\u672A\u77E5\u9891\u9053",data:h.chat.channels[o]})}}return e}),O=x(()=>{const e=h.chat.channels[n.value];if(e)return e.channelId===e.guildId?e.channelName:`${e.guildName} / ${e.channelName}`});function j(e,t){return t.label.includes(m.value)}function G(e){var o,d,_;if(e.children)return;n.value=e.id,r.value=e.data.guildId;const t=(o=S.value)[d=e.id]||(o[d]=[]);t.length<=100&&M("chat/history",{platform:e.data.platform,guildId:e.data.guildId,channelId:e.data.channelId,id:(_=t[0])==null?void 0:_.id})}function H(e){const t=[];return e.id===n.value&&t.push("is-activeChannel"),t.join(" ")}function Y({quoteId:e,userId:t,channelId:o,username:d},_){var I,q;const k=((I=S.value)[q=n.value]||(I[q]=[]))[_-1];return!e&&!!k&&k.userId===t&&k.channelId===o&&k.username===d}function J(e){if(!n.value)return;const[t,o,d]=n.value.split("/");M("chat/send",{content:e,platform:t,channelId:d,guildId:o})}let V=null;return le(a,([{isIntersecting:e}])=>{var t;!e||V||(V=M("chat/history",{platform:h.chat.channels[n.value].platform,guildId:h.chat.channels[n.value].guildId,channelId:h.chat.channels[n.value].channelId,id:(t=S.value[n.value][0])==null?void 0:t.id}),V.then(()=>V=null))}),U(()=>{var e;return(e=h.chat.channels[n.value])==null?void 0:e.guildId},async e=>{e&&($.value[e]=await M("chat/members",h.chat.channels[n.value].platform,e))}),(e,t)=>{const o=w("k-icon"),d=w("el-input"),_=w("el-tree"),k=w("el-scrollbar"),I=w("k-empty"),q=w("k-layout");return u(),L(q,{class:"page-chat"},R({header:i(()=>[W(b(O.value),1)]),left:i(()=>[p(k,null,{default:i(()=>[c("div",ke,[p(d,{modelValue:m.value,"onUpdate:modelValue":t[0]||(t[0]=v=>m.value=v)},{suffix:i(()=>[p(o,{name:"search"})]),_:1},8,["modelValue"])]),p(_,{ref_key:"tree",ref:N,data:K.value,props:{class:H},"filter-node-method":j,"default-expand-all":true,onNodeClick:G},null,8,["data","props"])]),_:1})]),default:i(()=>[(u(),L(X,null,[n.value?(u(),C(E,{key:0},[p(f(A),{class:"messages",data:f(S)[n.value],pinned:"","activeChannel-key":l.value,"onUpdate:activeChannelKey":t[1]||(t[1]=v=>l.value=v),"key-name":"messageId"},{header:i(()=>[c("div",{ref_key:"header",ref:a,class:"header-padding"},null,512)]),default:i(v=>[p($e,{successive:Y(v,v.index),data:v},null,8,["successive","data"])]),footer:i(()=>[Ne]),_:1},8,["data","activeChannel-key"]),c("div",we,[p(f(ne),{modelValue:g.value,"onUpdate:modelValue":t[2]||(t[2]=v=>g.value=v),onSend:J,placeholder:"\u5411\u9891\u9053\u53D1\u9001\u6D88\u606F"},null,8,["modelValue"])])],64)):(u(),L(I,{key:1},{default:i(()=>[Se]),_:1}))],1024))]),_:2},[f($)[r.value]?{name:"right",fn:i(()=>[p(f(A),{class:"members",data:f($)[r.value].data,pinned:"","key-name":"user.id"},{header:i(()=>[c("div",{ref_key:"header",ref:a,class:"header-padding"},[c("div",Ie,"\u6210\u5458\u5217\u8868 ("+b(f($)[r.value].next?"\u52A0\u8F7D\u4E2D":f($)[r.value].data.length)+")",1)],512)]),default:i(v=>[p(de,{data:v},null,8,["data"])]),footer:i(()=>[be]),_:1},8,["data"])]),key:"0"}:void 0]),1024)}}});const qe={},Me={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 640 512"},De=c("path",{fill:"currentColor",d:"M416 176C416 78.8 322.9 0 208 0S0 78.8 0 176c0 41.48 17.07 79.54 45.44 109.6c-15.17 32.34-38.65 58.07-38.95 58.38c-6.514 6.836-8.309 16.91-4.568 25.67C5.754 378.4 14.26 384 23.66 384c54.19 0 97.76-20.73 125.9-39.17C168.1 349.4 187.7 352 208 352C322.9 352 416 273.2 416 176zM208 320c-16.96 0-34.04-2.098-50.75-6.232L143.7 310.4L132 318.1c-20.43 13.38-51.58 28.99-89.85 32.97c9.377-12.11 22.3-30.63 32.24-51.82l9.242-19.71L68.72 263.7C44.7 238.2 32 207.9 32 176C32 96.6 110.1 32 208 32S384 96.6 384 176S305 320 208 320zM606.4 435.4C627.6 407.1 640 372.9 640 336C640 238.8 554 160 448 160c-.3145 0-.6191 .041-.9336 .043C447.5 165.3 448 170.6 448 176c0 5.43-.4668 10.76-.9414 16.09C447.4 192.1 447.7 192 448 192c88.22 0 160 64.6 160 144c0 28.69-9.424 56.45-27.25 80.26l-13.08 17.47l11.49 18.55c6.568 10.61 13.18 19.74 18.61 26.74c-18.26-1.91-36.45-6.625-54.3-14.09l-12.69-5.305l-12.58 5.557C495.9 475 472.3 480 448 480c-75.05 0-137.7-46.91-154.9-109.7c-10.1 3.336-20.5 6.132-31.2 8.271C282.7 455.1 357.1 512 448 512c29.82 0 57.94-6.414 83.12-17.54C555 504.5 583.7 512 616.3 512c9.398 0 17.91-5.57 21.73-14.32c3.74-8.758 1.945-18.84-4.568-25.67C633.3 471.8 619.6 456.8 606.4 435.4z"},null,-1),xe=[De];function Le(s,l){return u(),C("svg",Me,xe)}const Be=z(qe,[["render",Le]]);se.register("activity:comments",Be);const Ae=s=>{s.page({path:"/chat",name:"\u804A\u5929",icon:"activity:comments",authority:3,fields:["chat"],component:Ve,order:100}),s.menu("chat.message",[{id:".delete",label:"\u5220\u9664\u6D88\u606F"},{id:".quote",label:"\u5F15\u7528\u56DE\u590D"}])};export{Ae as default};
