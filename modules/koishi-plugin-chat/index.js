var k=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var D=Object.prototype.hasOwnProperty;var b=(r,s)=>()=>(r&&(s=r(r=0)),s);var L=(r,s)=>()=>(s||r((s={exports:{}}).exports,s),s.exports);var $=(r,s,o,h)=>{if(s&&typeof s=="object"||typeof s=="function")for(let c of B(s))!D.call(r,c)&&c!==o&&k(r,c,{get:()=>s[c],enumerable:!(h=A(s,c))||h.enumerable});return r},i=(r,s,o)=>($(r,s,"default"),o&&$(o,s,"default"));var v=r=>$(k({},"__esModule",{value:!0}),r);import{Buffer as l}from"https://registry.koishi.chat/modules/buffer/index.js";import y from"https://registry.koishi.chat/modules/process/index.js";var a=b(()=>{});var m={};import*as C from"https://registry.koishi.chat/modules/koishi/index.js";var M=b(()=>{a();i(m,C)});import H from"https://registry.koishi.chat/modules/@cordiverse/path/index.js";var j=L((G,S)=>{a();S.exports=H});var g={};import*as X from"https://registry.koishi.chat/modules/@koishijs/plugin-console/index.js";var E=b(()=>{a();i(g,X)});var P=L(w=>{a();Object.defineProperty(w,"__esModule",{value:!0});var f=(M(),v(m)),O=j(),J=(E(),v(g)),N=new f.Logger("chat"),p=class extends J.DataService{config;constructor(s,o){super(s,"chat"),this.config=o;let h=this;s.console.addEntry({dev:(0,O.resolve)(import.meta.url,"../client/index.ts"),prod:(0,O.resolve)(import.meta.url,"../dist")}),s.console.addListener("chat/send",async({content:t,platform:e,channelId:n,guildId:u})=>{let d=`${e}/${u}/${n}`,_=s.messages._channels[d];s.assets&&(t=await s.assets.transform(t)),s.bots[`${e}:${_.data.assignee}`]?.sendMessage(n,t,u)},{authority:4}),s.console.addListener("chat/history",async function({platform:t,channelId:e,guildId:n,id:u}){N.debug("fetching history of %s/%s/%s",t,n,e);let d=await s.messages.channel(t,n,e),_=`${t}/${n}/${e}`,q=await d.getHistory(50,u);for(let W of q)h.transform(W);this.send({type:"chat/message",body:{key:_,messages:q,history:!0}})},{authority:4}),s.console.addListener("chat/members",async function(t,e){return s.messages.guild(t,e).getMembers()}),s.on("chat/update",()=>{this.refresh()}),s.on("chat/message",(t,{data:e})=>{let n=`${e.platform}/${e.guildId}/${e.channelId}`;for(let u of t)this.transform(u);s.console.broadcast("chat/message",{key:n,messages:t},{authority:4})});let{get:c}=s.http;s.router.get("/chat/proxy/:url",async t=>{if(!o.whitelist.some(e=>t.params.url.startsWith(e)))return t.status=403;try{t.body=await c(t.params.url,{responseType:"stream"})}catch(e){if(!f.Quester.isAxiosError(e)||!e.response)throw e;t.status=e.response.status,t.body=e.response.data}})}transform(s){s.content=f.h.transform(s.content,{image:o=>(this.config.whitelist.some(h=>o.url.startsWith(h))&&(o.url="/chat/proxy/"+encodeURIComponent(o.url)),(0,f.h)("image",o))})}async get(){return this.ctx.messages.toJSON()}};(function(r){r.using=["messages","console"],r.Config=f.Schema.object({whitelist:f.Schema.array(String).default(["https://gchat.qpic.cn/","https://c2cpicdw.qpic.cn/"])})})(p||(p={}));w.default=p});export default P();
