var x=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var k=(r,e)=>()=>(r&&(e=r(r=0)),e);var B=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var g=(r,e,a,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of J(e))!R.call(r,t)&&t!==a&&x(r,t,{get:()=>e[t],enumerable:!(o=M(e,t))||o.enumerable});return r},v=(r,e,a)=>(g(r,e,"default"),a&&g(a,e,"default"));var E=r=>g(x({},"__esModule",{value:!0}),r);import{Buffer as w}from"https://registry.koishi.chat/modules/buffer/index.js";import $ from"https://registry.koishi.chat/modules/process/index.js";var m=k(()=>{});var p={};import*as ne from"https://registry.koishi.chat/modules/koishi/index.js";var O=k(()=>{m();v(p,ne)});var Y=B((oe,j)=>{m();var I=Object.defineProperty,F=Object.getOwnPropertyDescriptor,S=Object.getOwnPropertyNames,A=Object.prototype.hasOwnProperty,G=(r,e)=>I(r,"name",{value:e,configurable:!0}),H=(r,e)=>function(){return e||(0,r[S(r)[0]])((e={exports:{}}).exports,e),e.exports},K=(r,e)=>{for(var a in e)I(r,a,{get:e[a],enumerable:!0})},L=(r,e,a,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of S(e))!A.call(r,t)&&t!==a&&I(r,t,{get:()=>e[t],enumerable:!(o=F(e,t))||o.enumerable});return r},Q=r=>L(I({},"__esModule",{value:!0}),r),U=H({"external/common/packages/feedback/src/locales/zh-CN.yml"(r,e){e.exports={commands:{feedback:{description:"发送反馈信息给作者",options:{"receive.true":"添加到反馈频道列表","receive.false":"从反馈频道列表移除"},messages:{"expect-text":"请输入要发送的文本。",receive:`收到来自 {0} 的反馈信息：
{1}`,success:"反馈信息发送成功！",updated:"反馈频道更新成功！","not-modified":"反馈频道没有改动。"}}}}}}),P={};K(P,{Config:()=>W,apply:()=>q,name:()=>X});j.exports=Q(P);var n=(O(),E(p)),V=n.Schema.object({platform:n.Schema.string().required().description("平台名称。"),selfId:n.Schema.string().required().description("机器人 ID。"),channelId:n.Schema.string().required().description("频道 ID。"),guildId:n.Schema.string().description("群组 ID。")}),W=n.Schema.object({receivers:n.Schema.array(V).role("table").hidden().description("反馈接收列表。"),replyTimeout:n.Schema.number().default(n.Time.day).description("反馈回复时限。")}),X="feedback";function q(r,e){r.i18n.define("zh-CN",U());let a=r.logger("feedback"),o={};r.command("feedback <message:text>").userFields(["name","id"]).option("receive","-r",{authority:3,value:!0}).option("receive","-R",{authority:3,value:!1}).action(async({session:t,options:l},u)=>{if(typeof l.receive=="boolean"){let i=e.receivers.findIndex(s=>(0,n.deepEqual)((0,n.pick)(s,["platform","selfId","channelId","guildId"]),(0,n.pick)(t,["platform","selfId","channelId","guildId"])));if(l.receive){if(i>=0)return t.text(".not-modified");e.receivers.push((0,n.pick)(t,["platform","selfId","channelId","guildId"])),a.info(`add receiver ${t.platform}:${t.selfId}:${t.channelId}:${t.guildId}`)}else{if(i<0)return t.text(".not-modified");e.receivers.splice(i,1),a.info(`remove receiver ${t.platform}:${t.selfId}:${t.channelId}:${t.guildId}`)}return r.scope.update(e,!1),t.text(".updated")}if(!u)return t.text(".expect-text");let{username:f,userId:d}=t,C=f===""+d?d:`${f} (${d})`,D=t.text(".receive",[C,u]),h=r.root.config.delay.broadcast,N=[t.sid,t.channelId,t.guildId];for(let i=0;i<e.receivers.length;++i){i&&h&&await(0,n.sleep)(h);let{platform:s,selfId:_,channelId:T,guildId:z}=e.receivers[i],y=r.bots.find(c=>c.platform===s&&c.selfId===_);if(!y){a.warn(`cannot find bot (${s}:${_})`);continue}await y.sendMessage(T,D,z).then(c=>{for(let b of c)o[b]=N,r.setTimeout(()=>delete o[b],e.replyTimeout)},c=>{a.warn(c)})}return t.text(".success")}),r.middleware(async(t,l)=>{let{quote:u,stripped:f}=t;if(!f.content||!u)return l();let d=o[u.id];if(!d)return l();await r.bots[d[0]].sendMessage(d[1],f.content,d[2])})}G(q,"apply")});export default Y();
