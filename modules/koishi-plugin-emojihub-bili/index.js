var ee=Object.defineProperty;var he=Object.getOwnPropertyDescriptor;var we=Object.getOwnPropertyNames;var fe=Object.prototype.hasOwnProperty;var N=(a,e)=>()=>(a&&(e=a(a=0)),e);var K=(a,e)=>()=>(e||a((e={exports:{}}).exports,e),e.exports);var G=(a,e,o,m)=>{if(e&&typeof e=="object"||typeof e=="function")for(let g of we(e))!fe.call(a,g)&&g!==o&&ee(a,g,{get:()=>e[g],enumerable:!(m=he(e,g))||m.enumerable});return a},j=(a,e,o)=>(G(a,e,"default"),o&&G(o,e,"default"));var V=a=>G(ee({},"__esModule",{value:!0}),a);import{Buffer as W}from"https://registry.koishi.chat/modules/buffer/index.js";import T from"https://registry.koishi.chat/modules/process/index.js";var x=N(()=>{});var C={};import*as Qe from"https://registry.koishi.chat/modules/@cordiverse/fs/index.js";var te=N(()=>{x();j(C,Qe)});var B={};import*as Ce from"https://registry.koishi.chat/modules/@cordiverse/url/index.js";var ae=N(()=>{x();j(B,Ce)});import je from"https://registry.koishi.chat/modules/@cordiverse/path/index.js";var ie=K((Fe,re)=>{x();re.exports=je});import Me from"https://registry.koishi.chat/modules/crypto-browserify/index.js";var oe=K((Oe,ne)=>{x();ne.exports=Me});var F={};import*as Ge from"https://registry.koishi.chat/modules/@cordiverse/fs/promises/index.js";var le=N(()=>{x();j(F,Ge)});var H={};import*as Xe from"https://registry.koishi.chat/modules/koishi/index.js";var se=N(()=>{x();j(H,Xe)});var Ie=K(q=>{x();Object.defineProperty(q,"__esModule",{value:!0});q.apply=q.Config=q.usage=q.inject=q.name=void 0;var $=(te(),V(C)),O=(ae(),V(B)),i=ie(),xe=oe(),ke=(le(),V(F)),{Schema:r,Logger:ye,h:R}=(se(),V(H));q.inject={optional:["canvas"]};q.name="emojihub-bili";q.reusable=!0;q.usage=`
<h2><a href="https://www.npmjs.com/package/koishi-plugin-emojihub-bili" target="_blank">如何额外添加自己喜欢的表情包</a></h2>
<p>添加额外的表情包到 <strong>EmojiHub-bili</strong> 中非常简单！只需按照以下步骤操作：</p>
<ol>
<li><strong>安装扩展</strong>：<br>在 Edge 浏览器中添加扩展：<a href="https://greasyfork.org/zh-CN/scripts/456497-bilibili%E4%B8%93%E6%A0%8F%E5%8E%9F%E5%9B%BE%E9%93%BE%E6%8E%A5%E6%8F%90%E5%8F%96" target="_blank">（点击右侧文字查看）Bilibili专栏原图链接提取</a>。</li>
<li><strong>搜索表情包</strong>：<br>开启扩展后，打开<a href="https://search.bilibili.com/article/" target="_blank">哔哩哔哩专栏搜索</a>，在专栏中搜索您需要的表情包。</li>
<li><strong>提取链接</strong>：<br>点击进入具体的某个专栏帖子，屏幕靠近右下角会有一个绿色的【提取链接】按钮。点击该按钮，即可下载包含当前专栏所有图片的 URL 的 txt 文件。</li>
<li><strong>配置 EmojiHub-bili</strong>：<br>将同一类表情包图片的 URL 整合到同一个 txt 文件中。然后，在 Koishi 的配置项中填入相应的指令名称与 txt 文件路径。</li>
<li><strong>保存并重载</strong>：<br>完成配置后，保存您的配置并重载插件，您就可以使用自定义的指令发送表情包啦！🌟📚</li>
</ol>
<p> </p>
<h2>温馨提示：</h2>
<p><br>请勿将自定义的txt文件与本插件放置在同一目录下，以免插件更新导致文件丢失。</p>
<p>目前EmojiHub-bili默认提供<code>40套</code>表情包。若您的配置内容有误差，请点击<code>MoreEmojiHub</code>表格右上角按钮内的<code>恢复默认值</code>。</p>
<p>若开启插件后，指令不出现，<a href="/market?keyword=commands">请重新开关commands插件</a></p>
`;var D=new ye("emojihub-bili"),De=[{command:"本地图库示例",source_url:i.join(import.meta.url,"txts")},{command:"网络图片示例",source_url:"https://i0.hdslb.com/bfs/article/afc31d0e398204d94478473a497028e6352074746.gif"},{command:"2233娘小剧场表情包",source_url:i.join(import.meta.url,"txts/2233娘小剧场.txt")},{command:"acomu414表情包",source_url:i.join(import.meta.url,"txts/acomu414.txt")},{command:"ba表情包",source_url:i.join(import.meta.url,"txts/ba.txt")},{command:"capoo表情包",source_url:i.join(import.meta.url,"txts/capoo.txt")},{command:"chiikawa表情包",source_url:i.join(import.meta.url,"txts/chiikawa.txt")},{command:"downvote表情包",source_url:i.join(import.meta.url,"txts/Downvote.txt")},{command:"doro表情包",source_url:i.join(import.meta.url,"txts/doro.txt")},{command:"eveonecat表情包",source_url:i.join(import.meta.url,"txts/eveonecat.txt")},{command:"fufu表情包",source_url:i.join(import.meta.url,"txts/fufu.txt")},{command:"girlsbandcry",source_url:i.join(import.meta.url,"txts/GirlsBandCry.txt")},{command:"kemomimi表情包",source_url:i.join(import.meta.url,"txts/kemomimi酱表情包.txt")},{command:"koishi-meme表情包",source_url:i.join(import.meta.url,"txts/koimeme.txt")},{command:"mygo表情包",source_url:i.join(import.meta.url,"txts/mygo.txt")},{command:"seseren表情包",source_url:i.join(import.meta.url,"txts/seseren.txt")},{command:"阿夸表情包",source_url:i.join(import.meta.url,"txts/阿夸.txt")},{command:"阿尼亚表情包",source_url:i.join(import.meta.url,"txts/阿尼亚.txt")},{command:"白圣女表情包",source_url:i.join(import.meta.url,"txts/白圣女.txt")},{command:"白圣女漫画表情包",source_url:i.join(import.meta.url,"txts/白圣女黑白.txt")},{command:"柴郡表情包",source_url:i.join(import.meta.url,"txts/柴郡.txt")},{command:"初音Q版表情包",source_url:i.join(import.meta.url,"txts/初音未来Q.txt")},{command:"甘城猫猫表情包",source_url:i.join(import.meta.url,"txts/甘城猫猫.txt")},{command:"孤独摇滚表情包",source_url:i.join(import.meta.url,"txts/孤独摇滚.txt")},{command:"狗妈表情包",source_url:i.join(import.meta.url,"txts/狗妈.txt")},{command:"滑稽表情包",source_url:i.join(import.meta.url,"txts/滑稽.txt")},{command:"疾旋鼬表情包",source_url:i.join(import.meta.url,"txts/疾旋鼬.txt")},{command:"卡拉彼丘表情包",source_url:i.join(import.meta.url,"txts/卡拉彼丘.txt")},{command:"流萤表情包",source_url:i.join(import.meta.url,"txts/流萤.txt")},{command:"龙图表情包",source_url:i.join(import.meta.url,"txts/龙图.txt")},{command:"鹿乃子表情包",source_url:i.join(import.meta.url,"txts/鹿乃子.txt")},{command:"小c表情包",source_url:i.join(import.meta.url,"txts/蜜汁工坊.txt")},{command:"男娘武器库表情包",source_url:i.join(import.meta.url,"txts/男娘武器库.txt")},{command:"千恋万花表情包",source_url:i.join(import.meta.url,"txts/0721.txt")},{command:"赛马娘表情包",source_url:i.join(import.meta.url,"txts/赛马娘.txt")},{command:"瑟莉亚表情包",source_url:i.join(import.meta.url,"txts/瑟莉亚.txt")},{command:"藤田琴音表情包",source_url:i.join(import.meta.url,"txts/藤田琴音.txt")},{command:"小黑子表情包",source_url:i.join(import.meta.url,"txts/小黑子.txt")},{command:"心海表情包",source_url:i.join(import.meta.url,"txts/心海.txt")},{command:"绪山真寻表情包",source_url:i.join(import.meta.url,"txts/绪山真寻.txt")},{command:"亚托莉表情包",source_url:i.join(import.meta.url,"txts/亚托莉表情包.txt")},{command:"永雏小菲表情包",source_url:i.join(import.meta.url,"txts/永雏小菲.txt")},{command:"宇佐紀表情包",source_url:i.join(import.meta.url,"txts/宇佐紀.txt")}];q.Config=r.intersect([r.object({deleteMsg:r.boolean().description("`开启后`自动撤回表情").default(!1),deleteMsgtime:r.number().default(30).description("若干`秒`后 撤回表情"),emojihub_bili_command:r.string().default("emojihub-bili").description("`父级指令`的指令名称").pattern(/^\S+$/),MoreEmojiHub:r.array(r.object({command:r.string().description("注册的指令名称"),source_url:r.string().description("表情包文件地址")})).role("table").description("表情包指令映射 当前默认`40套`txt文件`点击右方按钮 可以恢复到默认值`<br>`表情包文件地址`可以填入`txt文件绝对路径`或者`文件夹绝对路径`或者`图片直链`或者`图片文件绝对路径`").default(De),searchSubfolders:r.boolean().description("是否递归搜索文件夹。`开启后 对于本地文件夹地址 会搜索其子文件夹内全部的图片`").default(!0)}).description("表情包设置"),r.object({autoEmoji:r.boolean().description("进阶设置总开关。打开后，开启自动表情包功能 `达到一定消息数量 自动触发表情包`").default(!1),count:r.number().default(30).description("触发自动表情包的消息数量的阈值。`不建议过低`"),triggerprobability:r.percent().default(.6).description("达到消息数量阈值时，发送表情包的概率 `范围为 0 到 1 `"),groupListmapping:r.array(r.object({groupList:r.string().description("开启自动表情包的群组ID").pattern(/^\S+$/),defaultemojicommand:r.string().description("表情包指令名称 `应与下方指令表格对应`"),enable:r.boolean().description("勾选后 屏蔽该群 的自动表情包")})).role("table").description("表情包指令映射 `注意群组ID不要多空格什么的`").default([{groupList:"114514",defaultemojicommand:"koishi-meme，白圣女表情包，男娘武器库",enable:!1},{groupList:"1919810",defaultemojicommand:"随机emojihub表情包",enable:!0}]),allgroupautoEmoji:r.boolean().description("`全部群组` 开启自动表情包").default(!1),allgroupemojicommand:r.string().role("textarea",{rows:[2,4]}).description("`全部群组的` 表情包指令映射`一行一个指令 或者 逗号分隔`   <br> 可以同时在`groupListmapping`指定群组的表情包内容").default(`宇佐紀表情包
白圣女表情包
白圣女漫画表情包`)}).description("进阶设置"),r.object({json_button_switch:r.boolean().description("`被动json按钮总开关`开启后以生效JSON按钮配置项（json按钮）<br>注意不要与下面的其他模式同时开，优先发送json按钮").default(!1),json_setting:r.object({json_button_mdid_emojilist:r.string().description("展示表情包列表的按钮<br>QQ官方bot 的 JSON按钮模板ID<br>20个群即可使用的按钮！使用方法请见[README](https://www.npmjs.com/package/koishi-plugin-emojihub-bili)").pattern(/^\d+_\d+$/),json_button_mdid_command:r.string().description("触发具体表情后发送的按钮<br>QQ官方bot 的 JSON按钮模板ID<br>20个群即可使用的按钮！使用方法请见[README](https://www.npmjs.com/package/koishi-plugin-emojihub-bili)").pattern(/^\d+_\d+$/)}).collapse().description("实现QQ官方bot `再来一张`和`返回列表`的按钮效果（JSON 按钮）"),MDswitch:r.boolean().description("`被动模板md总开关 `开启后以生效被动md配置项（被动markdown，模板md发送的）").default(!1),markdown_setting:r.object({mdid:r.string().description("QQ官方bot 的 MarkDown模板ID").pattern(/^\d+_\d+$/),zllbmdtext_1:r.string().default("text1").description("`指令列表MD`.`MD参数`MD文字参数--1"),zllbmdtext_2:r.string().default("text2").description("`指令列表MD`.`MD参数`MD文字参数--2"),zllbtext_1:r.array(String).default(["表情包列表","emoji表情列表","表情列表："]).description("`指令列表MD`MD显示文字内容--1`每次从下列随机选一个发送`").role("table"),zllbtext_2:r.array(String).default(["点击按钮即可触发哦~","😻列表如下：点击按钮触发哦！","点击即可查看对应表情哦！😽"]).description("`指令列表MD`MD显示文字内容--2`每次从下列随机选一个发送`").role("table"),zlmdtext_1:r.string().default("text1").description("`指令MD`.`MD参数`MD文字参数--1"),zlmdtext_2:r.string().default("text2").description("`指令MD`.`MD参数`MD文字参数--2"),zltext_1:r.array(String).default(["emoji~😺","表情包！","这是您的表情包~"]).description("`指令MD`MD显示文字内容--1`每次从下列随机选一个发送`").role("table"),zltext_2:r.array(String).default(["邦邦咔邦！","😺😺😺","😽来了哦！"]).description("`指令MD`MD显示文字内容--2`每次从下列随机选一个发送`").role("table"),zlmdp_1:r.string().default("img").description("`指令MD`.`MD参数`MD图片参数--1 `不需要设定图片宽高`"),zlmdp_2:r.string().default("url").description("`指令MD`.`MD参数`MD图片参数--2"),ButtonText1:r.string().default("再来一张😺").description("`指令MD`按钮上`再来一张功能`显示的文字"),ButtonText2:r.string().default("返回列表😽").description("`指令MD`按钮上`返回列表功能`显示的文字"),MinimumBoundary:r.number().default(200).description("`指令MD`过小图片的界限，宽或者高小于这个值就会自动放大到`Magnifymultiple`"),Magnifymultiple:r.number().default(1e3).description("`指令MD`对于过小图片（宽/高小于`MinimumBoundary`）的放大目标的标准，默认放大到1000px"),QQPicToChannelUrl:r.boolean().description("`开启后` 本地图片通过频道URL作为群聊MD的图片链接`须填写下方的 QQchannelId`").experimental().default(!1),QQchannelId:r.string().description("`填入QQ频道的频道ID`，将该ID的频道作为中转频道 <br> 频道ID可以用[inspect插件来查看](/market?keyword=inspect) `频道ID应为纯数字`").experimental().pattern(/^\S+$/)}).collapse().description("实现QQ官方bot `再来一张`和`返回列表`的按钮效果，需要`canvas`服务。<br> [适用本插件的QQ官方bot MD示例模版 可点击这里参考](https://www.npmjs.com/package/koishi-plugin-emojihub-bili)"),RAW_MD_switch:r.boolean().description("`原生md总开关` 开启后以生效原生markdown配置项").default(!1),RAW_MD_setting:r.object({RAW_MD_emojilist_markdown:r.path({filters:[".json",".JSON"]}).description("原生markdown表情包指令列表<br>建议参考原文件，重写该文件").default(i.join(import.meta.url,"qq/raw_markdown/RAW_MD_emojilist_markdown.json")),RAW_MD_command_markdown:r.path({filters:[".json",".JSON"]}).description("原生markdown返回的表情包内容<br>建议参考原文件，重写该文件").default(i.join(import.meta.url,"qq/raw_markdown/RAW_MD_command_markdown.json"))}).collapse().description("实现QQ官方bot `再来一张`和`返回列表`的按钮效果")}).description("QQ官方bot设置"),r.object({LocalSendNetworkPicturesList:r.string().role("textarea",{rows:[2,4]}).description("将`下列指令`对应的内容下载至本地，作为本地图片发送").default().experimental(),deletePictime:r.number().default(10).description("若干`秒`后 删除下载的本地临时文件").experimental(),localPicToBase64:r.boolean().description("`开启后`本地图片以base64发出 `日常使用无需开启，且不建议官方bot使用`").experimental().default(!1),consoleinfo:r.boolean().default(!1).description("日志调试模式`日常使用无需开启`")}).description("调试选项"),r.union([r.object({consoleinfo:r.const(!0).required(),allfileinfo:r.boolean().description("输出allfile调试内容`MoreEmojiHub 列表详细内容`")}),r.object({})])]);async function qe(a,e,o,m,g,h){async function u(E){let{access_token:l,expires_in:p}=await a.http.post("https://bots.qq.com/app/getAppAccessToken",{appId:E.appId,clientSecret:E.secret});E.token=l,a.setTimeout(()=>u(E),(p-30)*1e3)}let b={appId:m,secret:g,channelId:h};await u(b),typeof o=="string"&&(new URL(o).protocol==="file:"?o=await ke.readFile(O.fileURLToPath(o)):(o=await a.http.get(o,{responseType:"arraybuffer"}),o=W.from(o)));let _=new FormData;_.append("msg_id","0"),_.append("file_image",new Blob([o],{type:"image/png"}),"image.jpg"),await a.http.post(`https://api.sgroup.qq.com/channels/${b.channelId}/messages`,_,{headers:{Authorization:`QQBot ${b.token}`,"X-Union-Appid":b.appId}});let f=xe.createHash("md5").update(o).digest("hex").toUpperCase();return h!==void 0&&e&&D.info(`使用本地图片*QQ频道  发送URL为： https://gchat.qpic.cn/qmeetpic/0/0-0-${f}/0`),{url:`https://gchat.qpic.cn/qmeetpic/0/0-0-${f}/0`}}async function X(a){try{return $.readFileSync(a).toString("base64")}catch(e){return D.error("Error converting image to base64:",e),null}}async function me(a,e,o,m,g,h=null){if(a.startsWith("http://")||a.startsWith("https://"))return z(e,o,m,`直接的图片链接: ${a}`),{imageUrl:a,isLocal:!1};if(de(a))return $.existsSync(a)?(z(e,o,m,`本地图片的绝对路径: ${a}`),{imageUrl:a,isLocal:!0}):(S(`错误:路径不存在： ${a}`),{imageUrl:null,isLocal:!1});if(ue(a))return await _e(a,e,o,m,g,h);if(ce(a))return await pe(a,e,o,m,g);let u=Le(e);if(e.consoleinfo&&e.allfileinfo&&D.info(u),u.length>0)a=u[Math.floor(Math.random()*u.length)];else return{imageUrl:null,isLocal:!1};if(a.startsWith("http://")||a.startsWith("https://"))return z(e,o,m,`随机选择的网络图片链接: ${a}`),{imageUrl:a,isLocal:!1};if(ue(a))return await _e(a,e,o,m,g,h);if(ce(a))return await pe(a,e,o,m,g);if(de(a))return z(e,o,m,`随机选择的本地图片路径: ${a}`),{imageUrl:a,isLocal:!0}}function $e(a){let e=a.MoreEmojiHub.map(o=>o.command);return e.length>0?e[Math.floor(Math.random()*e.length)]:null}function de(a){return i.isAbsolute(a)&&(a.endsWith(".jpg")||a.endsWith(".png")||a.endsWith(".gif")||a.endsWith(".bmp")||a.endsWith(".webp"))}function ue(a){return i.isAbsolute(a)&&$.lstatSync(a).isDirectory()}function ce(a){return i.isAbsolute(a)&&a.endsWith(".txt")}function Le(a){return a.MoreEmojiHub.filter(e=>{let o=e.source_url;return i.isAbsolute(o)||o.startsWith("http://")||o.startsWith("https://")}).map(e=>e.source_url)}function ge(a,e=[]){return $.readdirSync(a).forEach(m=>{let g=i.join(a,m);$.statSync(g).isDirectory()?e=ge(g,e):e.push(g)}),e}async function _e(a,e,o,m,g,h){if(!$.existsSync(a))return S(`错误:路径不存在： ${a}`),{imageUrl:null,isLocal:!1};let u=e.searchSubfolders?ge(a):$.readdirSync(a).map(_=>i.join(a,_));if(u=u.filter(_=>_.endsWith(".jpg")||_.endsWith(".png")||_.endsWith(".gif")||_.endsWith(".bmp")||_.endsWith(".webp")),u.length===0)return S("文件夹中未找到有效图片文件（jpg,png,gif,webp,bmp）"),{imageUrl:null,isLocal:!1};if(h){let _=h.toLowerCase();if(u=u.filter(f=>i.basename(f).toLowerCase().includes(_)),u.length===0)return S(`未找到匹配关键词 "${h}" 的图片文件`),{imageUrl:null,isLocal:!1}}e.consoleinfo&&e.allfileinfo&&D.info(`文件夹 ${a} 下的所有文件: 
${u.join(`
`)}`);let b=u[Math.floor(Math.random()*u.length)];return z(e,o,m,`使用文件夹 ${a} 发送本地图片为 ${b}`),{imageUrl:b,isLocal:!0}}async function pe(a,e,o,m,g){let h,u;try{h=$.readFileSync(a,"utf8").split(`
`).filter(l=>l.trim()!=="")}catch(l){return l instanceof Error&&l.code==="ENOENT"?{imageUrl:null,isLocal:!1}:(S(l),{imageUrl:null,isLocal:!1})}if(h.length===0)return S(`错误！无有效URL可用：${a}`),{imageUrl:null,isLocal:!1};let b=Math.floor(Math.random()*h.length),_=h[b].trim(),f="https:",E="https://i0.hdslb.com/bfs/";if(_.startsWith(f+E)&&(_=_.replace(f,"")),!_.startsWith("https://")&&!_.startsWith("http://")&&(_=(a.includes("koimeme.txt")?"https://memes.none.bot/meme/":E)+_),u=_.trim(),e.LocalSendNetworkPicturesList&&e.LocalSendNetworkPicturesList.length>0){let l=e.LocalSendNetworkPicturesList.split(/\n|,|，/).map(t=>t.trim().toLowerCase()),p=m.toLowerCase();if(l.includes(p)){let t=i.join(import.meta.url,`${Date.now()}.png`);try{return u=await ve(_,t,g),setTimeout(()=>{$.unlinkSync(u),z(e,null,null,`临时文件已删除：${u}`)},e.deletePictime*1e3),z(e,o,m,`下载并发送本地图片: ${u}`),{imageUrl:u,isLocal:!0}}catch(s){return S(`图片下载失败：${s.message}`),{imageUrl:null,isLocal:!1}}}}return z(e,o,m,`使用文件 ${a} 发送URL为 ${u}`),{imageUrl:u,isLocal:!1}}async function ve(a,e,o){try{let m=await o.http.get(a,{responseType:"arraybuffer"}),g=W.from(m);return await $.promises.writeFile(e,g),e}catch(m){throw S(`下载图片失败: ${m.message}`),m}}function z(a,e,o,m){a.consoleinfo&&(e?D.info(`
${e} 触发表情包
使用指令： ${o}
${m}`):D.info(m))}function S(a){D.error(a)}function Ue(a){let e=a.MoreEmojiHub.map(o=>o.command);return e.length===0&&D.error("未找到任何表情包指令。"),e}function Ee(a,e){let o=e.emojihub_bili_command;function m(l){return{commands:{[l]:{description:`${l}表情包功能`,messages:{notfound_txt:"ERROR！找不到文件或文件为空！指令：",List_of_emojis:"表情包列表："}},再来一张:{description:"指定表情包",messages:{nocommand:`请输入一个表情包名称哦~
➣例如： 再来一张 白圣女表情包`}}}}}var g=m(o);a.i18n.define("zh-CN",g);let h={};function u(l,p){h[l]=p,b("记录到command为： "+p+" 在频道： "+l)}function b(l){e.consoleinfo&&D.info(l)}function _(l,p){if(e.MDswitch&&!e.RAW_MD_switch){let t=e.markdown_setting.mdid,s=e.markdown_setting.zllbmdtext_1,n=e.markdown_setting.zllbmdtext_2,d=e.markdown_setting.zllbtext_1,c=e.markdown_setting.zllbtext_2,w=d[Math.floor(Math.random()*d.length)],k=c[Math.floor(Math.random()*c.length)],M=[],y=[],I=[],v=[],J=[],A=[M,y,I,v,J,[]],L=0,U=0;for(let Q=0;Q<p.length;Q++)A[L].push({render_data:{label:p[Q],style:1},action:{type:2,permission:{type:2},data:`/${p[Q]}`,enter:!0}}),U++,U===4&&(L++,U=0,L===A.length&&(L=0));return{msg_type:2,msg_id:l.messageId,markdown:{custom_template_id:t,params:[{key:s,values:[w]},{key:n,values:[k]}]},keyboard:{content:{rows:[{buttons:M},{buttons:y},{buttons:I},{buttons:v},{buttons:J}]}}}}if(e.RAW_MD_switch&&!e.MDswitch)try{let t=e.RAW_MD_setting.RAW_MD_emojilist_markdown,n=$.readFileSync(t,"utf-8").replace(/\$\{session\.messageId\}/g,l.messageId),d=JSON.parse(n);return b(d),d}catch(t){return b(`解析 RAW_MD_emojilist_markdown 出错: ${t}`),null}}async function f(l,p,t){if(e.MDswitch&&!e.RAW_MD_switch){let s=e.markdown_setting.mdid,n=e.markdown_setting.zlmdp_1,d=e.markdown_setting.zlmdp_2,c=e.markdown_setting.zltext_1,w=e.markdown_setting.zltext_2,k=c[Math.floor(Math.random()*c.length)],M=w[Math.floor(Math.random()*w.length)],y=e.markdown_setting.zlmdtext_1,I=e.markdown_setting.zlmdtext_2,v=e.markdown_setting.ButtonText1,J=e.markdown_setting.ButtonText2,Y=e.emojihub_bili_command,A=await a.canvas.loadImage(t),L=A.naturalWidth||A.width,U=A.naturalHeight||A.height,Q=e.markdown_setting.MinimumBoundary,be=e.markdown_setting.Magnifymultiple;if(L<Q||U<Q){let P=be/Math.min(L,U);L=Math.round(L*P),U=Math.round(U*P),b(`宽度放大到了 ${L} 高度放大到了 ${U}`)}let Z={msg_type:2,msg_id:l.messageId,markdown:{custom_template_id:s,params:[{key:y,values:[k]},{key:I,values:[M]},{key:n,values:[`![img#${L}px #${U}px]`]},{key:d,values:[`(${t})`]}]},keyboard:{content:{rows:[{buttons:[{render_data:{label:`${v}`,style:2},action:{type:2,permission:{type:2},data:`/${p}`,enter:!0}},{render_data:{label:`${J}`,style:2},action:{type:2,permission:{type:2},data:`/${Y}`,enter:!0}}]}]}}};return b(Z),Z}if(e.RAW_MD_switch&&!e.MDswitch){let s=await a.canvas.loadImage(t),n=s.naturalWidth||s.width,d=s.naturalHeight||s.height,c=e.markdown_setting.MinimumBoundary,w=e.markdown_setting.Magnifymultiple;if(n<c||d<c){let k=w/Math.min(n,d);n=Math.round(n*k),d=Math.round(d*k),b(`宽度放大到了 ${n} 高度放大到了 ${d}`)}try{let k=e.RAW_MD_setting.RAW_MD_command_markdown,y=$.readFileSync(k,"utf-8").replace(/\$\{session\.messageId\}/g,l.messageId).replace(/\$\{imageurl\}/g,t).replace(/\$\{originalWidth\}/g,n).replace(/\$\{originalHeight\}/g,d).replace(/\$\{command\}/g,p).replace(/\$\{config\.emojihub_bili_command\}/g,e.emojihub_bili_command),I=JSON.parse(y);return b(I),I}catch(k){return b(`解析 RAW_MD_command_markdown 出错: ${k}`),null}}}let E=[];if(e.MoreEmojiHub.forEach(({command:l,source_url:p})=>{E.push(l),a.command(e.emojihub_bili_command).usage("emojihub父级指令 触发后列出全部的子指令!").action(async({session:t})=>{let s=Ue(e);if(b("指令列表txtCommandList：  "+s),e.json_button_switch&&e.json_setting.json_button_mdid_emojilist){let n={msg_id:t.event.message.id,msg_type:2,content:"",keyboard:{id:e.json_setting.json_button_mdid_emojilist}};t.event.guild?.id?await t.qq.sendMessage(t.channelId,n):await t.qq.sendPrivateMessage(t.event.user?.id,n)}else if(e.MDswitch&&e.markdown_setting.mdid&&e.markdown_setting.zlmdp_1&&e.markdown_setting.zlmdp_2&&t.platform==="qq"||e.RAW_MD_switch){let n=_(t,s);t.event.guild?.id?await t.qq.sendMessage(t.channelId,n):await t.qq.sendPrivateMessage(t.event.user?.id,n)}else{let n=s.join(`
`);await t.send(R.text(t.text(`commands.${o}.messages.List_of_emojis`)+`
`+n))}}),a.command(`${e.emojihub_bili_command}/${l} <local_picture_name:text>`).action(async({session:t},s)=>{let n=await me(p,e,t.channelId,l,a,s);if(!n.imageUrl){await t.send(R.text(t.text(`commands.${o}.messages.notfound_txt`)+l));return}u(t.channelId,l);try{let d;if(e.MDswitch&&e.markdown_setting.mdid&&e.markdown_setting.zlmdp_1&&e.markdown_setting.zlmdp_2&&t.platform==="qq"||e.RAW_MD_switch)if(n.isLocal)if(e.localPicToBase64){let w="data:image/png;base64,"+await X(n.imageUrl);t.event.guild?.id?d=t.qq.sendMessage(t.channelId,await f(t,l,w)):d=t.qq.sendPrivateMessage(t.event.user?.id,await f(t,l,w))}else if(e.markdown_setting.QQPicToChannelUrl){let c=await qe(a,e.consoleinfo,O.pathToFileURL(n.imageUrl).href,t.bot.config.id,t.bot.config.secret,e.markdown_setting.QQchannelId);t.event.guild?.id?d=t.qq.sendMessage(t.channelId,await f(t,l,c.url)):d=t.qq.sendPrivateMessage(t.event.user?.id,await f(t,l,c.url))}else{let c=O.pathToFileURL(n.imageUrl).href;t.event.guild?.id?d=t.qq.sendMessage(t.channelId,await f(t,l,c)):d=t.qq.sendPrivateMessage(t.event.user?.id,await f(t,l,c))}else t.event.guild?.id?d=t.qq.sendMessage(t.channelId,await f(t,l,n.imageUrl)):d=t.qq.sendPrivateMessage(t.event.user?.id,await f(t,l,n.imageUrl));else if(n.isLocal)if(e.localPicToBase64){let c=await X(n.imageUrl);if(d=await t.send(R("image",{url:"data:image/png;base64,"+c})),e.json_button_switch&&e.json_setting.json_button_mdid_command&&t.platform==="qq"){let w={msg_id:t.event.message.id,msg_type:2,content:"",keyboard:{id:e.json_setting.json_button_mdid_command}};t.event.guild?.id?await t.qq.sendMessage(t.channelId,w):await t.qq.sendPrivateMessage(t.event.user?.id,w)}}else{let c=O.pathToFileURL(n.imageUrl).href;if(d=await t.send(R.image(c)),e.json_button_switch&&e.json_setting.json_button_mdid_command&&t.platform==="qq"){let w={msg_id:t.event.message.id,msg_type:2,content:"",keyboard:{id:e.json_setting.json_button_mdid_command}};t.event.guild?.id?await t.qq.sendMessage(t.channelId,w):await t.qq.sendPrivateMessage(t.event.user?.id,w)}}else if(d=await t.send(R.image(n.imageUrl)),e.json_button_switch&&e.json_setting.json_button_mdid_command&&t.platform==="qq"){let c={msg_id:t.event.message.id,msg_type:2,content:"",keyboard:{id:e.json_setting.json_button_mdid_command}};t.event.guild?.id?await t.qq.sendMessage(t.channelId,c):await t.qq.sendPrivateMessage(t.event.user?.id,c)}e.deleteMsg&&e.deleteMsgtime>0&&setTimeout(async()=>{try{await t.bot.deleteMessage(t.channelId,d)}catch(c){D.error(`撤回消息失败: ${c}`)}},e.deleteMsgtime*1e3)}catch(d){D.error(`Error sending image:  ${d}`)}}),a.command(`${e.emojihub_bili_command}/再来一张`).action(async({session:t})=>{let s=h[t.channelId];b("尝试在频道 "+t.channelId+" 中执行最后一个命令： "+s),s?await t.execute(`${s}`):await t.send("没有找到上一个命令，请先执行一个命令！")}),a.command(`${e.emojihub_bili_command}/随机表情包`).action(async({session:t})=>{let s=$e(e);if(s){await t.execute(s),z(e,t.channelId,s,"随机表情包");return}else await t.send("没有任何表情包配置，请检查插件配置项")})}),e.autoEmoji&&(e.groupListmapping.length||e.allgroupautoEmoji)){let l={};e.groupListmapping.forEach(({groupList:p,defaultemojicommand:t,enable:s})=>{s===!1?l[p]={count:0,emojicommand:t}:l[p]={blacklisted:!0}}),a.middleware(async(p,t)=>{let s=p.channelId,n=l[s];if(n&&n.blacklisted)return t();if(!n&&e.allgroupautoEmoji&&(n={count:0,emojicommand:e.allgroupemojicommand},(!l[s]||!l[s].blacklisted)&&(l[s]=n)),!n&&e.allgroupautoEmoji&&(n={count:0,emojicommand:e.allgroupemojicommand},l[s]=n),n&&(n.count++,n.count>=e.count))if(Math.random()<=e.triggerprobability){let c=n.emojicommand.split(/\n|,|，/).map(M=>M.trim()),w=c[Math.floor(Math.random()*c.length)],k=e.MoreEmojiHub.find(({command:M})=>M===w);if(k){let M=await me(k.source_url,e,s,k.command,a);if(M.imageUrl)try{n.count=0;let y;if(M.isLocal)if(e.localPicToBase64){let v=await X(M.imageUrl);y=R("image",{url:"data:image/png;base64,"+v})}else{let v=O.pathToFileURL(M.imageUrl).href;y=R.image(v)}else y=R.image(M.imageUrl);let I=await p.send(y);e.deleteMsg&&e.deleteMsgtime>0&&setTimeout(async()=>{try{await p.bot.deleteMessage(p.channelId,I)}catch(v){D.error(`撤回消息失败: ${v}`)}},e.deleteMsgtime*1e3)}catch(y){D.error(`发送图片错误: ${y}`)}else n.count=0}}else n.count=0;return t()},!0)}}q.apply=Ee});export default Ie();
