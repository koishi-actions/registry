var V=Object.defineProperty;var ie=Object.getOwnPropertyDescriptor;var ne=Object.getOwnPropertyNames;var le=Object.prototype.hasOwnProperty;var D=(e,n)=>()=>(e&&(n=e(e=0)),n);var G=(e,n)=>()=>(n||e((n={exports:{}}).exports,n),n.exports);var Y=(e,n,f,r)=>{if(n&&typeof n=="object"||typeof n=="function")for(let t of ne(n))!le.call(e,t)&&t!==f&&V(e,t,{get:()=>n[t],enumerable:!(r=ie(n,t))||r.enumerable});return e},S=(e,n,f)=>(Y(e,n,"default"),f&&Y(f,n,"default"));var q=e=>Y(V({},"__esModule",{value:!0}),e);import{Buffer as $}from"https://registry.koishi.chat/modules/buffer/index.js";import U from"https://registry.koishi.chat/modules/process/index.js";var O=D(()=>{});var H={};import*as Pe from"https://registry.koishi.chat/modules/koishi/index.js";var F=D(()=>{O();S(H,Pe)});var A={};import*as He from"https://registry.koishi.chat/modules/@cordiverse/fs/index.js";var J=D(()=>{O();S(A,He)});import de from"https://registry.koishi.chat/modules/@cordiverse/path/index.js";var z=G((Ae,R)=>{O();R.exports=de});var _e=G(($e,re)=>{O();var me=Object.create,N=Object.defineProperty,oe=Object.getOwnPropertyDescriptor,K=Object.getOwnPropertyNames,ue=Object.getPrototypeOf,se=Object.prototype.hasOwnProperty,b=(e,n)=>N(e,"name",{value:n,configurable:!0}),Q=(e,n)=>function(){return n||(0,e[K(e)[0]])((n={exports:{}}).exports,n),n.exports},fe=(e,n)=>{for(var f in n)N(e,f,{get:n[f],enumerable:!0})},W=(e,n,f,r)=>{if(n&&typeof n=="object"||typeof n=="function")for(let t of K(n))!se.call(e,t)&&t!==f&&N(e,t,{get:()=>n[t],enumerable:!(r=oe(n,t))||r.enumerable});return e},X=(e,n,f)=>(f=e!=null?me(ue(e)):{},W(n||!e||!e.__esModule?N(f,"default",{value:e,enumerable:!0}):f,e)),pe=e=>W(N({},"__esModule",{value:!0}),e),ce=Q({"src/main.json"(e,n){n.exports={name:"Stardew_Valley",id:0,version:"1.0.6",description:"koishi星露谷物语插件主要内容文件",main:[{name:"土豆",id:0,description:"土豆作物",main:{type:"crop",main:{level:0,growthTime:144e5,harvestOutput:{max:3,min:1,output:[{id:"0:0",max:2,min:1,probability:1},{id:"0:2",max:1,min:0,probability:.2}]}}},price:{can:!0,sell:2,buy:3}},{name:"普通农场",id:1,description:"非常tm普通的农场",main:{type:"building",main:{type:"farm",level:0,max:15}},price:{can:!0,sell:100,buy:1e3}},{name:"毒土豆",id:2,description:"毒性很强的土豆，不能再次种植",main:{type:"output"},price:{can:!1,sell:1}}]}}}),ge=Q({"package.json"(e,n){n.exports={name:"koishi-plugin-stardew-valley",description:"星露谷物语，启动！",version:"1.0.9",main:"lib/index.js",typings:"lib/index.d.ts",files:["lib","dist","src"],license:"MIT",keywords:["chatbot","koishi","plugin"],peerDependencies:{koishi:"^4.17.6"},koishi:{service:{required:["cron","database","idconverter","monetary"],implements:["StardewValleyAPI"]},browser:!0},homepage:"https://forum.koishi.xyz/t/topic/8130",repository:{type:"git",url:"git+https://github.com/ACAlexChen/stardew-valley.git"},bugs:{url:"https://github.com/ACAlexChen/stardew-valley/issues"}}}}),Z={};fe(Z,{Config:()=>be,apply:()=>ae,inject:()=>he,name:()=>we});re.exports=pe(Z);var B=(F(),q(H)),Te=(F(),q(H));function C(e,n){function f(d){let o={};for(let p of d)p in o?o[p]++:o[p]=1;let c=[];for(let p in o)o[p]>1?c.push(`${p}x${o[p]}`):c.push(p);return c.join("、")}b(f,"ListTOString");function r(d){let o=parseInt(d.split(":")[0]),c=parseInt(d.split(":")[1]);return{modId:o,itemId:c}}b(r,"universalIdTOmodId");function t(d,o){return`${d}:${o}`}b(t,"modIdTOuniversalId");function a(d){if(d){if(typeof d=="number")return d;if(typeof d=="string")return parseInt(d)}else return 1}b(a,"numberYES");function i(d){let o=[];return n.main.forEach(async(c,p)=>{c.main.find(h=>h.name===d)&&o.push(p)}),o}b(i,"modsfind");function m(d){let o=i(d);if(o.length===1)return n.main[o[0]].id+":"+n.main[o[0]].main.find(c=>c.name===d).id;if(o.length===0)return e.logger.error("没有找到该物品"),"Error: 没有找到该物品";e.logger.error("该物品被多个mod声明，请检查你的mod")}b(m,"findId");function l(d){let o=parseInt(d.split(":")[0]),c=parseInt(d.split(":")[1]);return n.main[o].main.find(g=>g.id===c).name}b(l,"findName");function s(d){let o=i(d);if(o.length===1)return n.main[o[0]].main.find(c=>c.name===d);e.logger.error("该物品被多个mod声明，请检查你的mod")}b(s,"inModfind");async function u(d,o,c,p){let g=await e.idconverter.getUserAid(o,c),h=m(d);if(h==="Error: 没有找到该物品")return h;let T=s(d),k=(await e.database.get("stardew_valley",{id:g},["item","building"]))[0];if(!k)T.main.type==="building"?await e.database.create("stardew_valley",{id:g,item:{main:[]},building:{main:[{itemId:h,number:a(p)}]}}):await e.database.create("stardew_valley",{id:g,item:{main:[{itemId:h,number:a(p)}]},building:{main:[]}});else if(T.main.type==="building"){let y=k.building,w=[];y.main.forEach((P,j)=>{P.itemId===h&&w.push(j)}),w.length===0?(y.main.push({itemId:h,number:a(p)}),await e.database.set("stardew_valley",{id:g},{building:y})):w.length===1?(y.main[w[0]].number+=a(p),await e.database.set("stardew_valley",{id:g},{building:y})):e.logger.error("拥有物品id重复")}else{let y=k.item,w=[];y.main.forEach((P,j)=>{P.itemId===h&&w.push(j)}),w.length===0?(y.main.push({itemId:h,number:a(p)}),await e.database.set("stardew_valley",{id:g},{item:y})):w.length===1?(y.main[w[0]].number+=a(p),await e.database.set("stardew_valley",{id:g},{item:y})):e.logger.error("拥有物品id重复")}}b(u,"addItem");async function I(d,o,c,p){let g=await e.idconverter.getUserAid(o,c),h=m(d);if(h==="Error: 没有找到该物品")return h;let T=s(d),k=(await e.database.get("stardew_valley",{id:g},["item","building"]))[0];if(k.item.main.length===0&&k.building.main.length===0)return"Error: 你没有任何物品";if(T.main.type==="building"){let y=k.building,w=[];if(y.main.forEach((P,j)=>{P.itemId===h&&w.push(j)}),w.length===0)return"Error: 你没有该建筑";if(w.length===1){if(y.main[w[0]].number<a(p))return"Error: 你没有足够的该建筑";y.main[w[0]].number-=a(p),y.main[w[0]].number===0&&y.main.splice(w[0],1),await e.database.set("stardew_valley",{id:g},{building:y})}else e.logger.error("拥有物品id重复")}else{let y=k.item,w=[];if(y.main.forEach((P,j)=>{P.itemId===h&&w.push(j)}),w.length===0)return"Error: 你没有该物品";if(w.length===1){if(y.main[w[0]].number<a(p))return"Error: 你没有足够的该物品";y.main[w[0]].number-=a(p),y.main[w[0]].number===0&&y.main.splice(w[0],1),await e.database.set("stardew_valley",{id:g},{item:y})}else e.logger.error("拥有物品id重复")}}b(I,"removeItem");function E(d){return d===1?!0:Math.random()<d}b(E,"probabilityFunction");function v(d,o){return Math.floor(Math.random()*(d-o+1))+o}b(v,"getRandomValue");async function _(d,o){let c=await e.idconverter.getUserAid(d,o),p=await e.database.get("stardew_valley",{id:c}),g={item:null,buidling:null};if(p.length===0)return await e.database.create("stardew_valley",{id:c,item:{main:[]},building:{main:[{itemId:"0:1",number:1}]}}),"检测到你是第一次玩此游戏，系统已赠与你一个普通农场";let h=p[0];h.item?g.item=h.item:g.item={main:[]},h.building?g.buidling=h.building:g.buidling={main:[]},await e.database.set("stardew_valley",{id:c},{item:g.item,building:g.buidling})}return b(_,"checkPlayerHaveItem"),{ListTOString:f,universalIdTOmodId:r,modIdTOuniversalId:t,numberYES:a,modsfind:i,findId:m,findName:l,inModfind:s,addItem:u,removeItem:I,probabilityFunction:E,getRandomValue:v,checkPlayerHaveItem:_}}b(C,"modfunction");function x(e,n,f){ee(e,n,f);var r=C(e,f);f.main.forEach(t=>{t.main.forEach(a=>{a.type==="instantaneousEvents"&&a.main.listener.map(i=>i.listenername).includes("stardew-valley/plant")&&e.on("stardew-valley/plant",(i,m)=>{r.probabilityFunction(a.main.probability)===!0&&(m.send(a.main.message),a.main.action.forEach(l=>{l.includes("crop")&&e.emit(l,{cropid:i.cropid,number:1},m)}))})})})}b(x,"events");function ee(e,n,f){var r=C(e,f);e.on("stardew-valley/plugin-loaded",()=>{e.setTimeout(()=>{e.emit("stardew-valley/plugin-return-mods",f)},1e3)}),e.on("stardew-valley/action-add-item",(t,a)=>{r.checkPlayerHaveItem(a.userId,a.platform),r.addItem(r.findName(t.itemid),a.userId,a.platform,t.number)}),e.on("stardew-valley/action-add-crop",async(t,a)=>{r.checkPlayerHaveItem(a.userId,a.platform);let i=await e.database.get("stardew_valley_crop",{owner_id:await e.idconverter.getUserAid(a.userId,a.platform)}),m=await e.database.get("stardew_valley",{id:await e.idconverter.getUserAid(a.userId,a.platform)},["building.main"]),l=0;if(m.forEach(s=>{s.building.main.forEach(u=>{u.type==="farm"&&(l+=u.max)})}),i.length<l)for(let s=0;s<l-i.length&&s<t.number;s++)await e.database.create("stardew_valley_crop",{id:Math.max(...i.map(u=>u.id))+1,owner_id:await e.idconverter.getUserAid(a.userId,a.platform),crop_id:t.cropid})})}b(ee,"action");function te(e,n,f){var r=C(e,f);e.command("stardew-valley.购买 [name] [number]").action(async({session:t},a,i)=>{let m=await r.checkPlayerHaveItem(t.userId,t.platform);if(m==="检测到你是第一次玩此游戏，系统已赠与你一个普通农场"&&t.send(m),a){let l=r.inModfind(a);if(l){if(l.price.can===!1)return"该物品无法购买";try{return await e.monetary.cost(await e.idconverter.getUserAid(t.userId,t.platform),l.price.buy*r.numberYES(i)),await r.addItem(a,t.userId,t.platform,r.numberYES(i)),e.emit("stardew-valley/buy",{name:a,number:r.numberYES(i),playerpid:t.userId,platform:t.platform}),e.emit("stardew-valley/delay-buy",{name:a,number:r.numberYES(i),playerpid:t.userId,platform:t.platform}),"购买成功"}catch(s){return e.logger.error(s),"余额不足"}}else return"没有找到该物品"}else return"请输入物品名称"}),e.command("stardew-valley.卖出 [name] [number]").action(async({session:t},a,i)=>{let m=await r.checkPlayerHaveItem(t.userId,t.platform);if(m==="检测到你是第一次玩此游戏，系统已赠与你一个普通农场"&&t.send(m),a){let l=r.inModfind(a);if(l){let s=await r.removeItem(a,t.userId,t.platform,r.numberYES(i));if(s==="Error: 你没有足够的该物品")return s;try{return await e.monetary.gain(await e.idconverter.getUserAid(t.userId,t.platform),l.price.sell*r.numberYES(i)),"成功卖出"}catch(u){return e.logger.error(u),u}}else return"没有找到该物品"}else return"请输入物品名称"}),e.command("stardew-valley.种植 [name] [number]").action(async({session:t},a,i)=>{let m=await r.checkPlayerHaveItem(t.userId,t.platform);if(m==="检测到你是第一次玩此游戏，系统已赠与你一个普通农场"&&t.send(m),a){let l=r.inModfind(a);if(l){let s=l.main.main,u=(await e.database.get("stardew_valley",{id:await e.idconverter.getUserAid(t.userId,t.platform)}))[0],I=0;for(let _=0;_<u.building.main.length;_++){let d=r.inModfind(r.findName(u.building.main[_].itemId)).main.main;I+=d.max*u.building.main[_].number}let E=await e.database.get("stardew_valley_crop",{owner_id:await e.idconverter.getUserAid(t.userId,t.platform)});if(r.numberYES(i)+E.length>I)return"你没有足够的空间";{let _=[],d=await r.removeItem(a,t.userId,t.platform,r.numberYES(i));if(d==="Error: 你没有足够的该物品")return d;let o=Date.now()+s.growthTime;for(let c=0;c<r.numberYES(i);c++){let p=(await e.database.get("stardew_valley_crop",{location:1},["id"])).map(h=>h.id),g;p.length===0?g=0:g=Math.max(...p)+1,_.push(g),await e.database.create("stardew_valley_crop",{id:g,owner_id:await e.idconverter.getUserAid(t.userId,t.platform),crop_id:r.findId(a),date:new Date(o),location:1})}return e.emit("stardew-valley/plant",{cropid:r.findId(a),number:r.numberYES(i),ids:_},t),"种植成功，种植时间至"+new Date(o)}}else return"没有找到该物品"}else return"请输入物品名称"}),e.command("stardew-valley.收获").action(async({session:t})=>{let a=await r.checkPlayerHaveItem(t.userId,t.platform);a==="检测到你是第一次玩此游戏，系统已赠与你一个普通农场"&&t.send(a);let i=await e.database.get("stardew_valley_crop",{owner_id:await e.idconverter.getUserAid(t.userId,t.platform)});if(i.length===0)return"你没有种植任何作物";{let m=Date.now(),l=[];for(let s=0;s<i.length;s++){let u=[],I=r.inModfind(r.findName(i[s].crop_id)).main.main;if(m>=i[s].date.getTime()){let E=b(async v=>{for(let _=0;_<v.harvestOutput.output.length;_++)if(r.probabilityFunction(v.harvestOutput.output[_].probability)===!0){let d=r.getRandomValue(v.harvestOutput.output[_].max,v.harvestOutput.output[_].min);for(let o=0;o<d;o++){if(u.length>=v.harvestOutput.max)return u;if(u.length+d>=v.harvestOutput.max)for(let c=0;c<v.harvestOutput.max-u.length;c++)return u.push(v.harvestOutput.output[_].id),u;else u.push(v.harvestOutput.output[_].id)}}if(u.length<=v.harvestOutput.min)await E(v);else return u},"add_output");await E(I),await e.database.remove("stardew_valley_crop",{id:i[s].id});for(let v=0;v<u.length;v++)await r.addItem(r.findName(u[v]),t.userId,t.platform,1);u.forEach(async v=>{l.push(r.findName(v))})}}return l.length===0?"你种植的作物还未成熟":"收获成功，收获物品："+r.ListTOString(l)}}),e.command("stardew-valley.描述 [name]").action(async({session:t},a)=>{let i=await r.checkPlayerHaveItem(t.userId,t.platform);if(i==="检测到你是第一次玩此游戏，系统已赠与你一个普通农场"&&t.send(i),a){let m=r.inModfind(a);return m?m.description:"没有找到该物品"}else return"请输入物品名称"}),e.command("stardew-valley.查看.拥有物品").action(async({session:t})=>{let a=await r.checkPlayerHaveItem(t.userId,t.platform);a==="检测到你是第一次玩此游戏，系统已赠与你一个普通农场"&&t.send(a);let i=(await e.database.get("stardew_valley",{id:await e.idconverter.getUserAid(t.userId,t.platform)},["item","building"]))[0];if(i.item.main.length===0&&i.building.main.length===0)return"你没有任何物品";let m=[];for(let l=0;l<i.item.main.length;l++)m.push(r.findName(i.item.main[l].itemId)+"x"+i.item.main[l].number);for(let l=0;l<i.building.main.length;l++)m.push(r.findName(i.building.main[l].itemId)+"x"+i.building.main[l].number);return"你当前拥有以下物品："+m.join("、")}),e.command("stardew-valley.查看.可购买物品").action(async({session:t})=>{let a=await r.checkPlayerHaveItem(t.userId,t.platform);a==="检测到你是第一次玩此游戏，系统已赠与你一个普通农场"&&t.send(a);let i=[];return f.main.forEach(async m=>{for(let l=0;l<m.main.length;l++)m.main[l].price.can===!0&&i.push(`物品名称：${m.main[l].name}，买价：${m.main[l].price.buy}，卖价：${m.main[l].price.sell}`)}),"你可以购买以下物品：&#10;"+i.join("&#10;")}),e.command("stardew-valley.查看.种植作物").action(async({session:t})=>{let a=await r.checkPlayerHaveItem(t.userId,t.platform);a==="检测到你是第一次玩此游戏，系统已赠与你一个普通农场"&&t.send(a);let i=await e.database.get("stardew_valley_crop",{owner_id:await e.idconverter.getUserAid(t.userId,t.platform)});if(i.length===0)return"你没有种植任何作物";{let m=Date.now(),l=[],s=[];for(let I=0;I<i.length;I++){let E=r.findName(i[I].crop_id);l.push(E),m>=i[I].date.getTime()&&s.push(E)}let u=new Date(Math.min(...i.map(I=>I.date.getTime())));return`你当前种植的农作物有：${r.ListTOString(l)}&#10;可收获的农作物有：${r.ListTOString(s)}&#10;最快收获时间：${u}`}})}b(te,"command");var M=X((J(),q(A))),L=X(z()),ve=ce(),ye=ge().version,we="stardew-valley",he={required:["database","idconverter","monetary"]},be=B.Schema.intersect([B.Schema.object({max_events:B.Schema.number().description("单次事件所触发的最大事件数量").default(10)}).description("基础设置")]);function ae(e,n){function f(m,l){if(L.extname(m)===".json"){let s=M.readFileSync(m,"utf-8"),u=JSON.parse(s);if(u.version===ye){l.main.push(u);return}else return}}b(f,"loadMods");function r(m){try{let l={main:[]},s=b(u=>{M.readdirSync(u).forEach(E=>{let v=L.join(u,E);M.statSync(v).isDirectory()?s(v):f(v,l)})},"traverseFolders");return s(m),l.main.push(ve),{type:"success",message:l}}catch(l){return{type:"error",message:l}}}b(r,"loadModsFolders");let t=L.resolve(import.meta.url,"../../../data");M.existsSync(`${t}/mods`)||M.mkdirSync(`${t}/mods`),M.existsSync(`${t}/mods/stardew-valley`)||M.mkdirSync(`${t}/mods/stardew-valley`);let a=r(`${t}/mods/stardew-valley`);if(a.type==="error")e.logger.error("加载 mods 失败："+a.message);else if(a.type==="success")var i=a.message;e.model.extend("stardew_valley",{id:"unsigned",item:"json",building:"json"},{primary:["id"],autoInc:!1}),e.model.extend("stardew_valley_crop",{id:"unsigned",owner_id:"unsigned",crop_id:"string",date:"timestamp",location:"unsigned"},{primary:["id"],autoInc:!0}),te(e,n,i),x(e,n,i)}b(ae,"apply")});export default _e();
