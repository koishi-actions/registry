var q=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var H=Object.prototype.hasOwnProperty;var A=(t,e)=>()=>(t&&(e=t(t=0)),e);var b=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var j=(t,e,a,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of F(e))!H.call(t,i)&&i!==a&&q(t,i,{get:()=>e[i],enumerable:!(r=W(e,i))||r.enumerable});return t},y=(t,e,a)=>(j(t,e,"default"),a&&j(a,e,"default"));var v=t=>j(q({},"__esModule",{value:!0}),t);import{Buffer as w}from"https://registry.koishi.chat/modules/buffer/index.js";import S from"https://registry.koishi.chat/modules/process/index.js";var d=A(()=>{});var p={};import*as ue from"https://registry.koishi.chat/modules/koishi/index.js";var _=A(()=>{d();y(p,ue)});var R=b(u=>{"use strict";d();Object.defineProperty(u,"__esModule",{value:!0});u.stripDataPrefix=u.NetworkError=u.download=u.arrayBufferToBase64=void 0;var K=(_(),v(p));function C(t){{let e="";for(let r=0;r<t.byteLength;r+=8192)e+=String.fromCharCode.apply(null,t.slice(r,r+8192));return btoa(e)}}u.arrayBufferToBase64=C;var V=10485760,B=["image/jpeg","image/png"];async function X(t,e,a={}){if(e.startsWith("data:")){let[,r,i]=e.match(/^data:(image\/\w+);base64,(.*)$/);if(!B.includes(r))throw new f(".unsupported-file-type");let n=atob(i),l=new Uint8Array(n.length);for(let m=0;m<n.length;m++)l[m]=n.charCodeAt(m);return{buffer:l,base64:i,dataUrl:e}}else{let r=await t.http.head(e,{headers:a});if(+r["content-length"]>V)throw new f(".file-too-large");let i=r["content-type"];if(!B.includes(i))throw new f(".unsupported-file-type");let n=await t.http.get(e,{responseType:"arraybuffer",headers:a}),l=C(n);return{buffer:n,base64:l,dataUrl:`data:${i};base64,${l}`}}}u.download=X;var f=class extends Error{constructor(e,a={}){super(e),this.params=a}};u.NetworkError=f;f.catch=t=>e=>{if(K.Quester.isAxiosError(e)){let a=e.response?.status;for(let r in t)if(a===+r)throw new f(t[r])}throw e};function Y(t){return t.replace(/^data:image\/[\w-]+;base64,/,"")}u.stripDataPrefix=Y});var D=b(T=>{"use strict";d();Object.defineProperty(T,"__esModule",{value:!0});T.Config=void 0;var c=(_(),v(p));T.Config=c.Schema.intersect([c.Schema.object({endpoint:c.Schema.string().description("API 服务器地址。例如 http://127.0.0.1:7860").default("http://127.0.0.1:7860"),headers:c.Schema.dict(String).description("要附加的额外请求头。如无必要，此项不填写。")}).description("接入设置"),c.Schema.object({upscalers:c.Schema.array(String).description("允许使用的超分辨率模型，默认使用第一个。部分模型第一次调用需要下载模型文件，可能会导致超时。").default(["SwinIR_4x","ScuNET PSNR","ScuNET","R-ESRGAN 4x+ Anime6B","R-ESRGAN 4x+","LDSR","ESRGAN_4x","BSRGAN","Nearest","Lanczos","None"])}).description("模型设置"),c.Schema.object({maxRetryCount:c.Schema.natural().description("连接失败时最大的重试次数。").default(1),requestTimeout:c.Schema.number().role("time").description("当请求超过这个时间时会中止并提示超时。").default(c.Time.minute),recallTimeout:c.Schema.number().role("time").description("图片发送后自动撤回的时间 (设置为 0 以禁用此功能)。").default(0),maxConcurrency:c.Schema.number().description("单个频道下的最大并发数量 (设置为 0 以禁用此功能)。").default(0)}).description("高级设置")])});var M=b((me,Z)=>{Z.exports={commands:{extra:{description:"使用 SD-WebUI 对输入的图像进行超分辨率处理。",usage:"对输入的图像进行超分辨率处理",options:{resize:"放大倍数 (1~4) 默认为 2",upscaler:"通过名称选择模型",upscalerIndex:"通过序号选择模型"},example:"extra [图片]; extra -r 1.5 [图片]。",messages:{"expect-image":"请输入图片。","concurrent-jobs":"是数位板没电了，才…才不是我不想画呢！",waiting:"在画了在画了",pending:"在画了在画了，不过前面还有 {0} 个稿……","file-too-large":"文件体积过大。","unsupported-file-type":"不支持的文件格式。","download-error":"图片解析失败。","unknown-error":"发生未知错误。","response-error":"发生未知错误 ({0})。","empty-response":"服务器返回了空白图片，请稍后重试。","request-failed":"请求失败 ({0})，请稍后重试。","request-timeout":"请求超时。"}}}}});var ae=b(s=>{d();var J=s&&s.__createBinding||(Object.create?function(t,e,a,r){r===void 0&&(r=a);var i=Object.getOwnPropertyDescriptor(e,a);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[a]}}),Object.defineProperty(t,r,i)}:function(t,e,a,r){r===void 0&&(r=a),t[r]=e[a]}),ee=s&&s.__exportStar||function(t,e){for(var a in t)a!=="default"&&!Object.prototype.hasOwnProperty.call(e,a)&&J(e,t,a)};Object.defineProperty(s,"__esModule",{value:!0});s.apply=s.name=s.reactive=void 0;var h=(_(),v(p)),z=R();ee(D(),s);s.reactive=!0;s.name="extra";var U=new h.Logger("extra");function te(t,e){if(h.Quester.isAxiosError(e)){if(e.response?.status===402)return t.text(".unauthorized");if(e.response?.status)return t.text(".response-error",[e.response.status]);if(e.code==="ETIMEDOUT")return t.text(".request-timeout");if(e.code)return t.text(".request-failed",[e.code])}return U.error(e),t.text(".unknown-error")}function re(t,e){t.i18n.define("zh",M());let a=Object.create(null),r=new Set,i=t.command("extra <prompts:text>").alias("ext").userFields(["authority"]).option("resize","-r <resize:number>").option("upscaler","-s <upscaler:string>").option("upscalerIndex","-i <upscalerIndex:number>").action(async({session:n,options:l},m)=>{var N;if(!m?.trim())return n.execute("help extra");let E,O;E=h.h.select(m,"img")[0].attrs.src;let g={resize:2,upscalerIndex:0,upscaler:void 0};if(Object.assign(g,{resize:l.resize??2,upscalerIndex:l.upscalerIndex??0}),E)try{O=await(0,z.download)(t,E)}catch(o){return o instanceof z.NetworkError?n.text(o.message,o.params):(U.error(o),n.text(".download-error"))}let x=Math.random().toString(36).slice(2);if(e.maxConcurrency){let o=a[N=n.cid]||(a[N]=new Set);if(o.size>=e.maxConcurrency)return n.text(".concurrent-jobs");o.add(x)}n.send(r.size?n.text(".pending",[r.size]):n.text(".waiting")),r.add(x);let P=()=>{a[n.cid]?.delete(x),r.delete(x)},k={image:O&&O.dataUrl,upscaling_resize:g.resize,upscaler_1:g.upscaler??e.upscalers[g.upscalerIndex??0]},L=()=>t.http.axios((0,h.trimSlash)(e.endpoint)+"/sdapi/v1/extra-single-image",{method:"POST",timeout:e.requestTimeout,headers:{...e.headers},data:k}).then(o=>(0,z.stripDataPrefix)(o.data.image)),I,G=0;for(;;)try{I=await L(),P();break}catch(o){if(h.Quester.isAxiosError(o)&&o.code&&o.code!=="ETIMEDOUT"&&++G<e.maxRetryCount)continue;return P(),te(n,o)}if(!I.trim())return n.text(".empty-response");function $(){return h.h.image(`data:image/png;base64,${I}`)}let Q=await n.send($());e.recallTimeout&&t.setTimeout(()=>{for(let o of Q)n.bot.deleteMessage(n.channelId,o)},e.recallTimeout)})}s.apply=re});export default ae();
