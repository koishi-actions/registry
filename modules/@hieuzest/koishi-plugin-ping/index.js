var f=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var w=Object.prototype.hasOwnProperty;var h=(a,e)=>()=>(a&&(e=a(a=0)),e);var O=(a,e)=>()=>(e||a((e={exports:{}}).exports,e),e.exports);var l=(a,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of _(e))!w.call(a,s)&&s!==t&&f(a,s,{get:()=>e[s],enumerable:!(r=T(e,s))||r.enumerable});return a},u=(a,e,t)=>(l(a,e,"default"),t&&l(t,e,"default"));var k=a=>l(f({},"__esModule",{value:!0}),a);import{Buffer as b}from"https://registry.koishi.chat/modules/buffer/index.js";import y from"https://registry.koishi.chat/modules/process/index.js";var n=h(()=>{});var i={};import*as q from"https://registry.koishi.chat/modules/koishi/index.js";var g=h(()=>{n();u(i,q)});var C=O((x,S)=>{n();var c=Object.defineProperty,D=Object.getOwnPropertyDescriptor,N=Object.getOwnPropertyNames,P=Object.prototype.hasOwnProperty,I=(a,e)=>c(a,"name",{value:e,configurable:!0}),j=(a,e)=>{for(var t in e)c(a,t,{get:e[t],enumerable:!0})},R=(a,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of N(e))!P.call(a,s)&&s!==t&&c(a,s,{get:()=>e[s],enumerable:!(r=D(e,s))||r.enumerable});return a},A=a=>R(c({},"__esModule",{value:!0}),a),v={};j(v,{Ping:()=>m,default:()=>$});S.exports=A(v);var o=(g(),k(i)),m=class p{constructor(e,t){this.ctx=e,this.config=t,this.botsTime={},this.botsRetry={},this.curfew=(t.curfew||[]).map(({start:r,end:s})=>({start:p.markerTimeToNumber(r),end:p.markerTimeToNumber(s)})),e.middleware((r,s)=>(this.botsTime[r.sid]=Date.now(),this.botsRetry[r.sid]=0,s())),t.reloadAdapters.checkInterval&&e.setInterval(()=>{this.checkCurfew()||e.bots.forEach(r=>{t.reloadAdapters.intervals?.[r.sid]&&(!this.botsTime[r.sid]||Date.now()-this.botsTime[r.sid]>t.reloadAdapters.intervals?.[r.sid])&&(this.botsRetry[r.sid]=(this.botsRetry[r.sid]??0)+1,e.logger.info(`${r.sid} not responding, check`),this.botsRetry[r.sid]>t.reloadAdapters.retries&&(e.logger.info(`${r.sid} not responding, reload`),this.botsRetry[r.sid]=0,r.context.scope.update(r.context.config,!0)))})},t.reloadAdapters.checkInterval),t.ping&&e.command("ping",{authority:3}).action(()=>"pong"),e.on("bot-status-updated",async r=>{if(!r.platform.startsWith("sandbox:")&&r.status!==o.Universal.Status.ONLINE){if(r.sid!==t.notifySid){let s=e.bots[t.notifySid];s&&await s.sendMessage(t.notifyTarget,`Bot <${r.sid}> Offline`)}if(t.reloadOnDisconnect){e.logger.info(`${r.sid} disconnected, reload after ${t.reloadOnDisconnectDelay} ms`);let s=r.sid;e.setTimeout(()=>{let d=e.bots[s];!d||d.status===o.Universal.Status.ONLINE||(e.logger.info(`${r.sid} disconnected, try reloading`),d.context.scope.update(d.context.config,!0))},t.reloadOnDisconnectDelay)}}})}static name="ping";botsTime;botsRetry;curfew;checkCurfew(){let e=new Date,t=e.getHours()*60+e.getMinutes();for(let{start:r,end:s}of this.curfew)if(t>r&&t<s)return!0}};(a=>{a.reusable=!0;function e(t){let[r,s]=t.split(":");return parseInt(r)*60+parseInt(s)}a.markerTimeToNumber=e,I(e,"markerTimeToNumber"),a.Config=o.Schema.object({ping:o.Schema.boolean().default(!0),notifySid:o.Schema.string(),notifyTarget:o.Schema.string(),reloadOnDisconnect:o.Schema.boolean().default(!1),reloadOnDisconnectDelay:o.Schema.natural().role("ms").default(5*o.Time.minute),reloadAdapters:o.Schema.object({retries:o.Schema.natural().default(2).description("Max retries before reloading"),checkInterval:o.Schema.natural().role("ms").default(2*o.Time.minute),intervals:o.Schema.dict(o.Schema.natural().role("ms")).description("Intervals as offline")}).description("ReloadAdapters"),curfew:o.Schema.array(o.Schema.object({start:o.Schema.string().pattern(/\d{1,2}:\d{1,2}/),end:o.Schema.string().pattern(/\d{1,2}:\d{1,2}/)})).role("table")})})(m||(m={}));var $=m});export default C();
