var G=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var Z=Object.prototype.hasOwnProperty;var v=(r,e)=>()=>(r&&(e=r(r=0)),e);var x=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var F=(r,e,o,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of X(e))!Z.call(r,i)&&i!==o&&G(r,i,{get:()=>e[i],enumerable:!(t=Q(e,i))||t.enumerable});return r},w=(r,e,o)=>(F(r,e,"default"),o&&F(o,e,"default"));var K=r=>F(G({},"__esModule",{value:!0}),r);import{Buffer as q}from"https://registry.koishi.chat/modules/buffer/index.js";import E from"https://registry.koishi.chat/modules/process/index.js";var P=v(()=>{});var N={};import*as fe from"https://registry.koishi.chat/modules/koishi/index.js";var B=v(()=>{P();w(N,fe)});var D={};import*as Oe from"https://registry.koishi.chat/modules/@satorijs/element/jsx-runtime/index.js";var A=v(()=>{P();w(D,Oe)});var _e=x((Ie,H)=>{P();var U=Object.defineProperty,ee=Object.getOwnPropertyDescriptor,ae=Object.getOwnPropertyNames,te=Object.prototype.hasOwnProperty,y=(r,e)=>U(r,"name",{value:e,configurable:!0}),re=(r,e)=>{for(var o in e)U(r,o,{get:e[o],enumerable:!0})},ie=(r,e,o,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ae(e))!te.call(r,i)&&i!==o&&U(r,i,{get:()=>e[i],enumerable:!(t=ee(e,i))||t.enumerable});return r},ne=r=>ie(U({},"__esModule",{value:!0}),r),W={};re(W,{Config:()=>se,apply:()=>V,inject:()=>me,name:()=>oe,reusable:()=>le,usage:()=>ce});H.exports=ne(W);var a=(B(),K(N)),T=(A(),K(D)),oe="multi-platform-message-forwarding",le=!0,me={optional:["cache","idconverter"]};function Y(r){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o="";for(let t=0;t<r;t++)o+=e.charAt(Math.floor(Math.random()*e.length));return o}y(Y,"generateRandomString");function J(){function r(t){return{type:"section",text:{type:"plain-text",content:`${t}`}}}y(r,"plainText");function e(t){return{type:"section",text:{type:"kmarkdown",content:`${t}`}}}y(e,"kmarkdown");function o(t){return{type:"container",elements:[{type:"image",src:t}]}}return y(o,"image"),{plainText:r,kmarkdown:e,image:o}}y(J,"KOOKCardMessage");function R(r){let e=/<img.*?\/?>/g,o=r.match(e),t=[];return r.split(e).forEach((i,n)=>{t.push(i),o&&n<o.length&&t.push(o[n])}),t}y(R,"parseTextWithImages");function z(r){return/<img.*?\/?>/g.test(r)}y(z,"isImgTag");function L(r){let e=/<img.*?src=["'](.*?)["']/,o=r.match(e);return o?o[1]:null}y(L,"extractImgSrc");var ce=`
### 
`,se=a.Schema.intersect([a.Schema.object({Use_Unity_Message_ID:a.Schema.boolean().description("是否使用统一消息ID").default(!0)}).description("基础设置"),a.Schema.union([a.Schema.object({Use_Unity_Message_ID:a.Schema.const(!0),Unity_Message_ID_Time:a.Schema.number().description("统一消息ID的有效期（毫秒）").default(1296e6)}),a.Schema.object({})]),a.Schema.object({ChannelName_Setting:a.Schema.boolean().description("是否在转发消息前加上群聊/频道的名称").default(!1)}),a.Schema.union([a.Schema.object({ChannelName_Setting:a.Schema.const(!0),ChannelName_Package_Format:a.Schema.tuple([String,String]).description("请输入名称左右两旁的封装符号")}),a.Schema.object({})]),a.Schema.object({UserName_Setting:a.Schema.boolean().description("是否在转发消息前加上用户的名称").default(!0)}),a.Schema.union([a.Schema.object({UserName_Setting:a.Schema.const(!0),UserName_Package_Format:a.Schema.tuple([String,String]).description("请输入名称左右两旁的封装符号").default(["[","]"]),Nickname_Setting:a.Schema.boolean().description("是否使用群昵称作为消息开头（如果存在时）").default(!0)}),a.Schema.object({})]),a.Schema.object({Message_Wrapping_Setting:a.Schema.boolean().description("是否自动换行消息原文与消息开头").default(!1),filterVocabulary:a.Schema.array(String).description("过滤词列表").role("table"),Markdown:a.Schema.boolean().description("是否在支持Markdown的平台上使用Markdown修饰（优先度低于KOOK卡片消息）").default(!1),At_Setting:a.Schema.boolean().description("是否自动将@用户ID转化为名称").default(!1).hidden()}),a.Schema.union([a.Schema.object({Markdown:a.Schema.const(!0),UseMarkdownPlatform:a.Schema.array(String).description("使用Markdown的平台列表").default([]).role("table")})]),a.Schema.union([a.Schema.object({At_Setting:a.Schema.const(!1),At_Target_Platform_ID:a.Schema.boolean().description("是否自动将@用户ID通过idconverter转化为目标平台的ID（需idconverter服务）").default(!1)}),a.Schema.object({})]),a.Schema.object({Forward_Mode:a.Schema.union(["单向转发","双向转发","群聊互联！"]).required().description("转发模式").role("radio")}).description("转发设置"),a.Schema.union([a.Schema.object({Forward_Mode:a.Schema.const("单向转发").required(),Original_Target:a.Schema.array(a.Schema.object({Original_Guild:a.Schema.string().required().description("消息源群聊/频道ID"),Original_Platform:a.Schema.string().required().description("消息源平台"),Original_BotID:a.Schema.string().required().description("消息源机器人ID"),Target_Guild:a.Schema.string().required().description("转发目标群聊/频道ID"),Target_Platform:a.Schema.string().required().description("转发目标平台"),Target_BotID:a.Schema.string().required().description("转发目标机器人ID"),note:a.Schema.string().description("备注")})).role("table").description("消息源与转发目标（单向转发）")}),a.Schema.object({Forward_Mode:a.Schema.const("双向转发").required(),Original_Target:a.Schema.array(a.Schema.object({Original_Guild:a.Schema.string().required().description("群聊/频道ID（1）"),Original_Platform:a.Schema.string().required().description("平台（1）"),Original_BotID:a.Schema.string().required().description("机器人ID（1）"),Target_Guild:a.Schema.string().required().description("群聊/频道ID（2）"),Target_Platform:a.Schema.string().required().description("平台（2）"),Target_BotID:a.Schema.string().required().description("机器人ID（2）"),note:a.Schema.string().description("备注")})).role("table").description("消息源与转发目标（双向转发）")}),a.Schema.object({Forward_Mode:a.Schema.const("群聊互联！").required(),OT_EY:a.Schema.array(a.Schema.object({Original_Target:a.Schema.array(a.Schema.object({Original_Guild:a.Schema.string().required().description("群聊/频道ID"),Original_Platform:a.Schema.string().required().description("平台"),Original_BotID:a.Schema.string().required().description("机器人ID"),Target_Guild:a.Schema.string().hidden().default("nothing"),Target_Platform:a.Schema.string().hidden().default("nothing"),Target_BotID:a.Schema.string().hidden().default("nothing"),note:a.Schema.string().description("备注")})).role("table").description("消息源与转发目标（群聊互联！）")})).description("群聊互联列表")})]),a.Schema.object({KOOK_Use_CardMessage:a.Schema.boolean().description("KOOK是否使用卡片消息").default(!1).experimental()}).description("平台设置"),a.Schema.union([a.Schema.object({KOOK_Use_CardMessage:a.Schema.const(!0).required(),KOOK_CardMessage_USE_MINE:a.Schema.boolean().description("是否自定义卡片消息内容").default(!1).hidden()}),a.Schema.object({})]).description("卡片消息设置"),a.Schema.union([a.Schema.object({KOOK_CardMessage_USE_MINE:a.Schema.const(!0).required(),KOOK_CardMessage_MY_MESSAGE:a.Schema.string().role("textarea").description("作者写的卡片消息内容太辣鸡了！lz要自己写！（注：自己写的卡片消息内容如果导致koishi崩溃等问题，一律由使用者本人承担）").hidden()}),a.Schema.object({})]),a.Schema.object({KOOK_CardMessage_compatibilityMode:a.Schema.boolean().description("是否使用兼容模式").default(!0).hidden()})]);function V(r,e){if(e.Use_Unity_Message_ID===!0&&r.cache){let t=[];e.Forward_Mode==="群聊互联！"?e.OT_EY.forEach(i=>{i.Original_Target.forEach(n=>{t.push(n.Original_Guild)})}):e.Forward_Mode==="双向转发"?e.Original_Target.forEach(i=>{t.push(i.Original_Guild),t.push(i.Target_Guild)}):e.Forward_Mode==="单向转发"&&e.Original_Target.forEach(i=>{t.push(i.Original_Guild)}),r.on("message",async i=>{if(t.includes(i.channelId)&&!await r.cache.get("mpmf_message",`${i.messageId}:${i.channelId}:${i.platform}:${i.selfId}`)){let n=y(async()=>{let u=Y(20);if(await r.cache.get("mpmf_unity",u))n();else return u},"unity_id_create"),l=await n();await r.cache.set("mpmf_message",`${i.messageId}:${i.channelId}:${i.platform}:${i.selfId}`,l,e.Unity_Message_ID_Time),await r.cache.set("mpmf_unity",l,[],e.Unity_Message_ID_Time)}}),r.on("message-deleted",async i=>{if(t.includes(i.channelId)){let n=await r.cache.get("mpmf_message",`${i.messageId}:${i.channelId}:${i.platform}:${i.selfId}`);n&&(await r.cache.get("mpmf_unity",n)).forEach(async u=>{await r.bots[`${u.split(":")[2]}:${u.split(":")[3]}`].deleteMessage(u.split(":")[1],u.split(":")[0]),await r.cache.delete("mpmf_message",u),await r.cache.delete("mpmf_message",`${i.messageId}:${i.channelId}:${i.platform}:${i.selfId}`),await r.cache.delete("mpmf_unity",n)})}})}let o=[];r.command("TemporaryExclusion <time>","临时排除转发功能（time单位：毫秒）",{authority:3}).action(({session:t},i)=>{o.push(t.channelId);let n=parseInt(i);r.setTimeout(()=>{o.splice(o.indexOf(t.channelId),1),t.send("已恢复转发功能")},n),t.send(`已临时排除此频道转发功能${n}毫秒`)}),r.command("CancelTE","取消临时排除转发功能",{authority:3}).action(({session:t})=>{o.includes(t.channelId)?(o.splice(o.indexOf(t.channelId),1),t.send("已恢复转发功能")):o.includes(t.channelId)||t.send("此频道未排除转发")}),r.on("message",async t=>{async function i(n,l,u,O,f,g){if(e.filterVocabulary.some(_=>t.content.includes(_)))return;let p=t.messageId,k;if(!o.includes(t.channelId))try{if(t.channelId===n&&t.platform===l&&t.userId!==u&&t.userId!==g){let _;e.UserName_Setting===!0&&(e.Nickname_Setting===!1?(_=t.event.member.nick,_||typeof t.bot.getGuildMember=="function"&&(_=(await t.bot.getGuildMember(t.guildId,t.userId)).nick)):e.Nickname_Setting===!0&&(_=t.username));let S;e.ChannelName_Setting===!0&&(S=t.event.channel.name,S||(typeof t.bot.getChannel=="function"?S=(await t.bot.getChannel(t.channelId)).name:r.logger.warn(`${t.platform}平台适配器不支持获取频道名称`)));let I,$="";if(t.platform==="kook")try{let h=JSON.parse(t.event._data.content);if(typeof h!="object")$=h;else{let b=[];h[0].modules.forEach(d=>{switch(d.type){case"section":{b.push(d.text.content);break}case"container":{b.push((0,T.jsx)("img",{src:d.elements[0].src,alt:""}));break}}}),$=b.join("")}}catch{$=t.content}else $=t.content;let j=[];if(e.KOOK_Use_CardMessage===!0&&f==="kook"){if(!e.KOOK_CardMessage_USE_MINE){let d=[];S&&d.push(`${e.ChannelName_Package_Format[0]}${S}${e.ChannelName_Package_Format[1]}`),_&&d.push(`${e.UserName_Package_Format[0]}${_}${e.UserName_Package_Format[1]}`);let c=d.join(" ");e.Message_Wrapping_Setting===!1?j.push({type:"section",text:{type:"kmarkdown",content:`(font)${c}(font)[pink]：`}}):j.push({type:"section",text:{type:"kmarkdown",content:`(font)${c}(font)[pink]`}},{type:"divider"})}let h=R(t.content),b=J();for(let d=0;d<h.length;d++)if(z(h[d]))if(e.KOOK_CardMessage_compatibilityMode===!0){let c=[];if(S&&c.push(`${e.ChannelName_Package_Format[0]}${S}${e.ChannelName_Package_Format[1]}`),_&&c.push(`${e.UserName_Package_Format[0]}${_}${e.UserName_Package_Format[1]}`),e.UserName_Setting===!1&&e.ChannelName_Setting===!1?c.push(`${$}`):e.Message_Wrapping_Setting===!1?c.push(`: ${$}`):e.Message_Wrapping_Setting===!0&&c.push(`: &#10;${$}`),I=c.join(""),k=(await r.bots[`${f}:${g}`].sendMessage(O,I)).toString(),r.cache&&await r.cache.get("mpmf_message",`${p}:${t.channelId}:${t.platform}:${t.selfId}`)){let m=await r.cache.get("mpmf_message",`${p}:${t.channelId}:${t.platform}:${t.selfId}`),s=await r.cache.get("mpmf_unity",m);s.push(`${k}:${O}:${f}:${g}`),await r.cache.set("mpmf_unity",m,s,e.Unity_Message_ID_Time)}return}else j.push(b.image(L(h[d]).replace(/&amp;/g,"&")));else j.push(b.plainText(h[d]));I=[{type:"card",theme:"secondary",size:"lg",modules:j}],r.bots[`kook:${g}`].internal.createMessage({type:10,target_id:O,content:JSON.stringify(I)})}else{let h=[];e.Markdown&&e.UseMarkdownPlatform.includes(f)?(S&&_?h.push(e.ChannelName_Package_Format[0]+S+e.ChannelName_Package_Format[1]+e.UserName_Package_Format[0]+_+e.UserName_Package_Format[1]):S&&!_?h.push(e.ChannelName_Package_Format[0]+S+e.ChannelName_Package_Format[1]):!S&&_&&h.push(e.UserName_Package_Format[0]+_+e.UserName_Package_Format[1]),(S||_)&&h.push("&#10;---&#10;"),h.push("> "+$.replace(/\n/g,`
> `))):(S&&h.push(`${e.ChannelName_Package_Format[0]}${S}${e.ChannelName_Package_Format[1]}`),_&&h.push(`${e.UserName_Package_Format[0]}${_}${e.UserName_Package_Format[1]}`),e.UserName_Setting===!1&&e.ChannelName_Setting===!1?h.push(`${$}`):e.Message_Wrapping_Setting===!1?h.push(`: ${$}`):e.Message_Wrapping_Setting===!0&&h.push(`: &#10;${$}`));let b="";if(t.event.message.quote&&r.cache&&e.Use_Unity_Message_ID){let c=await r.cache.get("mpmf_message",`${t.event.message.quote.messageId}:${t.channelId}:${t.platform}:${t.selfId}`),m=await r.cache.get("mpmf_unity",c);for(let s=0;s<m.length;s++)if(m[s].split(":")[1]===O&&m[s].split(":")[2]===f&&m[s].split(":")[3]===g){b=m[s].split(":")[0];break}}let d;if(I=h.join(""),/<at id="([^"]*)"\/>/.exec(I))if(e.At_Setting){let c=[];d=I.replace(/<at id="([^"]*)"\/>/,(m,s)=>{c.push({match:m,p1:s,userName:null})});for(let m=0;m<c.length;m++){let s,M=await t.bot.getGuildMember(t.guildId,c[m].p1);M.nick?s=M.nick:s=M.user.name,c[m].userName=s}d=I.replace(/<at id="([^"]*)"\/>/g,(m,s)=>{let M=c.find(C=>C.p1===s).userName;return(0,T.jsx)("at",{name:M})})}else if(e.At_Target_Platform_ID){let c=[];d=I.replace(/<at id="([^"]*)"\/>/,(m,s)=>{c.push({match:m,p1:s,userId:null})});for(let m=0;m<c.length;m++){let s=await r.database.get("binding",{platform:t.platform,pid:c[m].p1});if(s.length>0){let M=await r.database.get("binding",{platform:f,aid:s[0].aid});c[m].userId=M[0].pid}else c[m].userId=c[m].p1}d=I.replace(/<at id="([^"]*)"\/>/g,(m,s)=>{let M=c.find(C=>C.p1===s).userId;return(0,T.jsx)("at",{id:M})})}else d=I;else d=I;if(t.event.message.quote&&r.cache&&e.Use_Unity_Message_ID?k=(await r.bots[`${f}:${g}`].sendMessage(O,(0,a.h)("quote",{id:b})+(0,T.jsx)(T.Fragment,{children:d}))).toString():k=(await r.bots[`${f}:${g}`].sendMessage(O,d)).toString(),r.cache&&await r.cache.get("mpmf_message",`${p}:${t.channelId}:${t.platform}:${t.selfId}`)){let c=await r.cache.get("mpmf_message",`${p}:${t.channelId}:${t.platform}:${t.selfId}`),m=await r.cache.get("mpmf_unity",c);m.push(`${k}:${O}:${f}:${g}`),await r.cache.set("mpmf_unity",c,m,e.Unity_Message_ID_Time)}}}}catch(_){r.logger.error(`消息转发函数错误：${_}`)}}switch(y(i,"Message_Forwarding"),e.Forward_Mode){case"单向转发":try{for(let n=0;n<e.Original_Target.length;n++){let l=e.Original_Target[n];i(l.Original_Guild,l.Original_Platform,l.Original_BotID,l.Target_Guild,l.Target_Platform,l.Target_BotID)}}catch(n){r.logger.error(`单向转发模式错误：${n}`)}break;case"双向转发":try{for(let n=0;n<e.Original_Target.length;n++){let l=e.Original_Target[n];i(l.Original_Guild,l.Original_Platform,l.Original_BotID,l.Target_Guild,l.Target_Platform,l.Target_BotID),i(l.Target_Guild,l.Target_Platform,l.Target_BotID,l.Original_Guild,l.Original_Platform,l.Original_BotID)}}catch(n){r.logger.error(`双向转发模式错误：${n}`)}break;case"群聊互联！":try{let n=function(u,O){return O.some(f=>JSON.stringify(f)===JSON.stringify(u))};y(n,"itemExists");let l=[];for(let u=0;u<e.OT_EY.length;u++)for(let O=0;O<e.OT_EY[u].Original_Target.length;O++)for(let f=O+1;f<e.OT_EY[u].Original_Target.length;f++){let g=e.OT_EY[u].Original_Target[O],p=e.OT_EY[u].Original_Target[f],k={Original_Guild:g.Original_Guild,Original_Platform:g.Original_Platform,Original_BotID:g.Original_BotID,Target_Guild:p.Original_Guild,Target_Platform:p.Original_Platform,Target_BotID:p.Original_BotID},_={Original_Guild:p.Original_Guild,Original_Platform:p.Original_Platform,Original_BotID:p.Original_BotID,Target_Guild:g.Original_Guild,Target_Platform:g.Original_Platform,Target_BotID:g.Original_BotID};n(k,l)||(l.push(k),i(g.Original_Guild,g.Original_Platform,g.Original_BotID,p.Original_Guild,p.Original_Platform,p.Original_BotID)),n(_,l)||(l.push(_),i(p.Original_Guild,p.Original_Platform,p.Original_BotID,g.Original_Guild,g.Original_Platform,g.Original_BotID))}}catch(n){r.logger.error(`群聊互联模式错误：${n}`)}break}})}y(V,"apply")});export default _e();
