import{Buffer as N}from"https://registry.koishi.chat/modules/buffer/index.js";import q from"https://registry.koishi.chat/modules/process/index.js";import{clone as M,deepEqual as v,filterKeys as P,isNullable as l,isPlainObject as O,pick as R,valueMap as h}from"https://registry.koishi.chat/modules/cosmokit/index.js";var J=Object.defineProperty,K=Object.getOwnPropertyNames,u=(b,y)=>J(b,"name",{value:y,configurable:!0}),A=(b,y)=>function(){return y||(0,b[K(b)[0]])((y={exports:{}}).exports,y),y.exports},D=A({"src/index.ts"(b,y){var $=Symbol.for("schemastery");globalThis.__schemastery_index__??=0;var o=u(function(e){let t=u(function(r,n){return o.resolve(r,t,n)[0]},"schema");if(e.refs){let r=h(e.refs,i=>new o(i)),n=u(i=>r[i],"getRef");for(let i in r){let s=r[i];s.sKey=n(s.sKey),s.inner=n(s.inner),s.list=s.list&&s.list.map(n),s.dict=s.dict&&h(s.dict,n)}return r[e.uid]}if(Object.assign(t,e),typeof t.callback=="string")try{t.callback=new Function("return "+t.callback)()}catch{}return Object.defineProperty(t,"uid",{value:globalThis.__schemastery_index__++}),Object.setPrototypeOf(t,o.prototype),t.meta||={},t.toString=t.toString.bind(t),t},"Schema");o.prototype=Object.create(Function.prototype),o.prototype[$]=!0;var m;o.prototype.toJSON=u(function(){if(m)return m[this.uid]??=JSON.parse(JSON.stringify({...this})),this.uid;m={[this.uid]:{...this}},m[this.uid]=JSON.parse(JSON.stringify({...this}));let t={uid:this.uid,refs:m};return m=void 0,t},"toJSON"),o.prototype.set=u(function(t,r){return this.dict[t]=r,this},"set"),o.prototype.push=u(function(t){return this.list.push(t),this},"push");function k(e,t){let r=typeof e=="string"?{"":e}:{...e};for(let n in t){let i=t[n];i?.$description||i?.$desc?r[n]=i.$description||i.$desc:typeof i=="string"&&(r[n]=i)}return r}u(k,"mergeDesc");function a(e){return e?.$value??e?.$inner}u(a,"getInner");function S(e){return P(e??{},t=>!t.startsWith("$"))}u(S,"extractKeys"),o.prototype.i18n=u(function(t){let r=o(this);return r.meta.description=k(r.meta.description,t),r.dict&&(r.dict=h(r.dict,(n,i)=>n.i18n(h(t,s=>a(s)?.[i]??s?.[i])))),r.list&&(r.list=r.list.map((n,i)=>n.i18n(h(t,(s={})=>Array.isArray(a(s))?a(s)[i]:Array.isArray(s)?s[i]:S(s))))),r.inner&&(r.inner=r.inner.i18n(h(t,n=>a(n)?a(n):S(n)))),r.sKey&&(r.sKey=r.sKey.i18n(h(t,n=>n?.$key))),r},"i18n"),o.prototype.extra=u(function(t,r){let n=o(this);return n.meta={...n.meta,[t]:r},n},"extra");for(let e of["required","disabled","collapse","hidden","loose"])Object.assign(o.prototype,{[e](t=!0){let r=o(this);return r.meta={...r.meta,[e]:t},r}});o.prototype.deprecated=u(function(){let t=o(this);return t.meta.badges||=[],t.meta.badges.push({text:"deprecated",type:"danger"}),t},"deprecated"),o.prototype.experimental=u(function(){let t=o(this);return t.meta.badges||=[],t.meta.badges.push({text:"experimental",type:"warning"}),t},"experimental"),o.prototype.pattern=u(function(t){let r=o(this),n=R(t,["source","flags"]);return r.meta={...r.meta,pattern:n},r},"pattern"),o.prototype.simplify=u(function(t){if(v(t,this.meta.default,this.type==="dict"))return null;if(l(t))return t;if(this.type==="object"||this.type==="dict"){let r={};for(let n in t){let s=(this.type==="object"?this.dict[n]:this.inner)?.simplify(t[n]);(this.type==="dict"||!l(s))&&(r[n]=s)}return v(r,this.meta.default,this.type==="dict")?null:r}else if(this.type==="array"||this.type==="tuple"){let r=[];return t.forEach((n,i)=>{let s=this.type==="array"?this.inner:this.list[i],c=s?s.simplify(n):n;r.push(c)}),r}else if(this.type==="intersect"){let r={};for(let n of this.list)Object.assign(r,n.simplify(t));return r}else if(this.type==="union")for(let r of this.list)try{return o.resolve(t,r),r.simplify(t)}catch{}return t},"simplify"),o.prototype.toString=u(function(t){return j[this.type]?.(this,t)??`Schema<${this.type}>`},"toString"),o.prototype.role=u(function(e,t){let r=o(this);return r.meta={...r.meta,role:e,extra:t},r},"role");for(let e of["default","link","comment","description","max","min","step"])Object.assign(o.prototype,{[e](t){let r=o(this);return r.meta={...r.meta,[e]:t},r}});var E={};o.extend=u(function(t,r){E[t]=r},"extend"),o.resolve=u(function(t,r,n={},i=!1){if(!r)return[t];if(l(t)){if(r.meta.required)throw new TypeError("missing required value");let c=r,f=r.meta.default;for(;c?.type==="intersect"&&l(f);)c=c.list[0],f=c?.meta.default;if(l(f))return[t];t=M(f)}let s=E[r.type];if(!s)throw new TypeError(`unsupported type "${r.type}"`);try{return s(t,r,n,i)}catch(c){if(!r.meta.loose)throw c;return[r.meta.default]}},"resolve"),o.from=u(function(t){if(l(t))return o.any();if(["string","number","boolean"].includes(typeof t))return o.const(t).required();if(t[$])return t;if(typeof t=="function")switch(t){case String:return o.string().required();case Number:return o.number().required();case Boolean:return o.boolean().required();case Function:return o.function().required();default:return o.is(t).required()}else throw new TypeError(`cannot infer schema from ${t}`)},"from"),o.natural=u(function(){return o.number().step(1).min(0)},"natural"),o.percent=u(function(){return o.number().step(.01).min(0).max(1).role("slider")},"percent"),o.date=u(function(){return o.union([o.is(Date),o.transform(o.string().role("datetime"),t=>{let r=new Date(t);if(isNaN(+r))throw new TypeError(`invalid date "${t}"`);return r},!0)])},"date"),o.extend("any",e=>[e]),o.extend("never",e=>{throw new TypeError(`expected nullable but got ${e}`)}),o.extend("const",(e,{value:t})=>{if(e===t)return[t];throw new TypeError(`expected ${t} but got ${e}`)});function d(e,t,r,n=!1){let{max:i=1/0,min:s=-1/0}=t;if(e>i)throw new TypeError(`expected ${r} <= ${i} but got ${e}`);if(e<s&&!n)throw new TypeError(`expected ${r} >= ${s} but got ${e}`)}u(d,"checkWithinRange"),o.extend("string",(e,{meta:t})=>{if(typeof e!="string")throw new TypeError(`expected string but got ${e}`);if(t.pattern){let r=new RegExp(t.pattern.source,t.pattern.flags);if(!r.test(e))throw new TypeError(`expect string to match regexp ${r}`)}return d(e.length,t,"string length"),[e]});function w(e,t){let r=e.toString();if(r.includes("e"))return e*Math.pow(10,t);let n=r.indexOf(".");if(n===-1)return e*Math.pow(10,t);let i=r.slice(n+1),s=r.slice(0,n);return i.length<=t?+(s+i.padEnd(t,"0")):+(s+i.slice(0,t)+"."+i.slice(t))}u(w,"decimalShift");function T(e,t,r){if(r=Math.abs(r),!/^\d+\.\d+$/.test(r.toString()))return(e-t)%r===0;let n=r.toString().indexOf("."),i=r.toString().slice(n+1).length;return Math.abs(w(e,i)-w(t,i))%w(r,i)===0}u(T,"isMultipleOf"),o.extend("number",(e,{meta:t})=>{if(typeof e!="number")throw new TypeError(`expected number but got ${e}`);d(e,t,"number");let{step:r}=t;if(r&&!T(e,t.min??0,r))throw new TypeError(`expected number multiple of ${r} but got ${e}`);return[e]}),o.extend("boolean",e=>{if(typeof e=="boolean")return[e];throw new TypeError(`expected boolean but got ${e}`)}),o.extend("bitset",(e,{bits:t,meta:r})=>{let n=0,i=[];if(typeof e=="number"){n=e;for(let s in t)e&t[s]&&i.push(s)}else if(Array.isArray(e)){i=e;for(let s of i){if(typeof s!="string")throw new TypeError(`expected string but got ${s}`);s in t&&(n|=t[s])}}else throw new TypeError(`expected number or array but got ${e}`);return n===r.default?[n]:[n,i]}),o.extend("function",e=>{if(typeof e=="function")return[e];throw new TypeError(`expected function but got ${e}`)}),o.extend("is",(e,{callback:t})=>{if(e instanceof t)return[e];throw new TypeError(`expected ${t.name} but got ${e}`)});function g(e,t,r,n){try{let[i,s]=o.resolve(e[t],r,n);return s!==void 0&&(e[t]=s),i}catch(i){if(!n?.autofix)throw i;return delete e[t],r.meta.default}}u(g,"property"),o.extend("array",(e,{inner:t,meta:r},n)=>{if(!Array.isArray(e))throw new TypeError(`expected array but got ${e}`);return d(e.length,r,"array length",!l(t.meta.default)),[e.map((i,s)=>g(e,s,t,n))]}),o.extend("dict",(e,{inner:t,sKey:r},n,i)=>{if(!O(e))throw new TypeError(`expected object but got ${e}`);let s={};for(let c in e){let f;try{f=o.resolve(c,r)[0]}catch(_){if(i)continue;throw _}s[f]=g(e,c,t,n),e[f]=e[c],c!==f&&delete e[c]}return[s]}),o.extend("tuple",(e,{list:t},r,n)=>{if(!Array.isArray(e))throw new TypeError(`expected array but got ${e}`);let i=t.map((s,c)=>g(e,c,s,r));return n?[i]:(i.push(...e.slice(t.length)),[i])});function x(e,t){for(let r in t)r in e||(e[r]=t[r])}u(x,"merge"),o.extend("object",(e,{dict:t},r,n)=>{if(!O(e))throw new TypeError(`expected object but got ${e}`);let i={};for(let s in t){let c=g(e,s,t[s],r);(!l(c)||s in e)&&(i[s]=c)}return n||x(i,e),[i]}),o.extend("union",(e,{list:t,toString:r},n,i)=>{let s=[];for(let c of t)try{return o.resolve(e,c,n,i)}catch(f){s.push(f)}throw new TypeError(`expected ${r()} but got ${JSON.stringify(e)}`)}),o.extend("intersect",(e,{list:t,toString:r},n,i)=>{let s;for(let c of t){let f=o.resolve(e,c,n,!0)[0];if(!l(f))if(l(s))s=f;else{if(typeof s!=typeof f)throw new TypeError(`expected ${r()} but got ${JSON.stringify(e)}`);if(typeof f=="object")x(s??={},f);else if(s!==f)throw new TypeError(`expected ${r()} but got ${JSON.stringify(e)}`)}}return!i&&O(e)&&x(s,e),[s]}),o.extend("transform",(e,{inner:t,callback:r,preserve:n},i)=>{let[s,c=e]=o.resolve(e,t,i,!0);return n?[r(s)]:[r(s),r(c)]});var j={};function p(e,t,r){j[e]=r,Object.assign(o,{[e](...n){let i=new o({type:e});return t.forEach((s,c)=>{switch(s){case"sKey":i.sKey=n[c]??o.string();break;case"inner":i.inner=o.from(n[c]);break;case"list":i.list=n[c].map(o.from);break;case"dict":i.dict=h(n[c],o.from);break;case"bits":{i.bits={};for(let f in n[c])typeof n[c][f]=="number"&&(i.bits[f]=n[c][f]);break}case"callback":{i.callback=n[c],i.callback.toJSON||=()=>i.callback.toString();break}default:i[s]=n[c]}}),e==="object"||e==="dict"?i.meta.default={}:e==="array"||e==="tuple"?i.meta.default=[]:e==="bitset"&&(i.meta.default=0),i}})}u(p,"defineMethod"),p("is",["callback"],({callback:e})=>e.name),p("any",[],()=>"any"),p("never",[],()=>"never"),p("const",["value"],({value:e})=>typeof e=="string"?JSON.stringify(e):e),p("string",[],()=>"string"),p("number",[],()=>"number"),p("boolean",[],()=>"boolean"),p("bitset",["bits"],()=>"bitset"),p("function",[],()=>"function"),p("array",["inner"],({inner:e})=>`${e.toString(!0)}[]`),p("dict",["inner","sKey"],({inner:e,sKey:t})=>`{ [key: ${t.toString()}]: ${e.toString()} }`),p("tuple",["list"],({list:e})=>`[${e.map(t=>t.toString()).join(", ")}]`),p("object",["dict"],({dict:e})=>Object.keys(e).length===0?"{}":`{ ${Object.entries(e).map(([t,r])=>`${t}${r.meta.required?"":"?"}: ${r.toString()}`).join(", ")} }`),p("union",["list"],({list:e},t)=>{let r=e.map(({toString:n})=>n()).join(" | ");return t?`(${r})`:r}),p("intersect",["list"],({list:e})=>`${e.map(t=>t.toString(!0)).join(" & ")}`),p("transform",["inner","callback","preserve"],({inner:e},t)=>e.toString(t)),y.exports=o}}),z=D();export{z as default};
