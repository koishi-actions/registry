import{Buffer as A}from"https://registry.koishi.chat/modules/buffer/index.js";import K from"https://registry.koishi.chat/modules/process/index.js";import{Binary as _,clone as M,deepEqual as O,filterKeys as R,isNullable as y,isPlainObject as k,pick as z,valueMap as a}from"https://registry.koishi.chat/modules/cosmokit/index.js";var T=Object.defineProperty,B=Object.getOwnPropertyNames,f=(b,h)=>T(b,"name",{value:h,configurable:!0}),P=(b,h)=>function(){return h||(0,b[B(b)[0]])((h={exports:{}}).exports,h),h.exports},V=P({"src/index.ts"(b,h){var g=Symbol.for("schemastery"),j=Symbol.for("ValidationError");globalThis.__schemastery_index__??=0,globalThis.__schemastery_refs__=void 0;var u=class extends TypeError{constructor(t,e){let r="$";for(let n of e.path||[])typeof n=="string"?r+="."+n:typeof n=="number"?r+="["+n+"]":typeof n=="symbol"&&(r+=`[Symbol(${n.toString()})]`);r.startsWith(".")&&(r=r.slice(1)),super((r==="$"?"":`${r} `)+t),this.options=e}static{f(this,"ValidationError")}name="ValidationError";static is(t){return!!t?.[j]}};Object.defineProperty(u.prototype,j,{value:!0});var i=f(function(t){let e=f(function(r,n={}){return i.resolve(r,e,n)[0]},"schema");if(t.refs){let r=a(t.refs,o=>new i(o)),n=f(o=>r[o],"getRef");for(let o in r){let s=r[o];s.sKey=n(s.sKey),s.inner=n(s.inner),s.list=s.list&&s.list.map(n),s.dict=s.dict&&a(s.dict,n)}return r[t.uid]}if(Object.assign(e,t),typeof e.callback=="string")try{e.callback=new Function("return "+e.callback)()}catch{}return Object.defineProperty(e,"uid",{value:globalThis.__schemastery_index__++}),Object.setPrototypeOf(e,i.prototype),e.meta||={},e.toString=e.toString.bind(e),e},"Schema");i.prototype=Object.create(Function.prototype),i.prototype[g]=!0,i.ValidationError=u,i.prototype.toJSON=f(function(){if(globalThis.__schemastery_refs__)return globalThis.__schemastery_refs__[this.uid]??=JSON.parse(JSON.stringify({...this})),this.uid;globalThis.__schemastery_refs__={[this.uid]:{...this}},globalThis.__schemastery_refs__[this.uid]=JSON.parse(JSON.stringify({...this}));let e={uid:this.uid,refs:globalThis.__schemastery_refs__};return globalThis.__schemastery_refs__=void 0,e},"toJSON"),i.prototype.set=f(function(e,r){return this.dict[e]=r,this},"set"),i.prototype.push=f(function(e){return this.list.push(e),this},"push");function v(t,e){let r=typeof t=="string"?{"":t}:{...t};for(let n in e){let o=e[n];o?.$description||o?.$desc?r[n]=o.$description||o.$desc:typeof o=="string"&&(r[n]=o)}return r}f(v,"mergeDesc");function m(t){return t?.$value??t?.$inner}f(m,"getInner");function S(t){return R(t??{},e=>!e.startsWith("$"))}f(S,"extractKeys"),i.prototype.i18n=f(function(e){let r=i(this),n=v(r.meta.description,e);return Object.keys(n).length&&(r.meta.description=n),r.dict&&(r.dict=a(r.dict,(o,s)=>o.i18n(a(e,c=>m(c)?.[s]??c?.[s])))),r.list&&(r.list=r.list.map((o,s)=>o.i18n(a(e,(c={})=>Array.isArray(m(c))?m(c)[s]:Array.isArray(c)?c[s]:S(c))))),r.inner&&(r.inner=r.inner.i18n(a(e,o=>m(o)?m(o):S(o)))),r.sKey&&(r.sKey=r.sKey.i18n(a(e,o=>o?.$key))),r},"i18n"),i.prototype.extra=f(function(e,r){let n=i(this);return n.meta={...n.meta,[e]:r},n},"extra");for(let t of["required","disabled","collapse","hidden","loose"])Object.assign(i.prototype,{[t](e=!0){let r=i(this);return r.meta={...r.meta,[t]:e},r}});i.prototype.deprecated=f(function(){let e=i(this);return e.meta.badges||=[],e.meta.badges.push({text:"deprecated",type:"danger"}),e},"deprecated"),i.prototype.experimental=f(function(){let e=i(this);return e.meta.badges||=[],e.meta.badges.push({text:"experimental",type:"warning"}),e},"experimental"),i.prototype.pattern=f(function(e){let r=i(this),n=z(e,["source","flags"]);return r.meta={...r.meta,pattern:n},r},"pattern"),i.prototype.simplify=f(function(e){if(O(e,this.meta.default,this.type==="dict"))return null;if(y(e))return e;if(this.type==="object"||this.type==="dict"){let r={};for(let n in e){let s=(this.type==="object"?this.dict[n]:this.inner)?.simplify(e[n]);(this.type==="dict"||!y(s))&&(r[n]=s)}return O(r,this.meta.default,this.type==="dict")?null:r}else if(this.type==="array"||this.type==="tuple"){let r=[];return e.forEach((n,o)=>{let s=this.type==="array"?this.inner:this.list[o],c=s?s.simplify(n):n;r.push(c)}),r}else if(this.type==="intersect"){let r={};for(let n of this.list)Object.assign(r,n.simplify(e));return r}else if(this.type==="union")for(let r of this.list)try{return i.resolve(e,r,{}),r.simplify(e)}catch{}return e},"simplify"),i.prototype.toString=f(function(e){return J[this.type]?.(this,e)??`Schema<${this.type}>`},"toString"),i.prototype.role=f(function(t,e){let r=i(this);return r.meta={...r.meta,role:t,extra:e},r},"role");for(let t of["default","link","comment","description","max","min","step"])Object.assign(i.prototype,{[t](e){let r=i(this);return r.meta={...r.meta,[t]:e},r}});var N={};i.extend=f(function(e,r){N[e]=r},"extend"),i.resolve=f(function(e,r,n={},o=!1){if(!r)return[e];if(n.ignore?.(e,r))return[e];if(y(e)&&r.type!=="lazy"){if(r.meta.required)throw new u("missing required value",n);let c=r,l=r.meta.default;for(;c?.type==="intersect"&&y(l);)c=c.list[0],l=c?.meta.default;if(y(l))return[e];e=M(l)}let s=N[r.type];if(!s)throw new u(`unsupported type "${r.type}"`,n);try{return s(e,r,n,o)}catch(c){if(!r.meta.loose)throw c;return[r.meta.default]}},"resolve"),i.from=f(function(e){if(y(e))return i.any();if(["string","number","boolean"].includes(typeof e))return i.const(e).required();if(e[g])return e;if(typeof e=="function")switch(e){case String:return i.string().required();case Number:return i.number().required();case Boolean:return i.boolean().required();case Function:return i.function().required();default:return i.is(e).required()}else throw new TypeError(`cannot infer schema from ${e}`)},"from"),i.lazy=f(function(e){let r=f(()=>(n.inner[g]||(n.inner=n.builder(),n.inner.meta={...n.meta,...n.inner.meta}),n.inner.toJSON()),"toJSON"),n=new i({type:"lazy",builder:e,inner:{toJSON:r}});return n},"lazy"),i.natural=f(function(){return i.number().step(1).min(0)},"natural"),i.percent=f(function(){return i.number().step(.01).min(0).max(1).role("slider")},"percent"),i.date=f(function(){return i.union([i.is(Date),i.transform(i.string().role("datetime"),(e,r)=>{let n=new Date(e);if(isNaN(+n))throw new u(`invalid date "${e}"`,r);return n},!0)])},"date"),i.regExp=f(function(e=""){return i.union([i.is(RegExp),i.transform(i.string().role("regexp",{flag:e}),(r,n)=>{try{return new RegExp(r,e)}catch(o){throw new u(o.message,n)}},!0)])},"regExp"),i.arrayBuffer=f(function(e){return i.union([i.is(ArrayBuffer),i.is(SharedArrayBuffer),i.transform(i.any(),(r,n)=>{if(_.isSource(r))return _.fromSource(r);throw new u(`expected ArrayBufferSource but got ${r}`,n)},!0),...e?[i.transform(i.string(),(r,n)=>{try{return e==="base64"?_.fromBase64(r):_.fromHex(r)}catch(o){throw new u(o.message,n)}},!0)]:[]])},"arrayBuffer"),i.extend("lazy",(t,e,r,n)=>(e.inner[g]||(e.inner=e.builder(),e.inner.meta={...e.meta,...e.inner.meta}),i.resolve(t,e.inner,r,n))),i.extend("any",t=>[t]),i.extend("never",(t,e,r)=>{throw new u(`expected nullable but got ${t}`,r)}),i.extend("const",(t,{value:e},r)=>{if(O(t,e))return[e];throw new u(`expected ${e} but got ${t}`,r)});function w(t,e,r,n,o=!1){let{max:s=1/0,min:c=-1/0}=e;if(t>s)throw new u(`expected ${r} <= ${s} but got ${t}`,n);if(t<c&&!o)throw new u(`expected ${r} >= ${c} but got ${t}`,n)}f(w,"checkWithinRange"),i.extend("string",(t,{meta:e},r)=>{if(typeof t!="string")throw new u(`expected string but got ${t}`,r);if(e.pattern){let n=new RegExp(e.pattern.source,e.pattern.flags);if(!n.test(t))throw new u(`expect string to match regexp ${n}`,r)}return w(t.length,e,"string length",r),[t]});function x(t,e){let r=t.toString();if(r.includes("e"))return t*Math.pow(10,e);let n=r.indexOf(".");if(n===-1)return t*Math.pow(10,e);let o=r.slice(n+1),s=r.slice(0,n);return o.length<=e?+(s+o.padEnd(e,"0")):+(s+o.slice(0,e)+"."+o.slice(e))}f(x,"decimalShift");function E(t,e,r){if(r=Math.abs(r),!/^\d+\.\d+$/.test(r.toString()))return(t-e)%r===0;let n=r.toString().indexOf("."),o=r.toString().slice(n+1).length;return Math.abs(x(t,o)-x(e,o))%x(r,o)===0}f(E,"isMultipleOf"),i.extend("number",(t,{meta:e},r)=>{if(typeof t!="number")throw new u(`expected number but got ${t}`,r);w(t,e,"number",r);let{step:n}=e;if(n&&!E(t,e.min??0,n))throw new u(`expected number multiple of ${n} but got ${t}`,r);return[t]}),i.extend("boolean",(t,e,r)=>{if(typeof t=="boolean")return[t];throw new u(`expected boolean but got ${t}`,r)}),i.extend("bitset",(t,{bits:e,meta:r},n)=>{let o=0,s=[];if(typeof t=="number"){o=t;for(let c in e)t&e[c]&&s.push(c)}else if(Array.isArray(t)){s=t;for(let c of s){if(typeof c!="string")throw new u(`expected string but got ${c}`,n);c in e&&(o|=e[c])}}else throw new u(`expected number or array but got ${t}`,n);return o===r.default?[o]:[o,s]}),i.extend("function",(t,e,r)=>{if(typeof t=="function")return[t];throw new u(`expected function but got ${t}`,r)}),i.extend("is",(t,{constructor:e},r)=>{if(typeof e=="function"){if(t instanceof e)return[t];throw new u(`expected ${e.name} but got ${t}`,r)}else{if(y(t))throw new u(`expected ${e} but got ${t}`,r);let n=Object.getPrototypeOf(t);for(;n;){if(n.constructor?.name===e)return[t];n=Object.getPrototypeOf(n)}throw new u(`expected ${e} but got ${t}`,r)}});function d(t,e,r,n){try{let[o,s]=i.resolve(t[e],r,{...n,path:[...n.path||[],e]});return s!==void 0&&(t[e]=s),o}catch(o){if(!n?.autofix)throw o;return delete t[e],r.meta.default}}f(d,"property"),i.extend("array",(t,{inner:e,meta:r},n)=>{if(!Array.isArray(t))throw new u(`expected array but got ${t}`,n);return w(t.length,r,"array length",n,!y(e.meta.default)),[t.map((o,s)=>d(t,s,e,n))]}),i.extend("dict",(t,{inner:e,sKey:r},n,o)=>{if(!k(t))throw new u(`expected object but got ${t}`,n);let s={};for(let c in t){let l;try{l=i.resolve(c,r,n)[0]}catch(q){if(o)continue;throw q}s[l]=d(t,c,e,n),t[l]=t[c],c!==l&&delete t[c]}return[s]}),i.extend("tuple",(t,{list:e},r,n)=>{if(!Array.isArray(t))throw new u(`expected array but got ${t}`,r);let o=e.map((s,c)=>d(t,c,s,r));return n?[o]:(o.push(...t.slice(e.length)),[o])});function $(t,e){for(let r in e)r in t||(t[r]=e[r])}f($,"merge"),i.extend("object",(t,{dict:e},r,n)=>{if(!k(t))throw new u(`expected object but got ${t}`,r);let o={};for(let s in e){let c=d(t,s,e[s],r);(!y(c)||s in t)&&(o[s]=c)}return n||$(o,t),[o]}),i.extend("union",(t,{list:e,toString:r},n,o)=>{let s=[];for(let c of e)try{return i.resolve(t,c,n,o)}catch(l){s.push(l)}throw new u(`expected ${r()} but got ${JSON.stringify(t)}`,n)}),i.extend("intersect",(t,{list:e,toString:r},n,o)=>{if(!e.length)return[t];let s;for(let c of e){let l=i.resolve(t,c,n,!0)[0];if(!y(l))if(y(s))s=l;else{if(typeof s!=typeof l)throw new u(`expected ${r()} but got ${JSON.stringify(t)}`,n);if(typeof l=="object")$(s??={},l);else if(s!==l)throw new u(`expected ${r()} but got ${JSON.stringify(t)}`,n)}}return!o&&k(t)&&$(s,t),[s]}),i.extend("transform",(t,{inner:e,callback:r,preserve:n},o)=>{let[s,c=t]=i.resolve(t,e,o,!0);return n?[r(s)]:[r(s),r(c)]});var J={};function p(t,e,r){J[t]=r,Object.assign(i,{[t](...n){let o=new i({type:t});return e.forEach((s,c)=>{switch(s){case"sKey":o.sKey=n[c]??i.string();break;case"inner":o.inner=i.from(n[c]);break;case"list":o.list=n[c].map(i.from);break;case"dict":o.dict=a(n[c],i.from);break;case"bits":{o.bits={};for(let l in n[c])typeof n[c][l]=="number"&&(o.bits[l]=n[c][l]);break}case"callback":{let l=o.callback=n[c];l.toJSON||=()=>l.toString();break}case"constructor":{let l=o.constructor=n[c];typeof l=="function"&&(l.toJSON||=()=>l.name);break}default:o[s]=n[c]}}),t==="object"||t==="dict"?o.meta.default={}:t==="array"||t==="tuple"?o.meta.default=[]:t==="bitset"&&(o.meta.default=0),o}})}f(p,"defineMethod"),p("is",["constructor"],({constructor:t})=>typeof t=="function"?t.name:t),p("any",[],()=>"any"),p("never",[],()=>"never"),p("const",["value"],({value:t})=>typeof t=="string"?JSON.stringify(t):t),p("string",[],()=>"string"),p("number",[],()=>"number"),p("boolean",[],()=>"boolean"),p("bitset",["bits"],()=>"bitset"),p("function",[],()=>"function"),p("array",["inner"],({inner:t})=>`${t.toString(!0)}[]`),p("dict",["inner","sKey"],({inner:t,sKey:e})=>`{ [key: ${e.toString()}]: ${t.toString()} }`),p("tuple",["list"],({list:t})=>`[${t.map(e=>e.toString()).join(", ")}]`),p("object",["dict"],({dict:t})=>Object.keys(t).length===0?"{}":`{ ${Object.entries(t).map(([e,r])=>`${e}${r.meta.required?"":"?"}: ${r.toString()}`).join(", ")} }`),p("union",["list"],({list:t},e)=>{let r=t.map(({toString:n})=>n()).join(" | ");return e?`(${r})`:r}),p("intersect",["list"],({list:t})=>`${t.map(e=>e.toString(!0)).join(" & ")}`),p("transform",["inner","callback","preserve"],({inner:t},e)=>t.toString(e)),h.exports=i}}),H=V();export{H as default};
